<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Kaldi: Reading and modifying the code (1/2 hour)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" /> 
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
 <td id="projectlogo"><a href="http://kaldi-asr.org/"><img alt="Logo" src="KaldiTextAndLogoSmall.png"/ style="padding: 3px 5px 1px 5px"></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname" style="display:none">Kaldi
   </div>
  </td>
    <td style="padding-left: 0.5em;">
    <div id="projectbrief" style="display:none"></div>
    </td>
   <!--END PROJECT_BRIEF-->
  <!--END !PROJECT_NAME-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('tutorial_code.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Reading and modifying the code (1/2 hour) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="el" href="tutorial.html">Up: Kaldi tutorial</a> <br />
 <a class="el" href="tutorial_running.html">Previous: Running the example scripts</a> <br />
</p>
<p>While the triphone system build is running, we will take a little while to glance at some parts of the code. The main thing you will get out of this section of the tutorial is some idea of how the code is organized and what the dependency structure is; and some experience with modifying and debugging the code. If you want to understand it code in more depth, we advise you to follow the links on the <a class="el" href="index.html">main documentation page</a>, where we have more detailed documentation organized by topic.</p>
<h1><a class="anchor" id="tutorial_code_utils"></a>
Common utilities</h1>
<p>Go to the top-level directory (we called it kaldi-1) and then into src/. First look at the file <a class="el" href="kaldi-common_8h.html">base/kaldi-common.h</a> (don't follow the links within this document; view it from the shell or from an editor). This #includes a number of things from the base/ directory that are used by almost every Kaldi program. You can mostly guess from the filenames the types of things that are provided: things like error-logging macros, typedefs, math utility functions such as random number generation, and miscellaneous #defines. But this is a stripped-down set of utilities; in <a class="el" href="common-utils_8h.html">util/common-utils.h</a> there is a more complete set, including command-line parsing and I/O functions that handle extended filenames such as pipes. Take a few seconds to glance over <a class="el" href="common-utils_8h.html">util/common-utils.h</a> and see what it #includes. The reason why we segregated a subset of utilities into the base/ directory is so that we could minimize the dependencies of the matrix/ directory (which is useful in itself); the matrix/ directory only depends on the base/ directory. Look at matrix/Makefile and search for base/ to see how this is specified. Looking at this type of rule in the Makefiles can give you some insight into the structure of the toolkit.</p>
<h1><a class="anchor" id="tutorial_code_matrix"></a>
Matrix library (and modifying and debugging code)</h1>
<p>Now look at the file <a class="el" href="matrix-lib_8h.html">matrix/matrix-lib.h</a>. See what files it includes. This provides an overview of the kinds of things that are in the matrix library. This library is basically a C++ wrapper for BLAS and LAPACK, if that means anything to you (if not, don't worry). The files <a class="el" href="sp-matrix_8h.html">sp-matrix.h</a> and <a class="el" href="tp-matrix_8h.html">tp-matrix.h</a> relate to symmetric packed matrices and triangular packed matrices, respectively. Quickly scan the file <a class="el" href="kaldi-matrix_8h.html">matrix/kaldi-matrix.h</a>. This will give you some idea what the matrix code looks like. It consists of a C++ class representing a matrix. We provide a mini-tutorial on the matrix library <a class="el" href="matrix.html">here</a>, if you are interested. You might notice what seems like a strange comment style in the code, with comments started by three slashes (///). These types of commends, and block comments that begin with</p><pre class="fragment">/**</pre><p>, are interpreted by the Doxygen software that automatically generates documentation. It also generates the page you are reading right now (the source for this type of documentation is in src/doc/).</p>
<p>At this point we would like you to modify the code and compile it. We will be adding a test function to the file <a class="el" href="matrix-lib-test_8cc.html">matrix/matrix-lib-test.cc</a>. As mentioned before, the test programs are designed to abort or exit with nonzero status if something is wrong.</p>
<p>We will be adding a test routine for the function Vector::AddVec. This function adds some constant times one vector, to another vector. Read through the code below and try to understand as much of it as you can (be careful: we have deliberately inserted two errors into the code). If you are not familiar with templates, understanding it may be difficult. We have tried to avoid the use of templates as much as possible, so large parts of Kaldi are still understandable without knowing template progamming. </p><pre class="fragment">template&lt;class Real&gt;
void UnitTestAddVec() {
  // note: Real will be float or double when instantiated.
  int32 dim = 1 + Rand() % 10;
  Vector&lt;Real&gt; v(dim); w(dim); // two vectors the same size.
  v.SetRandn();
  w.SetRandn();
  Vector&lt;Real&gt; w2(w); // w2 is a copy of w.
  Real f = RandGauss();
  w.AddVec(f, v); // w &lt;-- w + f v
  for (int32 i = 0; i &lt; dim; i++) {
    Real a = w(i), b = f * w2(i) + v(i);
    AssertEqual(a, b); // will crash if not equal to within
    // a tolerance.
  }
}
</pre><p> Add this code to the file <a class="el" href="matrix-lib-test_8cc.html">matrix-lib-test.cc</a>, just above the function <a class="el" href="namespacekaldi.html#a8a7376886f24285335b904248d9b9e38">MatrixUnitTest()</a>. Then, inside <a class="el" href="namespacekaldi.html#a8a7376886f24285335b904248d9b9e38">MatrixUnitTest()</a>, add the line: </p><pre class="fragment">  UnitTestAddVec&lt;Real&gt;();
</pre><p> It doesn't matter where in the function you add this. Then type "make test". There should be an error (a semicolon that should be a comma); fix it and try again. Now type "./matrix-lib-test". This should crash with an assertion failure, because there was another mistake in the unit-test code. Next we will debug it. Type </p><pre class="fragment"> gdb ./matrix-lib-test
</pre><p> (if you are on cygwin, you should now type into the gdb prompt, "break __assert_func"). Type "r". When it crashes, it calls abort(), which gets caught by the debugger. Type "bt" to see the stack trace. Nagivate up the stack by typing "up" until you are inside the test function. When you are at the right place you should see output like: </p><pre class="fragment">#5  0x080943cf in kaldi::UnitTestAddVec&lt;float&gt; () at matrix-lib-test.cc:2568
2568	    AssertEqual(a, b); // will crash if not equal to within
</pre><p> If you go too far you can type "down". Then type "p a" and "p b" to see the values of a and b ("p" is short for "print"). Your screen should look someting like this: </p><pre class="fragment">(gdb) p a
$5 = -0.931363404
(gdb) p b
$6 = -0.270584524
(gdb)
</pre><p> The exact values are, of course, random, and may be different for you. Since the numbers are considerably different, it's clear that it's not just a question of the tolerances being wrong. In general you can access any kind of expression from the debugger using the "print" expression, but the parenthesis operator (expressions like "v(i)") doesn't work, so to see the values inside the vectors you have to enter expressions like the following: </p><pre class="fragment">(gdb) p v.data_[0]
$8 = 0.281656802
(gdb) p w.data_[0]
$9 = -0.931363404
(gdb) p w2.data_[0]
$10 = -1.07592916
(gdb)
</pre><p> This may help you work out that the expression for "b" is wrong. Fix it in the code, recompile, and run again (you can just type "r" in the gdb prompt to rerun). It should now run OK. Force gdb to break into the code at the point where it was previously failing, so you can check the values of the expressions again and see that things are now working OK. To get the debugger to break there you have to set a breakpoint. Work out the line number that the assertion was failing (somewhere in UnitTestAddVec()), and type into gdb something like the following: </p><pre class="fragment">(gdb) b matrix-lib-test.cc:2568
Breakpoint 1 at 0x80943b4: file matrix-lib-test.cc, line 2568. (4 locations)
</pre><p> Then run the program (type "r"), and when it breaks there, look at the values of the expressions using "p" commands. To continue, type "c". It will keep stopping there since it was inside a loop. Type "d 1" to delete the breakpoint (assuming it was breakpoint number one), and type "c" to continue. The program should run to the end. Type "q" to quit the debugger. If you need to debug a program that takes command-line arguments, you can do it like: </p><pre class="fragment"> gdb --args kaldi-program arg1 arg2 ...
 (gdb) r
 ...
</pre><p> or you can invoke gdb without arguments and then type "r arg1 arg2..." at the prompt.</p>
<p>When you are done, and it compiles, type </p><pre class="fragment"> git diff
</pre><p> to see what changes you made. If you are contributing to the Kaldi project and planning to send us code in the near future, you may want to commit them to a branch as described in the , so that you can generate a clean <a href="https://help.github.com/articles/using-pull-requests/">GitHub pull request</a> later. We recommend that you familiarize yourself with Git branches even if you are not contributing your changes outright; Git is a powerful tool to maintain your local code changes as well as those you may contribute.</p>
<h1><a class="anchor" id="tutorial_code_acoustic"></a>
Acoustic modeling code</h1>
<p>Next look at <a class="el" href="diag-gmm_8h.html">gmm/diag-gmm.h</a> (this class stores a Gaussian Mixture Model). The class DiagGmm may look a bit confusing as it has many different accessor functions. Search for "private" and look at the class member variables (they always end with an underscore, as per the Kaldi style). This should make it clear how we store the GMM. This is just a single GMM, not a whole collection of GMMs. Look at <a class="el" href="am-diag-gmm_8h.html">gmm/am-diag-gmm.h</a>; this class stores a collection of GMMs. Notice that it does not inherit from anything. Search for "private" and you can see the member variables (there are only two of them). You can understand from this how simple the class is (everything else consists of various accessors and convenience functions). A natural question to ask is: where are the transitions, where is the decision tree, and where is the HMM topology? All of these things are kept separate from the acoustic model, because it's likely that researchers might want to replace the acoustic likelihoods while keeping the rest of the system the same. We'll come to this other stuff later.</p>
<h1><a class="anchor" id="tutorial_code_feat"></a>
Feature extraction code</h1>
<p>Next look at <a class="el" href="feature-mfcc_8h.html">feat/feature-mfcc.h</a>. Focus on the MfccOptions struct. The struct members give you some idea what kind of options are supported in MFCC feature extraction. Notice that some struct members are options structs themselves. Look at the Register function. This is standard in Kaldi options classes. Then look at <a class="el" href="compute-mfcc-feats_8cc.html">featbin/compute-mfcc-feats.cc</a> (this is a command-line program) and search for Register. You can see where the Register function of the options struct is called. To see a complete list of the options supported for MFCC feature extraction, execute the program featbin/compute-mfcc-feats with no arguments. Recall that you saw some of these options being registered in the MfccOptions class, and others being registered in <a class="el" href="compute-mfcc-feats_8cc.html">featbin/compute-mfcc-feats.cc</a>. The way to specify options is &ndash;option=value. Type </p><pre class="fragment">featbin/compute-mfcc-feats ark:/dev/null ark:/dev/null
</pre><p> This should run successfuly, as it interprets /dev/null as an empty archive. You can try setting the options using this example. Try, for example, </p><pre class="fragment">featbin/compute-mfcc-feats --raw-energy=false ark:/dev/null ark:/dev/null
</pre><p> The only useful information you get from this is that it doesn't crash; try removing the "=" sign or abbreviating the option name or changing the number of arguments, and see that it fails and prints a usage message.</p>
<h1><a class="anchor" id="tutorial_code_tree"></a>
Acoustic decision-tree and HMM topology code</h1>
<p>Next look at <a class="el" href="build-tree_8h.html">tree/build-tree.h</a>. Find the BuildTree function. This is the main top-level function for building the decision tree. Notice that it returns a pointer the type EventMap. This is a type that stores a function from a set of (key, value) pairs to an integer. It's defined in <a class="el" href="event-map_8h.html">tree/event-map.h</a>. The keys and values are both integers, but the keys represent phonetic-context positions (typically 0, 1 or 2) and the values represent phones. There is also a special key, -1, that roughly represents the position in the HMM. Go to the experimental directory (../egs/rm/s5), and we are going to look at how the tree is built. The main input to the BuildTree function is of type BuildTreeStatsType, which is a typedef as follows: </p><pre class="fragment">typedef vector&lt;pair&lt;EventType, Clusterable*&gt; &gt; BuildTreeStatsType;
</pre><p> Here, EvenType is the following typedef: </p><pre class="fragment">typedef vector&lt;pair&lt;EventKeyType, EventValueType&gt; &gt; EventType;
</pre><p> The EventType represents a set of (key,value) pairs, e.g. a typical one would be { {-1, 1}, {0, 15}, {1, 21}, {2, 38} } which represents phone 21 with a left-context of phone 15, a right-context of phone 38, and "pdf-class" 1 (which in the normal case means it's in state number 1, which is the middle of three states). The Clusterable* pointer is a pointer to a virtual class which has a generic interface that supports operations like adding statistics together and evaluating some kind of objective function (e.g. a likelihood). In the normal recipe, it actually points to a class that contains sufficient statistics for estimating a diagonal Gaussian p.d.f..</p>
<p>Do </p><pre class="fragment">less exp/tri1/log/acc_tree.log
</pre><p> There won't be much information in this file, but you can see the command line. This program accumulates the single-Gaussian statistics for each HMM-state (actually, pdf-class) of each seen triphone context. The <code>&ndash;ci-phones</code> options is so that it knows to avoid accumulating separate statistics for distinct context of phones like silence that we don't want to be context dependent (this is an optimization; it would work without this option). The output of this program can be thought of as being of the type BuildTreeStatsType discussed above, although in order to read it we have to know what concrete type it is.</p>
<p>Do </p><pre class="fragment">less exp/tri1/log/train_tree.log
</pre><p> This program does the decision-tree clustering; it reads in the statistics that were output by. It is basically a wrapper for the BuildTree function discussed above. The questions that it asks in the decision-tree clustering are automatically generated, as you can see in the script steps/train_tri1.sh (look for the programs cluster-phones and compile-questions).</p>
<p>Next look at <a class="el" href="hmm-topology_8h.html">hmm/hmm-topology.h</a>. The class HmmTopology defines a set of HMM topologies for a number of phones. In general each phone can have a different topology. The topology includes "default" transitions, used for initialization. Look at the example topology in the extended comment at the top of the header. There is a tag &lt;PdfClass&gt; (note: as with HTK text formats, this file looks vaguely XML-like, but it is not really XML). The &lt;PdfClass&gt; is always the same as the HMM-state (&lt;State&gt;) here; in general, it doesn't have to be. This is a mechanism to enforce tying of distributions between distinct HMM states; it's possibly useful if you want to 5~create more interesting transition models.</p>
<p><a class="el" href="tutorial.html">Up: Kaldi tutorial</a> <br />
 <a class="el" href="tutorial_running.html">Previous: Running the example scripts</a> <br />
 </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Kaldi</a></li><li class="navelem"><a class="el" href="tutorial.html">Kaldi tutorial</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
