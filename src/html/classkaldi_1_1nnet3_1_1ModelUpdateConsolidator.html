<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Kaldi: ModelUpdateConsolidator Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" /> 
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
 <td id="projectlogo"><a href="http://kaldi-asr.org/"><img alt="Logo" src="KaldiTextAndLogoSmall.png"/ style="padding: 3px 5px 1px 5px"></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname" style="display:none">Kaldi
   </div>
  </td>
    <td style="padding-left: 0.5em;">
    <div id="projectbrief" style="display:none"></div>
    </td>
   <!--END PROJECT_BRIEF-->
  <!--END !PROJECT_NAME-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pri-methods">Private Member Functions</a> &#124;
<a href="#pri-attribs">Private Attributes</a> &#124;
<a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">ModelUpdateConsolidator Class Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>This class is responsible for consolidating the model-update part of backprop commands, for components in (e.g.) recurrent networks that need to have many separate backprop commands, into more efficient single commands operating on consolidated data in larger matrices.  
 <a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#details">More...</a></p>
<div class="dynheader">
Collaboration diagram for ModelUpdateConsolidator:</div>
<div class="dyncontent">
<div class="center"><img src="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator__coll__graph.png" border="0" usemap="#ModelUpdateConsolidator_coll__map" alt="Collaboration graph"/></div>
<map name="ModelUpdateConsolidator_coll__map" id="ModelUpdateConsolidator_coll__map">
</map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a49ab0eb74e9ab7b96b459d319f443d02"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a49ab0eb74e9ab7b96b459d319f443d02">ModelUpdateConsolidator</a> (const <a class="el" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;nnet, <a class="el" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation)</td></tr>
<tr class="separator:a49ab0eb74e9ab7b96b459d319f443d02"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1d8913b401bfd339536bdd60f97d6101"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1d8913b401bfd339536bdd60f97d6101">ConsolidateModelUpdate</a> ()</td></tr>
<tr class="separator:a1d8913b401bfd339536bdd60f97d6101"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pri-methods"></a>
Private Member Functions</h2></td></tr>
<tr class="memitem:ad691fe3a6e61eb46c08d591d4af2ea4b"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#ad691fe3a6e61eb46c08d591d4af2ea4b">ConsolidateUpdateForComponent</a> (int32 component, const std::vector&lt; int32 &gt; &amp;backprop_commands)</td></tr>
<tr class="memdesc:ad691fe3a6e61eb46c08d591d4af2ea4b"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function, called from ConsolidateModelUpdate, is passed a list of commands that are all backprops for the same component, and it consolidates them into a single model-update command.  <a href="#ad691fe3a6e61eb46c08d591d4af2ea4b">More...</a><br /></td></tr>
<tr class="separator:ad691fe3a6e61eb46c08d591d4af2ea4b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9ff791337c174a7dd4d789a414c452e3"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a9ff791337c174a7dd4d789a414c452e3">AddCommandsToComputation</a> ()</td></tr>
<tr class="memdesc:a9ff791337c174a7dd4d789a414c452e3"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function, called at the end of <a class="el" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1d8913b401bfd339536bdd60f97d6101">ConsolidateModelUpdate()</a>, takes the commands that we have put in extra_commands_, final_commands_ and final_deallocate_commands_, and puts them in the appropriate place in computation-&gt;commands_.  <a href="#a9ff791337c174a7dd4d789a414c452e3">More...</a><br /></td></tr>
<tr class="separator:a9ff791337c174a7dd4d789a414c452e3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad6767e6a06ceef8ceedb067c8c86d463"><td class="memItemLeft" align="right" valign="top">int32&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#ad6767e6a06ceef8ceedb067c8c86d463">ConsolidateSubmatrices</a> (const std::vector&lt; int32 &gt; &amp;commands, const std::vector&lt; int32 &gt; &amp;submatrices)</td></tr>
<tr class="memdesc:ad6767e6a06ceef8ceedb067c8c86d463"><td class="mdescLeft">&#160;</td><td class="mdescRight">You call this function when you want to consolidate the values of a list of submatrices taken just prior to particular commands.  <a href="#ad6767e6a06ceef8ceedb067c8c86d463">More...</a><br /></td></tr>
<tr class="separator:ad6767e6a06ceef8ceedb067c8c86d463"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a20efdbe0990f3fa04abb85ac56089614"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a20efdbe0990f3fa04abb85ac56089614">AppendDebugInfoForSubmatrix</a> (int32 submatrix_index, <a class="el" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a> *debug_info) const</td></tr>
<tr class="memdesc:a20efdbe0990f3fa04abb85ac56089614"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function, called from ConsolidateSubmatrices, will update 'debug_info' by appending the corresponding 'indexes' from the existing debug info for this submatrix.  <a href="#a20efdbe0990f3fa04abb85ac56089614">More...</a><br /></td></tr>
<tr class="separator:a20efdbe0990f3fa04abb85ac56089614"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pri-attribs"></a>
Private Attributes</h2></td></tr>
<tr class="memitem:adbabf05a7702103113a02a113015205f"><td class="memItemLeft" align="right" valign="top">const <a class="el" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#adbabf05a7702103113a02a113015205f">nnet_</a></td></tr>
<tr class="separator:adbabf05a7702103113a02a113015205f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a36d13565d1302a2bf74127b141ba3537"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a></td></tr>
<tr class="separator:a36d13565d1302a2bf74127b141ba3537"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aff6dbc6bf1ea33e5ea29bebebae8617a"><td class="memItemLeft" align="right" valign="top">std::vector&lt; std::vector&lt; <a class="el" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &gt; &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#aff6dbc6bf1ea33e5ea29bebebae8617a">extra_commands_</a></td></tr>
<tr class="separator:aff6dbc6bf1ea33e5ea29bebebae8617a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af13a24e7f0ed6969f7659518478ffdc2"><td class="memItemLeft" align="right" valign="top">std::vector&lt; <a class="el" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#af13a24e7f0ed6969f7659518478ffdc2">final_commands_</a></td></tr>
<tr class="separator:af13a24e7f0ed6969f7659518478ffdc2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1637cd5c5a1274835dfb87d75fde2037"><td class="memItemLeft" align="right" valign="top">std::vector&lt; <a class="el" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1637cd5c5a1274835dfb87d75fde2037">final_deallocate_commands_</a></td></tr>
<tr class="separator:a1637cd5c5a1274835dfb87d75fde2037"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>This class is responsible for consolidating the model-update part of backprop commands, for components in (e.g.) recurrent networks that need to have many separate backprop commands, into more efficient single commands operating on consolidated data in larger matrices. </p>
<p>This is useful for recurrent networks. </p>

<p class="definition">Definition at line <a class="el" href="nnet-optimize-utils_8cc_source.html#l01282">1282</a> of file <a class="el" href="nnet-optimize-utils_8cc_source.html">nnet-optimize-utils.cc</a>.</p>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="a49ab0eb74e9ab7b96b459d319f443d02"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a49ab0eb74e9ab7b96b459d319f443d02">&#9670;&nbsp;</a></span>ModelUpdateConsolidator()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html">ModelUpdateConsolidator</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;&#160;</td>
          <td class="paramname"><em>nnet</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *&#160;</td>
          <td class="paramname"><em>computation</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="nnet-optimize-utils_8cc_source.html#l01509">1509</a> of file <a class="el" href="nnet-optimize-utils_8cc_source.html">nnet-optimize-utils.cc</a>.</p>
<div class="fragment"><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;                                 :</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#adbabf05a7702103113a02a113015205f">nnet_</a>(nnet), <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>(computation),</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#aff6dbc6bf1ea33e5ea29bebebae8617a">extra_commands_</a>(computation-&gt;commands.size()) { }</div><div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_aff6dbc6bf1ea33e5ea29bebebae8617a"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#aff6dbc6bf1ea33e5ea29bebebae8617a">kaldi::nnet3::ModelUpdateConsolidator::extra_commands_</a></div><div class="ttdeci">std::vector&lt; std::vector&lt; NnetComputation::Command &gt; &gt; extra_commands_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01335">nnet-optimize-utils.cc:1335</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_a36d13565d1302a2bf74127b141ba3537"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">kaldi::nnet3::ModelUpdateConsolidator::computation_</a></div><div class="ttdeci">NnetComputation * computation_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01329">nnet-optimize-utils.cc:1329</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_adbabf05a7702103113a02a113015205f"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#adbabf05a7702103113a02a113015205f">kaldi::nnet3::ModelUpdateConsolidator::nnet_</a></div><div class="ttdeci">const Nnet &amp; nnet_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01328">nnet-optimize-utils.cc:1328</a></div></div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="a9ff791337c174a7dd4d789a414c452e3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9ff791337c174a7dd4d789a414c452e3">&#9670;&nbsp;</a></span>AddCommandsToComputation()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void AddCommandsToComputation </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This function, called at the end of <a class="el" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1d8913b401bfd339536bdd60f97d6101">ConsolidateModelUpdate()</a>, takes the commands that we have put in extra_commands_, final_commands_ and final_deallocate_commands_, and puts them in the appropriate place in computation-&gt;commands_. </p>

<p class="definition">Definition at line <a class="el" href="nnet-optimize-utils_8cc_source.html#l01434">1434</a> of file <a class="el" href="nnet-optimize-utils_8cc_source.html">nnet-optimize-utils.cc</a>.</p>

<p class="reference">References <a class="el" href="nnet-computation_8h_source.html#l00439">NnetComputation::commands</a>, <a class="el" href="nnet-optimize-utils_8cc_source.html#l01052">MatrixExtender::computation_</a>, <a class="el" href="mikolov-rnnlm-lib_8cc_source.html#l00066">rnnlm::i</a>, and <a class="el" href="kaldi-error_8h_source.html#l00168">KALDI_ASSERT</a>.</p>

<p class="reference">Referenced by <a class="el" href="nnet-optimize-utils_8cc_source.html#l01515">ModelUpdateConsolidator::ConsolidateModelUpdate()</a>.</p>
<div class="fragment"><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;                                                       {</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(<a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size() == <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#aff6dbc6bf1ea33e5ea29bebebae8617a">extra_commands_</a>.size());</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;  int32 old_num_commands = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size(),</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;      new_num_commands = old_num_commands +</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;      <span class="keyword">static_cast&lt;</span>int32<span class="keyword">&gt;</span>(<a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#af13a24e7f0ed6969f7659518478ffdc2">final_commands_</a>.size() +</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;                         <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1637cd5c5a1274835dfb87d75fde2037">final_deallocate_commands_</a>.size());</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#aff6dbc6bf1ea33e5ea29bebebae8617a">extra_commands_</a>.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++)</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;    new_num_commands += static_cast&lt;int32&gt;(<a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#aff6dbc6bf1ea33e5ea29bebebae8617a">extra_commands_</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].size());</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;  std::vector&lt;NnetComputation::Command&gt; new_commands;</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;  new_commands.reserve(new_num_commands);</div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;  <span class="keywordflow">for</span> (int32 c = 0; c &lt; old_num_commands; c++) {</div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;    new_commands.insert(new_commands.end(),</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;                        <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#aff6dbc6bf1ea33e5ea29bebebae8617a">extra_commands_</a>[c].begin(), <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#aff6dbc6bf1ea33e5ea29bebebae8617a">extra_commands_</a>[c].end());</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;    new_commands.push_back(<a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[c]);</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;  }</div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;  new_commands.insert(new_commands.end(),</div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;                      <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#af13a24e7f0ed6969f7659518478ffdc2">final_commands_</a>.begin(), <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#af13a24e7f0ed6969f7659518478ffdc2">final_commands_</a>.end());</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;  new_commands.insert(new_commands.end(),</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;                      <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1637cd5c5a1274835dfb87d75fde2037">final_deallocate_commands_</a>.begin(),</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;                      <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1637cd5c5a1274835dfb87d75fde2037">final_deallocate_commands_</a>.end());</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.swap(new_commands);</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;}</div><div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_af13a24e7f0ed6969f7659518478ffdc2"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#af13a24e7f0ed6969f7659518478ffdc2">kaldi::nnet3::ModelUpdateConsolidator::final_commands_</a></div><div class="ttdeci">std::vector&lt; NnetComputation::Command &gt; final_commands_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01340">nnet-optimize-utils.cc:1340</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_aff6dbc6bf1ea33e5ea29bebebae8617a"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#aff6dbc6bf1ea33e5ea29bebebae8617a">kaldi::nnet3::ModelUpdateConsolidator::extra_commands_</a></div><div class="ttdeci">std::vector&lt; std::vector&lt; NnetComputation::Command &gt; &gt; extra_commands_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01335">nnet-optimize-utils.cc:1335</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_afeb2e3e7413a0649c8a60e3bcd66981b"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">kaldi::nnet3::NnetComputation::commands</a></div><div class="ttdeci">std::vector&lt; Command &gt; commands</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00439">nnet-computation.h:439</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_a36d13565d1302a2bf74127b141ba3537"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">kaldi::nnet3::ModelUpdateConsolidator::computation_</a></div><div class="ttdeci">NnetComputation * computation_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01329">nnet-optimize-utils.cc:1329</a></div></div>
<div class="ttc" id="namespacernnlm_html_acb559820d9ca11295b4500f179ef6392"><div class="ttname"><a href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">rnnlm::i</a></div><div class="ttdeci">int i</div><div class="ttdef"><b>Definition:</b> <a href="mikolov-rnnlm-lib_8cc_source.html#l00066">mikolov-rnnlm-lib.cc:66</a></div></div>
<div class="ttc" id="group__error__group_html_gad5710173d69cddcda4fa21ded3c77f16"><div class="ttname"><a href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a></div><div class="ttdeci">#define KALDI_ASSERT(cond)</div><div class="ttdef"><b>Definition:</b> <a href="kaldi-error_8h_source.html#l00168">kaldi-error.h:168</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_a1637cd5c5a1274835dfb87d75fde2037"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1637cd5c5a1274835dfb87d75fde2037">kaldi::nnet3::ModelUpdateConsolidator::final_deallocate_commands_</a></div><div class="ttdeci">std::vector&lt; NnetComputation::Command &gt; final_deallocate_commands_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01343">nnet-optimize-utils.cc:1343</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a20efdbe0990f3fa04abb85ac56089614"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a20efdbe0990f3fa04abb85ac56089614">&#9670;&nbsp;</a></span>AppendDebugInfoForSubmatrix()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void AppendDebugInfoForSubmatrix </td>
          <td>(</td>
          <td class="paramtype">int32&#160;</td>
          <td class="paramname"><em>submatrix_index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a> *&#160;</td>
          <td class="paramname"><em>debug_info</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td> const</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This function, called from ConsolidateSubmatrices, will update 'debug_info' by appending the corresponding 'indexes' from the existing debug info for this submatrix. </p>
<p>It will also set the 'is_deriv' of '*debug_info' to the same value as the debug info for 'submatrix_index', and set the 'node_index' to the 'node_index' in the debug info for that submatrix-index. It requires that computation_-&gt;matrix_debug_info be nonempty. </p>

<p class="definition">Definition at line <a class="el" href="nnet-optimize-utils_8cc_source.html#l01347">1347</a> of file <a class="el" href="nnet-optimize-utils_8cc_source.html">nnet-optimize-utils.cc</a>.</p>

<p class="reference">References <a class="el" href="nnet-computation_8h_source.html#l00317">NnetComputation::MatrixDebugInfo::cindexes</a>, <a class="el" href="nnet-optimize-utils_8cc_source.html#l01052">MatrixExtender::computation_</a>, <a class="el" href="nnet-computation_8h_source.html#l00316">NnetComputation::MatrixDebugInfo::is_deriv</a>, <a class="el" href="kaldi-error_8h_source.html#l00168">KALDI_ASSERT</a>, <a class="el" href="nnet-computation_8h_source.html#l00390">NnetComputation::matrices</a>, <a class="el" href="nnet-computation_8h_source.html#l00394">NnetComputation::matrix_debug_info</a>, and <a class="el" href="nnet-computation_8h_source.html#l00404">NnetComputation::submatrices</a>.</p>
<div class="fragment"><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;                                                      {</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!<a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.empty());</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(static_cast&lt;size_t&gt;(submatrix_index) &lt;</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;               <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.size());</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;  NnetComputation::SubMatrixInfo submatrix_info =</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submatrix_index];</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;  int32 matrix_index = submatrix_info.matrix_index;</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(matrix_index &gt; 0 &amp;&amp; static_cast&lt;size_t&gt;(matrix_index) &lt;</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;               <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.size());</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;  <span class="keyword">const</span> NnetComputation::MatrixDebugInfo &amp;src_info =</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[matrix_index];</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;  debug_info-&gt;is_deriv = src_info.is_deriv;</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(src_info.cindexes.size() ==</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;               <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[matrix_index].num_rows);</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;  int32 row_begin = submatrix_info.row_offset,</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;      row_end = row_begin + submatrix_info.num_rows;</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;  debug_info-&gt;cindexes.insert(debug_info-&gt;cindexes.end(),</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;                             src_info.cindexes.begin() + row_begin,</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;                             src_info.cindexes.begin() + row_end);</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;}</div><div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_ad608a50eef55fe012c53acb48f1de02b"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">kaldi::nnet3::NnetComputation::matrix_debug_info</a></div><div class="ttdeci">std::vector&lt; MatrixDebugInfo &gt; matrix_debug_info</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00394">nnet-computation.h:394</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_a47a751a8db1c9c4856d04495f80620e9"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">kaldi::nnet3::NnetComputation::matrices</a></div><div class="ttdeci">std::vector&lt; MatrixInfo &gt; matrices</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00390">nnet-computation.h:390</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_acb31bf5441a137f7cbed4aeb74cb8421"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">kaldi::nnet3::NnetComputation::submatrices</a></div><div class="ttdeci">std::vector&lt; SubMatrixInfo &gt; submatrices</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00404">nnet-computation.h:404</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_a36d13565d1302a2bf74127b141ba3537"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">kaldi::nnet3::ModelUpdateConsolidator::computation_</a></div><div class="ttdeci">NnetComputation * computation_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01329">nnet-optimize-utils.cc:1329</a></div></div>
<div class="ttc" id="group__error__group_html_gad5710173d69cddcda4fa21ded3c77f16"><div class="ttname"><a href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a></div><div class="ttdeci">#define KALDI_ASSERT(cond)</div><div class="ttdef"><b>Definition:</b> <a href="kaldi-error_8h_source.html#l00168">kaldi-error.h:168</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a1d8913b401bfd339536bdd60f97d6101"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1d8913b401bfd339536bdd60f97d6101">&#9670;&nbsp;</a></span>ConsolidateModelUpdate()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ConsolidateModelUpdate </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="nnet-optimize-utils_8cc_source.html#l01515">1515</a> of file <a class="el" href="nnet-optimize-utils_8cc_source.html">nnet-optimize-utils.cc</a>.</p>

<p class="reference">References <a class="el" href="nnet-optimize-utils_8cc_source.html#l01434">ModelUpdateConsolidator::AddCommandsToComputation()</a>, <a class="el" href="nnet-computation_8h_source.html#l00341">NnetComputation::Command::arg1</a>, <a class="el" href="nnet-computation_8h_source.html#l00339">NnetComputation::Command::command_type</a>, <a class="el" href="nnet-computation_8h_source.html#l00439">NnetComputation::commands</a>, <a class="el" href="nnet-optimize-utils_8cc_source.html#l01329">ModelUpdateConsolidator::computation_</a>, <a class="el" href="nnet-optimize-utils_8cc_source.html#l01460">ModelUpdateConsolidator::ConsolidateUpdateForComponent()</a>, <a class="el" href="_2nnet-nnet_8cc_source.html#l00150">Nnet::GetComponent()</a>, <a class="el" href="nnet-computation_8h_source.html#l00290">kaldi::nnet3::kBackprop</a>, <a class="el" href="nnet-component-itf_8h_source.html#l00038">kaldi::nnet3::kSimpleComponent</a>, <a class="el" href="nnet-component-itf_8h_source.html#l00042">kaldi::nnet3::kUpdatableComponent</a>, <a class="el" href="nnet-component-itf_8h_source.html#l00079">kaldi::nnet3::kUsesMemo</a>, <a class="el" href="nnet-optimize-utils_8cc_source.html#l01328">ModelUpdateConsolidator::nnet_</a>, <a class="el" href="_2nnet-nnet_8h_source.html#l00124">Nnet::NumComponents()</a>, and <a class="el" href="classkaldi_1_1nnet3_1_1Component.html#a3a4ff15fafe0c8c4885586fc2c36ca8a">Component::Properties()</a>.</p>

<p class="reference">Referenced by <a class="el" href="nnet-optimize-utils_8cc_source.html#l01551">kaldi::nnet3::ConsolidateModelUpdate()</a>.</p>
<div class="fragment"><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;                                                     {</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;  int32 num_components = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#adbabf05a7702103113a02a113015205f">nnet_</a>.<a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html#a15b5336b4413124b1fd4531f57781182">NumComponents</a>(),</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;      num_commands = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size();</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;  <span class="comment">// &#39;backprop_commands&#39; is a list, for each component (but nonempty only for</span></div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;  <span class="comment">// updatable simple components), of the command indexes for the backprop</span></div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;  <span class="comment">// commands.</span></div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;  std::vector&lt;std::vector&lt;int32&gt; &gt; backprop_commands(num_components);</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;  <span class="keywordflow">for</span> (int32 command_index = 0;</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;       command_index &lt; num_commands; command_index++) {</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;    <span class="keyword">const</span> NnetComputation::Command &amp;c = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;    <span class="keywordflow">if</span> (c.command_type == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83">kBackprop</a>) {</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;      int32 component_index = c.arg1;</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;      <span class="keyword">const</span> Component *component = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#adbabf05a7702103113a02a113015205f">nnet_</a>.<a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html#aec8d6dfed3e4ab080d3ff4cf6a1126e3">GetComponent</a>(component_index);</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;      int32 properties = component-&gt;<a class="code" href="classkaldi_1_1nnet3_1_1Component.html#a3a4ff15fafe0c8c4885586fc2c36ca8a">Properties</a>();</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;      <span class="keywordflow">if</span> ((properties &amp; <a class="code" href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a61132a04f6c327dffd7f053b93ae393b">kUpdatableComponent</a>) &amp;&amp;</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;          (properties &amp; <a class="code" href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a5530b2f8f01fac9e6e73fd29a65d4127">kSimpleComponent</a>) &amp;&amp;</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;          !(properties &amp; <a class="code" href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a1713e609229066c956d4c7d544c69658">kUsesMemo</a>))</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;        backprop_commands[component_index].push_back(command_index);</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;    }</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;  }</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;  <span class="keywordtype">bool</span> consolidated = <span class="keyword">false</span>;</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;  <span class="keywordflow">for</span> (int32 component = 0; component &lt; num_components; component++) {</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;    <span class="keywordflow">if</span> (backprop_commands[component].size() &gt; 1) {</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#ad691fe3a6e61eb46c08d591d4af2ea4b">ConsolidateUpdateForComponent</a>(component,</div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;                                    backprop_commands[component]);</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;      consolidated = <span class="keyword">true</span>;</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;    }</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;  }</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;  <span class="keywordflow">if</span> (!consolidated)  <span class="comment">// This is an optimization to avoid redundant computation</span></div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;    <span class="keywordflow">return</span>;           <span class="comment">// if there is nothing to do.</span></div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;  <span class="comment">// the following function call commits all the commands we stored in member</span></div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;  <span class="comment">// variables, to computation_-&gt;commands.</span></div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a9ff791337c174a7dd4d789a414c452e3">AddCommandsToComputation</a>();</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;}</div><div class="ttc" id="namespacekaldi_1_1nnet3_html_a36da016976f88292c0d31653a20cbfe3a1713e609229066c956d4c7d544c69658"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a1713e609229066c956d4c7d544c69658">kaldi::nnet3::kUsesMemo</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-component-itf_8h_source.html#l00079">nnet-component-itf.h:79</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a36da016976f88292c0d31653a20cbfe3a61132a04f6c327dffd7f053b93ae393b"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a61132a04f6c327dffd7f053b93ae393b">kaldi::nnet3::kUpdatableComponent</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-component-itf_8h_source.html#l00042">nnet-component-itf.h:42</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_afeb2e3e7413a0649c8a60e3bcd66981b"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">kaldi::nnet3::NnetComputation::commands</a></div><div class="ttdeci">std::vector&lt; Command &gt; commands</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00439">nnet-computation.h:439</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_a9ff791337c174a7dd4d789a414c452e3"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a9ff791337c174a7dd4d789a414c452e3">kaldi::nnet3::ModelUpdateConsolidator::AddCommandsToComputation</a></div><div class="ttdeci">void AddCommandsToComputation()</div><div class="ttdoc">This function, called at the end of ConsolidateModelUpdate(), takes the commands that we have put in ...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01434">nnet-optimize-utils.cc:1434</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1Component_html_a3a4ff15fafe0c8c4885586fc2c36ca8a"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1Component.html#a3a4ff15fafe0c8c4885586fc2c36ca8a">kaldi::nnet3::Component::Properties</a></div><div class="ttdeci">virtual int32 Properties() const =0</div><div class="ttdoc">Return bitmask of the component&amp;#39;s properties. </div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_ad691fe3a6e61eb46c08d591d4af2ea4b"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#ad691fe3a6e61eb46c08d591d4af2ea4b">kaldi::nnet3::ModelUpdateConsolidator::ConsolidateUpdateForComponent</a></div><div class="ttdeci">void ConsolidateUpdateForComponent(int32 component, const std::vector&lt; int32 &gt; &amp;backprop_commands)</div><div class="ttdoc">This function, called from ConsolidateModelUpdate, is passed a list of commands that are all backprop...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01460">nnet-optimize-utils.cc:1460</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a36da016976f88292c0d31653a20cbfe3a5530b2f8f01fac9e6e73fd29a65d4127"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a5530b2f8f01fac9e6e73fd29a65d4127">kaldi::nnet3::kSimpleComponent</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-component-itf_8h_source.html#l00038">nnet-component-itf.h:38</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_a36d13565d1302a2bf74127b141ba3537"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">kaldi::nnet3::ModelUpdateConsolidator::computation_</a></div><div class="ttdeci">NnetComputation * computation_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01329">nnet-optimize-utils.cc:1329</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1Nnet_html_aec8d6dfed3e4ab080d3ff4cf6a1126e3"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1Nnet.html#aec8d6dfed3e4ab080d3ff4cf6a1126e3">kaldi::nnet3::Nnet::GetComponent</a></div><div class="ttdeci">Component * GetComponent(int32 c)</div><div class="ttdoc">Return component indexed c. Not a copy; not owned by caller. </div><div class="ttdef"><b>Definition:</b> <a href="_2nnet-nnet_8cc_source.html#l00150">nnet-nnet.cc:150</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83">kaldi::nnet3::kBackprop</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00290">nnet-computation.h:290</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1Nnet_html_a15b5336b4413124b1fd4531f57781182"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1Nnet.html#a15b5336b4413124b1fd4531f57781182">kaldi::nnet3::Nnet::NumComponents</a></div><div class="ttdeci">int32 NumComponents() const</div><div class="ttdef"><b>Definition:</b> <a href="_2nnet-nnet_8h_source.html#l00124">nnet-nnet.h:124</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_adbabf05a7702103113a02a113015205f"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#adbabf05a7702103113a02a113015205f">kaldi::nnet3::ModelUpdateConsolidator::nnet_</a></div><div class="ttdeci">const Nnet &amp; nnet_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01328">nnet-optimize-utils.cc:1328</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ad6767e6a06ceef8ceedb067c8c86d463"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad6767e6a06ceef8ceedb067c8c86d463">&#9670;&nbsp;</a></span>ConsolidateSubmatrices()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">int32 ConsolidateSubmatrices </td>
          <td>(</td>
          <td class="paramtype">const std::vector&lt; int32 &gt; &amp;&#160;</td>
          <td class="paramname"><em>commands</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::vector&lt; int32 &gt; &amp;&#160;</td>
          <td class="paramname"><em>submatrices</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>You call this function when you want to consolidate the values of a list of submatrices taken just prior to particular commands. </p>
<p>The input 'commands' and 'submatrices' lists must be the same size, and size must be &gt; 1. This function will create a new matrix that is the row-wise concatentation of all these submatrices, with values taken just prior to the respective command indexes. This function will will add to extra_commands_ the commands to do the copying at the appropriate places (at the supplied command indexes; they will be inserted just before). The return value is the submatrix index of a submatrix that represents the whole of the consolidated matrix. This command will insert, at the beginning of the computation (in extra_commands_[0]), a command to initialize the matrix; and will append to final_deallocate_commands_ the commands to deallocate the matrix. If computation_-&gt;matrix_debug_info is nonempty, this function will also update computation_-&gt;matrix_debug_info with suitable values for the newly added matrix </p>

<p class="definition">Definition at line <a class="el" href="nnet-optimize-utils_8cc_source.html#l01371">1371</a> of file <a class="el" href="nnet-optimize-utils_8cc_source.html">nnet-optimize-utils.cc</a>.</p>

<p class="reference">References <a class="el" href="nnet-optimize-utils_8cc_source.html#l01052">MatrixExtender::computation_</a>, <a class="el" href="mikolov-rnnlm-lib_8cc_source.html#l00066">rnnlm::i</a>, <a class="el" href="nnet-computation_8cc_source.html#l00975">NnetComputation::IsWholeMatrix()</a>, <a class="el" href="kaldi-error_8h_source.html#l00168">KALDI_ASSERT</a>, <a class="el" href="nnet-computation_8h_source.html#l00289">kaldi::nnet3::kAllocMatrix</a>, <a class="el" href="nnet-computation_8h_source.html#l00289">kaldi::nnet3::kDeallocMatrix</a>, <a class="el" href="matrix-common_8h_source.html#l00045">kaldi::kDefaultStride</a>, <a class="el" href="nnet-computation_8h_source.html#l00291">kaldi::nnet3::kMatrixCopy</a>, <a class="el" href="nnet-computation_8h_source.html#l00289">kaldi::nnet3::kSetConst</a>, <a class="el" href="matrix-common_8h_source.html#l00046">kaldi::kStrideEqualNumCols</a>, <a class="el" href="nnet-computation_8h_source.html#l00390">NnetComputation::matrices</a>, <a class="el" href="nnet-computation_8h_source.html#l00394">NnetComputation::matrix_debug_info</a>, <a class="el" href="nnet-computation_8cc_source.html#l00128">NnetComputation::NewMatrix()</a>, <a class="el" href="nnet-computation_8cc_source.html#l00102">NnetComputation::NewSubMatrix()</a>, and <a class="el" href="nnet-computation_8h_source.html#l00404">NnetComputation::submatrices</a>.</p>
<div class="fragment"><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;                                         {</div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;  int32 num_submatrices = submatrices.size();</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(num_submatrices &gt; 1 &amp;&amp; commands.size() == submatrices.size());</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;  int32 first_submatrix = submatrices[0];</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;  int32 num_cols = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[first_submatrix].num_cols,</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;      num_rows = 0;</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;  <a class="code" href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51">MatrixStrideType</a> stride_type = <a class="code" href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51aae343c6085287b6272231336d4b75986">kDefaultStride</a>;</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;  NnetComputation::MatrixDebugInfo debug_info;</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; num_submatrices; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;    int32 submatrix = submatrices[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;    num_rows += <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submatrix].num_rows;</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(<a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submatrix].num_cols == num_cols);</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.empty())</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a20efdbe0990f3fa04abb85ac56089614">AppendDebugInfoForSubmatrix</a>(submatrix, &amp;debug_info);</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab4efec36ef0d5bab190891c36bd9b2e3">IsWholeMatrix</a>(submatrix)) {</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;      int32 matrix = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submatrix].matrix_index;</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[matrix].stride_type == <a class="code" href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51a2b73d1b429e7067fc592b019190e4976">kStrideEqualNumCols</a>)</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;        stride_type = <a class="code" href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51a2b73d1b429e7067fc592b019190e4976">kStrideEqualNumCols</a>;</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;    }</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;  }</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;  <span class="comment">// new_whole_submatrix is a new submatrix index corresponding to the whole</span></div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;  <span class="comment">// of a new matrix that we are creating.</span></div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;  int32 new_whole_submatrix = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a16ed03ea200a71de08070d77fd52ceb9">NewMatrix</a>(num_rows, num_cols,</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;                                                      stride_type);</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;  <span class="comment">// Add commands at the very start, to initialize and then zero this new</span></div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;  <span class="comment">// matrix.  we can later on remove the zeroing if it is not necessary.</span></div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#aff6dbc6bf1ea33e5ea29bebebae8617a">extra_commands_</a>[0].push_back(</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;      NnetComputation::Command(<a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a73b5995148c3e987c4a163ad6bc9850b">kAllocMatrix</a>, new_whole_submatrix));</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#aff6dbc6bf1ea33e5ea29bebebae8617a">extra_commands_</a>[0].push_back(</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;      NnetComputation::Command(0.0, <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a55f8cb2bfd2e2c3605dfa961eff35fa2">kSetConst</a>, new_whole_submatrix));</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1637cd5c5a1274835dfb87d75fde2037">final_deallocate_commands_</a>.push_back(</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;      NnetComputation::Command(<a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae77588ab7fc4ccf842de7ec941247062">kDeallocMatrix</a>, new_whole_submatrix));</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;  int32 new_matrix_index =</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[new_whole_submatrix].matrix_index;</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;  <span class="keywordflow">if</span> (!<a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.empty())</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[new_matrix_index].Swap(&amp;debug_info);</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;  int32 row_offset = 0;</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; num_submatrices; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;    int32 submatrix_index = submatrices[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;    int32 this_num_rows = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submatrix_index].num_rows;</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;    <span class="comment">// submatrix corresponding to the part of the new matrix corresponding</span></div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;    <span class="comment">// to &#39;submatrices[i]&#39;.</span></div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;    int32 new_submatrix = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a61634eedcfea10a32bdb33bca3f94f2b">NewSubMatrix</a>(new_whole_submatrix,</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;                                                     row_offset, this_num_rows,</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;                                                     0, num_cols);</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;    <span class="comment">// Just before command &#39;commands[i]&#39;, add a command that assigns to the</span></div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;    <span class="comment">// submatrix numbered &#39;new_submatrix&#39; the contents of the submatrix numbered</span></div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;    <span class="comment">// &#39;submatrices[i]&#39;.  Note: we hope that a later pass of optimization</span></div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    <span class="comment">// (VariableMergingOptimization) will remove this redundant copy by</span></div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;    <span class="comment">// having the operation that created it write directly to the location</span></div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;    <span class="comment">// we want it to be.</span></div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;    NnetComputation::Command c(<a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a35d3d1a70d075561aaf91b263ea28f74">kMatrixCopy</a>, new_submatrix, submatrices[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>]);</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#aff6dbc6bf1ea33e5ea29bebebae8617a">extra_commands_</a>[commands[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>]].push_back(c);</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;    row_offset += this_num_rows;</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;  }</div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(row_offset == num_rows);</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;  <span class="keywordflow">return</span> new_whole_submatrix;</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;}</div><div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a35d3d1a70d075561aaf91b263ea28f74"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a35d3d1a70d075561aaf91b263ea28f74">kaldi::nnet3::kMatrixCopy</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00291">nnet-computation.h:291</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_ad608a50eef55fe012c53acb48f1de02b"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">kaldi::nnet3::NnetComputation::matrix_debug_info</a></div><div class="ttdeci">std::vector&lt; MatrixDebugInfo &gt; matrix_debug_info</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00394">nnet-computation.h:394</a></div></div>
<div class="ttc" id="namespacekaldi_html_a21841167f1ffde9582edc512acdbaa51a2b73d1b429e7067fc592b019190e4976"><div class="ttname"><a href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51a2b73d1b429e7067fc592b019190e4976">kaldi::kStrideEqualNumCols</a></div><div class="ttdef"><b>Definition:</b> <a href="matrix-common_8h_source.html#l00046">matrix-common.h:46</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_aff6dbc6bf1ea33e5ea29bebebae8617a"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#aff6dbc6bf1ea33e5ea29bebebae8617a">kaldi::nnet3::ModelUpdateConsolidator::extra_commands_</a></div><div class="ttdeci">std::vector&lt; std::vector&lt; NnetComputation::Command &gt; &gt; extra_commands_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01335">nnet-optimize-utils.cc:1335</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_a16ed03ea200a71de08070d77fd52ceb9"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#a16ed03ea200a71de08070d77fd52ceb9">kaldi::nnet3::NnetComputation::NewMatrix</a></div><div class="ttdeci">int32 NewMatrix(int32 num_rows, int32 num_cols, MatrixStrideType stride_type)</div><div class="ttdoc">Convenience function used when adding new matrices. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8cc_source.html#l00128">nnet-computation.cc:128</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352ae77588ab7fc4ccf842de7ec941247062"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae77588ab7fc4ccf842de7ec941247062">kaldi::nnet3::kDeallocMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00289">nnet-computation.h:289</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_a47a751a8db1c9c4856d04495f80620e9"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">kaldi::nnet3::NnetComputation::matrices</a></div><div class="ttdeci">std::vector&lt; MatrixInfo &gt; matrices</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00390">nnet-computation.h:390</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a73b5995148c3e987c4a163ad6bc9850b"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a73b5995148c3e987c4a163ad6bc9850b">kaldi::nnet3::kAllocMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00289">nnet-computation.h:289</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a55f8cb2bfd2e2c3605dfa961eff35fa2"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a55f8cb2bfd2e2c3605dfa961eff35fa2">kaldi::nnet3::kSetConst</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00289">nnet-computation.h:289</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_a61634eedcfea10a32bdb33bca3f94f2b"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#a61634eedcfea10a32bdb33bca3f94f2b">kaldi::nnet3::NnetComputation::NewSubMatrix</a></div><div class="ttdeci">int32 NewSubMatrix(int32 base_submatrix, int32 row_offset, int32 num_rows, int32 col_offset, int32 num_cols)</div><div class="ttdoc">Convenience function used when adding new sub-matrices. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8cc_source.html#l00102">nnet-computation.cc:102</a></div></div>
<div class="ttc" id="namespacekaldi_html_a21841167f1ffde9582edc512acdbaa51aae343c6085287b6272231336d4b75986"><div class="ttname"><a href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51aae343c6085287b6272231336d4b75986">kaldi::kDefaultStride</a></div><div class="ttdef"><b>Definition:</b> <a href="matrix-common_8h_source.html#l00045">matrix-common.h:45</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_acb31bf5441a137f7cbed4aeb74cb8421"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">kaldi::nnet3::NnetComputation::submatrices</a></div><div class="ttdeci">std::vector&lt; SubMatrixInfo &gt; submatrices</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00404">nnet-computation.h:404</a></div></div>
<div class="ttc" id="namespacekaldi_html_a21841167f1ffde9582edc512acdbaa51"><div class="ttname"><a href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51">kaldi::MatrixStrideType</a></div><div class="ttdeci">MatrixStrideType</div><div class="ttdef"><b>Definition:</b> <a href="matrix-common_8h_source.html#l00044">matrix-common.h:44</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_a36d13565d1302a2bf74127b141ba3537"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">kaldi::nnet3::ModelUpdateConsolidator::computation_</a></div><div class="ttdeci">NnetComputation * computation_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01329">nnet-optimize-utils.cc:1329</a></div></div>
<div class="ttc" id="namespacernnlm_html_acb559820d9ca11295b4500f179ef6392"><div class="ttname"><a href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">rnnlm::i</a></div><div class="ttdeci">int i</div><div class="ttdef"><b>Definition:</b> <a href="mikolov-rnnlm-lib_8cc_source.html#l00066">mikolov-rnnlm-lib.cc:66</a></div></div>
<div class="ttc" id="group__error__group_html_gad5710173d69cddcda4fa21ded3c77f16"><div class="ttname"><a href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a></div><div class="ttdeci">#define KALDI_ASSERT(cond)</div><div class="ttdef"><b>Definition:</b> <a href="kaldi-error_8h_source.html#l00168">kaldi-error.h:168</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_a20efdbe0990f3fa04abb85ac56089614"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a20efdbe0990f3fa04abb85ac56089614">kaldi::nnet3::ModelUpdateConsolidator::AppendDebugInfoForSubmatrix</a></div><div class="ttdeci">void AppendDebugInfoForSubmatrix(int32 submatrix_index, NnetComputation::MatrixDebugInfo *debug_info) const</div><div class="ttdoc">This function, called from ConsolidateSubmatrices, will update &amp;#39;debug_info&amp;#39; by appending the correspo...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01347">nnet-optimize-utils.cc:1347</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_a1637cd5c5a1274835dfb87d75fde2037"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1637cd5c5a1274835dfb87d75fde2037">kaldi::nnet3::ModelUpdateConsolidator::final_deallocate_commands_</a></div><div class="ttdeci">std::vector&lt; NnetComputation::Command &gt; final_deallocate_commands_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01343">nnet-optimize-utils.cc:1343</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_ab4efec36ef0d5bab190891c36bd9b2e3"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab4efec36ef0d5bab190891c36bd9b2e3">kaldi::nnet3::NnetComputation::IsWholeMatrix</a></div><div class="ttdeci">bool IsWholeMatrix(int32 submatrix_index) const</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8cc_source.html#l00975">nnet-computation.cc:975</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ad691fe3a6e61eb46c08d591d4af2ea4b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad691fe3a6e61eb46c08d591d4af2ea4b">&#9670;&nbsp;</a></span>ConsolidateUpdateForComponent()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void ConsolidateUpdateForComponent </td>
          <td>(</td>
          <td class="paramtype">int32&#160;</td>
          <td class="paramname"><em>component_index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::vector&lt; int32 &gt; &amp;&#160;</td>
          <td class="paramname"><em>backprop_commands</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This function, called from ConsolidateModelUpdate, is passed a list of commands that are all backprops for the same component, and it consolidates them into a single model-update command. </p>

<p class="definition">Definition at line <a class="el" href="nnet-optimize-utils_8cc_source.html#l01460">1460</a> of file <a class="el" href="nnet-optimize-utils_8cc_source.html">nnet-optimize-utils.cc</a>.</p>

<p class="reference">References <a class="el" href="nnet-computation_8h_source.html#l00342">NnetComputation::Command::arg2</a>, <a class="el" href="nnet-computation_8h_source.html#l00343">NnetComputation::Command::arg3</a>, <a class="el" href="nnet-computation_8h_source.html#l00344">NnetComputation::Command::arg4</a>, <a class="el" href="nnet-computation_8h_source.html#l00345">NnetComputation::Command::arg5</a>, <a class="el" href="nnet-computation_8h_source.html#l00339">NnetComputation::Command::command_type</a>, <a class="el" href="nnet-computation_8h_source.html#l00439">NnetComputation::commands</a>, <a class="el" href="nnet-optimize-utils_8cc_source.html#l01052">MatrixExtender::computation_</a>, <a class="el" href="mikolov-rnnlm-lib_8cc_source.html#l00066">rnnlm::i</a>, <a class="el" href="kaldi-error_8h_source.html#l00168">KALDI_ASSERT</a>, <a class="el" href="nnet-computation_8h_source.html#l00290">kaldi::nnet3::kBackprop</a>, <a class="el" href="nnet-component-itf_8h_source.html#l00065">kaldi::nnet3::kBackpropNeedsInput</a>, <a class="el" href="nnet-component-itf_8h_source.html#l00067">kaldi::nnet3::kBackpropNeedsOutput</a>, <a class="el" href="nnet-computation_8h_source.html#l00290">kaldi::nnet3::kBackpropNoModelUpdate</a>, and <a class="el" href="classkaldi_1_1nnet3_1_1Component.html#a3a4ff15fafe0c8c4885586fc2c36ca8a">Component::Properties()</a>.</p>

<p class="reference">Referenced by <a class="el" href="nnet-optimize-utils_8cc_source.html#l01515">ModelUpdateConsolidator::ConsolidateModelUpdate()</a>.</p>
<div class="fragment"><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;                                               {</div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;  <span class="keyword">const</span> Component *component = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#adbabf05a7702103113a02a113015205f">nnet_</a>.<a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html#aec8d6dfed3e4ab080d3ff4cf6a1126e3">GetComponent</a>(component_index);</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;  int32 num_backprop_commands = backprop_commands.size();</div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;  <span class="keywordtype">bool</span> need_input = (component-&gt;Properties() &amp; <a class="code" href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3adac6588b2ef2e8b52936718cf97263e7">kBackpropNeedsInput</a>) != 0,</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;      need_output = (component-&gt;Properties() &amp; <a class="code" href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a2a37e781d9be4e2cb09699a840dde841">kBackpropNeedsOutput</a>) != 0;</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;  std::vector&lt;int32&gt;  input_submatrices(num_backprop_commands),</div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;      output_submatrices(num_backprop_commands),</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;      output_deriv_submatrices(num_backprop_commands);</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; num_backprop_commands; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;    int32 command_index = backprop_commands[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;    NnetComputation::Command &amp;command =</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;    <span class="comment">// arg2 must be 0 because simple components don&#39;t use precomputed indexes.</span></div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(command.command_type == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83">kBackprop</a> &amp;&amp; command.arg2 == 0);</div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;    command.command_type = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352afab6637ac4a83d6775366b4e9c42e241">kBackpropNoModelUpdate</a>;</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;    int32 input_submatrix = command.arg3,</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;        output_submatrix = command.arg4,</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;        output_deriv_submatrix = command.arg5;</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>((input_submatrix != 0) == need_input &amp;&amp;</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;                 (output_submatrix != 0) == need_output);</div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;    input_submatrices[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = input_submatrix;</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;    output_submatrices[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = output_submatrix;</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;    output_deriv_submatrices[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = output_deriv_submatrix;</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;  }</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;  <span class="comment">// Get the sub-matrix indexes of whichever of the consolidated matrices we</span></div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;  <span class="comment">// need (will usually be input_submatrix and output_deriv_submatrix).</span></div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;  int32 input_submatrix = (need_input ?</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;                           <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#ad6767e6a06ceef8ceedb067c8c86d463">ConsolidateSubmatrices</a>(backprop_commands,</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;                                                  input_submatrices) : 0),</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;      output_submatrix = (need_output ?</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;                         ConsolidateSubmatrices(backprop_commands,</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;                                                output_submatrices) : 0),</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;      output_deriv_submatrix = ConsolidateSubmatrices(backprop_commands,</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;                                                      output_deriv_submatrices);</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;  int32 precomputed_indexes_index = 0,  <span class="comment">// unused since simple component</span></div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;      input_deriv_submatrix = 0,  <span class="comment">// we don&#39;t need the input-deriv.</span></div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;      memo_index = 0;  <span class="comment">// we checked that no memos were used.</span></div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;  NnetComputation::Command c(<a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83">kBackprop</a>, component_index, precomputed_indexes_index,</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;                             input_submatrix, output_submatrix,</div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;                             output_deriv_submatrix, input_deriv_submatrix,</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;                             memo_index);</div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#af13a24e7f0ed6969f7659518478ffdc2">final_commands_</a>.push_back(c);</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;}</div><div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_af13a24e7f0ed6969f7659518478ffdc2"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#af13a24e7f0ed6969f7659518478ffdc2">kaldi::nnet3::ModelUpdateConsolidator::final_commands_</a></div><div class="ttdeci">std::vector&lt; NnetComputation::Command &gt; final_commands_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01340">nnet-optimize-utils.cc:1340</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_afeb2e3e7413a0649c8a60e3bcd66981b"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">kaldi::nnet3::NnetComputation::commands</a></div><div class="ttdeci">std::vector&lt; Command &gt; commands</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00439">nnet-computation.h:439</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a36da016976f88292c0d31653a20cbfe3a2a37e781d9be4e2cb09699a840dde841"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a2a37e781d9be4e2cb09699a840dde841">kaldi::nnet3::kBackpropNeedsOutput</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-component-itf_8h_source.html#l00067">nnet-component-itf.h:67</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_ad6767e6a06ceef8ceedb067c8c86d463"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#ad6767e6a06ceef8ceedb067c8c86d463">kaldi::nnet3::ModelUpdateConsolidator::ConsolidateSubmatrices</a></div><div class="ttdeci">int32 ConsolidateSubmatrices(const std::vector&lt; int32 &gt; &amp;commands, const std::vector&lt; int32 &gt; &amp;submatrices)</div><div class="ttdoc">You call this function when you want to consolidate the values of a list of submatrices taken just pr...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01371">nnet-optimize-utils.cc:1371</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_a36d13565d1302a2bf74127b141ba3537"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">kaldi::nnet3::ModelUpdateConsolidator::computation_</a></div><div class="ttdeci">NnetComputation * computation_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01329">nnet-optimize-utils.cc:1329</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a36da016976f88292c0d31653a20cbfe3adac6588b2ef2e8b52936718cf97263e7"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3adac6588b2ef2e8b52936718cf97263e7">kaldi::nnet3::kBackpropNeedsInput</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-component-itf_8h_source.html#l00065">nnet-component-itf.h:65</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352afab6637ac4a83d6775366b4e9c42e241"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352afab6637ac4a83d6775366b4e9c42e241">kaldi::nnet3::kBackpropNoModelUpdate</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00290">nnet-computation.h:290</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1Nnet_html_aec8d6dfed3e4ab080d3ff4cf6a1126e3"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1Nnet.html#aec8d6dfed3e4ab080d3ff4cf6a1126e3">kaldi::nnet3::Nnet::GetComponent</a></div><div class="ttdeci">Component * GetComponent(int32 c)</div><div class="ttdoc">Return component indexed c. Not a copy; not owned by caller. </div><div class="ttdef"><b>Definition:</b> <a href="_2nnet-nnet_8cc_source.html#l00150">nnet-nnet.cc:150</a></div></div>
<div class="ttc" id="namespacernnlm_html_acb559820d9ca11295b4500f179ef6392"><div class="ttname"><a href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">rnnlm::i</a></div><div class="ttdeci">int i</div><div class="ttdef"><b>Definition:</b> <a href="mikolov-rnnlm-lib_8cc_source.html#l00066">mikolov-rnnlm-lib.cc:66</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83">kaldi::nnet3::kBackprop</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00290">nnet-computation.h:290</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_adbabf05a7702103113a02a113015205f"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#adbabf05a7702103113a02a113015205f">kaldi::nnet3::ModelUpdateConsolidator::nnet_</a></div><div class="ttdeci">const Nnet &amp; nnet_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01328">nnet-optimize-utils.cc:1328</a></div></div>
<div class="ttc" id="group__error__group_html_gad5710173d69cddcda4fa21ded3c77f16"><div class="ttname"><a href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a></div><div class="ttdeci">#define KALDI_ASSERT(cond)</div><div class="ttdef"><b>Definition:</b> <a href="kaldi-error_8h_source.html#l00168">kaldi-error.h:168</a></div></div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Member Data Documentation</h2>
<a id="a36d13565d1302a2bf74127b141ba3537"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a36d13565d1302a2bf74127b141ba3537">&#9670;&nbsp;</a></span>computation_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a>* computation_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="nnet-optimize-utils_8cc_source.html#l01329">1329</a> of file <a class="el" href="nnet-optimize-utils_8cc_source.html">nnet-optimize-utils.cc</a>.</p>

<p class="reference">Referenced by <a class="el" href="nnet-optimize-utils_8cc_source.html#l01515">ModelUpdateConsolidator::ConsolidateModelUpdate()</a>, <a class="el" href="nnet-optimize-utils_8cc_source.html#l01564">DerivativeTimeLimiter::GetPruneValues()</a>, <a class="el" href="nnet-optimize-utils_8cc_source.html#l01860">DerivativeTimeLimiter::MapAddRowRangesCommand()</a>, <a class="el" href="nnet-optimize-utils_8cc_source.html#l01735">DerivativeTimeLimiter::MapIndexesCommand()</a>, <a class="el" href="nnet-optimize-utils_8cc_source.html#l01798">DerivativeTimeLimiter::MapIndexesMultiCommand()</a>, <a class="el" href="nnet-optimize-utils_8cc_source.html#l01686">DerivativeTimeLimiter::MapSimpleMatrixCommand()</a>, and <a class="el" href="nnet-optimize-utils_8cc_source.html#l01580">DerivativeTimeLimiter::RowIsKept()</a>.</p>

</div>
</div>
<a id="aff6dbc6bf1ea33e5ea29bebebae8617a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aff6dbc6bf1ea33e5ea29bebebae8617a">&#9670;&nbsp;</a></span>extra_commands_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">std::vector&lt;std::vector&lt;<a class="el" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a>&gt; &gt; extra_commands_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="nnet-optimize-utils_8cc_source.html#l01335">1335</a> of file <a class="el" href="nnet-optimize-utils_8cc_source.html">nnet-optimize-utils.cc</a>.</p>

</div>
</div>
<a id="af13a24e7f0ed6969f7659518478ffdc2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af13a24e7f0ed6969f7659518478ffdc2">&#9670;&nbsp;</a></span>final_commands_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">std::vector&lt;<a class="el" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a>&gt; final_commands_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="nnet-optimize-utils_8cc_source.html#l01340">1340</a> of file <a class="el" href="nnet-optimize-utils_8cc_source.html">nnet-optimize-utils.cc</a>.</p>

</div>
</div>
<a id="a1637cd5c5a1274835dfb87d75fde2037"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1637cd5c5a1274835dfb87d75fde2037">&#9670;&nbsp;</a></span>final_deallocate_commands_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">std::vector&lt;<a class="el" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a>&gt; final_deallocate_commands_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="nnet-optimize-utils_8cc_source.html#l01343">1343</a> of file <a class="el" href="nnet-optimize-utils_8cc_source.html">nnet-optimize-utils.cc</a>.</p>

</div>
</div>
<a id="adbabf05a7702103113a02a113015205f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adbabf05a7702103113a02a113015205f">&#9670;&nbsp;</a></span>nnet_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const <a class="el" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a>&amp; nnet_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="nnet-optimize-utils_8cc_source.html#l01328">1328</a> of file <a class="el" href="nnet-optimize-utils_8cc_source.html">nnet-optimize-utils.cc</a>.</p>

<p class="reference">Referenced by <a class="el" href="nnet-optimize-utils_8cc_source.html#l01515">ModelUpdateConsolidator::ConsolidateModelUpdate()</a>, and <a class="el" href="nnet-optimize-utils_8cc_source.html#l01604">DerivativeTimeLimiter::ModifyCommand()</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>nnet3/<a class="el" href="nnet-optimize-utils_8cc_source.html">nnet-optimize-utils.cc</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacekaldi.html">kaldi</a></li><li class="navelem"><a class="el" href="namespacekaldi_1_1nnet3.html">nnet3</a></li><li class="navelem"><a class="el" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html">ModelUpdateConsolidator</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
