<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Kaldi: decoder/grammar-fst.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" /> 
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
 <td id="projectlogo"><a href="http://kaldi-asr.org/"><img alt="Logo" src="KaldiTextAndLogoSmall.png"/ style="padding: 3px 5px 1px 5px"></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname" style="display:none">Kaldi
   </div>
  </td>
    <td style="padding-left: 0.5em;">
    <div id="projectbrief" style="display:none"></div>
    </td>
   <!--END PROJECT_BRIEF-->
  <!--END !PROJECT_NAME-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('grammar-fst_8cc_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">grammar-fst.cc</div>  </div>
</div><!--header-->
<div class="contents">
<a href="grammar-fst_8cc.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">// decoder/grammar-fst.cc</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">// Copyright   2018  Johns Hopkins University (author: Daniel Povey)</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">// See ../../COPYING for clarification regarding multiple authors</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">// you may not use this file except in compliance with the License.</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// You may obtain a copy of the License at</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">//  http://www.apache.org/licenses/LICENSE-2.0</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// THIS CODE IS PROVIDED *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">// KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">// WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">// MERCHANTABLITY OR NON-INFRINGEMENT.</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">// See the Apache 2 License for the specific language governing permissions and</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">// limitations under the License.</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="grammar-fst_8h.html">decoder/grammar-fst.h</a>&quot;</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="grammar-context-fst_8h.html">fstext/grammar-context-fst.h</a>&quot;</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespacefst.html">fst</a> {</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<a class="code" href="classfst_1_1GrammarFst.html#a0d2feaf3dcb4c627e7c4c7ae0c1d2a56">GrammarFst::GrammarFst</a>(</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;    int32 nonterm_phones_offset,</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    <span class="keyword">const</span> ConstFst&lt;StdArc&gt; &amp;top_fst,</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    <span class="keyword">const</span> std::vector&lt;std::pair&lt;<a class="code" href="namespacefst.html#a006b00477e4d9250474e76e1ec61bb3f">Label</a>, <span class="keyword">const</span> ConstFst&lt;StdArc&gt; *&gt; &gt; &amp;ifsts):</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    nonterm_phones_offset_(nonterm_phones_offset),</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;    top_fst_(&amp;top_fst),</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;    ifsts_(ifsts) {</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;  Init();</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;}</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFst.html#a1e3b6d38df0786ccf7f938d60e386aae">   36</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classfst_1_1GrammarFst.html#a1e3b6d38df0786ccf7f938d60e386aae">GrammarFst::Init</a>() {</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(nonterm_phones_offset_ &gt; 1);</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  InitNonterminalMap();</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;  entry_arcs_.resize(ifsts_.size());</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  <span class="keywordflow">if</span> (!ifsts_.empty()) {</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    <span class="comment">// We call this mostly so that if something is wrong with the input FSTs, the</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    <span class="comment">// problem will be detected sooner rather than later.</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    <span class="comment">// There would be no problem if we were to call InitEntryArcs(i)</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <span class="comment">// for all 0 &lt;= i &lt; ifsts_size(), but we choose to call it</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="comment">// lazily on demand, to save startup time if the number of nonterminals</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="comment">// is large.</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    InitEntryArcs(0);</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;  }</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  InitInstances();</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;}</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFst.html#afcde49f68292e807c903f4a577a21dfc">   52</a></span>&#160;<a class="code" href="classfst_1_1GrammarFst.html#afcde49f68292e807c903f4a577a21dfc">GrammarFst::~GrammarFst</a>() {</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  Destroy();</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;}</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFst.html#ac919a991060ede6983343719401686de">   56</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classfst_1_1GrammarFst.html#ac919a991060ede6983343719401686de">GrammarFst::Destroy</a>() {</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; instances_.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html">FstInstance</a> &amp;instance = instances_[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    std::unordered_map&lt;BaseStateId, ExpandedState*&gt;::const_iterator</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        iter = instance.<a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html#a50d6dd52001b15f23c15ef0eb48f4bca">expanded_states</a>.begin(),</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        end = instance.<a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html#a50d6dd52001b15f23c15ef0eb48f4bca">expanded_states</a>.end();</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="keywordflow">for</span> (; iter != end; ++iter) {</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;      <a class="code" href="structfst_1_1GrammarFst_1_1ExpandedState.html">ExpandedState</a> *e = iter-&gt;second;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;      <span class="keyword">delete</span> e;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    }</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;  }</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;  top_fst_ = NULL;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;  ifsts_.clear();</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;  nonterminal_map_.clear();</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  entry_arcs_.clear();</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;  instances_.clear();</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  <span class="comment">// the following will only do something if we read this object from disk using</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;  <span class="comment">// its Read() function.</span></div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; fsts_to_delete_.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++)</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="keyword">delete</span> fsts_to_delete_[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  fsts_to_delete_.clear();</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;}</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00080"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFst.html#a9956a77f3a82dfddc07f7ee649d07bc4">   80</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classfst_1_1GrammarFst.html#a9956a77f3a82dfddc07f7ee649d07bc4">GrammarFst::DecodeSymbol</a>(<a class="code" href="classfst_1_1GrammarFst.html#a8b4305fe971ea965a741395013fd9c49">Label</a> label,</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;                              int32 *nonterminal_symbol,</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;                              int32 *left_context_phone) {</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  <span class="comment">// encoding_multiple will normally equal 1000 (but may be a multiple of 1000</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="comment">// if there are a lot of phones); kNontermBigNumber is 10000000.</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  int32 big_number = <span class="keyword">static_cast&lt;</span>int32<span class="keyword">&gt;</span>(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2aafc1d79474b5b834eae90c6a9c42790f">kNontermBigNumber</a>),</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;      nonterm_phones_offset = nonterm_phones_offset_,</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;      encoding_multiple = <a class="code" href="namespacefst.html#a4828391bb3d612ffffaf704c14c30d6a">GetEncodingMultiple</a>(nonterm_phones_offset);</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <span class="comment">// The following assertion should be optimized out as the condition is</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  <span class="comment">// statically known.</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(big_number % static_cast&lt;int32&gt;(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a912e4937034fa71a1d4dc31c523dc351">kNontermMediumNumber</a>) == 0);</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  *nonterminal_symbol = (label - big_number) / encoding_multiple;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  *left_context_phone = label % encoding_multiple;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  <span class="keywordflow">if</span> (*nonterminal_symbol &lt;= nonterm_phones_offset ||</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;      *left_context_phone == 0 || *left_context_phone &gt;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;      nonterm_phones_offset + static_cast&lt;int32&gt;(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a8420d849ee0c4302c3e4f963feed7a00">kNontermBos</a>))</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Decoding invalid label &quot;</span> &lt;&lt; label</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;              &lt;&lt; <span class="stringliteral">&quot;: code error or invalid --nonterm-phones-offset?&quot;</span>;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;}</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div><div class="line"><a name="l00102"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFst.html#a8ad20dddb56f73904c0d427e51f2eb4f">  102</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classfst_1_1GrammarFst.html#a8ad20dddb56f73904c0d427e51f2eb4f">GrammarFst::InitNonterminalMap</a>() {</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  nonterminal_map_.clear();</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; ifsts_.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    int32 nonterminal = ifsts_[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].first;</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <span class="keywordflow">if</span> (nonterminal_map_.count(nonterminal))</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Nonterminal symbol &quot;</span> &lt;&lt; nonterminal</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;                &lt;&lt; <span class="stringliteral">&quot; is paired with two FSTs.&quot;</span>;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    <span class="keywordflow">if</span> (nonterminal &lt; GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a9407a1ae01a2fea99f092723c3c3cbc0">kNontermUserDefined</a>))</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Nonterminal symbol &quot;</span> &lt;&lt; nonterminal</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                &lt;&lt; <span class="stringliteral">&quot; in input pairs, was expected to be &gt;= &quot;</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                &lt;&lt; GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a9407a1ae01a2fea99f092723c3c3cbc0">kNontermUserDefined</a>);</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    nonterminal_map_[nonterminal] = <span class="keyword">static_cast&lt;</span>int32<span class="keyword">&gt;</span>(<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>);</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;  }</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;}</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div><div class="line"><a name="l00118"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFst.html#a98a1bd90bcd088e6a889a7e61ce4a99b">  118</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classfst_1_1GrammarFst.html#a98a1bd90bcd088e6a889a7e61ce4a99b">GrammarFst::InitEntryArcs</a>(int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>) {</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(static_cast&lt;size_t&gt;(i) &lt; ifsts_.size());</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  <span class="keyword">const</span> ConstFst&lt;StdArc&gt; &amp;<a class="code" href="namespacefst.html">fst</a> = *(ifsts_[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].second);</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  InitEntryOrReentryArcs(fst, fst.Start(),</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                         GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a853f28d67c5daf316eecc91390831332">kNontermBegin</a>),</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                         &amp;(entry_arcs_[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>]));</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;}</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div><div class="line"><a name="l00126"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFst.html#af2aa0f8fd6325fdede2bca6d013a2f29">  126</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classfst_1_1GrammarFst.html#af2aa0f8fd6325fdede2bca6d013a2f29">GrammarFst::InitInstances</a>() {</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(instances_.empty());</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  instances_.resize(1);</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  instances_[0].ifst_index = -1;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  instances_[0].fst = top_fst_;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;  instances_[0].parent_instance = -1;</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  instances_[0].parent_state = -1;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;}</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div><div class="line"><a name="l00135"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFst.html#a9a0814345f5aa1ad5ada7b9a4439124b">  135</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classfst_1_1GrammarFst.html#a9a0814345f5aa1ad5ada7b9a4439124b">GrammarFst::InitEntryOrReentryArcs</a>(</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    <span class="keyword">const</span> ConstFst&lt;StdArc&gt; &amp;<a class="code" href="namespacefst.html">fst</a>,</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    int32 entry_state,</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    int32 expected_nonterminal_symbol,</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    std::unordered_map&lt;int32, int32&gt; *phone_to_arc) {</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;  phone_to_arc-&gt;clear();</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  ArcIterator&lt;ConstFst&lt;StdArc&gt; &gt; aiter(fst, entry_state);</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  int32 arc_index = 0;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;  <span class="keywordflow">for</span> (; !aiter.Done(); aiter.Next(), ++arc_index) {</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="keyword">const</span> <a class="code" href="namespacefst.html#a70478eb2428a9406e4692d19a7a3a97f">StdArc</a> &amp;arc = aiter.Value();</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    int32 nonterminal, left_context_phone;</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="keywordflow">if</span> (arc.ilabel &lt;= (int32)<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2aafc1d79474b5b834eae90c6a9c42790f">kNontermBigNumber</a>) {</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;      <span class="keywordflow">if</span> (entry_state == fst.Start()) {</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;There is something wrong with the graph; did you forget to &quot;</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;            <span class="stringliteral">&quot;add #nonterm_begin and #nonterm_end to the non-top-level FSTs &quot;</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;            <span class="stringliteral">&quot;before compiling?&quot;</span>;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;There is something wrong with the graph; re-entry state is &quot;</span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;            <span class="stringliteral">&quot;not as anticipated.&quot;</span>;</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;      }</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    }</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    DecodeSymbol(arc.ilabel, &amp;nonterminal, &amp;left_context_phone);</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <span class="keywordflow">if</span> (nonterminal != expected_nonterminal_symbol) {</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Expected arcs from this state to have nonterminal-symbol &quot;</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;                &lt;&lt; expected_nonterminal_symbol &lt;&lt; <span class="stringliteral">&quot;, but got &quot;</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                &lt;&lt; nonterminal;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    }</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    std::pair&lt;int32, int32&gt; p(left_context_phone, arc_index);</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    <span class="keywordflow">if</span> (!phone_to_arc-&gt;insert(p).second) {</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;      <span class="comment">// If it was not successfully inserted in the phone_to_arc map, it means</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;      <span class="comment">// there were two arcs with the same left-context phone, which does not</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;      <span class="comment">// make sense; that&#39;s an error, likely a code error (or an error when the</span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;      <span class="comment">// input FSTs were generated).</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Two arcs had the same left-context phone.&quot;</span>;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    }</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;  }</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;}</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div><div class="line"><a name="l00173"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFst.html#a2a8a892a0794d0cefabeec2a8860d4dc">  173</a></span>&#160;<a class="code" href="structfst_1_1GrammarFst_1_1ExpandedState.html">GrammarFst::ExpandedState</a> *<a class="code" href="classfst_1_1GrammarFst.html#a2a8a892a0794d0cefabeec2a8860d4dc">GrammarFst::ExpandState</a>(</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    int32 instance_id, <a class="code" href="classfst_1_1GrammarFst.html#a8086078c61f5b3c4959476d0a59c2836">BaseStateId</a> state_id) {</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;  int32 big_number = <a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2aafc1d79474b5b834eae90c6a9c42790f">kNontermBigNumber</a>;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;  <span class="keyword">const</span> ConstFst&lt;StdArc&gt; &amp;<a class="code" href="namespacefst.html">fst</a> = *(instances_[instance_id].fst);</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  ArcIterator&lt;ConstFst&lt;StdArc&gt; &gt; aiter(fst, state_id);</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!aiter.Done() &amp;&amp; aiter.Value().ilabel &gt; big_number &amp;&amp;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;               <span class="stringliteral">&quot;Something is not right; did you call PrepareForGrammarFst()?&quot;</span>);</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;  <span class="keyword">const</span> <a class="code" href="namespacefst.html#a70478eb2428a9406e4692d19a7a3a97f">StdArc</a> &amp;arc = aiter.Value();</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;  int32 encoding_multiple = <a class="code" href="namespacefst.html#a4828391bb3d612ffffaf704c14c30d6a">GetEncodingMultiple</a>(nonterm_phones_offset_),</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;      nonterminal = (arc.ilabel - big_number) / encoding_multiple;</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  <span class="keywordflow">if</span> (nonterminal == GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a853f28d67c5daf316eecc91390831332">kNontermBegin</a>) ||</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;      nonterminal == GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2af2f1f7ed744565c5728529dcce2e2ef5">kNontermReenter</a>)) {</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Encountered unexpected type of nonterminal while &quot;</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        <span class="stringliteral">&quot;expanding state.&quot;</span>;</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nonterminal == GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a534b236508a8d909dd97b3d7475b75db">kNontermEnd</a>)) {</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <span class="keywordflow">return</span> ExpandStateEnd(instance_id, state_id);</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nonterminal &gt;= GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a9407a1ae01a2fea99f092723c3c3cbc0">kNontermUserDefined</a>)) {</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    <span class="keywordflow">return</span> ExpandStateUserDefined(instance_id, state_id);</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Encountered unexpected type of nonterminal &quot;</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;              &lt;&lt; nonterminal &lt;&lt; <span class="stringliteral">&quot; while expanding state.&quot;</span>;</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  }</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  <span class="keywordflow">return</span> NULL;  <span class="comment">// Suppress compiler warning</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;}</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="comment">// static inline</span></div><div class="line"><a name="l00201"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFst.html#a799fac4aecf6dc610b3ca2dae19473df">  201</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classfst_1_1GrammarFst.html#a799fac4aecf6dc610b3ca2dae19473df">GrammarFst::CombineArcs</a>(<span class="keyword">const</span> <a class="code" href="namespacefst.html#a70478eb2428a9406e4692d19a7a3a97f">StdArc</a> &amp;leaving_arc,</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                             <span class="keyword">const</span> <a class="code" href="namespacefst.html#a70478eb2428a9406e4692d19a7a3a97f">StdArc</a> &amp;arriving_arc,</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                             <span class="keywordtype">float</span> cost_correction,</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                             <a class="code" href="namespacefst.html#a70478eb2428a9406e4692d19a7a3a97f">StdArc</a> *arc) {</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;  <span class="comment">// The following assertion shouldn&#39;t fail; we ensured this in</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;  <span class="comment">// PrepareForGrammarFst(), search for &#39;olabel_problem&#39;.</span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(leaving_arc.olabel == 0);</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;  <span class="comment">// &#39;leaving_arc&#39; leaves one fst, and &#39;arriving_arcs&#39;, conceptually arrives in</span></div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  <span class="comment">// another.  This code merges the information of the two arcs to make a</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;  <span class="comment">// cross-FST arc.  The ilabel information is discarded as it was only intended</span></div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;  <span class="comment">// for the consumption of the GrammarFST code.</span></div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;  arc-&gt;ilabel = 0;</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;  arc-&gt;olabel = arriving_arc.olabel;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;  <span class="comment">// conceptually, arc-&gt;weight =</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;  <span class="comment">//  Times(Times(leaving_arc.weight, arriving_arc.weight), Weight(cost_correction)).</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;  <span class="comment">// The below might be a bit faster, I hope-- avoiding checking.</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;  arc-&gt;weight = <a class="code" href="classkaldi_1_1FasterDecoder.html#a20d097b045b23dd618a3067dd4e3f915">Weight</a>(cost_correction + leaving_arc.weight.Value() +</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;                       arriving_arc.weight.Value());</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  arc-&gt;nextstate = arriving_arc.nextstate;</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;}</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;</div><div class="line"><a name="l00222"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFst.html#a1d2cede02beae2c01ae4ca6cbb6c6086">  222</a></span>&#160;<a class="code" href="structfst_1_1GrammarFst_1_1ExpandedState.html">GrammarFst::ExpandedState</a> *<a class="code" href="classfst_1_1GrammarFst.html#a1d2cede02beae2c01ae4ca6cbb6c6086">GrammarFst::ExpandStateEnd</a>(</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    int32 instance_id, <a class="code" href="classfst_1_1GrammarFst.html#a8086078c61f5b3c4959476d0a59c2836">BaseStateId</a> state_id) {</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;  <span class="keywordflow">if</span> (instance_id == 0)</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Did not expect #nonterm_end symbol in FST-instance 0.&quot;</span>;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;  <span class="keyword">const</span> <a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html">FstInstance</a> &amp;instance = instances_[instance_id];</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;  int32 parent_instance_id = instance.<a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html#a79af827320a39e183d23b70ab15e8762">parent_instance</a>;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;  <span class="keyword">const</span> ConstFst&lt;StdArc&gt; &amp;<a class="code" href="namespacefst.html">fst</a> = *(instance.<a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html#ada83bf34b10bb90e0ebdf2bd985f3761">fst</a>);</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;  <span class="keyword">const</span> <a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html">FstInstance</a> &amp;parent_instance = instances_[parent_instance_id];</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;  <span class="keyword">const</span> ConstFst&lt;StdArc&gt; &amp;parent_fst = *(parent_instance.<a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html#ada83bf34b10bb90e0ebdf2bd985f3761">fst</a>);</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  <a class="code" href="structfst_1_1GrammarFst_1_1ExpandedState.html">ExpandedState</a> *ans = <span class="keyword">new</span> <a class="code" href="structfst_1_1GrammarFst_1_1ExpandedState.html">ExpandedState</a>;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;  ans-&gt;<a class="code" href="structfst_1_1GrammarFst_1_1ExpandedState.html#aa0b8f93e973467d2be4be17aa0eabebd">dest_fst_instance</a> = parent_instance_id;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;  <span class="comment">// parent_aiter is the arc-iterator in the state we return to.  We&#39;ll Seek()</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;  <span class="comment">// to a different position &#39;parent_aiter&#39; for each arc leaving this state.</span></div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;  <span class="comment">// (actually we expect just one arc to leave this state).</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  ArcIterator&lt;ConstFst&lt;StdArc&gt; &gt; parent_aiter(parent_fst,</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                                              instance.<a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html#a2e2b185fc9c2826b33756ea9fe322086">parent_state</a>);</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  <span class="comment">// for explanation of cost_correction, see documentation for CombineArcs().</span></div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;  <span class="keywordtype">float</span> num_reentry_arcs = instances_[instance_id].parent_reentry_arcs.size(),</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;      cost_correction = -log(num_reentry_arcs);</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;  ArcIterator&lt;ConstFst&lt;StdArc&gt; &gt; aiter(fst, state_id);</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  <span class="keywordflow">for</span> (; !aiter.Done(); aiter.Next()) {</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <span class="keyword">const</span> <a class="code" href="namespacefst.html#a70478eb2428a9406e4692d19a7a3a97f">StdArc</a> &amp;leaving_arc = aiter.Value();</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    int32 this_nonterminal, left_context_phone;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    DecodeSymbol(leaving_arc.ilabel, &amp;this_nonterminal,</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                 &amp;left_context_phone);</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(this_nonterminal == GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a534b236508a8d909dd97b3d7475b75db">kNontermEnd</a>) &amp;&amp;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                 <span class="stringliteral">&quot;&gt;1 nonterminals from a state; did you use &quot;</span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                 <span class="stringliteral">&quot;PrepareForGrammarFst()?&quot;</span>);</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    std::unordered_map&lt;int32, int32&gt;::const_iterator reentry_iter =</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        instances_[instance_id].parent_reentry_arcs.find(left_context_phone),</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        reentry_end = instances_[instance_id].parent_reentry_arcs.end();</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <span class="keywordflow">if</span> (reentry_iter == reentry_end) {</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;FST with index &quot;</span> &lt;&lt; instance.<a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html#a62e5dfb19f79edb7d7692c37a2d370b2">ifst_index</a></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                &lt;&lt; <span class="stringliteral">&quot; ends with left-context-phone &quot;</span> &lt;&lt; left_context_phone</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                &lt;&lt; <span class="stringliteral">&quot; but parent FST does not support that left-context &quot;</span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;          <span class="stringliteral">&quot;at the return point.&quot;</span>;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    }</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordtype">size_t</span> parent_arc_index = <span class="keyword">static_cast&lt;</span><span class="keywordtype">size_t</span><span class="keyword">&gt;</span>(reentry_iter-&gt;second);</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    parent_aiter.Seek(parent_arc_index);</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <span class="keyword">const</span> <a class="code" href="namespacefst.html#a70478eb2428a9406e4692d19a7a3a97f">StdArc</a> &amp;arriving_arc = parent_aiter.Value();</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <span class="comment">// &#39;arc&#39; will combine the information on &#39;leaving_arc&#39; and &#39;arriving_arc&#39;,</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <span class="comment">// except that the ilabel will be set to zero.</span></div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    <span class="keywordflow">if</span> (leaving_arc.olabel != 0) {</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;      <span class="comment">// If the following fails it would maybe indicate you hadn&#39;t called</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;      <span class="comment">// PrepareForGrammarFst(), or there was an error in that, because</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;      <span class="comment">// we made sure the leaving arc does not have an olabel.  Search</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;      <span class="comment">// in that code for &#39;olabel_problem&#39; for more details.</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Leaving arc has zero olabel.&quot;</span>;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    }</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    <a class="code" href="namespacefst.html#a70478eb2428a9406e4692d19a7a3a97f">StdArc</a> arc;</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    CombineArcs(leaving_arc, arriving_arc, cost_correction, &amp;arc);</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    ans-&gt;<a class="code" href="structfst_1_1GrammarFst_1_1ExpandedState.html#a06c56935c45a75821adc0cdfa6183c2a">arcs</a>.push_back(arc);</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;  }</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;  <span class="keywordflow">return</span> ans;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;}</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div><div class="line"><a name="l00283"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFst.html#a02544b1df2ed0618053ca21f2188b43f">  283</a></span>&#160;int32 <a class="code" href="classfst_1_1GrammarFst.html#a02544b1df2ed0618053ca21f2188b43f">GrammarFst::GetChildInstanceId</a>(int32 instance_id, int32 nonterminal,</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                                     int32 state) {</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;  int64 encoded_pair = (<span class="keyword">static_cast&lt;</span>int64<span class="keyword">&gt;</span>(nonterminal) &lt;&lt; 32) + state;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;  <span class="comment">// &#39;new_instance_id&#39; is the instance-id we&#39;d assign if we had to create a new one.</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;  <span class="comment">// We try to add it at once, to avoid having to do an extra map lookup in case</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;  <span class="comment">// it wasn&#39;t there and we did need to add it.</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;  int32 child_instance_id = instances_.size();</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;  {</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    std::pair&lt;int64, int32&gt; p(encoded_pair, child_instance_id);</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    std::pair&lt;std::unordered_map&lt;int64, int32&gt;::const_iterator, <span class="keywordtype">bool</span>&gt; ans =</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        instances_[instance_id].child_instances.insert(p);</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    <span class="keywordflow">if</span> (!ans.second) {</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;      <span class="comment">// The pair was not inserted, which means the key &#39;encoded_pair&#39; did exist in the</span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;      <span class="comment">// map.  Return the value in the map.</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;      child_instance_id = ans.first-&gt;second;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;      <span class="keywordflow">return</span> child_instance_id;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    }</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;  }</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;  <span class="comment">// If we reached this point, we did successfully insert &#39;child_instance_id&#39; into</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;  <span class="comment">// the map, because the key didn&#39;t exist.  That means we have to actually create</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;  <span class="comment">// the instance.</span></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;  instances_.resize(child_instance_id + 1);</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;  <span class="keyword">const</span> <a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html">FstInstance</a> &amp;parent_instance = instances_[instance_id];</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  <a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html">FstInstance</a> &amp;child_instance = instances_[child_instance_id];</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;  <span class="comment">// Work out the ifst_index for this nonterminal.</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;  std::unordered_map&lt;int32, int32&gt;::const_iterator iter =</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;      nonterminal_map_.find(nonterminal);</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;  <span class="keywordflow">if</span> (iter == nonterminal_map_.end()) {</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Nonterminal &quot;</span> &lt;&lt; nonterminal &lt;&lt; <span class="stringliteral">&quot; was requested, but &quot;</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        <span class="stringliteral">&quot;there is no FST for it.&quot;</span>;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;  }</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;  int32 ifst_index = iter-&gt;second;</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;  child_instance.<a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html#a62e5dfb19f79edb7d7692c37a2d370b2">ifst_index</a> = ifst_index;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;  child_instance.<a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html#ada83bf34b10bb90e0ebdf2bd985f3761">fst</a> = ifsts_[ifst_index].second;</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;  child_instance.<a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html#a79af827320a39e183d23b70ab15e8762">parent_instance</a> = instance_id;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;  child_instance.<a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html#a2e2b185fc9c2826b33756ea9fe322086">parent_state</a> = state;</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;  InitEntryOrReentryArcs(*(parent_instance.<a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html#ada83bf34b10bb90e0ebdf2bd985f3761">fst</a>), state,</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                         GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2af2f1f7ed744565c5728529dcce2e2ef5">kNontermReenter</a>),</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                         &amp;(child_instance.<a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html#aa417518f4b98c5af7dec3d62faf77ec2">parent_reentry_arcs</a>));</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;  <span class="keywordflow">return</span> child_instance_id;</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;}</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div><div class="line"><a name="l00326"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFst.html#a35bb38a463a02d47426a68faa1584092">  326</a></span>&#160;<a class="code" href="structfst_1_1GrammarFst_1_1ExpandedState.html">GrammarFst::ExpandedState</a> *<a class="code" href="classfst_1_1GrammarFst.html#a35bb38a463a02d47426a68faa1584092">GrammarFst::ExpandStateUserDefined</a>(</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    int32 instance_id, <a class="code" href="classfst_1_1GrammarFst.html#a8086078c61f5b3c4959476d0a59c2836">BaseStateId</a> state_id) {</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;  <span class="keyword">const</span> ConstFst&lt;StdArc&gt; &amp;<a class="code" href="namespacefst.html">fst</a> = *(instances_[instance_id].fst);</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;  ArcIterator&lt;ConstFst&lt;StdArc&gt; &gt; aiter(fst, state_id);</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;  <a class="code" href="structfst_1_1GrammarFst_1_1ExpandedState.html">ExpandedState</a> *ans = <span class="keyword">new</span> <a class="code" href="structfst_1_1GrammarFst_1_1ExpandedState.html">ExpandedState</a>;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;  int32 dest_fst_instance = -1;  <span class="comment">// We&#39;ll set it in the loop.</span></div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                                 <span class="comment">// and-&gt;dest_fst_instance will be set to this.</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;  <span class="keywordflow">for</span> (; !aiter.Done(); aiter.Next()) {</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="keyword">const</span> <a class="code" href="namespacefst.html#a70478eb2428a9406e4692d19a7a3a97f">StdArc</a> &amp;leaving_arc = aiter.Value();</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    int32 nonterminal, left_context_phone;</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    DecodeSymbol(leaving_arc.ilabel, &amp;nonterminal,</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                 &amp;left_context_phone);</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    int32 child_instance_id = GetChildInstanceId(instance_id,</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                                                 nonterminal,</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                                                 leaving_arc.nextstate);</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="keywordflow">if</span> (dest_fst_instance &lt; 0) {</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;      dest_fst_instance = child_instance_id;</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dest_fst_instance != child_instance_id) {</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Same state leaves to different FST instances &quot;</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;          <span class="stringliteral">&quot;(Did you use PrepareForGrammarFst()?)&quot;</span>;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    }</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="keyword">const</span> <a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html">FstInstance</a> &amp;child_instance = instances_[child_instance_id];</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    <span class="keyword">const</span> ConstFst&lt;StdArc&gt; &amp;child_fst = *(child_instance.<a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html#ada83bf34b10bb90e0ebdf2bd985f3761">fst</a>);</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    int32 child_ifst_index = child_instance.<a class="code" href="structfst_1_1GrammarFst_1_1FstInstance.html#a62e5dfb19f79edb7d7692c37a2d370b2">ifst_index</a>;</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    std::unordered_map&lt;int32, int32&gt; &amp;entry_arcs = entry_arcs_[child_ifst_index];</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="keywordflow">if</span> (entry_arcs.empty())</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;      InitEntryArcs(child_ifst_index);</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="comment">// for explanation of cost_correction, see documentation for CombineArcs().</span></div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <span class="keywordtype">float</span> num_entry_arcs = entry_arcs.size(),</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        cost_correction = -log(num_entry_arcs);</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    <span class="comment">// Get the arc-index for the arc leaving the start-state of child FST that</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    <span class="comment">// corresponds to this phonetic context.</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    std::unordered_map&lt;int32, int32&gt;::const_iterator entry_iter =</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        entry_arcs.find(left_context_phone);</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <span class="keywordflow">if</span> (entry_iter == entry_arcs.end()) {</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;FST for nonterminal &quot;</span> &lt;&lt; nonterminal</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                &lt;&lt; <span class="stringliteral">&quot; does not have an entry point for left-context-phone &quot;</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                &lt;&lt; left_context_phone;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    }</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    int32 arc_index = entry_iter-&gt;second;</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    ArcIterator&lt;ConstFst&lt;StdArc&gt; &gt; child_aiter(child_fst, child_fst.Start());</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    child_aiter.Seek(arc_index);</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="keyword">const</span> <a class="code" href="namespacefst.html#a70478eb2428a9406e4692d19a7a3a97f">StdArc</a> &amp;arriving_arc = child_aiter.Value();</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    <a class="code" href="namespacefst.html#a70478eb2428a9406e4692d19a7a3a97f">StdArc</a> arc;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    CombineArcs(leaving_arc, arriving_arc, cost_correction, &amp;arc);</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    ans-&gt;<a class="code" href="structfst_1_1GrammarFst_1_1ExpandedState.html#a06c56935c45a75821adc0cdfa6183c2a">arcs</a>.push_back(arc);</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;  }</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  ans-&gt;<a class="code" href="structfst_1_1GrammarFst_1_1ExpandedState.html#aa0b8f93e973467d2be4be17aa0eabebd">dest_fst_instance</a> = dest_fst_instance;</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;  <span class="keywordflow">return</span> ans;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;}</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;</div><div class="line"><a name="l00381"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFst.html#a68f354fd5f096134162f01719096e6fc">  381</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classfst_1_1GrammarFst.html#a68f354fd5f096134162f01719096e6fc">GrammarFst::Write</a>(std::ostream &amp;os, <span class="keywordtype">bool</span> binary)<span class="keyword"> const </span>{</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;  <span class="keyword">using namespace </span><a class="code" href="namespacekaldi.html">kaldi</a>;</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;  <span class="keywordflow">if</span> (!binary)</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;GrammarFst::Write only supports binary mode.&quot;</span>;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  int32 format = 1,</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;      num_ifsts = ifsts_.size();</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;  <a class="code" href="group__io__funcs__basic.html#ga87f1638ef3c0a3ee117178b202c2d02a">WriteToken</a>(os, binary, <span class="stringliteral">&quot;&lt;GrammarFst&gt;&quot;</span>);</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;  <a class="code" href="group__io__funcs__basic.html#ga108506a9aabafd9006926aa1b47617da">WriteBasicType</a>(os, binary, format);</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;  <a class="code" href="group__io__funcs__basic.html#ga108506a9aabafd9006926aa1b47617da">WriteBasicType</a>(os, binary, num_ifsts);</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;  <a class="code" href="group__io__funcs__basic.html#ga108506a9aabafd9006926aa1b47617da">WriteBasicType</a>(os, binary, nonterm_phones_offset_);</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;  std::string stream_name(<span class="stringliteral">&quot;unknown&quot;</span>);</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;  FstWriteOptions wopts(stream_name);</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;  top_fst_-&gt;Write(os, wopts);</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; num_ifsts; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    int32 nonterminal = ifsts_[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].first;</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    <a class="code" href="group__io__funcs__basic.html#ga108506a9aabafd9006926aa1b47617da">WriteBasicType</a>(os, binary, nonterminal);</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    ifsts_[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].second-&gt;Write(os, wopts);</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;  }</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  <a class="code" href="group__io__funcs__basic.html#ga87f1638ef3c0a3ee117178b202c2d02a">WriteToken</a>(os, binary, <span class="stringliteral">&quot;&lt;/GrammarFst&gt;&quot;</span>);</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;}</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div><div class="line"><a name="l00404"></a><span class="lineno"><a class="line" href="namespacefst.html#a279c469277315d755bd9ed37d718c377">  404</a></span>&#160;<span class="keyword">static</span> ConstFst&lt;StdArc&gt; *<a class="code" href="namespacefst.html#a279c469277315d755bd9ed37d718c377">ReadConstFstFromStream</a>(std::istream &amp;is) {</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;  fst::FstHeader hdr;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;  std::string stream_name(<span class="stringliteral">&quot;unknown&quot;</span>);</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;  <span class="keywordflow">if</span> (!hdr.Read(is, stream_name))</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Reading FST: error reading FST header&quot;</span>;</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;  FstReadOptions ropts(<span class="stringliteral">&quot;&lt;unspecified&gt;&quot;</span>, &amp;hdr);</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;  ConstFst&lt;StdArc&gt; *ans = ConstFst&lt;StdArc&gt;::Read(is, ropts);</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;  <span class="keywordflow">if</span> (!ans)</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Could not read ConstFst from stream.&quot;</span>;</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;  <span class="keywordflow">return</span> ans;</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;}</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div><div class="line"><a name="l00418"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFst.html#ae2892c501e401b523a3eb774e735d64d">  418</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classfst_1_1GrammarFst.html#ae2892c501e401b523a3eb774e735d64d">GrammarFst::Read</a>(std::istream &amp;is, <span class="keywordtype">bool</span> binary) {</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;  <span class="keyword">using namespace </span><a class="code" href="namespacekaldi.html">kaldi</a>;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;  <span class="keywordflow">if</span> (!binary)</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;GrammarFst::Read only supports binary mode.&quot;</span>;</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;  <span class="keywordflow">if</span> (top_fst_ != NULL)</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    Destroy();</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;  int32 format = 1, num_ifsts;</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;  <a class="code" href="group__io__funcs__basic.html#ga4c7a80f758e878578e78b667f62463a5">ExpectToken</a>(is, binary, <span class="stringliteral">&quot;&lt;GrammarFst&gt;&quot;</span>);</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;  <a class="code" href="group__io__funcs__basic.html#ga1bd1af0ef712b76f2332febcec8d095a">ReadBasicType</a>(is, binary, &amp;format);</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;  <span class="keywordflow">if</span> (format != 1)</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;This version of the code cannot read this GrammarFst, &quot;</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        <span class="stringliteral">&quot;update your code.&quot;</span>;</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;  <a class="code" href="group__io__funcs__basic.html#ga1bd1af0ef712b76f2332febcec8d095a">ReadBasicType</a>(is, binary, &amp;num_ifsts);</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;  <a class="code" href="group__io__funcs__basic.html#ga1bd1af0ef712b76f2332febcec8d095a">ReadBasicType</a>(is, binary, &amp;nonterm_phones_offset_);</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;  top_fst_ = <a class="code" href="namespacefst.html#a279c469277315d755bd9ed37d718c377">ReadConstFstFromStream</a>(is);</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;  fsts_to_delete_.push_back(top_fst_);</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; num_ifsts; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    int32 nonterminal;</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    <a class="code" href="group__io__funcs__basic.html#ga1bd1af0ef712b76f2332febcec8d095a">ReadBasicType</a>(is, binary, &amp;nonterminal);</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    ConstFst&lt;StdArc&gt; *this_fst =  <a class="code" href="namespacefst.html#a279c469277315d755bd9ed37d718c377">ReadConstFstFromStream</a>(is);</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    fsts_to_delete_.push_back(this_fst);</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    ifsts_.push_back(std::pair&lt;int32, <span class="keyword">const</span> ConstFst&lt;StdArc&gt;* &gt;(nonterminal,</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;                                                                this_fst));</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;  }</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;  Init();</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;}</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;<span class="comment">// This class contains the implementation of the function</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;<span class="comment">// PrepareForGrammarFst(), which is declared in grammar-fst.h.</span></div><div class="line"><a name="l00448"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html">  448</a></span>&#160;<span class="keyword">class </span><a class="code" href="classfst_1_1GrammarFstPreparer.html">GrammarFstPreparer</a> {</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160; <span class="keyword">public</span>:</div><div class="line"><a name="l00450"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#a08fde93370b81531183d644bca127d3f">  450</a></span>&#160;  <span class="keyword">using</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#a08fde93370b81531183d644bca127d3f">FST</a> = VectorFst&lt;StdArc&gt;;</div><div class="line"><a name="l00451"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#aea7adf59f410ad3bfd9c9147b5966f26">  451</a></span>&#160;  <span class="keyword">using</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#aea7adf59f410ad3bfd9c9147b5966f26">Arc</a> = <a class="code" href="namespacefst.html#a70478eb2428a9406e4692d19a7a3a97f">StdArc</a>;</div><div class="line"><a name="l00452"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">  452</a></span>&#160;  <span class="keyword">using</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> = <a class="code" href="namespacefst.html#ae38f9e2cc96a39ff2953a2846c2538db">Arc::StateId</a>;</div><div class="line"><a name="l00453"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#a377361b58f9b7d7fb6f3b739133bda9b">  453</a></span>&#160;  <span class="keyword">using</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#a377361b58f9b7d7fb6f3b739133bda9b">Label</a> = <a class="code" href="namespacefst.html#a006b00477e4d9250474e76e1ec61bb3f">Arc::Label</a>;</div><div class="line"><a name="l00454"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#a6b012f4ca0376685a4e946793da1e5bc">  454</a></span>&#160;  <span class="keyword">using</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#a6b012f4ca0376685a4e946793da1e5bc">Weight</a> = <a class="code" href="namespacefst.html#a2fdd196e46607f0d35b13369d9f9970d">Arc::Weight</a>;</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div><div class="line"><a name="l00456"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#adce5e15f952be777b8cf5eb47e60acb6">  456</a></span>&#160;  <a class="code" href="classfst_1_1GrammarFstPreparer.html#adce5e15f952be777b8cf5eb47e60acb6">GrammarFstPreparer</a>(int32 nonterm_phones_offset,</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                     VectorFst&lt;StdArc&gt; *<a class="code" href="namespacefst.html">fst</a>):</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;      nonterm_phones_offset_(nonterm_phones_offset),</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;      <a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>(fst), orig_num_states_(fst-&gt;NumStates()),</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;      simple_final_state_(kNoStateId) { }</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div><div class="line"><a name="l00462"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#a6a3db0bfa3259f043005fbf4861ba357">  462</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#a6a3db0bfa3259f043005fbf4861ba357">Prepare</a>() {</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;Start() == kNoStateId) {</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;FST has no states.&quot;</span>;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    }</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    <span class="keywordflow">for</span> (<a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> s = 0; s &lt; <a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;NumStates(); s++) {</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;      <span class="keywordflow">if</span> (IsSpecialState(s)) {</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        <span class="keywordflow">if</span> (NeedEpsilons(s)) {</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;          InsertEpsilonsForState(s);</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;          <span class="comment">// This state won&#39;t be treated as a &#39;special&#39; state any more;</span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;          <span class="comment">// all &#39;special&#39; arcs (arcs with ilabels &gt;= kNontermBigNumber)</span></div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;          <span class="comment">// have been moved and now leave from newly created states that</span></div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;          <span class="comment">// this state transitions to via epsilons arcs.</span></div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;          <span class="comment">// OK, state s is a special state.</span></div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;          FixArcsToFinalStates(s);</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;          MaybeAddFinalProbToState(s);</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        }</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;      }</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    }</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> num_new_states = <a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;NumStates() - orig_num_states_;</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    <a class="code" href="group__error__group.html#gaf8fb55454306b60c9c1e07a6ef9d341a">KALDI_LOG</a> &lt;&lt; <span class="stringliteral">&quot;Added &quot;</span> &lt;&lt; num_new_states &lt;&lt; <span class="stringliteral">&quot; new states while &quot;</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;        <span class="stringliteral">&quot;preparing for grammar FST.&quot;</span>;</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;  }</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160; <span class="keyword">private</span>:</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;  <span class="comment">// Returns true if state &#39;s&#39; has at least one arc coming out of it with a</span></div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;  <span class="comment">// special nonterminal-related ilabel on it (i.e. an ilabel &gt;=</span></div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;  <span class="comment">// kNontermBigNumber)</span></div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;  <span class="keywordtype">bool</span> IsSpecialState(<a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> s) <span class="keyword">const</span>;</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;  <span class="comment">// This function verifies that state s does not currently have any</span></div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;  <span class="comment">// final-prob (crashes if that fails); then, if the arcs leaving s have</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;  <span class="comment">// nonterminal symbols kNontermEnd or user-defined nonterminals (&gt;=</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;  <span class="comment">// kNontermUserDefined), it adds a final-prob with cost given by</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;  <span class="comment">// KALDI_GRAMMAR_FST_SPECIAL_WEIGHT to the state.</span></div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;  <span class="comment">//</span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;  <span class="comment">// State s is required to be a &#39;special state&#39;, i.e. have special symbols on</span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;  <span class="comment">// arcs leaving it, and the function assumes (since it will already</span></div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;  <span class="comment">// have been checked) that the arcs leaving s, if there are more than</span></div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;  <span class="comment">// one, all correspond to the same nonterminal symbol.</span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;  <span class="keywordtype">void</span> MaybeAddFinalProbToState(<a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> s);</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;  <span class="comment">// This function does some checking for &#39;special states&#39;, that they have</span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;  <span class="comment">// certain expected properties, and also detects certain problematic</span></div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;  <span class="comment">// conditions that we need to fix.  It returns true if we need to</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;  <span class="comment">// modify this state (by adding input-epsilon arcs), and false otherwise.</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;  <span class="keywordtype">bool</span> NeedEpsilons(<a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> s) <span class="keyword">const</span>;</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;  <span class="comment">// Fixes any final-prob-related problems with this state.  The problem we aim</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;  <span class="comment">// to fix is that there may be arcs with nonterminal symbol #nonterm_end which</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;  <span class="comment">// transition from this state to a state with non-unit final prob.  This</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;  <span class="comment">// function assimilates that final-prob into the arc leaving from this state,</span></div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;  <span class="comment">// by making the arc transition to a new state with unit final-prob, and</span></div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;  <span class="comment">// incorporating the original final-prob into the arc&#39;s weight.</span></div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;  <span class="comment">//</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;  <span class="comment">// The purpose of this is to keep the GrammarFst code simple.</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;  <span class="comment">//</span></div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;  <span class="comment">// It would have been more efficient to do this in CheckProperties(), but</span></div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;  <span class="comment">// doing it this way is clearer; and the extra time taken here will be tiny.</span></div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;  <span class="keywordtype">void</span> FixArcsToFinalStates(<a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> s);</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;  <span class="comment">// This struct represents a category of arcs that are allowed to leave from</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;  <span class="comment">// the same &#39;special state&#39;.  If a special state has arcs leaving it that</span></div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;  <span class="comment">// are in more than one category, it will need to be split up into</span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;  <span class="comment">// multiple states connected by epsilons.</span></div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;  <span class="comment">//</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;  <span class="comment">// The &#39;nonterminal&#39; and &#39;nextstate&#39; have to do with ensuring that all</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;  <span class="comment">// arcs leaving a particular FST state transition to the same FST instance</span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;  <span class="comment">// (which, in turn, helps to keep the ArcIterator code efficient).</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;  <span class="comment">//</span></div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;  <span class="comment">// The &#39;olabel&#39; has to do with ensuring that arcs with user-defined</span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;  <span class="comment">// nonterminals or kNontermEnd have no olabels on them.  This is a requirement</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;  <span class="comment">// of the CombineArcs() function of GrammarFst, because it needs to combine</span></div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;  <span class="comment">// two olabels into one so we need to know that at least one of the olabels is</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;  <span class="comment">// always epsilon.</span></div><div class="line"><a name="l00540"></a><span class="lineno"><a class="line" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html">  540</a></span>&#160;  <span class="keyword">struct </span><a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html">ArcCategory</a> {</div><div class="line"><a name="l00541"></a><span class="lineno"><a class="line" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ad09e426fba4154e4edc4619ca7ccf3c0">  541</a></span>&#160;    int32 <a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ad09e426fba4154e4edc4619ca7ccf3c0">nonterminal</a>;  <span class="comment">//  The nonterminal symbol #nontermXXX encoded into the ilabel,</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                        <span class="comment">// or 0 if the ilabel was &lt;kNontermBigNumber.</span></div><div class="line"><a name="l00543"></a><span class="lineno"><a class="line" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#a9cecd6199a2f3b82bb326ed2fb444477">  543</a></span>&#160;    <a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> <a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#a9cecd6199a2f3b82bb326ed2fb444477">nextstate</a>; <span class="comment">//  If &#39;nonterminal&#39; is a user-defined nonterminal like</span></div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                       <span class="comment">//  #nonterm:foo,</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                       <span class="comment">// then the destination state of the arc, else kNoStateId (-1).</span></div><div class="line"><a name="l00546"></a><span class="lineno"><a class="line" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ae52b88141c62bd80d030ee41f3e833c2">  546</a></span>&#160;    <a class="code" href="classfst_1_1GrammarFstPreparer.html#a377361b58f9b7d7fb6f3b739133bda9b">Label</a> <a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ae52b88141c62bd80d030ee41f3e833c2">olabel</a>;  <span class="comment">//  If &#39;nonterminal&#39; is #nonterm_end or is a user-defined</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;                   <span class="comment">// nonterminal (e.g. #nonterm:foo), then the olabel on the</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;                   <span class="comment">// arc; else, 0.</span></div><div class="line"><a name="l00549"></a><span class="lineno"><a class="line" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#a1d3865a2e38c21da659b7bff63c48644">  549</a></span>&#160;    <span class="keywordtype">bool</span> operator &lt; (<span class="keyword">const</span> <a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html">ArcCategory</a> &amp;other)<span class="keyword"> const </span>{</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;      <span class="keywordflow">if</span> (nonterminal &lt; other.<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ad09e426fba4154e4edc4619ca7ccf3c0">nonterminal</a>) <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nonterminal &gt; other.<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ad09e426fba4154e4edc4619ca7ccf3c0">nonterminal</a>) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;      <span class="keywordflow">if</span> (nextstate &lt; other.<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#a9cecd6199a2f3b82bb326ed2fb444477">nextstate</a>) <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nextstate &gt; other.<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#a9cecd6199a2f3b82bb326ed2fb444477">nextstate</a>) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;      <span class="keywordflow">return</span> olabel &lt; other.<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ae52b88141c62bd80d030ee41f3e833c2">olabel</a>;</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    }</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;  };</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;  <span class="comment">// This function, which is used in CheckProperties() and</span></div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;  <span class="comment">// InsertEpsilonsForState(), works out the categrory of the arc; see</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;  <span class="comment">// documentation of struct ArcCategory for more details.</span></div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;  <span class="keywordtype">void</span> GetCategoryOfArc(<span class="keyword">const</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#aea7adf59f410ad3bfd9c9147b5966f26">Arc</a> &amp;arc,</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                        <a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html">ArcCategory</a> *arc_category) <span class="keyword">const</span>;</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;  <span class="comment">// This will be called for &#39;special states&#39; that need to be split up.</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;  <span class="comment">// Non-special arcs leaving this state will stay here.  For each</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;  <span class="comment">// category of special arcs (see ArcCategory for details), a new</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;  <span class="comment">// state will be created and those arcs will leave from that state</span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;  <span class="comment">// instead; for each such state, an input-epsilon arc will leave this state</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  <span class="comment">// for that state.  For more details, see the code.</span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;  <span class="keywordtype">void</span> InsertEpsilonsForState(<a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> s);</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;</div><div class="line"><a name="l00573"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#a8a5039ffc452cbca64337db914f957b9">  573</a></span>&#160;  <span class="keyword">inline</span> int32 <a class="code" href="classfst_1_1GrammarFstPreparer.html#a8a5039ffc452cbca64337db914f957b9">GetPhoneSymbolFor</a>(<span class="keyword">enum</span> <a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2">NonterminalValues</a> <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a>)<span class="keyword"> const </span>{</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    <span class="keywordflow">return</span> nonterm_phones_offset_ + <span class="keyword">static_cast&lt;</span>int32<span class="keyword">&gt;</span>(<a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a>);</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;  }</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;</div><div class="line"><a name="l00577"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#a56db4c50d7ba7ecdac05db5856374e81">  577</a></span>&#160;  int32 <a class="code" href="classfst_1_1GrammarFstPreparer.html#a56db4c50d7ba7ecdac05db5856374e81">nonterm_phones_offset_</a>;</div><div class="line"><a name="l00578"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#a9de7936f9b2c05814a9d02a73fced9bb">  578</a></span>&#160;  VectorFst&lt;StdArc&gt; *<a class="code" href="classfst_1_1GrammarFstPreparer.html#a9de7936f9b2c05814a9d02a73fced9bb">fst_</a>;</div><div class="line"><a name="l00579"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#a1eba0f66b5fdfa4e8f2cf8edbe8fe2df">  579</a></span>&#160;  <a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> <a class="code" href="classfst_1_1GrammarFstPreparer.html#a1eba0f66b5fdfa4e8f2cf8edbe8fe2df">orig_num_states_</a>;</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;  <span class="comment">// If needed we may add a &#39;simple final state&#39; to fst_, which has unit</span></div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;  <span class="comment">// final-prob.  This is used when we ensure that states with kNontermExit on</span></div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;  <span class="comment">// them transition to a state with unit final-prob, so we don&#39;t need to</span></div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;  <span class="comment">// look at the final-prob when expanding states.</span></div><div class="line"><a name="l00584"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#a6254f57059e768b013550c5acaa22a53">  584</a></span>&#160;  <a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> <a class="code" href="classfst_1_1GrammarFstPreparer.html#a6254f57059e768b013550c5acaa22a53">simple_final_state_</a>;</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;};</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;</div><div class="line"><a name="l00587"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#a63c52c9105e956fe268f66a7d3b9e6d9">  587</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#a63c52c9105e956fe268f66a7d3b9e6d9">GrammarFstPreparer::IsSpecialState</a>(<a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> s)<span class="keyword"> const </span>{</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;Final(s).Value() == <a class="code" href="grammar-fst_8h.html#ac5ec65c3c945b6fcf47a7f303304b1a4">KALDI_GRAMMAR_FST_SPECIAL_WEIGHT</a>) {</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    <span class="comment">// TODO: find a way to detect if it was a coincidence, or not make it an</span></div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    <span class="comment">// error, because in principle a user-defined grammar could contain this</span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    <span class="comment">// special cost.</span></div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    <a class="code" href="group__error__group.html#ga994be213ddf127b5d6f20a43a02b513a">KALDI_WARN</a> &lt;&lt; <span class="stringliteral">&quot;It looks like you are calling PrepareForGrammarFst twice.&quot;</span>;</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;  }</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;  <span class="keywordflow">for</span> (ArcIterator&lt;FST&gt; aiter(*<a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>, s ); !aiter.Done(); aiter.Next()) {</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    <span class="keyword">const</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#aea7adf59f410ad3bfd9c9147b5966f26">Arc</a> &amp;arc = aiter.Value();</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;    <span class="keywordflow">if</span> (arc.ilabel &gt;= <a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2aafc1d79474b5b834eae90c6a9c42790f">kNontermBigNumber</a>) <span class="comment">// 1 million</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;  }</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;}</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div><div class="line"><a name="l00602"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#a99ea6983fdd7008ccc7c5dddf663a1ec">  602</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#a99ea6983fdd7008ccc7c5dddf663a1ec">GrammarFstPreparer::NeedEpsilons</a>(<a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> s)<span class="keyword"> const </span>{</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;  <span class="comment">// See the documentation for GetCategoryOfArc() for explanation of what these are.</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;  std::set&lt;ArcCategory&gt; categories;</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;Final(s) != Weight::Zero()) {</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    <span class="comment">// A state having a final-prob is considered the same as it having</span></div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    <span class="comment">// a non-nonterminal arc out of it.. this would be like a transition</span></div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    <span class="comment">// within the same FST.</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    <a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html">ArcCategory</a> category;</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;    category.<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ad09e426fba4154e4edc4619ca7ccf3c0">nonterminal</a> = 0;</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    category.<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#a9cecd6199a2f3b82bb326ed2fb444477">nextstate</a> = kNoStateId;</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    category.<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ae52b88141c62bd80d030ee41f3e833c2">olabel</a> = 0;</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    categories.insert(category);</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;  }</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;  int32 big_number = <a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2aafc1d79474b5b834eae90c6a9c42790f">kNontermBigNumber</a>,</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;      encoding_multiple = <a class="code" href="namespacefst.html#a4828391bb3d612ffffaf704c14c30d6a">GetEncodingMultiple</a>(nonterm_phones_offset_);</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;  <span class="keywordflow">for</span> (ArcIterator&lt;FST&gt; aiter(*<a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>, s ); !aiter.Done(); aiter.Next()) {</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    <span class="keyword">const</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#aea7adf59f410ad3bfd9c9147b5966f26">Arc</a> &amp;arc = aiter.Value();</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    <a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html">ArcCategory</a> category;</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    GetCategoryOfArc(arc, &amp;category);</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    categories.insert(category);</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    <span class="comment">// the rest of this block is just checking.</span></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    int32 nonterminal = category.<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ad09e426fba4154e4edc4619ca7ccf3c0">nonterminal</a>;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    <span class="keywordflow">if</span> (nonterminal &gt;= GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a9407a1ae01a2fea99f092723c3c3cbc0">kNontermUserDefined</a>)) {</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;      <span class="comment">// Check that the destination state of this arc has arcs with</span></div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;      <span class="comment">// kNontermReenter on them.  We&#39;ll separately check that such states</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;      <span class="comment">// don&#39;t have other types of arcs leaving them (search for</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;      <span class="comment">// kNontermReenter below), so it&#39;s sufficient to check the first arc.</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;      ArcIterator&lt;FST&gt; next_aiter(*<a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>, arc.nextstate);</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;      <span class="keywordflow">if</span> (next_aiter.Done())</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;        <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Destination state of a user-defined nonterminal &quot;</span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;            <span class="stringliteral">&quot;has no arcs leaving it.&quot;</span>;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;      <span class="keyword">const</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#aea7adf59f410ad3bfd9c9147b5966f26">Arc</a> &amp;next_arc = next_aiter.Value();</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;      int32 next_nonterminal = (next_arc.ilabel - big_number) /</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;          encoding_multiple;</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;      <span class="keywordflow">if</span> (next_nonterminal != GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2af2f1f7ed744565c5728529dcce2e2ef5">kNontermReenter</a>)) {</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;        <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Expected arcs with user-defined nonterminals to be &quot;</span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;            <span class="stringliteral">&quot;followed by arcs with kNontermReenter.&quot;</span>;</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;      }</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    }</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    <span class="keywordflow">if</span> (nonterminal == GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a853f28d67c5daf316eecc91390831332">kNontermBegin</a>) &amp;&amp;</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        s != <a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;Start()) {</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;#nonterm_begin symbol is present but this is not the &quot;</span></div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;          <span class="stringliteral">&quot;first arc.  Did you do fstdeterminizestar while compiling?&quot;</span>;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;    }</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;    <span class="keywordflow">if</span> (nonterminal == GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a534b236508a8d909dd97b3d7475b75db">kNontermEnd</a>)) {</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;NumArcs(arc.nextstate) != 0 ||</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;          <a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;Final(arc.nextstate) == Weight::Zero()) {</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;        <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Arc with kNontermEnd is not the final arc.&quot;</span>;</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;      }</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;    }</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;  }</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;  <span class="keywordflow">if</span> (categories.size() &gt; 1) {</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;    <span class="comment">// This state has arcs leading to multiple FST instances.</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    <span class="comment">// Do some checking to see that there is nothing really unexpected in</span></div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    <span class="comment">// there.</span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;    <span class="keywordflow">for</span> (std::set&lt;ArcCategory&gt;::const_iterator</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;             iter = categories.begin();</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;         iter != categories.end(); ++iter) {</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;      int32 nonterminal = iter-&gt;nonterminal;</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;      <span class="keywordflow">if</span> (nonterminal == nonterm_phones_offset_ + <a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a853f28d67c5daf316eecc91390831332">kNontermBegin</a> ||</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;          nonterminal == nonterm_phones_offset_ + <a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2af2f1f7ed744565c5728529dcce2e2ef5">kNontermReenter</a>)</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;        <span class="comment">// we don&#39;t expect any state which has symbols like (kNontermBegin:p1)</span></div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;        <span class="comment">// on arcs coming out of it, to also have other types of symbol.  The</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;        <span class="comment">// same goes for kNontermReenter.</span></div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;        <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;We do not expect states with arcs of type &quot;</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;            <span class="stringliteral">&quot;kNontermBegin/kNontermReenter coming out of them, to also have &quot;</span></div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;            <span class="stringliteral">&quot;other types of arc.&quot;</span>;</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    }</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;  }</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;  <span class="comment">// the first half of the || below relates to olabels on arcs with either</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;  <span class="comment">// user-defined nonterminals or #nonterm_end (which would become &#39;leaving_arc&#39;</span></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;  <span class="comment">// in the CombineArcs() function of GrammarFst).  That function does not allow</span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;  <span class="comment">// nonzero olabels on &#39;leaving_arc&#39;, which would be a problem if the</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;  <span class="comment">// &#39;arriving&#39; arc had nonzero olabels, so we solve this by introducing</span></div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;  <span class="comment">// input-epsilon arcs and putting the olabels on them instead.</span></div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;  <span class="keywordtype">bool</span> need_epsilons = (categories.size() == 1 &amp;&amp;</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;                        categories.begin()-&gt;olabel != 0) ||</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;      categories.size() &gt; 1;</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;  <span class="keywordflow">return</span> need_epsilons;</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;}</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;</div><div class="line"><a name="l00689"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#a9601c7b527a729326d873a71b61c8edb">  689</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#a9601c7b527a729326d873a71b61c8edb">GrammarFstPreparer::FixArcsToFinalStates</a>(<a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> s) {</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;  int32 encoding_multiple = <a class="code" href="namespacefst.html#a4828391bb3d612ffffaf704c14c30d6a">GetEncodingMultiple</a>(nonterm_phones_offset_),</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;      big_number = <a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2aafc1d79474b5b834eae90c6a9c42790f">kNontermBigNumber</a>;</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;  <span class="keywordflow">for</span> (MutableArcIterator&lt;FST&gt; aiter(<a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>, s ); !aiter.Done(); aiter.Next()) {</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    <a class="code" href="classfst_1_1GrammarFstPreparer.html#aea7adf59f410ad3bfd9c9147b5966f26">Arc</a> arc = aiter.Value();</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;    <span class="keywordflow">if</span> (arc.ilabel &lt; big_number)</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;      <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    int32 nonterminal = (arc.ilabel - big_number) / encoding_multiple;</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    <span class="keywordflow">if</span> (nonterminal ==  GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a534b236508a8d909dd97b3d7475b75db">kNontermEnd</a>)) {</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;      <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(<a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;NumArcs(arc.nextstate) == 0 &amp;&amp;</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;                   <a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;Final(arc.nextstate) != Weight::Zero());</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;Final(arc.nextstate) == Weight::One())</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;        <span class="keywordflow">continue</span>;  <span class="comment">// There is no problem to fix.</span></div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;      <span class="keywordflow">if</span> (simple_final_state_ == kNoStateId) {</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;        simple_final_state_ = <a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;AddState();</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;        <a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;SetFinal(simple_final_state_, Weight::One());</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;      }</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;      arc.weight = <a class="code" href="namespacefst.html#a0807071c6ceb397bc35281fce74ff8a7">Times</a>(arc.weight, <a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;Final(arc.nextstate));</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;      arc.nextstate = simple_final_state_;</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;      aiter.SetValue(arc);</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;    }</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;  }</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;}</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;</div><div class="line"><a name="l00713"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#ac5abac3af0c1431f2485834eadcd6ab1">  713</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#ac5abac3af0c1431f2485834eadcd6ab1">GrammarFstPreparer::MaybeAddFinalProbToState</a>(<a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> s) {</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;Final(s) != Weight::Zero()) {</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    <span class="comment">// Something went wrong and it will require some debugging.  In Prepare(),</span></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <span class="comment">// if we detected that the special state had a nonzero final-prob, we</span></div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;    <span class="comment">// would have inserted epsilons to remove it, so there may be a bug in</span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;    <span class="comment">// this class&#39;s code.</span></div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;State already final-prob.&quot;</span>;</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;  }</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;  ArcIterator&lt;FST&gt; aiter(*<a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>, s );</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!aiter.Done());</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;  <span class="keyword">const</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#aea7adf59f410ad3bfd9c9147b5966f26">Arc</a> &amp;arc = aiter.Value();</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;  int32 encoding_multiple = <a class="code" href="namespacefst.html#a4828391bb3d612ffffaf704c14c30d6a">GetEncodingMultiple</a>(nonterm_phones_offset_),</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;      big_number = <a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2aafc1d79474b5b834eae90c6a9c42790f">kNontermBigNumber</a>,</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;      nonterminal = (arc.ilabel - big_number) / encoding_multiple;</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(nonterminal &gt;= GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a853f28d67c5daf316eecc91390831332">kNontermBegin</a>));</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;  <span class="keywordflow">if</span> (nonterminal == GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a534b236508a8d909dd97b3d7475b75db">kNontermEnd</a>) ||</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;      nonterminal &gt;= GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a9407a1ae01a2fea99f092723c3c3cbc0">kNontermUserDefined</a>)) {</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    <a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;SetFinal(s, <a class="code" href="classkaldi_1_1FasterDecoder.html#a20d097b045b23dd618a3067dd4e3f915">Weight</a>(<a class="code" href="grammar-fst_8h.html#ac5ec65c3c945b6fcf47a7f303304b1a4">KALDI_GRAMMAR_FST_SPECIAL_WEIGHT</a>));</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;  }</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;}</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;</div><div class="line"><a name="l00734"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#a07ef9ce5666fca96970f8232f446f106">  734</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#a07ef9ce5666fca96970f8232f446f106">GrammarFstPreparer::GetCategoryOfArc</a>(</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    <span class="keyword">const</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#aea7adf59f410ad3bfd9c9147b5966f26">Arc</a> &amp;arc, <a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html">ArcCategory</a> *arc_category)<span class="keyword"> const </span>{</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;  int32 encoding_multiple = <a class="code" href="namespacefst.html#a4828391bb3d612ffffaf704c14c30d6a">GetEncodingMultiple</a>(nonterm_phones_offset_),</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;      big_number = <a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2aafc1d79474b5b834eae90c6a9c42790f">kNontermBigNumber</a>;</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;  int32 ilabel = arc.ilabel;</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;  <span class="keywordflow">if</span> (ilabel &lt; big_number) {</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    arc_category-&gt;<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ad09e426fba4154e4edc4619ca7ccf3c0">nonterminal</a> = 0;</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    arc_category-&gt;<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#a9cecd6199a2f3b82bb326ed2fb444477">nextstate</a> = kNoStateId;</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;    arc_category-&gt;<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ae52b88141c62bd80d030ee41f3e833c2">olabel</a> = 0;</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    int32 nonterminal = (ilabel - big_number) / encoding_multiple;</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    arc_category-&gt;<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ad09e426fba4154e4edc4619ca7ccf3c0">nonterminal</a> = nonterminal;</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    <span class="keywordflow">if</span> (nonterminal &lt;= nonterm_phones_offset_) {</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Problem decoding nonterminal symbol &quot;</span></div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;          <span class="stringliteral">&quot;(wrong --nonterm-phones-offset option?), ilabel=&quot;</span></div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;                &lt;&lt; ilabel;</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    }</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;    <span class="keywordflow">if</span> (nonterminal &gt;= GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a9407a1ae01a2fea99f092723c3c3cbc0">kNontermUserDefined</a>)) {</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;      <span class="comment">// This is a user-defined symbol.</span></div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;      arc_category-&gt;<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#a9cecd6199a2f3b82bb326ed2fb444477">nextstate</a> = arc.nextstate;</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;      arc_category-&gt;<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ae52b88141c62bd80d030ee41f3e833c2">olabel</a> = arc.olabel;</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;      arc_category-&gt;<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#a9cecd6199a2f3b82bb326ed2fb444477">nextstate</a> = kNoStateId;</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;      <span class="keywordflow">if</span> (nonterminal == GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a534b236508a8d909dd97b3d7475b75db">kNontermEnd</a>))</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;        arc_category-&gt;<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ae52b88141c62bd80d030ee41f3e833c2">olabel</a> = arc.olabel;</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        arc_category-&gt;<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ae52b88141c62bd80d030ee41f3e833c2">olabel</a> = 0;</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    }</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;  }</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;}</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;</div><div class="line"><a name="l00767"></a><span class="lineno"><a class="line" href="classfst_1_1GrammarFstPreparer.html#ae45931fdd0f05b1adc5b982b480eb704">  767</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#ae45931fdd0f05b1adc5b982b480eb704">GrammarFstPreparer::InsertEpsilonsForState</a>(<a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> s) {</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;  <span class="comment">// Maps from category of arc, to a pair:</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;  <span class="comment">//  the StateId is the state corresponding to that category.</span></div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;  <span class="comment">//  the float is the cost on the arc leading to that state;</span></div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;  <span class="comment">//   we compute the value that corresponds to the sum of the probabilities</span></div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;  <span class="comment">//   of the leaving arcs, bearing in mind that p = exp(-cost).</span></div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;  <span class="comment">// We don&#39;t insert the arc-category whose &#39;nonterminal&#39; is 0 here (i.e. the</span></div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;  <span class="comment">// category for normal arcs); those arcs stay at this state.</span></div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;  std::map&lt;ArcCategory, std::pair&lt;StateId, float&gt; &gt; category_to_state;</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;  <span class="comment">// This loop sets up &#39;category_to_state&#39;.</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;  <span class="keywordflow">for</span> (fst::ArcIterator&lt;FST&gt; aiter(*<a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>, s); !aiter.Done(); aiter.Next()) {</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    <span class="keyword">const</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#aea7adf59f410ad3bfd9c9147b5966f26">Arc</a> &amp;arc = aiter.Value();</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    <a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html">ArcCategory</a> category;</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    GetCategoryOfArc(arc, &amp;category);</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    int32 nonterminal = category.<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ad09e426fba4154e4edc4619ca7ccf3c0">nonterminal</a>;</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    <span class="keywordflow">if</span> (nonterminal == 0)</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;      <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    <span class="keywordflow">if</span> (nonterminal == GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a853f28d67c5daf316eecc91390831332">kNontermBegin</a>) ||</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        nonterminal == GetPhoneSymbolFor(<a class="code" href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2af2f1f7ed744565c5728529dcce2e2ef5">kNontermReenter</a>)) {</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Something went wrong; did not expect to insert epsilons &quot;</span></div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;          <span class="stringliteral">&quot;for this type of state.&quot;</span>;</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    }</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;    <span class="keyword">auto</span> iter = category_to_state.find(category);</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    <span class="keywordflow">if</span> (iter == category_to_state.end()) {</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;      <a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> new_state = <a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;AddState();</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;      <span class="keywordtype">float</span> cost = arc.weight.Value();</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;      category_to_state[category] = std::pair&lt;StateId, float&gt;(new_state, cost);</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;      std::pair&lt;StateId, float&gt; &amp;p = iter-&gt;second;</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;      p.second = -<a class="code" href="namespacekaldi.html#a4ae8be9c3451f1dfa8cf05ffa48085ae">kaldi::LogAdd</a>(-p.second, -arc.weight.Value());</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    }</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;  }</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!category_to_state.empty());  <span class="comment">// would be a code error.</span></div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;  <span class="comment">// &#39;arcs_from_this_state&#39; is a place to put arcs that will put on this state</span></div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;  <span class="comment">// after we delete all its existing arcs.</span></div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;  std::vector&lt;Arc&gt; arcs_from_this_state;</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;  arcs_from_this_state.reserve(<a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;NumArcs(s) + category_to_state.size());</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;  <span class="comment">// add arcs corresponding to transitions to the newly created states, to</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;  <span class="comment">// &#39;arcs_from_this_state&#39;</span></div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;  <span class="keywordflow">for</span> (std::map&lt;<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html">ArcCategory</a>, std::pair&lt;StateId, float&gt; &gt;::const_iterator</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;           iter = category_to_state.begin(); iter != category_to_state.end();</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;       ++iter) {</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    <span class="keyword">const</span> <a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html">ArcCategory</a> &amp;category = iter-&gt;first;</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    <a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> new_state = iter-&gt;second.first;</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    <span class="keywordtype">float</span> cost = iter-&gt;second.second;</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    <a class="code" href="classfst_1_1GrammarFstPreparer.html#aea7adf59f410ad3bfd9c9147b5966f26">Arc</a> arc;</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    arc.ilabel = 0;</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    arc.<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ae52b88141c62bd80d030ee41f3e833c2">olabel</a> = category.<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ae52b88141c62bd80d030ee41f3e833c2">olabel</a>;</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    arc.weight = <a class="code" href="classkaldi_1_1FasterDecoder.html#a20d097b045b23dd618a3067dd4e3f915">Weight</a>(cost);</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    arc.nextstate = new_state;</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    arcs_from_this_state.push_back(arc);</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;  }</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;  <span class="comment">// Now add to &#39;arcs_from_this_state&#39;, and to the newly created states,</span></div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;  <span class="comment">// arcs corresponding to each of the arcs that were originally leaving</span></div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;  <span class="comment">// this state.</span></div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;  <span class="keywordflow">for</span> (fst::ArcIterator&lt;FST&gt; aiter(*<a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>, s); !aiter.Done(); aiter.Next()) {</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    <span class="keyword">const</span> <a class="code" href="classfst_1_1GrammarFstPreparer.html#aea7adf59f410ad3bfd9c9147b5966f26">Arc</a> &amp;arc = aiter.Value();</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    <a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html">ArcCategory</a> category;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    GetCategoryOfArc(arc, &amp;category);</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    int32 nonterminal = category.<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ad09e426fba4154e4edc4619ca7ccf3c0">nonterminal</a>;</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    <span class="keywordflow">if</span> (nonterminal == 0) { <span class="comment">// this arc remains unchanged; we&#39;ll put it back later.</span></div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;      arcs_from_this_state.push_back(arc);</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;      <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    }</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <span class="keyword">auto</span> iter = category_to_state.find(category);</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(iter != category_to_state.end());</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    <a class="code" href="classfst_1_1GrammarFstPreparer.html#aea7adf59f410ad3bfd9c9147b5966f26">Arc</a> new_arc;</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    new_arc.ilabel = arc.ilabel;</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    <span class="keywordflow">if</span> (arc.olabel == category.<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ae52b88141c62bd80d030ee41f3e833c2">olabel</a>) {</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;      new_arc.olabel = 0;  <span class="comment">// the olabel went on the epsilon-input arc.</span></div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;      <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(category.<a class="code" href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ae52b88141c62bd80d030ee41f3e833c2">olabel</a> == 0);</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;      new_arc.olabel = arc.olabel;</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    }</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    <a class="code" href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">StateId</a> new_state = iter-&gt;second.first;</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    <span class="keywordtype">float</span> epsilon_arc_cost = iter-&gt;second.second;</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    new_arc.weight = <a class="code" href="classkaldi_1_1FasterDecoder.html#a20d097b045b23dd618a3067dd4e3f915">Weight</a>(arc.weight.Value() - epsilon_arc_cost);</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    new_arc.nextstate = arc.nextstate;</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;    <a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;AddArc(new_state, new_arc);</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;  }</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;  <a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;DeleteArcs(s);</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; arcs_from_this_state.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;    <a class="code" href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">fst_</a>-&gt;AddArc(s, arcs_from_this_state[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>]);</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;  }</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;  <span class="comment">// leave the final-prob on this state as it was before.</span></div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;}</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;</div><div class="line"><a name="l00861"></a><span class="lineno"><a class="line" href="namespacefst.html#acbbeb727f9b9258b2830e83c89dbedda">  861</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacefst.html#acbbeb727f9b9258b2830e83c89dbedda">PrepareForGrammarFst</a>(int32 nonterm_phones_offset,</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;                          VectorFst&lt;StdArc&gt; *<a class="code" href="namespacefst.html">fst</a>) {</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;  <a class="code" href="classfst_1_1GrammarFstPreparer.html">GrammarFstPreparer</a> p(nonterm_phones_offset, fst);</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;  p.<a class="code" href="classfst_1_1GrammarFstPreparer.html#a6a3db0bfa3259f043005fbf4861ba357">Prepare</a>();</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;}</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;</div><div class="line"><a name="l00867"></a><span class="lineno"><a class="line" href="namespacefst.html#a2ce371531425ec7d5049f73d839a16c1">  867</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacefst.html#a2ce371531425ec7d5049f73d839a16c1">CopyToVectorFst</a>(<a class="code" href="classfst_1_1GrammarFst.html">GrammarFst</a> *grammar_fst,</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;                     VectorFst&lt;StdArc&gt; *vector_fst) {</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;  <span class="keyword">typedef</span> <a class="code" href="structfst_1_1GrammarFstArc.html#a875b746461472785be87ec24826ff874">GrammarFstArc::StateId</a> GrammarStateId;  <span class="comment">// int64</span></div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;  <span class="keyword">typedef</span> <a class="code" href="namespacefst.html#ae38f9e2cc96a39ff2953a2846c2538db">StdArc::StateId</a> StdStateId;  <span class="comment">// int</span></div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;  <span class="keyword">typedef</span> <a class="code" href="namespacefst.html#a006b00477e4d9250474e76e1ec61bb3f">StdArc::Label</a> <a class="code" href="classkaldi_1_1FasterDecoder.html#a8b4305fe971ea965a741395013fd9c49">Label</a>;</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;  <span class="keyword">typedef</span> <a class="code" href="namespacefst.html#a2fdd196e46607f0d35b13369d9f9970d">StdArc::Weight</a> <a class="code" href="classkaldi_1_1FasterDecoder.html#a20d097b045b23dd618a3067dd4e3f915">Weight</a>;</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;  std::vector&lt;std::pair&lt;GrammarStateId, StdStateId&gt; &gt; queue;</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;  std::unordered_map&lt;GrammarStateId, StdStateId&gt; state_map;</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;  vector_fst-&gt;DeleteStates();</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;  state_map[grammar_fst-&gt;<a class="code" href="classfst_1_1GrammarFst.html#a505ff365f90ab7b3851c6c531ad772c2">Start</a>()] = vector_fst-&gt;AddState();  <span class="comment">// state 0.</span></div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;  vector_fst-&gt;SetStart(0);</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;  queue.push_back(</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;      std::pair&lt;GrammarStateId, StdStateId&gt;(grammar_fst-&gt;<a class="code" href="classfst_1_1GrammarFst.html#a505ff365f90ab7b3851c6c531ad772c2">Start</a>(), 0));</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;  <span class="keywordflow">while</span> (!queue.empty()) {</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    std::pair&lt;GrammarStateId, StdStateId&gt; p = queue.back();</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    queue.pop_back();</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    GrammarStateId grammar_state = p.first;</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    StdStateId std_state = p.second;</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    vector_fst-&gt;SetFinal(std_state, grammar_fst-&gt;<a class="code" href="classfst_1_1GrammarFst.html#abac0d92668ae11c078d86c557a9217c9">Final</a>(grammar_state));</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;    <a class="code" href="classfst_1_1ArcIterator_3_01GrammarFst_01_4.html">ArcIterator&lt;GrammarFst&gt;</a> aiter(*grammar_fst, grammar_state);</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    <span class="keywordflow">for</span> (; !aiter.<a class="code" href="classfst_1_1ArcIterator_3_01GrammarFst_01_4.html#a950b56506a3a27d431dbe1fca7efd0c7">Done</a>(); aiter.<a class="code" href="classfst_1_1ArcIterator_3_01GrammarFst_01_4.html#a659a293dd51073a1b9560bb80f687705">Next</a>()) {</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;      <span class="keyword">const</span> <a class="code" href="structfst_1_1GrammarFstArc.html">GrammarFstArc</a> &amp;grammar_arc = aiter.<a class="code" href="classfst_1_1ArcIterator_3_01GrammarFst_01_4.html#a9cd150c6c4516fe9299f043993da7183">Value</a>();</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;      <a class="code" href="namespacefst.html#a70478eb2428a9406e4692d19a7a3a97f">StdArc</a> std_arc;</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;      std_arc.ilabel = grammar_arc.<a class="code" href="structfst_1_1GrammarFstArc.html#ac3f2f236a15c5a4af29f92c8ce9817ec">ilabel</a>;</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;      std_arc.olabel = grammar_arc.<a class="code" href="structfst_1_1GrammarFstArc.html#ae52b88141c62bd80d030ee41f3e833c2">olabel</a>;</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;      std_arc.weight = grammar_arc.<a class="code" href="structfst_1_1GrammarFstArc.html#ac348b84fbc0a26e6fcf42ea1b47639ca">weight</a>;</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;      GrammarStateId next_grammar_state = grammar_arc.<a class="code" href="structfst_1_1GrammarFstArc.html#a9cecd6199a2f3b82bb326ed2fb444477">nextstate</a>;</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;      StdStateId next_std_state;</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;      std::unordered_map&lt;GrammarStateId, StdStateId&gt;::const_iterator</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;          state_iter = state_map.find(next_grammar_state);</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;      <span class="keywordflow">if</span> (state_iter == state_map.end()) {</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;        next_std_state = vector_fst-&gt;AddState();</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;        state_map[next_grammar_state] = next_std_state;</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;        queue.push_back(std::pair&lt;GrammarStateId, StdStateId&gt;(</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;            next_grammar_state, next_std_state));</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;        next_std_state = state_iter-&gt;second;</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;      }</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;      std_arc.nextstate = next_std_state;</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;      vector_fst-&gt;AddArc(std_state, std_arc);</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;    }</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;  }</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;}</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;} <span class="comment">// end namespace fst</span></div><div class="ttc" id="classfst_1_1GrammarFst_html_a68f354fd5f096134162f01719096e6fc"><div class="ttname"><a href="classfst_1_1GrammarFst.html#a68f354fd5f096134162f01719096e6fc">fst::GrammarFst::Write</a></div><div class="ttdeci">void Write(std::ostream &amp;os, bool binary) const</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00381">grammar-fst.cc:381</a></div></div>
<div class="ttc" id="namespacefst_html_ae38f9e2cc96a39ff2953a2846c2538db"><div class="ttname"><a href="namespacefst.html#ae38f9e2cc96a39ff2953a2846c2538db">fst::StateId</a></div><div class="ttdeci">fst::StdArc::StateId StateId</div><div class="ttdef"><b>Definition:</b> <a href="deterministic-fst-test_8cc_source.html#l00055">deterministic-fst-test.cc:55</a></div></div>
<div class="ttc" id="namespacekaldi_html"><div class="ttname"><a href="namespacekaldi.html">kaldi</a></div><div class="ttdoc">Relabels neural network egs with the read pdf-id alignments. </div><div class="ttdef"><b>Definition:</b> <a href="chain_8dox_source.html#l00020">chain.dox:20</a></div></div>
<div class="ttc" id="namespacefst_html_a251b709d87fe58fc66599f483fb98bd2aafc1d79474b5b834eae90c6a9c42790f"><div class="ttname"><a href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2aafc1d79474b5b834eae90c6a9c42790f">fst::kNontermBigNumber</a></div><div class="ttdef"><b>Definition:</b> <a href="grammar-context-fst_8h_source.html#l00080">grammar-context-fst.h:80</a></div></div>
<div class="ttc" id="namespacefst_html_a279c469277315d755bd9ed37d718c377"><div class="ttname"><a href="namespacefst.html#a279c469277315d755bd9ed37d718c377">fst::ReadConstFstFromStream</a></div><div class="ttdeci">static ConstFst&lt; StdArc &gt; * ReadConstFstFromStream(std::istream &amp;is)</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00404">grammar-fst.cc:404</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFst_1_1FstInstance_html_a50d6dd52001b15f23c15ef0eb48f4bca"><div class="ttname"><a href="structfst_1_1GrammarFst_1_1FstInstance.html#a50d6dd52001b15f23c15ef0eb48f4bca">fst::GrammarFst::FstInstance::expanded_states</a></div><div class="ttdeci">std::unordered_map&lt; BaseStateId, ExpandedState * &gt; expanded_states</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00400">grammar-fst.h:400</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFst_1_1FstInstance_html_a2e2b185fc9c2826b33756ea9fe322086"><div class="ttname"><a href="structfst_1_1GrammarFst_1_1FstInstance.html#a2e2b185fc9c2826b33756ea9fe322086">fst::GrammarFst::FstInstance::parent_state</a></div><div class="ttdeci">int32 parent_state</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00428">grammar-fst.h:428</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFst_1_1FstInstance_html_ada83bf34b10bb90e0ebdf2bd985f3761"><div class="ttname"><a href="structfst_1_1GrammarFst_1_1FstInstance.html#ada83bf34b10bb90e0ebdf2bd985f3761">fst::GrammarFst::FstInstance::fst</a></div><div class="ttdeci">const ConstFst&lt; StdArc &gt; * fst</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00393">grammar-fst.h:393</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_a08fde93370b81531183d644bca127d3f"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#a08fde93370b81531183d644bca127d3f">fst::GrammarFstPreparer::FST</a></div><div class="ttdeci">VectorFst&lt; StdArc &gt; FST</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00450">grammar-fst.cc:450</a></div></div>
<div class="ttc" id="classkaldi_1_1FasterDecoder_html_a8b4305fe971ea965a741395013fd9c49"><div class="ttname"><a href="classkaldi_1_1FasterDecoder.html#a8b4305fe971ea965a741395013fd9c49">kaldi::FasterDecoder::Label</a></div><div class="ttdeci">Arc::Label Label</div><div class="ttdef"><b>Definition:</b> <a href="faster-decoder_8h_source.html#l00065">faster-decoder.h:65</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_a6254f57059e768b013550c5acaa22a53"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#a6254f57059e768b013550c5acaa22a53">fst::GrammarFstPreparer::simple_final_state_</a></div><div class="ttdeci">StateId simple_final_state_</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00584">grammar-fst.cc:584</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_a9de7936f9b2c05814a9d02a73fced9bb"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#a9de7936f9b2c05814a9d02a73fced9bb">fst::GrammarFstPreparer::fst_</a></div><div class="ttdeci">VectorFst&lt; StdArc &gt; * fst_</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00578">grammar-fst.cc:578</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_a6a3db0bfa3259f043005fbf4861ba357"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#a6a3db0bfa3259f043005fbf4861ba357">fst::GrammarFstPreparer::Prepare</a></div><div class="ttdeci">void Prepare()</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00462">grammar-fst.cc:462</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_aea7adf59f410ad3bfd9c9147b5966f26"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#aea7adf59f410ad3bfd9c9147b5966f26">fst::GrammarFstPreparer::Arc</a></div><div class="ttdeci">StdArc Arc</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00451">grammar-fst.cc:451</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFst_1_1FstInstance_html_a62e5dfb19f79edb7d7692c37a2d370b2"><div class="ttname"><a href="structfst_1_1GrammarFst_1_1FstInstance.html#a62e5dfb19f79edb7d7692c37a2d370b2">fst::GrammarFst::FstInstance::ifst_index</a></div><div class="ttdeci">int32 ifst_index</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00389">grammar-fst.h:389</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_a8a5039ffc452cbca64337db914f957b9"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#a8a5039ffc452cbca64337db914f957b9">fst::GrammarFstPreparer::GetPhoneSymbolFor</a></div><div class="ttdeci">int32 GetPhoneSymbolFor(enum NonterminalValues n) const</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00573">grammar-fst.cc:573</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_ae2892c501e401b523a3eb774e735d64d"><div class="ttname"><a href="classfst_1_1GrammarFst.html#ae2892c501e401b523a3eb774e735d64d">fst::GrammarFst::Read</a></div><div class="ttdeci">void Read(std::istream &amp;os, bool binary)</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00418">grammar-fst.cc:418</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_a9a0814345f5aa1ad5ada7b9a4439124b"><div class="ttname"><a href="classfst_1_1GrammarFst.html#a9a0814345f5aa1ad5ada7b9a4439124b">fst::GrammarFst::InitEntryOrReentryArcs</a></div><div class="ttdeci">void InitEntryOrReentryArcs(const ConstFst&lt; StdArc &gt; &amp;fst, int32 entry_state, int32 nonterminal_symbol, std::unordered_map&lt; int32, int32 &gt; *phone_to_arc)</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00135">grammar-fst.cc:135</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFst_1_1ExpandedState_html_a06c56935c45a75821adc0cdfa6183c2a"><div class="ttname"><a href="structfst_1_1GrammarFst_1_1ExpandedState.html#a06c56935c45a75821adc0cdfa6183c2a">fst::GrammarFst::ExpandedState::arcs</a></div><div class="ttdeci">std::vector&lt; StdArc &gt; arcs</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00379">grammar-fst.h:379</a></div></div>
<div class="ttc" id="group__io__funcs__basic_html_ga1bd1af0ef712b76f2332febcec8d095a"><div class="ttname"><a href="group__io__funcs__basic.html#ga1bd1af0ef712b76f2332febcec8d095a">kaldi::ReadBasicType</a></div><div class="ttdeci">void ReadBasicType(std::istream &amp;is, bool binary, T *t)</div><div class="ttdoc">ReadBasicType is the name of the read function for bool, integer types, and floating-point types...</div><div class="ttdef"><b>Definition:</b> <a href="io-funcs-inl_8h_source.html#l00055">io-funcs-inl.h:55</a></div></div>
<div class="ttc" id="namespacefst_html"><div class="ttname"><a href="namespacefst.html">fst</a></div><div class="ttdoc">For an extended explanation of the framework of which grammar-fsts are a part, please see Support for...</div><div class="ttdef"><b>Definition:</b> <a href="graph_8dox_source.html#l00021">graph.dox:21</a></div></div>
<div class="ttc" id="namespacefst_html_a251b709d87fe58fc66599f483fb98bd2a853f28d67c5daf316eecc91390831332"><div class="ttname"><a href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a853f28d67c5daf316eecc91390831332">fst::kNontermBegin</a></div><div class="ttdef"><b>Definition:</b> <a href="grammar-context-fst_8h_source.html#l00070">grammar-context-fst.h:70</a></div></div>
<div class="ttc" id="namespacefst_html_a70478eb2428a9406e4692d19a7a3a97f"><div class="ttname"><a href="namespacefst.html#a70478eb2428a9406e4692d19a7a3a97f">fst::StdArc</a></div><div class="ttdeci">fst::StdArc StdArc</div><div class="ttdef"><b>Definition:</b> <a href="deterministic-fst-test_8cc_source.html#l00053">deterministic-fst-test.cc:53</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_a2a8a892a0794d0cefabeec2a8860d4dc"><div class="ttname"><a href="classfst_1_1GrammarFst.html#a2a8a892a0794d0cefabeec2a8860d4dc">fst::GrammarFst::ExpandState</a></div><div class="ttdeci">ExpandedState * ExpandState(int32 instance_id, BaseStateId state_id)</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00173">grammar-fst.cc:173</a></div></div>
<div class="ttc" id="classfst_1_1ArcIterator_3_01GrammarFst_01_4_html_a950b56506a3a27d431dbe1fca7efd0c7"><div class="ttname"><a href="classfst_1_1ArcIterator_3_01GrammarFst_01_4.html#a950b56506a3a27d431dbe1fca7efd0c7">fst::ArcIterator&lt; GrammarFst &gt;::Done</a></div><div class="ttdeci">bool Done()</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00532">grammar-fst.h:532</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html">fst::GrammarFstPreparer</a></div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00448">grammar-fst.cc:448</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFstArc_html_ae52b88141c62bd80d030ee41f3e833c2"><div class="ttname"><a href="structfst_1_1GrammarFstArc.html#ae52b88141c62bd80d030ee41f3e833c2">fst::GrammarFstArc::olabel</a></div><div class="ttdeci">Label olabel</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00054">grammar-fst.h:54</a></div></div>
<div class="ttc" id="namespacefst_html_a251b709d87fe58fc66599f483fb98bd2af2f1f7ed744565c5728529dcce2e2ef5"><div class="ttname"><a href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2af2f1f7ed744565c5728529dcce2e2ef5">fst::kNontermReenter</a></div><div class="ttdef"><b>Definition:</b> <a href="grammar-context-fst_8h_source.html#l00072">grammar-context-fst.h:72</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_a02544b1df2ed0618053ca21f2188b43f"><div class="ttname"><a href="classfst_1_1GrammarFst.html#a02544b1df2ed0618053ca21f2188b43f">fst::GrammarFst::GetChildInstanceId</a></div><div class="ttdeci">int32 GetChildInstanceId(int32 instance_id, int32 nonterminal, int32 state)</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00283">grammar-fst.cc:283</a></div></div>
<div class="ttc" id="namespacefst_html_a251b709d87fe58fc66599f483fb98bd2"><div class="ttname"><a href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2">fst::NonterminalValues</a></div><div class="ttdeci">NonterminalValues</div><div class="ttdoc">An anonymous enum to define some values for symbols used in our grammar-fst framework. </div><div class="ttdef"><b>Definition:</b> <a href="grammar-context-fst_8h_source.html#l00068">grammar-context-fst.h:68</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_a8b4305fe971ea965a741395013fd9c49"><div class="ttname"><a href="classfst_1_1GrammarFst.html#a8b4305fe971ea965a741395013fd9c49">fst::GrammarFst::Label</a></div><div class="ttdeci">Arc::Label Label</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00104">grammar-fst.h:104</a></div></div>
<div class="ttc" id="grammar-fst_8h_html_ac5ec65c3c945b6fcf47a7f303304b1a4"><div class="ttname"><a href="grammar-fst_8h.html#ac5ec65c3c945b6fcf47a7f303304b1a4">KALDI_GRAMMAR_FST_SPECIAL_WEIGHT</a></div><div class="ttdeci">#define KALDI_GRAMMAR_FST_SPECIAL_WEIGHT</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00067">grammar-fst.h:67</a></div></div>
<div class="ttc" id="namespacefst_html_acbbeb727f9b9258b2830e83c89dbedda"><div class="ttname"><a href="namespacefst.html#acbbeb727f9b9258b2830e83c89dbedda">fst::PrepareForGrammarFst</a></div><div class="ttdeci">void PrepareForGrammarFst(int32 nonterm_phones_offset, VectorFst&lt; StdArc &gt; *fst)</div><div class="ttdoc">This function prepares &amp;#39;ifst&amp;#39; for use in GrammarFst: it ensures that it has the expected properties...</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00861">grammar-fst.cc:861</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_a799fac4aecf6dc610b3ca2dae19473df"><div class="ttname"><a href="classfst_1_1GrammarFst.html#a799fac4aecf6dc610b3ca2dae19473df">fst::GrammarFst::CombineArcs</a></div><div class="ttdeci">static void CombineArcs(const StdArc &amp;leaving_arc, const StdArc &amp;arriving_arc, float cost_correction, StdArc *arc)</div><div class="ttdoc">Called while expanding states, this function combines information from two arcs: one leaving one sub-...</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00201">grammar-fst.cc:201</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFst_1_1FstInstance_html_aa417518f4b98c5af7dec3d62faf77ec2"><div class="ttname"><a href="structfst_1_1GrammarFst_1_1FstInstance.html#aa417518f4b98c5af7dec3d62faf77ec2">fst::GrammarFst::FstInstance::parent_reentry_arcs</a></div><div class="ttdeci">std::unordered_map&lt; int32, int32 &gt; parent_reentry_arcs</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00439">grammar-fst.h:439</a></div></div>
<div class="ttc" id="namespacefst_html_a251b709d87fe58fc66599f483fb98bd2a9407a1ae01a2fea99f092723c3c3cbc0"><div class="ttname"><a href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a9407a1ae01a2fea99f092723c3c3cbc0">fst::kNontermUserDefined</a></div><div class="ttdef"><b>Definition:</b> <a href="grammar-context-fst_8h_source.html#l00073">grammar-context-fst.h:73</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_a8086078c61f5b3c4959476d0a59c2836"><div class="ttname"><a href="classfst_1_1GrammarFst.html#a8086078c61f5b3c4959476d0a59c2836">fst::GrammarFst::BaseStateId</a></div><div class="ttdeci">StdArc::StateId BaseStateId</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00102">grammar-fst.h:102</a></div></div>
<div class="ttc" id="namespacefst_html_a0807071c6ceb397bc35281fce74ff8a7"><div class="ttname"><a href="namespacefst.html#a0807071c6ceb397bc35281fce74ff8a7">fst::Times</a></div><div class="ttdeci">LatticeWeightTpl&lt; FloatType &gt; Times(const LatticeWeightTpl&lt; FloatType &gt; &amp;w1, const LatticeWeightTpl&lt; FloatType &gt; &amp;w2)</div><div class="ttdef"><b>Definition:</b> <a href="lattice-weight_8h_source.html#l00363">lattice-weight.h:363</a></div></div>
<div class="ttc" id="classkaldi_1_1FasterDecoder_html_ae6a9be3017661463c1d83b3dd1933cfb"><div class="ttname"><a href="classkaldi_1_1FasterDecoder.html#ae6a9be3017661463c1d83b3dd1933cfb">kaldi::FasterDecoder::fst_</a></div><div class="ttdeci">const fst::Fst&lt; fst::StdArc &gt; &amp; fst_</div><div class="ttdef"><b>Definition:</b> <a href="faster-decoder_8h_source.html#l00171">faster-decoder.h:171</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_a0d2feaf3dcb4c627e7c4c7ae0c1d2a56"><div class="ttname"><a href="classfst_1_1GrammarFst.html#a0d2feaf3dcb4c627e7c4c7ae0c1d2a56">fst::GrammarFst::GrammarFst</a></div><div class="ttdeci">GrammarFst()</div><div class="ttdoc">This constructor should only be used prior to calling Read(). </div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00145">grammar-fst.h:145</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_a8ad20dddb56f73904c0d427e51f2eb4f"><div class="ttname"><a href="classfst_1_1GrammarFst.html#a8ad20dddb56f73904c0d427e51f2eb4f">fst::GrammarFst::InitNonterminalMap</a></div><div class="ttdeci">void InitNonterminalMap()</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00102">grammar-fst.cc:102</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFst_1_1ExpandedState_html"><div class="ttname"><a href="structfst_1_1GrammarFst_1_1ExpandedState.html">fst::GrammarFst::ExpandedState</a></div><div class="ttdoc">Represents an expanded state in an FstInstance. </div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00363">grammar-fst.h:363</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFst_1_1FstInstance_html"><div class="ttname"><a href="structfst_1_1GrammarFst_1_1FstInstance.html">fst::GrammarFst::FstInstance</a></div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00386">grammar-fst.h:386</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_aadf365d3fd4efe997835a726dcc5b0d5"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#aadf365d3fd4efe997835a726dcc5b0d5">fst::GrammarFstPreparer::StateId</a></div><div class="ttdeci">Arc::StateId StateId</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00452">grammar-fst.cc:452</a></div></div>
<div class="ttc" id="grammar-context-fst_8h_html"><div class="ttname"><a href="grammar-context-fst_8h.html">grammar-context-fst.h</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_ac919a991060ede6983343719401686de"><div class="ttname"><a href="classfst_1_1GrammarFst.html#ac919a991060ede6983343719401686de">fst::GrammarFst::Destroy</a></div><div class="ttdeci">void Destroy()</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00056">grammar-fst.cc:56</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFstArc_html_a875b746461472785be87ec24826ff874"><div class="ttname"><a href="structfst_1_1GrammarFstArc.html#a875b746461472785be87ec24826ff874">fst::GrammarFstArc::StateId</a></div><div class="ttdeci">int64 StateId</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00051">grammar-fst.h:51</a></div></div>
<div class="ttc" id="group__io__funcs__basic_html_ga4c7a80f758e878578e78b667f62463a5"><div class="ttname"><a href="group__io__funcs__basic.html#ga4c7a80f758e878578e78b667f62463a5">kaldi::ExpectToken</a></div><div class="ttdeci">void ExpectToken(std::istream &amp;is, bool binary, const char *token)</div><div class="ttdoc">ExpectToken tries to read in the given token, and throws an exception on failure. ...</div><div class="ttdef"><b>Definition:</b> <a href="io-funcs_8cc_source.html#l00194">io-funcs.cc:194</a></div></div>
<div class="ttc" id="namespacernnlm_html_ab4871778d570f724a07823e0a2fb9884"><div class="ttname"><a href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">rnnlm::n</a></div><div class="ttdeci">struct rnnlm::@11::@12 n</div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_a1e3b6d38df0786ccf7f938d60e386aae"><div class="ttname"><a href="classfst_1_1GrammarFst.html#a1e3b6d38df0786ccf7f938d60e386aae">fst::GrammarFst::Init</a></div><div class="ttdeci">void Init()</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00036">grammar-fst.cc:36</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_af2aa0f8fd6325fdede2bca6d013a2f29"><div class="ttname"><a href="classfst_1_1GrammarFst.html#af2aa0f8fd6325fdede2bca6d013a2f29">fst::GrammarFst::InitInstances</a></div><div class="ttdeci">void InitInstances()</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00126">grammar-fst.cc:126</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_a99ea6983fdd7008ccc7c5dddf663a1ec"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#a99ea6983fdd7008ccc7c5dddf663a1ec">fst::GrammarFstPreparer::NeedEpsilons</a></div><div class="ttdeci">bool NeedEpsilons(StateId s) const</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00602">grammar-fst.cc:602</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFst_1_1ExpandedState_html_aa0b8f93e973467d2be4be17aa0eabebd"><div class="ttname"><a href="structfst_1_1GrammarFst_1_1ExpandedState.html#aa0b8f93e973467d2be4be17aa0eabebd">fst::GrammarFst::ExpandedState::dest_fst_instance</a></div><div class="ttdeci">int32 dest_fst_instance</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00370">grammar-fst.h:370</a></div></div>
<div class="ttc" id="group__error__group_html_ga0251fa005e2fdb1dcc6e24f06afe3b1f"><div class="ttname"><a href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a></div><div class="ttdeci">#define KALDI_ERR</div><div class="ttdef"><b>Definition:</b> <a href="kaldi-error_8h_source.html#l00126">kaldi-error.h:126</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_a35bb38a463a02d47426a68faa1584092"><div class="ttname"><a href="classfst_1_1GrammarFst.html#a35bb38a463a02d47426a68faa1584092">fst::GrammarFst::ExpandStateUserDefined</a></div><div class="ttdeci">ExpandedState * ExpandStateUserDefined(int32 instance_id, BaseStateId state_id)</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00326">grammar-fst.cc:326</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_ac5abac3af0c1431f2485834eadcd6ab1"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#ac5abac3af0c1431f2485834eadcd6ab1">fst::GrammarFstPreparer::MaybeAddFinalProbToState</a></div><div class="ttdeci">void MaybeAddFinalProbToState(StateId s)</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00713">grammar-fst.cc:713</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_a63c52c9105e956fe268f66a7d3b9e6d9"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#a63c52c9105e956fe268f66a7d3b9e6d9">fst::GrammarFstPreparer::IsSpecialState</a></div><div class="ttdeci">bool IsSpecialState(StateId s) const</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00587">grammar-fst.cc:587</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html"><div class="ttname"><a href="classfst_1_1GrammarFst.html">fst::GrammarFst</a></div><div class="ttdoc">GrammarFst is an FST that is &amp;#39;stitched together&amp;#39; from multiple FSTs, that can recursively incorporate...</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00091">grammar-fst.h:91</a></div></div>
<div class="ttc" id="group__error__group_html_ga994be213ddf127b5d6f20a43a02b513a"><div class="ttname"><a href="group__error__group.html#ga994be213ddf127b5d6f20a43a02b513a">KALDI_WARN</a></div><div class="ttdeci">#define KALDI_WARN</div><div class="ttdef"><b>Definition:</b> <a href="kaldi-error_8h_source.html#l00129">kaldi-error.h:129</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFst_1_1FstInstance_html_a79af827320a39e183d23b70ab15e8762"><div class="ttname"><a href="structfst_1_1GrammarFst_1_1FstInstance.html#a79af827320a39e183d23b70ab15e8762">fst::GrammarFst::FstInstance::parent_instance</a></div><div class="ttdeci">int32 parent_instance</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00423">grammar-fst.h:423</a></div></div>
<div class="ttc" id="classfst_1_1ArcIterator_3_01GrammarFst_01_4_html_a9cd150c6c4516fe9299f043993da7183"><div class="ttname"><a href="classfst_1_1ArcIterator_3_01GrammarFst_01_4.html#a9cd150c6c4516fe9299f043993da7183">fst::ArcIterator&lt; GrammarFst &gt;::Value</a></div><div class="ttdeci">const Arc &amp; Value() const</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00552">grammar-fst.h:552</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFstArc_html_a9cecd6199a2f3b82bb326ed2fb444477"><div class="ttname"><a href="structfst_1_1GrammarFstArc.html#a9cecd6199a2f3b82bb326ed2fb444477">fst::GrammarFstArc::nextstate</a></div><div class="ttdeci">StateId nextstate</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00056">grammar-fst.h:56</a></div></div>
<div class="ttc" id="group__io__funcs__basic_html_ga87f1638ef3c0a3ee117178b202c2d02a"><div class="ttname"><a href="group__io__funcs__basic.html#ga87f1638ef3c0a3ee117178b202c2d02a">kaldi::WriteToken</a></div><div class="ttdeci">void WriteToken(std::ostream &amp;os, bool binary, const char *token)</div><div class="ttdoc">The WriteToken functions are for writing nonempty sequences of non-space characters. </div><div class="ttdef"><b>Definition:</b> <a href="io-funcs_8cc_source.html#l00134">io-funcs.cc:134</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_a1eba0f66b5fdfa4e8f2cf8edbe8fe2df"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#a1eba0f66b5fdfa4e8f2cf8edbe8fe2df">fst::GrammarFstPreparer::orig_num_states_</a></div><div class="ttdeci">StateId orig_num_states_</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00579">grammar-fst.cc:579</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_afcde49f68292e807c903f4a577a21dfc"><div class="ttname"><a href="classfst_1_1GrammarFst.html#afcde49f68292e807c903f4a577a21dfc">fst::GrammarFst::~GrammarFst</a></div><div class="ttdeci">~GrammarFst()</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00052">grammar-fst.cc:52</a></div></div>
<div class="ttc" id="namespacefst_html_a006b00477e4d9250474e76e1ec61bb3f"><div class="ttname"><a href="namespacefst.html#a006b00477e4d9250474e76e1ec61bb3f">fst::Label</a></div><div class="ttdeci">fst::StdArc::Label Label</div><div class="ttdef"><b>Definition:</b> <a href="deterministic-fst-test_8cc_source.html#l00054">deterministic-fst-test.cc:54</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFstPreparer_1_1ArcCategory_html_ae52b88141c62bd80d030ee41f3e833c2"><div class="ttname"><a href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ae52b88141c62bd80d030ee41f3e833c2">fst::GrammarFstPreparer::ArcCategory::olabel</a></div><div class="ttdeci">Label olabel</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00546">grammar-fst.cc:546</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFstPreparer_1_1ArcCategory_html"><div class="ttname"><a href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html">fst::GrammarFstPreparer::ArcCategory</a></div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00540">grammar-fst.cc:540</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFstArc_html"><div class="ttname"><a href="structfst_1_1GrammarFstArc.html">fst::GrammarFstArc</a></div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00048">grammar-fst.h:48</a></div></div>
<div class="ttc" id="namespacefst_html_a2fdd196e46607f0d35b13369d9f9970d"><div class="ttname"><a href="namespacefst.html#a2fdd196e46607f0d35b13369d9f9970d">fst::Weight</a></div><div class="ttdeci">fst::StdArc::Weight Weight</div><div class="ttdef"><b>Definition:</b> <a href="deterministic-fst-test_8cc_source.html#l00057">deterministic-fst-test.cc:57</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_a6b012f4ca0376685a4e946793da1e5bc"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#a6b012f4ca0376685a4e946793da1e5bc">fst::GrammarFstPreparer::Weight</a></div><div class="ttdeci">Arc::Weight Weight</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00454">grammar-fst.cc:454</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_adce5e15f952be777b8cf5eb47e60acb6"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#adce5e15f952be777b8cf5eb47e60acb6">fst::GrammarFstPreparer::GrammarFstPreparer</a></div><div class="ttdeci">GrammarFstPreparer(int32 nonterm_phones_offset, VectorFst&lt; StdArc &gt; *fst)</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00456">grammar-fst.cc:456</a></div></div>
<div class="ttc" id="namespacekaldi_html_a4ae8be9c3451f1dfa8cf05ffa48085ae"><div class="ttname"><a href="namespacekaldi.html#a4ae8be9c3451f1dfa8cf05ffa48085ae">kaldi::LogAdd</a></div><div class="ttdeci">double LogAdd(double x, double y)</div><div class="ttdef"><b>Definition:</b> <a href="kaldi-math_8h_source.html#l00184">kaldi-math.h:184</a></div></div>
<div class="ttc" id="namespacernnlm_html_acb559820d9ca11295b4500f179ef6392"><div class="ttname"><a href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">rnnlm::i</a></div><div class="ttdeci">int i</div><div class="ttdef"><b>Definition:</b> <a href="mikolov-rnnlm-lib_8cc_source.html#l00066">mikolov-rnnlm-lib.cc:66</a></div></div>
<div class="ttc" id="grammar-fst_8h_html"><div class="ttname"><a href="grammar-fst_8h.html">grammar-fst.h</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_a07ef9ce5666fca96970f8232f446f106"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#a07ef9ce5666fca96970f8232f446f106">fst::GrammarFstPreparer::GetCategoryOfArc</a></div><div class="ttdeci">void GetCategoryOfArc(const Arc &amp;arc, ArcCategory *arc_category) const</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00734">grammar-fst.cc:734</a></div></div>
<div class="ttc" id="group__error__group_html_gad5710173d69cddcda4fa21ded3c77f16"><div class="ttname"><a href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a></div><div class="ttdeci">#define KALDI_ASSERT(cond)</div><div class="ttdef"><b>Definition:</b> <a href="kaldi-error_8h_source.html#l00168">kaldi-error.h:168</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_a98a1bd90bcd088e6a889a7e61ce4a99b"><div class="ttname"><a href="classfst_1_1GrammarFst.html#a98a1bd90bcd088e6a889a7e61ce4a99b">fst::GrammarFst::InitEntryArcs</a></div><div class="ttdeci">void InitEntryArcs(int32 i)</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00118">grammar-fst.cc:118</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_abac0d92668ae11c078d86c557a9217c9"><div class="ttname"><a href="classfst_1_1GrammarFst.html#abac0d92668ae11c078d86c557a9217c9">fst::GrammarFst::Final</a></div><div class="ttdeci">Weight Final(StateId s) const</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00162">grammar-fst.h:162</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFstPreparer_1_1ArcCategory_html_ad09e426fba4154e4edc4619ca7ccf3c0"><div class="ttname"><a href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#ad09e426fba4154e4edc4619ca7ccf3c0">fst::GrammarFstPreparer::ArcCategory::nonterminal</a></div><div class="ttdeci">int32 nonterminal</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00541">grammar-fst.cc:541</a></div></div>
<div class="ttc" id="namespacefst_html_a251b709d87fe58fc66599f483fb98bd2a8420d849ee0c4302c3e4f963feed7a00"><div class="ttname"><a href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a8420d849ee0c4302c3e4f963feed7a00">fst::kNontermBos</a></div><div class="ttdef"><b>Definition:</b> <a href="grammar-context-fst_8h_source.html#l00069">grammar-context-fst.h:69</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_ae45931fdd0f05b1adc5b982b480eb704"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#ae45931fdd0f05b1adc5b982b480eb704">fst::GrammarFstPreparer::InsertEpsilonsForState</a></div><div class="ttdeci">void InsertEpsilonsForState(StateId s)</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00767">grammar-fst.cc:767</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_a1d2cede02beae2c01ae4ca6cbb6c6086"><div class="ttname"><a href="classfst_1_1GrammarFst.html#a1d2cede02beae2c01ae4ca6cbb6c6086">fst::GrammarFst::ExpandStateEnd</a></div><div class="ttdeci">ExpandedState * ExpandStateEnd(int32 instance_id, BaseStateId state_id)</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00222">grammar-fst.cc:222</a></div></div>
<div class="ttc" id="namespacefst_html_a251b709d87fe58fc66599f483fb98bd2a534b236508a8d909dd97b3d7475b75db"><div class="ttname"><a href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a534b236508a8d909dd97b3d7475b75db">fst::kNontermEnd</a></div><div class="ttdef"><b>Definition:</b> <a href="grammar-context-fst_8h_source.html#l00071">grammar-context-fst.h:71</a></div></div>
<div class="ttc" id="namespacefst_html_a251b709d87fe58fc66599f483fb98bd2a912e4937034fa71a1d4dc31c523dc351"><div class="ttname"><a href="namespacefst.html#a251b709d87fe58fc66599f483fb98bd2a912e4937034fa71a1d4dc31c523dc351">fst::kNontermMediumNumber</a></div><div class="ttdef"><b>Definition:</b> <a href="grammar-context-fst_8h_source.html#l00079">grammar-context-fst.h:79</a></div></div>
<div class="ttc" id="group__io__funcs__basic_html_ga108506a9aabafd9006926aa1b47617da"><div class="ttname"><a href="group__io__funcs__basic.html#ga108506a9aabafd9006926aa1b47617da">kaldi::WriteBasicType</a></div><div class="ttdeci">void WriteBasicType(std::ostream &amp;os, bool binary, T t)</div><div class="ttdoc">WriteBasicType is the name of the write function for bool, integer types, and floating-point types...</div><div class="ttdef"><b>Definition:</b> <a href="io-funcs-inl_8h_source.html#l00034">io-funcs-inl.h:34</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFstArc_html_ac3f2f236a15c5a4af29f92c8ce9817ec"><div class="ttname"><a href="structfst_1_1GrammarFstArc.html#ac3f2f236a15c5a4af29f92c8ce9817ec">fst::GrammarFstArc::ilabel</a></div><div class="ttdeci">Label ilabel</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00053">grammar-fst.h:53</a></div></div>
<div class="ttc" id="classfst_1_1ArcIterator_3_01GrammarFst_01_4_html_a659a293dd51073a1b9560bb80f687705"><div class="ttname"><a href="classfst_1_1ArcIterator_3_01GrammarFst_01_4.html#a659a293dd51073a1b9560bb80f687705">fst::ArcIterator&lt; GrammarFst &gt;::Next</a></div><div class="ttdeci">void Next()</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00541">grammar-fst.h:541</a></div></div>
<div class="ttc" id="classfst_1_1ArcIterator_3_01GrammarFst_01_4_html"><div class="ttname"><a href="classfst_1_1ArcIterator_3_01GrammarFst_01_4.html">fst::ArcIterator&lt; GrammarFst &gt;</a></div><div class="ttdoc">This is the overridden template for class ArcIterator for GrammarFst. </div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00488">grammar-fst.h:488</a></div></div>
<div class="ttc" id="namespacefst_html_a2ce371531425ec7d5049f73d839a16c1"><div class="ttname"><a href="namespacefst.html#a2ce371531425ec7d5049f73d839a16c1">fst::CopyToVectorFst</a></div><div class="ttdeci">void CopyToVectorFst(GrammarFst *grammar_fst, VectorFst&lt; StdArc &gt; *vector_fst)</div><div class="ttdoc">This function copies a GrammarFst to a VectorFst (intended mostly for testing and comparison purposes...</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00867">grammar-fst.cc:867</a></div></div>
<div class="ttc" id="classkaldi_1_1FasterDecoder_html_a20d097b045b23dd618a3067dd4e3f915"><div class="ttname"><a href="classkaldi_1_1FasterDecoder.html#a20d097b045b23dd618a3067dd4e3f915">kaldi::FasterDecoder::Weight</a></div><div class="ttdeci">Arc::Weight Weight</div><div class="ttdef"><b>Definition:</b> <a href="faster-decoder_8h_source.html#l00067">faster-decoder.h:67</a></div></div>
<div class="ttc" id="group__error__group_html_gaf8fb55454306b60c9c1e07a6ef9d341a"><div class="ttname"><a href="group__error__group.html#gaf8fb55454306b60c9c1e07a6ef9d341a">KALDI_LOG</a></div><div class="ttdeci">#define KALDI_LOG</div><div class="ttdef"><b>Definition:</b> <a href="kaldi-error_8h_source.html#l00132">kaldi-error.h:132</a></div></div>
<div class="ttc" id="namespacefst_html_a4828391bb3d612ffffaf704c14c30d6a"><div class="ttname"><a href="namespacefst.html#a4828391bb3d612ffffaf704c14c30d6a">fst::GetEncodingMultiple</a></div><div class="ttdeci">int32 GetEncodingMultiple(int32 nonterm_phones_offset)</div><div class="ttdef"><b>Definition:</b> <a href="grammar-context-fst_8h_source.html#l00090">grammar-context-fst.h:90</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_a9601c7b527a729326d873a71b61c8edb"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#a9601c7b527a729326d873a71b61c8edb">fst::GrammarFstPreparer::FixArcsToFinalStates</a></div><div class="ttdeci">void FixArcsToFinalStates(StateId s)</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00689">grammar-fst.cc:689</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFstPreparer_1_1ArcCategory_html_a9cecd6199a2f3b82bb326ed2fb444477"><div class="ttname"><a href="structfst_1_1GrammarFstPreparer_1_1ArcCategory.html#a9cecd6199a2f3b82bb326ed2fb444477">fst::GrammarFstPreparer::ArcCategory::nextstate</a></div><div class="ttdeci">StateId nextstate</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00543">grammar-fst.cc:543</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_a505ff365f90ab7b3851c6c531ad772c2"><div class="ttname"><a href="classfst_1_1GrammarFst.html#a505ff365f90ab7b3851c6c531ad772c2">fst::GrammarFst::Start</a></div><div class="ttdeci">StateId Start() const</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00156">grammar-fst.h:156</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_a56db4c50d7ba7ecdac05db5856374e81"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#a56db4c50d7ba7ecdac05db5856374e81">fst::GrammarFstPreparer::nonterm_phones_offset_</a></div><div class="ttdeci">int32 nonterm_phones_offset_</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00577">grammar-fst.cc:577</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFstPreparer_html_a377361b58f9b7d7fb6f3b739133bda9b"><div class="ttname"><a href="classfst_1_1GrammarFstPreparer.html#a377361b58f9b7d7fb6f3b739133bda9b">fst::GrammarFstPreparer::Label</a></div><div class="ttdeci">Arc::Label Label</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00453">grammar-fst.cc:453</a></div></div>
<div class="ttc" id="structfst_1_1GrammarFstArc_html_ac348b84fbc0a26e6fcf42ea1b47639ca"><div class="ttname"><a href="structfst_1_1GrammarFstArc.html#ac348b84fbc0a26e6fcf42ea1b47639ca">fst::GrammarFstArc::weight</a></div><div class="ttdeci">Weight weight</div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8h_source.html#l00055">grammar-fst.h:55</a></div></div>
<div class="ttc" id="classfst_1_1GrammarFst_html_a9956a77f3a82dfddc07f7ee649d07bc4"><div class="ttname"><a href="classfst_1_1GrammarFst.html#a9956a77f3a82dfddc07f7ee649d07bc4">fst::GrammarFst::DecodeSymbol</a></div><div class="ttdeci">void DecodeSymbol(Label label, int32 *nonterminal_symbol, int32 *left_context_phone)</div><div class="ttdoc">Decodes an ilabel into a pair (nonterminal, left_context_phone). </div><div class="ttdef"><b>Definition:</b> <a href="grammar-fst_8cc_source.html#l00080">grammar-fst.cc:80</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_20fe30135636529d1a58383957a516d7.html">decoder</a></li><li class="navelem"><a class="el" href="grammar-fst_8cc.html">grammar-fst.cc</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
