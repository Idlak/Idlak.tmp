<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Kaldi: nnet3/nnet-optimize-utils.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" /> 
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
 <td id="projectlogo"><a href="http://kaldi-asr.org/"><img alt="Logo" src="KaldiTextAndLogoSmall.png"/ style="padding: 3px 5px 1px 5px"></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname" style="display:none">Kaldi
   </div>
  </td>
    <td style="padding-left: 0.5em;">
    <div id="projectbrief" style="display:none"></div>
    </td>
   <!--END PROJECT_BRIEF-->
  <!--END !PROJECT_NAME-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('nnet-optimize-utils_8cc_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">nnet-optimize-utils.cc</div>  </div>
</div><!--header-->
<div class="contents">
<a href="nnet-optimize-utils_8cc.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">// nnet3/nnet-optimize-utils.cc</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">// Copyright      2015  Johns Hopkins University (author: Daniel Povey)</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">// See ../../COPYING for clarification regarding multiple authors</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">// you may not use this file except in compliance with the License.</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// You may obtain a copy of the License at</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">//  http://www.apache.org/licenses/LICENSE-2.0</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// THIS CODE IS PROVIDED *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">// KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">// WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">// MERCHANTABLITY OR NON-INFRINGEMENT.</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">// See the Apache 2 License for the specific language governing permissions and</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">// limitations under the License.</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &lt;map&gt;</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="nnet-optimize-utils_8h.html">nnet3/nnet-optimize-utils.h</a>&quot;</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="nnet-optimize_8h.html">nnet3/nnet-optimize.h</a>&quot;</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespacekaldi.html">kaldi</a> {</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="keyword">namespace </span>nnet3 {</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div><div class="line"><a name="l00028"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a2ec833031232462f45b425a8a5503489">   28</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a2ec833031232462f45b425a8a5503489">IdentifySubmatrixArgs</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> *c,</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;                           std::vector&lt;int32*&gt; *submatrix_args) {</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;  submatrix_args-&gt;clear();</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;  <span class="keywordflow">switch</span> (c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a>) {</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a73b5995148c3e987c4a163ad6bc9850b">kAllocMatrix</a>:</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae77588ab7fc4ccf842de7ec941247062">kDeallocMatrix</a>:</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a55f8cb2bfd2e2c3605dfa961eff35fa2">kSetConst</a>:</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;      submatrix_args-&gt;push_back(&amp;c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>);</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a8ecee91c55553bcf2d755d00328b0253">kSwapMatrix</a>:</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;      submatrix_args-&gt;push_back(&amp;c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>);</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;      submatrix_args-&gt;push_back(&amp;c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>);</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26ebe2a579bf27a5453cb7b489ad6f69">kPropagate</a>:</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;      submatrix_args-&gt;push_back(&amp;c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>);</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;      submatrix_args-&gt;push_back(&amp;c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ab082999af0bd106d899d3121506053a4">arg4</a>);</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83">kBackprop</a>:</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352afab6637ac4a83d6775366b4e9c42e241">kBackpropNoModelUpdate</a>:</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;      submatrix_args-&gt;push_back(&amp;c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>);</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;      submatrix_args-&gt;push_back(&amp;c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ab082999af0bd106d899d3121506053a4">arg4</a>);</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;      submatrix_args-&gt;push_back(&amp;c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a27787107ac04bc94a8708c2a5c63e092">arg5</a>);</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;      submatrix_args-&gt;push_back(&amp;c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a267b75d3c5f85743c08fb319bd679b1f">arg6</a>);</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a35d3d1a70d075561aaf91b263ea28f74">kMatrixCopy</a>:</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a8ce789ab4782758335cc37349fb97257">kMatrixAdd</a>:</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae9638edeb0ada9a6373257fd508ae11f">kAddRows</a>:</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a308b0ecf9083a7fde572d88f70af6258">kCopyRows</a>:</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a86646468234ab036580a4f2e4d72af3c">kAddRowRanges</a>:</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;      submatrix_args-&gt;push_back(&amp;c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>);</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;      submatrix_args-&gt;push_back(&amp;c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>);</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26009d8f2bc3f61d214925ae25af9962">kAddRowsMulti</a>:</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a341a9c019757a7f1172d86bad51500a5">kCopyRowsMulti</a>:</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a662aa95978d72cd24fde262e35941fad">kAddToRowsMulti</a>:</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a5161c1dfc34a4df1b19e9d3b8dc9499c">kCopyToRowsMulti</a>:</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;      submatrix_args-&gt;push_back(&amp;c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>);</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a6b396f5162883c2f4fb837a2af4b8895">kAcceptInput</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352aaa3fd92744438323baec475cee5b9b3d">kProvideOutput</a>:</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;      submatrix_args-&gt;push_back(&amp;c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>);</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>:</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352af9786d4042a4fcf23b29a14a6fb64126">kNoOperationPermanent</a>:</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352af67517e882c1aebe145a016945b9e6a4">kNoOperationMarker</a>:</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a967844c2c7775d280d15738cbe852536">kNoOperationLabel</a>:</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352add9060e8c7434f250048082c634d9a6d">kGotoLabel</a>:</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="keywordflow">default</span>:</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Unknown command type.&quot;</span>;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  }</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;}</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00080"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#aac8664deabb618f4c3dc3d99d8462ea1">   80</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a2ec833031232462f45b425a8a5503489">IdentifySubmatrixArgs</a>(std::vector&lt;NnetComputation::Command&gt; *commands,</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;                           std::vector&lt;int32*&gt; *submatrix_args) {</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  submatrix_args-&gt;clear();</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  std::vector&lt;NnetComputation::Command&gt;::iterator iter = commands-&gt;begin(),</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;      end = commands-&gt;end();</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  std::vector&lt;int32*&gt; this_submatrix_args;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  <span class="keywordflow">for</span> (; iter != end; ++iter) {</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <a class="code" href="namespacekaldi_1_1nnet3.html#a2ec833031232462f45b425a8a5503489">IdentifySubmatrixArgs</a>(&amp;(*iter), &amp;this_submatrix_args);</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    submatrix_args-&gt;insert(submatrix_args-&gt;end(),</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;                           this_submatrix_args.begin(),</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;                           this_submatrix_args.end());</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  }</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;}</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div><div class="line"><a name="l00096"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#ae8592f4c16a6a1b36c06dccda5511316">   96</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#ae8592f4c16a6a1b36c06dccda5511316">IdentifyMatrixArgsInComputation</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation,</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                                     std::vector&lt;int32*&gt; *matrix_args) {</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  int32 num_submatrices = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.size();</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  matrix_args-&gt;reserve(computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.size());</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  <span class="keywordflow">for</span> (int32 s = 1; s &lt; num_submatrices; s++)</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    matrix_args-&gt;push_back(&amp;(computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s].matrix_index));</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;}</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;</div><div class="line"><a name="l00105"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#af96b480d0b6d2b5890e1490f8c2e6ac0">  105</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#af96b480d0b6d2b5890e1490f8c2e6ac0">IdentifyIndexesMultiArgs</a>(std::vector&lt;NnetComputation::Command&gt; *commands,</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                              std::vector&lt;int32*&gt; *indexes_multi_args) {</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  indexes_multi_args-&gt;clear();</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;  std::vector&lt;NnetComputation::Command&gt;::iterator iter = commands-&gt;begin(),</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;      end = commands-&gt;end();</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;  <span class="keywordflow">for</span> (; iter != end; ++iter) {</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;command = *iter;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="keywordflow">if</span> (command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26009d8f2bc3f61d214925ae25af9962">kAddRowsMulti</a> ||</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a662aa95978d72cd24fde262e35941fad">kAddToRowsMulti</a> ||</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a341a9c019757a7f1172d86bad51500a5">kCopyRowsMulti</a> ||</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a5161c1dfc34a4df1b19e9d3b8dc9499c">kCopyToRowsMulti</a>)</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;      indexes_multi_args-&gt;push_back(&amp;(command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>));</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  }</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;}</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div><div class="line"><a name="l00121"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a17acd598bf1ced7e83e0c8a8569d224f">  121</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a17acd598bf1ced7e83e0c8a8569d224f">IdentifyIndexesRangesArgs</a>(std::vector&lt;NnetComputation::Command&gt; *commands,</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                               std::vector&lt;int32*&gt; *indexes_ranges_args) {</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;  indexes_ranges_args-&gt;clear();</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  std::vector&lt;NnetComputation::Command&gt;::iterator iter = commands-&gt;begin(),</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;      end = commands-&gt;end();</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;  <span class="keywordflow">for</span> (; iter != end; ++iter) {</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;command = *iter;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <span class="keywordflow">if</span> (command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a86646468234ab036580a4f2e4d72af3c">kAddRowRanges</a>)</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;      indexes_ranges_args-&gt;push_back(&amp;(command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>));</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  }</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;}</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div><div class="line"><a name="l00133"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a6950699c83d835e55f003f89bb92bc80">  133</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a6950699c83d835e55f003f89bb92bc80">IdentifyIndexesArgs</a>(std::vector&lt;NnetComputation::Command&gt; *commands,</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                         std::vector&lt;int32*&gt; *indexes_args) {</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;  indexes_args-&gt;clear();</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  std::vector&lt;NnetComputation::Command&gt;::iterator iter = commands-&gt;begin(),</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;      end = commands-&gt;end();</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  <span class="keywordflow">for</span> (; iter != end; ++iter) {</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;command = *iter;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <span class="keywordflow">if</span> (command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a308b0ecf9083a7fde572d88f70af6258">kCopyRows</a> ||</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae9638edeb0ada9a6373257fd508ae11f">kAddRows</a>)</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;      indexes_args-&gt;push_back(&amp;(command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>));</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;  }</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;}</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment">// We declare this class in the .cc file, we don&#39;t need to export it.</span></div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="comment">// It&#39;s used inside RenumberComputation.</span></div><div class="line"><a name="l00148"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html">  148</a></span>&#160;<span class="keyword">class </span><a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html">ComputationRenumberer</a> {</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160; <span class="keyword">public</span>:</div><div class="line"><a name="l00150"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a8f1ed03be326c0cbf0728194d4ac30d0">  150</a></span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a8f1ed03be326c0cbf0728194d4ac30d0">ComputationRenumberer</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation):</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>(computation) { }</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a1920fdb81424ab47c050e27102ddcfd6">Renumber</a>();</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160; <span class="keyword">private</span>:</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;  <span class="comment">// this function removes unused vectors within the indexes_multi_ array, i.e.</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;  <span class="comment">// ones that are not referenced in the computation.</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a4ba6b7dba4c539ad7a149e05b59f80aa">RemoveUnusedIndexesMulti</a>();</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;  <span class="comment">// this function computes the submatrix_is_used_ vector, saying whether each</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  <span class="comment">// of the original submatrices is referenced somewhere.</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a356665946a32706f0cc3c880154ff3ca">ComputeSubmatrixIsUsed</a>();</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  <span class="comment">// this function computes the matrix_is_used_ vector (from the</span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;  <span class="comment">// submatrix_is_used_ vector, from computation_-&gt;input_output_info, and from</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  <span class="comment">// computation_-&gt;commands, saying whether each of the original matrices is</span></div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;  <span class="comment">// referenced somewhere, directly or indirectly.</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a6f8e8995300ee82f98f923a053d66573">ComputeMatrixIsUsed</a>();</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;  <span class="comment">// This function sets up mappings from old to new matrix and submatrix indexes,</span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  <span class="comment">// writing to num_{,sub}matrices_new_ and old_to_new_{,sub}matrix_.</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a777e19363ed62a4364eeb8743e848889">SetUpMappings</a>();</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;  <span class="comment">// This function renumbers submatrix indexes appearing within commands and</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;  <span class="comment">// indexes_multi_, and then removes unused submatrices from the list of</span></div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  <span class="comment">// submatrices while leaving the matrix-indexes at their old values (they will</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;  <span class="comment">// be mapped by RenumberMatrices()).</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#aaa18736d4d5abceba0340d264da8ecd2">RenumberSubmatrices</a>();</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  <span class="comment">// renumber matrix indexes appearing within &#39;commmands&#39;, within &#39;submatrices&#39;</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;  <span class="comment">// and &#39;input_output_info&#39;; renumber &#39;matrices&#39; and if applicable</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;  <span class="comment">// &#39;debug_info&#39;.</span></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ac671ddd1b3a2e51149bc86d7a0965b64">RenumberMatrices</a>();</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;  <span class="comment">// removes duplicates within the indexes_multi array itself.</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a138955c2d9469f28aa78853564c298ce">RemoveIndexesMultiDuplicates</a>();</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;  <span class="comment">// removes unused elements and duplicates within &#39;computation-&gt;indexes&#39;</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a228a7ce7320c66bc72058b3805fec957">RenumberIndexes</a>();</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;  <span class="comment">// removes unused elements and duplicates within &#39;computation-&gt;indexes_ranges&#39;</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a2d58446b9b01c450142c48ec4732b0b6">RenumberIndexesRanges</a>();</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  <span class="comment">// renumbers memos, removing any gaps between memo indexes.</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a221b58d21500493f6a49cdefcd9c5d4f">RenumberMemos</a>();</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div><div class="line"><a name="l00187"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1SubMatrixHasher.html">  187</a></span>&#160;  <span class="keyword">struct </span><a class="code" href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1SubMatrixHasher.html">SubMatrixHasher</a> {</div><div class="line"><a name="l00188"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1SubMatrixHasher.html#afdeb79758745dbc19fd1fab85623feba">  188</a></span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1SubMatrixHasher.html#afdeb79758745dbc19fd1fab85623feba">SubMatrixHasher</a>() { }</div><div class="line"><a name="l00189"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1SubMatrixHasher.html#a1653f8247dc6dcc4f76d44aafaade46d">  189</a></span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1SubMatrixHasher.html#a1653f8247dc6dcc4f76d44aafaade46d">operator () </a>(<span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">NnetComputation::SubMatrixInfo</a> &amp;submat) <span class="keyword">const</span> noexcept {</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;      <span class="comment">// these numbers are arbitrarily chosen primes.</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;      <span class="keywordflow">return</span> submat.matrix_index +</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;          19553 * submat.row_offset +</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;          29297 * submat.num_rows +</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;          42209 * submat.col_offset +</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;          56527 * submat.num_cols;</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    }</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  };</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;  <span class="comment">// Here, T will be int32 or std::pair&lt;int32,int32&gt;</span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;</div><div class="line"><a name="l00202"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1PointerCompare.html">  202</a></span>&#160;  <span class="keyword">struct </span><a class="code" href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1PointerCompare.html">PointerCompare</a> {</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <span class="comment">// This provides an operator &lt; on two vectors of ints or pairs of ints.  It</span></div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="comment">// is designed to provide a total order on the vectors while accessing as</span></div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    <span class="comment">// small a portion of the vectors&#39; data as possible.  It&#39;s used in removing</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    <span class="comment">// duplicates from computation_-&gt;indexes_multi and computation_-&gt;indexes.</span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <span class="comment">// First it compares the length, then it does lexicographical compare.</span></div><div class="line"><a name="l00208"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1PointerCompare.html#a1c3bbc6752630885231247ab062965d9">  208</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1SubMatrixHasher.html#a1653f8247dc6dcc4f76d44aafaade46d">operator ()</a>(<span class="keyword">const</span> std::vector&lt;T&gt; *ptr1,</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;                     <span class="keyword">const</span> std::vector&lt;T&gt; *ptr2)<span class="keyword"> const </span>{</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;      <span class="keywordtype">size_t</span> size1 = ptr1-&gt;size(), size2 = ptr2-&gt;size();</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;      <span class="keywordflow">if</span> (size1 &lt; size2) <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (size1 &gt; size2) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">return</span> (*ptr1 &lt; *ptr2);  <span class="comment">// use the std::vector operator &lt;, which is</span></div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                                    <span class="comment">// lexicographical comparison.</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    }</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;  };</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a04c50ce17b400e39661d1f8a38c05f1e">CreateRenumbering</a>(int32 old_num_elements,</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                                <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;to_remove,</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                                std::vector&lt;int32&gt; *renumbering);</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;  <span class="keyword">static</span> int32 <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a04c50ce17b400e39661d1f8a38c05f1e">CreateRenumbering</a>(<span class="keyword">const</span> std::vector&lt;bool&gt; &amp;used,</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                                 std::vector&lt;int32&gt; *renumbering);</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  <span class="comment">// vector of bool indexed by original submatrix-index, that is true if a</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;  <span class="comment">// submatrix-index is used somewhere in the computation (always true for</span></div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;  <span class="comment">// the zeroth element).</span></div><div class="line"><a name="l00235"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ab9f2139eeea0f81f453a7d514d7fb3d2">  235</a></span>&#160;  std::vector&lt;bool&gt; <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ab9f2139eeea0f81f453a7d514d7fb3d2">submatrix_is_used_</a>;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;  <span class="comment">// vector of bool indexed by original submatrix-index, that is true if a</span></div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;  <span class="comment">// submatrix-index will be kept; this is like submatrix_is_used_; but for</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  <span class="comment">// duplicate submatrices, all but the first duplicate will be marked false).</span></div><div class="line"><a name="l00239"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a741e7e5a1297b3649eddf521ccede5a4">  239</a></span>&#160;  std::vector&lt;bool&gt; <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a741e7e5a1297b3649eddf521ccede5a4">submatrix_is_kept_</a>;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;  <span class="comment">// vector of bool indexed by original-matrix-index &gt; 0, that is true if a</span></div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  <span class="comment">// matrix-index is used somewhere in the computation, directly or indirectly.</span></div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;  <span class="comment">// always true for the zeroth element.</span></div><div class="line"><a name="l00243"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a5ce3b0b9947d694dce936488d805cbc9">  243</a></span>&#160;  std::vector&lt;bool&gt; <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a5ce3b0b9947d694dce936488d805cbc9">matrix_is_used_</a>;</div><div class="line"><a name="l00244"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">  244</a></span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>;</div><div class="line"><a name="l00245"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#af21b8b1c9ede3dc6087eb7f89f7f1b43">  245</a></span>&#160;  int32 <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#af21b8b1c9ede3dc6087eb7f89f7f1b43">num_matrices_new_</a>;</div><div class="line"><a name="l00246"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ab22ae6f823fa687017ff28e30c668156">  246</a></span>&#160;  int32 <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ab22ae6f823fa687017ff28e30c668156">num_submatrices_new_</a>;</div><div class="line"><a name="l00247"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a2e550555b94eb7980bb3f5c0474ef816">  247</a></span>&#160;  std::vector&lt;int32&gt; <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a2e550555b94eb7980bb3f5c0474ef816">old_to_new_matrix_</a>; <span class="comment">// numbered by orig-matrix-index, gives</span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                                         <span class="comment">// new-matrix-index.  -1 for removed</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                                         <span class="comment">// ones.</span></div><div class="line"><a name="l00250"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ac9050b561913ee338e9a5b75d1671ac9">  250</a></span>&#160;  std::vector&lt;int32&gt; <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ac9050b561913ee338e9a5b75d1671ac9">old_to_new_submatrix_</a>; <span class="comment">// numbered by orig-submatrix-index,</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                                            <span class="comment">// gives new-submatrix-index.  -1</span></div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                                            <span class="comment">// for removed ones.</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;};</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment">// static</span></div><div class="line"><a name="l00256"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a1c72f841b34be9e125b5268514c72331">  256</a></span>&#160;int32 <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a04c50ce17b400e39661d1f8a38c05f1e">ComputationRenumberer::CreateRenumbering</a>(</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="keyword">const</span> std::vector&lt;bool&gt; &amp;used,</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    std::vector&lt;int32&gt; *renumbering) {</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;  renumbering-&gt;clear();</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;  renumbering-&gt;reserve(used.size());</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;  std::vector&lt;bool&gt;::const_iterator iter = used.begin(), end = used.end();</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;  int32 cur_index = 0;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;  <span class="keywordflow">for</span> (; iter != end; ++iter) {</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordflow">if</span> (*iter) renumbering-&gt;push_back(cur_index++);</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    <span class="keywordflow">else</span> renumbering-&gt;push_back(-1);</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;  }</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;  <span class="keywordflow">return</span> cur_index;</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;}</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">// static</span></div><div class="line"><a name="l00271"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a04c50ce17b400e39661d1f8a38c05f1e">  271</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a04c50ce17b400e39661d1f8a38c05f1e">ComputationRenumberer::CreateRenumbering</a>(</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    int32 old_num_elements,</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;to_remove,</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    std::vector&lt;int32&gt; *renumbering) {</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(<a class="code" href="namespacekaldi.html#a81dfa76eeac63eba502e32ee58e37d57">IsSortedAndUniq</a>(to_remove) &amp;&amp; old_num_elements &gt; 0);</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;  renumbering-&gt;clear();</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;  renumbering-&gt;resize(old_num_elements, 0);</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;  int32 num_remove = to_remove.size();</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;  <span class="keywordflow">for</span> (int32 r = 0; r &lt; num_remove; r++) {</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    int32 this_remove = to_remove[r];</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    <span class="comment">// the &quot;&gt; 0&quot; would be &quot;&gt;= 0&quot; in a more generic context, but zero is</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    <span class="comment">// not valid in this particular application.</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(this_remove &gt; 0 &amp;&amp; this_remove &lt; old_num_elements);</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    (*renumbering)[this_remove] = -1;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;  }</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;  int32 cur_number = 0;</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; old_num_elements; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <span class="keywordflow">if</span> ((*renumbering)[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] != -1)</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;      (*renumbering)[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = cur_number++;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;  }</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(cur_number == old_num_elements -</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;               static_cast&lt;int32&gt;(to_remove.size()));</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;}</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;</div><div class="line"><a name="l00296"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a221b58d21500493f6a49cdefcd9c5d4f">  296</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a221b58d21500493f6a49cdefcd9c5d4f">ComputationRenumberer::RenumberMemos</a>() {</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;  <span class="comment">// this is indexed by memo-index, and maps to the</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;  <span class="comment">// (propagate, backprop) commands that use that memo-index, or</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;  <span class="comment">// (-1, -1) if there are no such commands.</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;  std::vector&lt;std::pair&lt;int32, int32&gt; &gt; memo_to_commands;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;  std::vector&lt;int32&gt; memo_indexes_used;</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;  std::pair&lt;int32, int32&gt; blank(-1, -1);</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;  int32 num_commands = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size();</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;  <span class="keywordflow">for</span> (int32 c = 0; c &lt; num_commands; c++) {</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;command = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[c];</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="keywordflow">if</span> (command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26ebe2a579bf27a5453cb7b489ad6f69">kPropagate</a>) {</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;      int32 memo_index = command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a27787107ac04bc94a8708c2a5c63e092">arg5</a>;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;      <span class="keywordflow">if</span> (memo_index &gt; 0) {</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        <span class="keywordflow">if</span> (memo_to_commands.size() &lt;= <span class="keyword">static_cast&lt;</span><span class="keywordtype">size_t</span><span class="keyword">&gt;</span>(memo_index))</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;          memo_to_commands.resize(memo_index + 1, blank);</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(memo_to_commands[memo_index].first == -1);</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        memo_to_commands[memo_index].first = c;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        memo_indexes_used.push_back(memo_index);</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;      }</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83">kBackprop</a>) {</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;      int32 memo_index = command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a299b2046550515733509b29583ea605c">arg7</a>;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;      <span class="keywordflow">if</span> (memo_index &gt; 0) {</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        <span class="keywordflow">if</span> (memo_to_commands.size() &lt;= <span class="keyword">static_cast&lt;</span><span class="keywordtype">size_t</span><span class="keyword">&gt;</span>(memo_index))</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;          memo_to_commands.resize(memo_index + 1, blank);</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(memo_to_commands[memo_index].first &gt; 0 &amp;&amp;</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                     memo_to_commands[memo_index].second == -1);</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        memo_to_commands[memo_index].second = c;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;      }</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    }</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;  }</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;  int32 new_memo_index = 1;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;  <span class="keywordflow">for</span> (std::vector&lt;int32&gt;::iterator iter = memo_indexes_used.begin();</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;       iter != memo_indexes_used.end(); ++iter) {</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    int32 memo_index = *iter;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    int32 propagate_command = memo_to_commands[memo_index].first,</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        backprop_command = memo_to_commands[memo_index].second;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(backprop_command &gt; 0 &amp;&amp;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                 <span class="stringliteral">&quot;Propagate generates memo but backprop doesn&#39;t use it.&quot;</span>);</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[propagate_command].arg5 = new_memo_index;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[backprop_command].arg7 = new_memo_index;</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    new_memo_index++;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;  }</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;}</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;</div><div class="line"><a name="l00340"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#af87da4e8a0e1880438bf77e8a34b4143">  340</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#af87da4e8a0e1880438bf77e8a34b4143">IdentifySubmatrixArgsInComputation</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation,</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                                        std::vector&lt;int32*&gt; *submatrix_args) {</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a2ec833031232462f45b425a8a5503489">IdentifySubmatrixArgs</a>(&amp;(computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>), submatrix_args);</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;  <span class="keywordtype">size_t</span> extra_size = 0;</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++)</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    extra_size += computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].size();</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;  submatrix_args-&gt;reserve(submatrix_args-&gt;size() + extra_size);</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;indexes_multi =</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    std::vector&lt;std::pair&lt;int32, int32&gt; &gt;::iterator</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        iter = indexes_multi.begin(), end = indexes_multi.end();</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <span class="keywordflow">for</span> (; iter != end; ++iter)</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;      <span class="keywordflow">if</span> (iter-&gt;first != -1)</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        submatrix_args-&gt;push_back(&amp;(iter-&gt;first));</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;  }</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;}</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;</div><div class="line"><a name="l00361"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a356665946a32706f0cc3c880154ff3ca">  361</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a356665946a32706f0cc3c880154ff3ca">ComputationRenumberer::ComputeSubmatrixIsUsed</a>() {</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;  int32 num_submatrices = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.size();</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ab9f2139eeea0f81f453a7d514d7fb3d2">submatrix_is_used_</a>.clear();</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ab9f2139eeea0f81f453a7d514d7fb3d2">submatrix_is_used_</a>.resize(num_submatrices, <span class="keyword">false</span>);</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ab9f2139eeea0f81f453a7d514d7fb3d2">submatrix_is_used_</a>[0] = <span class="keyword">true</span>;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  <span class="comment">// the zeroth element of the array is &#39;special&#39;, it refers to the</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;  <span class="comment">// zero submatrix, and we don&#39;t want to renumber it.</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;  std::vector&lt;int32*&gt; submatrix_args;</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#af87da4e8a0e1880438bf77e8a34b4143">IdentifySubmatrixArgsInComputation</a>(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>, &amp;submatrix_args);</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;  std::vector&lt;int32*&gt;::iterator iter = submatrix_args.begin(),</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;      end = submatrix_args.end();</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;  int32 cur_submatrix_index = -1;  <span class="comment">// an optimization to avoid too many</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                                   <span class="comment">// indexings of the bool vector</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                                   <span class="comment">// submatrix_is_used_.</span></div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;  <span class="keywordflow">for</span> (; iter != end; ++iter) {</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    int32 submatrix_index = **iter;</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="keywordflow">if</span> (submatrix_index &gt; 0 &amp;&amp; submatrix_index != cur_submatrix_index) {</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;      cur_submatrix_index = submatrix_index;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;      <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(submatrix_index &lt; num_submatrices);</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ab9f2139eeea0f81f453a7d514d7fb3d2">submatrix_is_used_</a>[submatrix_index] = <span class="keyword">true</span>;</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    }</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;  }</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;}</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;</div><div class="line"><a name="l00385"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a6f8e8995300ee82f98f923a053d66573">  385</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a6f8e8995300ee82f98f923a053d66573">ComputationRenumberer::ComputeMatrixIsUsed</a>() {</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a5ce3b0b9947d694dce936488d805cbc9">matrix_is_used_</a>.clear();</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a5ce3b0b9947d694dce936488d805cbc9">matrix_is_used_</a>.resize(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>.size(), <span class="keyword">false</span>);</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a5ce3b0b9947d694dce936488d805cbc9">matrix_is_used_</a>[0] = <span class="keyword">true</span>;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;  <span class="comment">// We also need to take into account when matrices are used indirectly via</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;  <span class="comment">// submatrices (which is actually the main way they are accessed).</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;  int32 num_submatrices = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.size();</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;  <span class="keywordflow">for</span> (int32 s = 1; s &lt; num_submatrices; s++) {</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    int32 matrix_index = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s].matrix_index;</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ab9f2139eeea0f81f453a7d514d7fb3d2">submatrix_is_used_</a>[s])</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a5ce3b0b9947d694dce936488d805cbc9">matrix_is_used_</a>[matrix_index] = <span class="keyword">true</span>;</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;  }</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;}</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;</div><div class="line"><a name="l00401"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a777e19363ed62a4364eeb8743e848889">  401</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a777e19363ed62a4364eeb8743e848889">ComputationRenumberer::SetUpMappings</a>() {</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#af21b8b1c9ede3dc6087eb7f89f7f1b43">num_matrices_new_</a> = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a04c50ce17b400e39661d1f8a38c05f1e">CreateRenumbering</a>(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a5ce3b0b9947d694dce936488d805cbc9">matrix_is_used_</a>, &amp;<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a2e550555b94eb7980bb3f5c0474ef816">old_to_new_matrix_</a>);</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;  unordered_map&lt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">NnetComputation::SubMatrixInfo</a>, int32,</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;                <a class="code" href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1SubMatrixHasher.html">SubMatrixHasher</a>&gt; submat_map;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;  int32 cur_index = 1, num_submatrices_orig =</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.size();</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;  <span class="comment">// the old_to_new_submatrix_ map will remove duplicates.</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;  <span class="comment">// -1&#39;s will appear wherever a particular submatrix was never used.</span></div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a741e7e5a1297b3649eddf521ccede5a4">submatrix_is_kept_</a> = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ab9f2139eeea0f81f453a7d514d7fb3d2">submatrix_is_used_</a>;</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ac9050b561913ee338e9a5b75d1671ac9">old_to_new_submatrix_</a>.resize(num_submatrices_orig, -1);</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ac9050b561913ee338e9a5b75d1671ac9">old_to_new_submatrix_</a>[0] = 0;</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;  <span class="keywordflow">for</span> (int32 s = 1; s &lt; num_submatrices_orig; s++) {</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ab9f2139eeea0f81f453a7d514d7fb3d2">submatrix_is_used_</a>[s]) {</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;      <span class="keyword">const</span> NnetComputation::SubMatrixInfo &amp;info =</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;          <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s];</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;      <span class="keywordflow">if</span> (submat_map.count(info) &gt; 0) {  <span class="comment">// a duplicate...</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ac9050b561913ee338e9a5b75d1671ac9">old_to_new_submatrix_</a>[s] = submat_map[info];</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a741e7e5a1297b3649eddf521ccede5a4">submatrix_is_kept_</a>[s] = <span class="keyword">false</span>;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ac9050b561913ee338e9a5b75d1671ac9">old_to_new_submatrix_</a>[s] = (submat_map[info] = cur_index++);</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;      }</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    }</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;  }</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ab22ae6f823fa687017ff28e30c668156">num_submatrices_new_</a> = cur_index;</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;}</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;</div><div class="line"><a name="l00428"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#aaa18736d4d5abceba0340d264da8ecd2">  428</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#aaa18736d4d5abceba0340d264da8ecd2">ComputationRenumberer::RenumberSubmatrices</a>() {</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;  std::vector&lt;int32*&gt; submatrix_args;</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#af87da4e8a0e1880438bf77e8a34b4143">IdentifySubmatrixArgsInComputation</a>(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>, &amp;submatrix_args);</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;  std::vector&lt;int32*&gt;::iterator iter = submatrix_args.begin(),</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;      end = submatrix_args.end();</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;  <span class="keywordflow">for</span> (; iter != end; ++iter) {</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="keywordflow">if</span> (**iter &gt; 0) {</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;      int32 new_submatrix_index = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ac9050b561913ee338e9a5b75d1671ac9">old_to_new_submatrix_</a>[**iter];</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;      <span class="comment">// old_to_new_submatrix_[s] for s &gt; 0 is only &lt;= 0 (actually, -1) for</span></div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;      <span class="comment">// submatrices that are never accessed, and these should never appear</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;      <span class="comment">// in this list.</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;      <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(new_submatrix_index &gt; 0);</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;      **iter = new_submatrix_index;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    }</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;  }</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;  std::vector&lt;NnetComputation::SubMatrixInfo&gt; new_submatrices;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;  int32 num_submatrices_old = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.size();</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;  new_submatrices.reserve(num_submatrices_old);</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;  <span class="keywordflow">for</span> (int32 s = 0; s &lt; num_submatrices_old; s++)</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a741e7e5a1297b3649eddf521ccede5a4">submatrix_is_kept_</a>[s])</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;      new_submatrices.push_back(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s]);</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.swap(new_submatrices);</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;  <span class="comment">// We&#39;ll map the matrix indexes inside computation_-&gt;submatrices</span></div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;  <span class="comment">// when we call RenumberMatrices().</span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;}</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;</div><div class="line"><a name="l00454"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ac671ddd1b3a2e51149bc86d7a0965b64">  454</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ac671ddd1b3a2e51149bc86d7a0965b64">ComputationRenumberer::RenumberMatrices</a>() {</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;  std::vector&lt;int32*&gt; matrix_args;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;  int32 num_submatrices = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.size();</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;  <span class="keywordflow">for</span> (int32 s = 1; s &lt; num_submatrices; s++) {</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    int32 *matrix_index = &amp;(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s].matrix_index);</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    <span class="comment">// old_to_new_matrix_[s] for s &gt; 0 is only &lt;= 0 (actually, -1) for</span></div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    <span class="comment">// submatrices that are never accessed, and these should never appear</span></div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    <span class="comment">// in this list.  (presumably because we renumber the submatrices first).</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    int32 new_matrix_index = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a2e550555b94eb7980bb3f5c0474ef816">old_to_new_matrix_</a>[*matrix_index];</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(new_matrix_index &gt; 0);</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;    *matrix_index = new_matrix_index;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;  }</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  std::vector&lt;NnetComputation::MatrixInfo&gt; new_matrices;</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;  int32 num_matrices_old = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>.size();</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;  new_matrices.reserve(num_matrices_old);</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;  <span class="keywordflow">for</span> (int32 m = 0; m &lt; num_matrices_old; m++)</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a5ce3b0b9947d694dce936488d805cbc9">matrix_is_used_</a>[m])</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;      new_matrices.push_back(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m]);</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>.swap(new_matrices);</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;  std::vector&lt;NnetComputation::MatrixDebugInfo&gt; new_debug_info;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;  int32 debug_info_size = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.size();</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(debug_info_size == 0 || debug_info_size == num_matrices_old);</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;  new_debug_info.reserve(debug_info_size);</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;  <span class="keywordflow">for</span> (int32 m = 0; m &lt; debug_info_size; m++) {</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a5ce3b0b9947d694dce936488d805cbc9">matrix_is_used_</a>[m]) {</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;      new_debug_info.push_back(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a>());</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;      new_debug_info.back().Swap(&amp;(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[m]));</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    }</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;  }</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.swap(new_debug_info);</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;}</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;</div><div class="line"><a name="l00489"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a1920fdb81424ab47c050e27102ddcfd6">  489</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a1920fdb81424ab47c050e27102ddcfd6">ComputationRenumberer::Renumber</a>() {</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a4ba6b7dba4c539ad7a149e05b59f80aa">RemoveUnusedIndexesMulti</a>();</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a356665946a32706f0cc3c880154ff3ca">ComputeSubmatrixIsUsed</a>();</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a6f8e8995300ee82f98f923a053d66573">ComputeMatrixIsUsed</a>();</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a777e19363ed62a4364eeb8743e848889">SetUpMappings</a>();</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#aaa18736d4d5abceba0340d264da8ecd2">RenumberSubmatrices</a>();</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ac671ddd1b3a2e51149bc86d7a0965b64">RenumberMatrices</a>();</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a138955c2d9469f28aa78853564c298ce">RemoveIndexesMultiDuplicates</a>();</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a228a7ce7320c66bc72058b3805fec957">RenumberIndexes</a>();</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a2d58446b9b01c450142c48ec4732b0b6">RenumberIndexesRanges</a>();</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a221b58d21500493f6a49cdefcd9c5d4f">RenumberMemos</a>();</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;}</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;</div><div class="line"><a name="l00502"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a4ba6b7dba4c539ad7a149e05b59f80aa">  502</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a4ba6b7dba4c539ad7a149e05b59f80aa">ComputationRenumberer::RemoveUnusedIndexesMulti</a>() {</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;  int32 num_indexes_multi = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>.size();</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;  <span class="keywordflow">if</span> (num_indexes_multi == 0)</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    <span class="keywordflow">return</span>;  <span class="comment">// Nothing to do.  An optimization.</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;  std::vector&lt;bool&gt; indexes_multi_used(num_indexes_multi, <span class="keyword">false</span>);</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;  std::vector&lt;int32*&gt; indexes_multi_args;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#af96b480d0b6d2b5890e1490f8c2e6ac0">IdentifyIndexesMultiArgs</a>(&amp;(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>), &amp;indexes_multi_args);</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;  std::vector&lt;int32*&gt;::iterator iter = indexes_multi_args.begin(),</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;      end = indexes_multi_args.end();</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;  <span class="keywordflow">for</span> (; iter != end; ++iter) {</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    int32 indexes_multi_index = **iter;</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(indexes_multi_index &gt;= 0 &amp;&amp;</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                 indexes_multi_index &lt; num_indexes_multi);</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    indexes_multi_used[indexes_multi_index] = 1;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;  }</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;  <span class="comment">// old-&gt;new mapping for the indexes_multi arrays.  will remain -1 for</span></div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;  <span class="comment">// ones that are unused.</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;  std::vector&lt;int32&gt; old_to_new(num_indexes_multi, -1);</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;  int32 new_num_indexes_multi = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a04c50ce17b400e39661d1f8a38c05f1e">CreateRenumbering</a>(indexes_multi_used,</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                                                  &amp;old_to_new);</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;  <span class="keywordflow">if</span> (new_num_indexes_multi == num_indexes_multi)</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    <span class="keywordflow">return</span>;  <span class="comment">// Nothing to do.  An optimization.</span></div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;  std::vector&lt;std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &gt;</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;      new_indexes_multi(new_num_indexes_multi);</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; num_indexes_multi; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    <span class="keywordflow">if</span> (old_to_new[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] != -1)</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;      new_indexes_multi[old_to_new[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>]].swap(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>]);</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;  }</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>.swap(new_indexes_multi);</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;  <span class="comment">// renumber within the commands.</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;  <span class="keywordflow">for</span> (iter = indexes_multi_args.begin(); iter != end; ++iter)</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    **iter = old_to_new[**iter];</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;}</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="comment">// removes duplicates within the indexes_multi_ array itself.</span></div><div class="line"><a name="l00538"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a138955c2d9469f28aa78853564c298ce">  538</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a138955c2d9469f28aa78853564c298ce">ComputationRenumberer::RemoveIndexesMultiDuplicates</a>() {</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;  int32 cur_index = 0,</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;      old_indexes_multi_size = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>.size();</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;  <span class="keywordflow">if</span> (old_indexes_multi_size == 0)</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;  <span class="comment">// create index mapping from old to new.  the use of map is generally not that</span></div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;  <span class="comment">// efficient, but the idea here is that we can do most of the comparisons just</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;  <span class="comment">// based on the size of the vectors, and avoid even visiting most of their</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;  <span class="comment">// contents.</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;  std::vector&lt;int32&gt; indexes_multi_old_to_new(old_indexes_multi_size);</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;  <span class="keyword">typedef</span> std::vector&lt;std::pair&lt;int32,int32&gt; &gt; PairVectorType;</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;  <span class="keyword">typedef</span> std::map&lt;<span class="keyword">const</span> PairVectorType*, int32,</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;                   <a class="code" href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1PointerCompare.html">PointerCompare&lt;std::pair&lt;int32,int32&gt;</a> &gt; &gt; MapType;</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;  MapType indexes_multi_map;</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    std::pair&lt;MapType::iterator, bool&gt; p =</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;        indexes_multi_map.insert(std::pair&lt;const PairVectorType*, int32&gt;(</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;            &amp;(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>]), cur_index));</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    <span class="keywordflow">if</span> (p.second) {  <span class="comment">// was inserted-- was not there already.</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;      indexes_multi_old_to_new[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = cur_index++;</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;      int32 index_from_map = p.first-&gt;second;</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;      indexes_multi_old_to_new[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = index_from_map;</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;    }</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;  }</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;  <span class="keywordflow">if</span> (cur_index == old_indexes_multi_size)</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    <span class="keywordflow">return</span>;  <span class="comment">// An optimization.  No duplicates were found.</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;  std::vector&lt;PairVectorType&gt; new_indexes_multi(cur_index);</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; old_indexes_multi_size; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    int32 new_index = indexes_multi_old_to_new[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].swap(new_indexes_multi[new_index]);</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;  }</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>.swap(new_indexes_multi);</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;  std::vector&lt;int32*&gt; indexes_multi_args;</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#af96b480d0b6d2b5890e1490f8c2e6ac0">IdentifyIndexesMultiArgs</a>(&amp;(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>), &amp;indexes_multi_args);</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;  std::vector&lt;int32*&gt;::const_iterator iter = indexes_multi_args.begin(),</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;      end = indexes_multi_args.end();</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;  <span class="keywordflow">for</span> (; iter != end; ++iter)</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    **iter = indexes_multi_old_to_new[**iter];</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;}</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div><div class="line"><a name="l00581"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a228a7ce7320c66bc72058b3805fec957">  581</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a228a7ce7320c66bc72058b3805fec957">ComputationRenumberer::RenumberIndexes</a>() {</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;  int32 old_num_indexes = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>.size();</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;  <span class="keywordflow">if</span> (old_num_indexes == 0)</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;  std::vector&lt;int32*&gt; indexes_args;</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a6950699c83d835e55f003f89bb92bc80">IdentifyIndexesArgs</a>(&amp;(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>), &amp;indexes_args);</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;  std::vector&lt;bool&gt; indexes_seen(old_num_indexes, <span class="keyword">false</span>);</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;  std::vector&lt;int32*&gt;::const_iterator iter = indexes_args.begin(),</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;      end = indexes_args.end();</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;  <span class="keywordflow">for</span> (; iter != end; ++iter)</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    indexes_seen[**iter] = <span class="keyword">true</span>;</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;  std::vector&lt;int32&gt; old_to_new_index(old_num_indexes);</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;  <span class="keyword">typedef</span> std::map&lt;const std::vector&lt;int32&gt;*, int32,</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                   <a class="code" href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1PointerCompare.html">PointerCompare&lt;int32&gt;</a> &gt; MapType;</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;  MapType indexes_map;</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;  int32 cur_index = 0;</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; old_num_indexes; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    <span class="keywordflow">if</span> (!indexes_seen[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>]) {</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;      old_to_new_index[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = -1;</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;      std::pair&lt;MapType::iterator, bool&gt; p =</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;          indexes_map.insert(std::pair&lt;<span class="keyword">const</span> std::vector&lt;int32&gt;*, int32&gt;(</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;              &amp;(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>[i]), cur_index));</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;      <span class="keywordflow">if</span> (p.second) {  <span class="comment">// was inserted-- was not there already.</span></div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;        old_to_new_index[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = cur_index++;</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;        int32 index_from_map = p.first-&gt;second;</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;        old_to_new_index[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = index_from_map;</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;      }</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    }</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;  }</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;  <span class="keywordflow">if</span> (cur_index == old_num_indexes)</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;    <span class="keywordflow">return</span>;  <span class="comment">// An optimization.  No changes to the numbering are made.</span></div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;  std::vector&lt;std::vector&lt;int32&gt; &gt; new_indexes(cur_index);</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; old_num_indexes; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    int32 new_index = old_to_new_index[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    <span class="keywordflow">if</span> (new_index != -1)</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].swap(new_indexes[new_index]);</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;  }</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>.swap(new_indexes);</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;  <span class="comment">// renumber the indexes inside the commmands.</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;  <span class="keywordflow">for</span> (iter = indexes_args.begin(); iter != end; ++iter) {</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    int32 old_index = **iter;</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(old_index &gt;= 0 &amp;&amp; old_index &lt; old_num_indexes);</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    int32 new_index = old_to_new_index[old_index];</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(new_index &gt;= 0);</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;    **iter = new_index;</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;  }</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;}</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;</div><div class="line"><a name="l00635"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a2d58446b9b01c450142c48ec4732b0b6">  635</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a2d58446b9b01c450142c48ec4732b0b6">ComputationRenumberer::RenumberIndexesRanges</a>() {</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;  int32 old_num_indexes_ranges = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a3095d45a751aaa81c1024cf9510e2ed7">indexes_ranges</a>.size();</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;  <span class="keywordflow">if</span> (old_num_indexes_ranges == 0)</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;  std::vector&lt;int32*&gt; indexes_ranges_args;</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a17acd598bf1ced7e83e0c8a8569d224f">IdentifyIndexesRangesArgs</a>(&amp;(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>), &amp;indexes_ranges_args);</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;  std::vector&lt;bool&gt; is_seen(old_num_indexes_ranges, <span class="keyword">false</span>);</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;  std::vector&lt;int32*&gt;::const_iterator iter = indexes_ranges_args.begin(),</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;      end = indexes_ranges_args.end();</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;  <span class="keywordflow">for</span> (; iter != end; ++iter)</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    is_seen[**iter] = <span class="keyword">true</span>;</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;  std::vector&lt;int32&gt; old_to_new_index(old_num_indexes_ranges);</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;  <span class="keyword">typedef</span> std::map&lt;const std::vector&lt;std::pair&lt;int32, int32&gt; &gt;*, int32,</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                   <a class="code" href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1PointerCompare.html">PointerCompare&lt;std::pair&lt;int32, int32&gt;</a> &gt; &gt; MapType;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;  MapType indexes_map;</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;  int32 cur_index = 0;</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; old_num_indexes_ranges; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;    <span class="keywordflow">if</span> (!is_seen[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>]) {</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;      old_to_new_index[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = -1;</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;      std::pair&lt;MapType::iterator, bool&gt; p =</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;          indexes_map.insert(</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;              std::pair&lt;<span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt;*, int32&gt;(</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;                  &amp;(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a3095d45a751aaa81c1024cf9510e2ed7">indexes_ranges</a>[i]), cur_index));</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;      <span class="keywordflow">if</span> (p.second) {  <span class="comment">// was inserted-- was not there already.</span></div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;        old_to_new_index[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = cur_index++;</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;        int32 index_from_map = p.first-&gt;second;</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;        old_to_new_index[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = index_from_map;</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;      }</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;    }</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;  }</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;  <span class="keywordflow">if</span> (cur_index == old_num_indexes_ranges)</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    <span class="keywordflow">return</span>;  <span class="comment">// An optimization.  No changes to the numbering are made.</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;  std::vector&lt;std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &gt; new_indexes_ranges(</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;      cur_index);</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; old_num_indexes_ranges; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    int32 new_index = old_to_new_index[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    <span class="keywordflow">if</span> (new_index != -1)</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a3095d45a751aaa81c1024cf9510e2ed7">indexes_ranges</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].swap(new_indexes_ranges[new_index]);</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;  }</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a3095d45a751aaa81c1024cf9510e2ed7">indexes_ranges</a>.swap(new_indexes_ranges);</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;  <span class="comment">// renumber the indexes inside the commmands.</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;  <span class="keywordflow">for</span> (iter = indexes_ranges_args.begin(); iter != end; ++iter) {</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    int32 old_index = **iter;</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(old_index &gt;= 0 &amp;&amp; old_index &lt; old_num_indexes_ranges);</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    int32 new_index = old_to_new_index[old_index];</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(new_index &gt;= 0);</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    **iter = new_index;</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;  }</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;}</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;</div><div class="line"><a name="l00693"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a6828e427bd8883455705e0c9b99b5f2f">  693</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a6828e427bd8883455705e0c9b99b5f2f">RenumberComputation</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation) {</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html">ComputationRenumberer</a> renumberer(computation);</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;  renumberer.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a1920fdb81424ab47c050e27102ddcfd6">Renumber</a>();</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;}</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;</div><div class="line"><a name="l00699"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#ae3ebe9f7e8bfc061d7582b3964698e4e">  699</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="namespacekaldi_1_1nnet3.html#ae3ebe9f7e8bfc061d7582b3964698e4e">IsNoop</a>(<span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;command) {</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;  <span class="keywordflow">return</span> command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;}</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;</div><div class="line"><a name="l00703"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a1146f4efa141a56210f9dbf1090b20f0">  703</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a1146f4efa141a56210f9dbf1090b20f0">RemoveNoOps</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation) {</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;  computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.erase(</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;      std::remove_if(computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.begin(),</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;                     computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.end(),</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;                     <a class="code" href="namespacekaldi_1_1nnet3.html#ae3ebe9f7e8bfc061d7582b3964698e4e">IsNoop</a>), computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.end());</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;}</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;</div><div class="line"><a name="l00711"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a65d0ad3958501631af43a076c556a8d8">  711</a></span>&#160;<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a65d0ad3958501631af43a076c556a8d8">VariableMergingOptimizer::VariableMergingOptimizer</a>(</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetOptimizeOptions.html">NnetOptimizeOptions</a> &amp;config,</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    <span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;nnet,</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation):</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    config_(config), nnet_(nnet),</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>(computation),</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;    already_called_merge_variables_(false) {</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#ac8ca96df1ecdb635738c59a88cff8835">analyzer_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html#aab8a145e53802c80302dc498e388a2ad">Init</a>(nnet, *computation);</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a7468a5d6108f9a2f81b9b79b82866354">ComputeMatrixToSubmatrix</a>(*<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>, &amp;<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a0655730456d3a04cafe943687894a84d">matrix_to_submatrix_</a>);</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a63de82c33f6a7330727c0f2fc670ae0d">variable_dirty_</a>.resize(<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#ac8ca96df1ecdb635738c59a88cff8835">analyzer_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html#afe662460f3e8b135d96fcd057638bd28">variables</a>.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationVariables.html#a869ebf8f8238163a6c89ab096a6fcacf">NumVariables</a>(), <span class="keyword">false</span>);</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;}</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;</div><div class="line"><a name="l00723"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a08a57d03b1828eeb8548ee5e8a942264">  723</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a08a57d03b1828eeb8548ee5e8a942264">VariableMergingOptimizer::MergeVariables</a>() {</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a400e33db7a90834eec20a7eee34f162d">already_called_merge_variables_</a>);</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a400e33db7a90834eec20a7eee34f162d">already_called_merge_variables_</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;  <span class="keywordflow">if</span> (!<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a4dcce2ef4364ac3b222debac11646a39">config_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetOptimizeOptions.html#ada3212723faff5ad5d718401c2b14abd">optimize</a>)</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;  <span class="keywordtype">bool</span> merged = <span class="keyword">false</span>;</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;  int32 num_commands = <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size();</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;  <span class="keywordflow">for</span> (int32 command_index = 0; command_index &lt; num_commands;</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;       command_index++) {</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;    <span class="comment">// This loop looks for pairs of sub-matrix indexes s1,s2 that we could</span></div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    <span class="comment">// potentially merge into a single variable.</span></div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c = <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    int32 s1 = -1, s2 = -1;</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    <span class="keywordflow">if</span> (c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a35d3d1a70d075561aaf91b263ea28f74">kMatrixCopy</a> &amp;&amp;</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a4dcce2ef4364ac3b222debac11646a39">config_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetOptimizeOptions.html#a5a9cf0a0e6fa879ef136d18e4b3a7493">remove_assignments</a>) {</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;      s2 = c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>;  <span class="comment">// s2 is the written-to matrix.</span></div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;      s1 = c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>;</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26ebe2a579bf27a5453cb7b489ad6f69">kPropagate</a> &amp;&amp;</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;               <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a4dcce2ef4364ac3b222debac11646a39">config_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetOptimizeOptions.html#a8de177378a5c3ef537b9d5927012427d">propagate_in_place</a>) {</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;      <span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Component.html">Component</a> *component = <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#adbabf05a7702103113a02a113015205f">nnet_</a>.<a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html#aec8d6dfed3e4ab080d3ff4cf6a1126e3">GetComponent</a>(c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>);</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;      <span class="keywordflow">if</span> (component-&gt;<a class="code" href="classkaldi_1_1nnet3_1_1Component.html#a3a4ff15fafe0c8c4885586fc2c36ca8a">Properties</a>() &amp; <a class="code" href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a2f52823d0c7fdc03b0be47662c66146d">kPropagateInPlace</a>) {</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        s1 = c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>;</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;        s2 = c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ab082999af0bd106d899d3121506053a4">arg4</a>;  <span class="comment">// s2 is the written-to matrix.</span></div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;      }</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83">kBackprop</a> ||</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;                c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352afab6637ac4a83d6775366b4e9c42e241">kBackpropNoModelUpdate</a>) &amp;&amp;</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;               <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a4dcce2ef4364ac3b222debac11646a39">config_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetOptimizeOptions.html#a751610db82b663a3b2b415a839b0cad4">backprop_in_place</a>) {</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;      <span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Component.html">Component</a> *component = <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#adbabf05a7702103113a02a113015205f">nnet_</a>.<a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html#aec8d6dfed3e4ab080d3ff4cf6a1126e3">GetComponent</a>(c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>);</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;      <span class="keywordflow">if</span> (component-&gt;<a class="code" href="classkaldi_1_1nnet3_1_1Component.html#a3a4ff15fafe0c8c4885586fc2c36ca8a">Properties</a>() &amp; <a class="code" href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3abaa0f1d8521d4753ffae9f2cc22a15df">kBackpropInPlace</a>) {</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;        s1 = c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a27787107ac04bc94a8708c2a5c63e092">arg5</a>;</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;        s2 = c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a267b75d3c5f85743c08fb319bd679b1f">arg6</a>;  <span class="comment">// s2 is the written-to matrix.</span></div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;        <span class="keywordflow">if</span> (s1 == c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a> || s2 == c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a> || s1 == c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ab082999af0bd106d899d3121506053a4">arg4</a> || s2 == c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ab082999af0bd106d899d3121506053a4">arg4</a>) {</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;          <span class="comment">// we don&#39;t think this should ever happen, but just out of an</span></div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;          <span class="comment">// abundance of caution: if either of these submatrix indexes are the</span></div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;          <span class="comment">// input-value or output-value args to Backprop, don&#39;t do the optimization.</span></div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;          s1 = -1;</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;          s2 = -1;</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;        }</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;      }</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    }</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    <span class="keywordflow">if</span> (s1 &gt; 0 &amp;&amp; s2 &gt; 0) {</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;      std::pair&lt;bool,bool&gt; p = <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a7156e8f117cea1292ffbbc0dc1d87067">MayBeMerged</a>(command_index, s1, s2);</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;      <span class="keywordflow">if</span> (p.first) {</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a22dcf522c53105fb97eedd837ec8f6ec">DoMerge</a>(command_index, s1, s2);</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;        merged = <span class="keyword">true</span>;</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p.second) {</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a22dcf522c53105fb97eedd837ec8f6ec">DoMerge</a>(command_index, s2, s1);</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;        merged = <span class="keyword">true</span>;</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;      }</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    }</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;  }</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;  <span class="keywordflow">if</span> (merged) {</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;    <a class="code" href="namespacekaldi_1_1nnet3.html#a6828e427bd8883455705e0c9b99b5f2f">RenumberComputation</a>(<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>);</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    <a class="code" href="namespacekaldi_1_1nnet3.html#a1146f4efa141a56210f9dbf1090b20f0">RemoveNoOps</a>(<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>);</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;  }</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;  <span class="keywordflow">return</span> merged;</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;}</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;</div><div class="line"><a name="l00789"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a86704308a1467b6000867cc9ed198482">  789</a></span>&#160;<span class="keyword">static</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">NnetComputation::SubMatrixInfo</a> <a class="code" href="namespacekaldi_1_1nnet3.html#a86704308a1467b6000867cc9ed198482">GetSubMatrixOfSubMatrix</a>(</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> &amp;computation, int32 submat_a, int32 submat_b) {</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(static_cast&lt;size_t&gt;(submat_a) &lt; computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.size());</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(static_cast&lt;size_t&gt;(submat_b) &lt; computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.size());</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">NnetComputation::SubMatrixInfo</a> &amp;a = computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submat_a],</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                                       &amp;b = computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submat_b];</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html">NnetComputation::MatrixInfo</a> &amp;a_mat =</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;      computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[a.matrix_index];</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(a_mat.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a> == b.num_rows &amp;&amp; a_mat.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#aea941d74a486998b6fa921bc19fed05c">num_cols</a> == b.num_cols);</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">NnetComputation::SubMatrixInfo</a> ans;</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;  ans.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a515c4dd14ce4dc58f42c9a60b6bfbaba">matrix_index</a> = b.matrix_index;</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;  ans.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#acfb04e9339880d3594894f5201b70eac">row_offset</a> = a.row_offset + b.row_offset;</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;  ans.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a> = a.num_rows;</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;  ans.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a7524bea2834a3dc08b90e5b3406ee0e8">col_offset</a> = a.col_offset + b.col_offset;</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;  ans.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#aea941d74a486998b6fa921bc19fed05c">num_cols</a> = a.num_cols;</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;  <span class="keywordflow">return</span> ans;</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;}</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;</div><div class="line"><a name="l00807"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a60ce57f518b5fa77d140cb414354cd95">  807</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a60ce57f518b5fa77d140cb414354cd95">VariableMergingOptimizer::MarkAsDirty</a>(int32 s) {</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;  std::vector&lt;int32&gt; variable_indexes;</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#ac8ca96df1ecdb635738c59a88cff8835">analyzer_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html#afe662460f3e8b135d96fcd057638bd28">variables</a>.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationVariables.html#a15ab7e051d1b51d4e5391c92cb283c50">AppendVariablesForSubmatrix</a>(s, &amp;variable_indexes);</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;  std::vector&lt;int32&gt;::const_iterator iter = variable_indexes.begin(),</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;      end = variable_indexes.end();</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;  <span class="keywordflow">for</span> (; iter != end; ++iter) {</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    int32 v = *iter;</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(static_cast&lt;size_t&gt;(v) &lt; <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a63de82c33f6a7330727c0f2fc670ae0d">variable_dirty_</a>.size());</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a63de82c33f6a7330727c0f2fc670ae0d">variable_dirty_</a>[v] = <span class="keyword">true</span>;</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;  }</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;}</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;</div><div class="line"><a name="l00819"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a22dcf522c53105fb97eedd837ec8f6ec">  819</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a22dcf522c53105fb97eedd837ec8f6ec">VariableMergingOptimizer::DoMerge</a>(int32 command_index,</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;                                       int32 s_to_keep,</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;                                       int32 s_to_discard) {</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;  <span class="comment">// Prevent further optimizations touching either submatrix (we can try again</span></div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;  <span class="comment">// in a later round of optimization, with a new instance of this class).</span></div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a60ce57f518b5fa77d140cb414354cd95">MarkAsDirty</a>(s_to_keep);</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a60ce57f518b5fa77d140cb414354cd95">MarkAsDirty</a>(s_to_discard);</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;  int32 m_to_keep = <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s_to_keep].matrix_index,</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;      m_to_discard = <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s_to_discard].matrix_index;</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(m_to_keep != m_to_discard &amp;&amp; m_to_keep &gt; 0 &amp;&amp; m_to_discard &gt; 0);</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;  { <span class="comment">// modify submatrices of m_to_discard to effectively be sub-matrices of</span></div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    <span class="comment">// s_to_keep instead (they will refer to m_to_keep as the matrix_index).</span></div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;    std::vector&lt;int32&gt;::const_iterator iter =</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a0655730456d3a04cafe943687894a84d">matrix_to_submatrix_</a>[m_to_discard].begin(),</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;        end = <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a0655730456d3a04cafe943687894a84d">matrix_to_submatrix_</a>[m_to_discard].end();</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <span class="keywordflow">for</span> (; iter != end; ++iter) {</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;      int32 submatrix_index = *iter;</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;      <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submatrix_index].matrix_index</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;                   == m_to_discard);</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submatrix_index] =</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;          <a class="code" href="namespacekaldi_1_1nnet3.html#a86704308a1467b6000867cc9ed198482">GetSubMatrixOfSubMatrix</a>(*<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>, submatrix_index,</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;                                  s_to_keep);</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    }</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;  }</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html">ComputationAnalysis</a> analysis(*<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>, <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#ac8ca96df1ecdb635738c59a88cff8835">analyzer_</a>);</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c = <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;  <span class="keyword">const</span> std::vector&lt;MatrixAccesses&gt; &amp;matrix_accesses =</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#ac8ca96df1ecdb635738c59a88cff8835">analyzer_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html#a1451c041c35be895025d122f136b9959">matrix_accesses</a>;</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;  <span class="comment">//  - If it was a matrix-copy (assignment) with scale 1.0, replace the</span></div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;  <span class="comment">//    assignment command with a no-op.</span></div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;  <span class="comment">//    If it was matrix-copy with a scale, leave the command there;</span></div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;  <span class="comment">//    it will have the effect of scaling the matrix (it will be</span></div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;  <span class="comment">//    mapped so that arg1 == arg2, but that is OK).</span></div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;  <span class="keywordflow">if</span> (c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a35d3d1a70d075561aaf91b263ea28f74">kMatrixCopy</a> &amp;&amp; c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2de3c74f7141e97502ff48c2407b78be">alpha</a> == 1.0) {</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;    <span class="comment">// remove the command.</span></div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;    c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;    c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a> = -1;</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a> = -1;</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;  }</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;  <span class="comment">//   We want to ensure that there is only one deallocation command.</span></div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;  <span class="comment">//   If neither matrix is an output, then there will be 2 deallocation</span></div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;  <span class="comment">//   commands and we keep the one for m_to_keep (which, if the sizes</span></div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;  <span class="comment">//   differ, will be the larger of the two, so it&#39;s the one whose</span></div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;  <span class="comment">//   submatrix index refers to the entirety of the matrix).</span></div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;  <span class="comment">//   If one of them is an output, then remove the deallocation command</span></div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;  <span class="comment">//   of whichever one is not an output.</span></div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;  <span class="comment">//   As a simplification to the logic above: if the &#39;discard&#39; matrix</span></div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;  <span class="comment">//   has a deallocation command (i.e. if that matrix was not an output)</span></div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;  <span class="comment">//   then remove it; otherwise remove the deallocation command of</span></div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;  <span class="comment">//   the &#39;keep&#39; matrix.</span></div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;  int32 dealloc_keep = matrix_accesses[m_to_keep].deallocate_command,</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;      dealloc_discard = matrix_accesses[m_to_discard].deallocate_command;</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;  <span class="keywordflow">if</span> (dealloc_discard != -1) {</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[dealloc_discard].command_type = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(dealloc_keep != -1);</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[dealloc_keep].command_type = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;  }</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;  {</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    <span class="comment">//   - Both m_to_keep and m_to_discard will have commands that allocate</span></div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    <span class="comment">//     them, as all matrices do (note, kAcceptInput counts as an allocation</span></div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    <span class="comment">//     command).  If one of them is kAcceptInput, then delete the other one,</span></div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    <span class="comment">//     because the position of the kAcceptInput commands is important.</span></div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    <span class="comment">//     Otherwise delete the &quot;discard&quot; one.  As a simplification of the logic</span></div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;    <span class="comment">//     of the previous sentence: if the &quot;discard&quot; allocate command is</span></div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    <span class="comment">//     kAcceptInput then delete the &quot;keep&quot; allocate command, else delete</span></div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;    <span class="comment">//     the &quot;discard&quot; allocate command.</span></div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    <span class="comment">//     Note: after we renumber the submatrices, they both refer to the</span></div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;    <span class="comment">//     same underlying matrix, but we need to refer to them using a</span></div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    <span class="comment">//     submatrix that refers to the entire matrix.  The one we keep will</span></div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    <span class="comment">//     always refer to the entire matrix.  (In the case where one of</span></div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    <span class="comment">//     them is an input, both submatrices are guaranteed to refer to the</span></div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    <span class="comment">//     entire matrix, this is guaranteed by the logic we use to decide</span></div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;    <span class="comment">//     which matrices we can merge).</span></div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;    int32 alloc_keep = matrix_accesses[m_to_keep].allocate_command,</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;        alloc_discard = matrix_accesses[m_to_discard].allocate_command;</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(alloc_keep != -1 &amp;&amp; alloc_discard != -1);</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(analysis.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html#a20b2fb94d3cfc130b1402912f072199e">FirstNontrivialMatrixAccess</a>(m_to_discard) &gt;</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;                 alloc_keep);</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a></div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;        &amp;keep_alloc_command = <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[alloc_keep],</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;        &amp;discard_alloc_command = <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[alloc_discard];</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    int32 matrix_whose_zeroing_to_discard;</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;    <span class="keywordflow">if</span> (discard_alloc_command.command_type == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a6b396f5162883c2f4fb837a2af4b8895">kAcceptInput</a>) {</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;      keep_alloc_command.command_type = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;      matrix_whose_zeroing_to_discard = m_to_keep;</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;      discard_alloc_command.command_type = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;      matrix_whose_zeroing_to_discard = m_to_discard;</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;    }</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;    <span class="comment">// Now remove the command that zeroed one of the matrices</span></div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    <span class="comment">// (the one whose allocation command we just discarded).</span></div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    int32 zeroing_command_to_discard =</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;     matrix_accesses[matrix_whose_zeroing_to_discard].accesses[0].command_index;</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;zeroing_command =</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[zeroing_command_to_discard];</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;    <span class="keywordflow">if</span> (zeroing_command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a55f8cb2bfd2e2c3605dfa961eff35fa2">kSetConst</a> &amp;&amp;</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;        zeroing_command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2de3c74f7141e97502ff48c2407b78be">alpha</a> == 0.0) {</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;      <span class="comment">// if &#39;zeroing_command&#39; actually *was* a zeroing command, then remove it.</span></div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;      zeroing_command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    }</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;  }</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;  <span class="comment">//  If the matrix to discard had stride_type == kStrideEqualNumCols, set the</span></div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;  <span class="comment">//  stride type of the matrix we&#39;re keeping to kStrideEqualNumCols.</span></div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m_to_discard].stride_type == <a class="code" href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51a2b73d1b429e7067fc592b019190e4976">kStrideEqualNumCols</a>) {</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m_to_keep].stride_type = <a class="code" href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51a2b73d1b429e7067fc592b019190e4976">kStrideEqualNumCols</a>;</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    <span class="comment">// ... and perform an additional check.</span></div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m_to_discard].num_rows ==</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;                 <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m_to_keep].num_rows &amp;&amp;</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;                 <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m_to_discard].num_cols ==</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;                 <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m_to_keep].num_cols);</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;  }</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;}</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;</div><div class="line"><a name="l00945"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a7156e8f117cea1292ffbbc0dc1d87067">  945</a></span>&#160;std::pair&lt;bool,bool&gt; <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a7156e8f117cea1292ffbbc0dc1d87067">VariableMergingOptimizer::MayBeMerged</a>(</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;    int32 command_index, int32 s1, int32 s2)<span class="keyword"> const </span>{</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(s1 &gt; 0 &amp;&amp; s2 &gt; 0 &amp;&amp; static_cast&lt;size_t&gt;(command_index) &lt;</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;               <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size());</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;  <span class="keywordflow">if</span> (!<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a4dcce2ef4364ac3b222debac11646a39">config_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetOptimizeOptions.html#a9338247ac24f099364f25f6221981cf8">allow_left_merge</a> &amp;&amp; !<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a4dcce2ef4364ac3b222debac11646a39">config_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetOptimizeOptions.html#a2af78454a6c4008c23ec34cb8cefc376">allow_right_merge</a>)</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;    <span class="keywordflow">return</span> std::pair&lt;bool,bool&gt;(<span class="keyword">false</span>,<span class="keyword">false</span>);</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;  int32 m1 = <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s1].matrix_index,</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;      m2 = <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s2].matrix_index;</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;  <span class="comment">// we can&#39;t merge two different submatrices of the same matrix.</span></div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;  <span class="keywordflow">if</span> (m1 == m2) <span class="keywordflow">return</span> std::pair&lt;bool,bool&gt;(<span class="keyword">false</span>,<span class="keyword">false</span>);</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;  std::vector&lt;int32&gt; variable_indexes;</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#ac8ca96df1ecdb635738c59a88cff8835">analyzer_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html#afe662460f3e8b135d96fcd057638bd28">variables</a>.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationVariables.html#a15ab7e051d1b51d4e5391c92cb283c50">AppendVariablesForSubmatrix</a>(s1, &amp;variable_indexes);</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#ac8ca96df1ecdb635738c59a88cff8835">analyzer_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html#afe662460f3e8b135d96fcd057638bd28">variables</a>.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationVariables.html#a15ab7e051d1b51d4e5391c92cb283c50">AppendVariablesForSubmatrix</a>(s2, &amp;variable_indexes);</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;  std::vector&lt;int32&gt;::iterator iter = variable_indexes.begin(),</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;      end = variable_indexes.end();</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;  <span class="comment">// condition c5:</span></div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;  <span class="keywordflow">for</span> (; iter != end; ++iter)</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a63de82c33f6a7330727c0f2fc670ae0d">variable_dirty_</a>[*iter])</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;      <span class="keywordflow">return</span> std::pair&lt;bool,bool&gt;(<span class="keyword">false</span>,<span class="keyword">false</span>);</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;  <span class="keyword">const</span> std::vector&lt;MatrixAccesses&gt; &amp;matrix_accesses = <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#ac8ca96df1ecdb635738c59a88cff8835">analyzer_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html#a1451c041c35be895025d122f136b9959">matrix_accesses</a>;</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html">MatrixAccesses</a> &amp;m1_access = matrix_accesses[m1],</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;      &amp;m2_access = matrix_accesses[m2];</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;  <span class="comment">// condition c1:</span></div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;  <span class="keywordflow">if</span> ((m1_access.<a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#aa8a8ede92285acbe2795e8570b81c9ae">is_input</a> &amp;&amp; m2_access.is_input) ||</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;      (m1_access.<a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#a7464ec491eeba4c23632a6ae583e9429">is_output</a> &amp;&amp; m2_access.is_output))</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;    <span class="keywordflow">return</span> std::pair&lt;bool,bool&gt;(<span class="keyword">false</span>,<span class="keyword">false</span>);</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;  <span class="comment">// condition c2:</span></div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;  <span class="keywordflow">if</span> ((m1_access.<a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#aa8a8ede92285acbe2795e8570b81c9ae">is_input</a> || m1_access.<a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#a7464ec491eeba4c23632a6ae583e9429">is_output</a> ||</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;       m2_access.is_input || m2_access.is_output) &amp;&amp;</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;      (!<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab4efec36ef0d5bab190891c36bd9b2e3">IsWholeMatrix</a>(s1) ||</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;       !<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab4efec36ef0d5bab190891c36bd9b2e3">IsWholeMatrix</a>(s2)))</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;    <span class="keywordflow">return</span> std::pair&lt;bool,bool&gt;(<span class="keyword">false</span>,<span class="keyword">false</span>);</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;  <span class="keywordtype">bool</span> left = <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a4dcce2ef4364ac3b222debac11646a39">config_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetOptimizeOptions.html#a9338247ac24f099364f25f6221981cf8">allow_left_merge</a>,</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;      right = <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a4dcce2ef4364ac3b222debac11646a39">config_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetOptimizeOptions.html#a2af78454a6c4008c23ec34cb8cefc376">allow_right_merge</a>;</div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;  <span class="comment">// condition c3:</span></div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;  <span class="keywordflow">if</span> (!<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab4efec36ef0d5bab190891c36bd9b2e3">IsWholeMatrix</a>(s2)) left = <span class="keyword">false</span>;</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;  <span class="comment">// condition c4:</span></div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;  <span class="keywordflow">if</span> (!<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab4efec36ef0d5bab190891c36bd9b2e3">IsWholeMatrix</a>(s1)) right = <span class="keyword">false</span>;</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;  <span class="comment">// condition c6:</span></div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m2].stride_type == <a class="code" href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51a2b73d1b429e7067fc592b019190e4976">kStrideEqualNumCols</a> &amp;&amp;</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;      !<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab4efec36ef0d5bab190891c36bd9b2e3">IsWholeMatrix</a>(s1)) left = <span class="keyword">false</span>;</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;  <span class="comment">// condition c7:</span></div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m1].stride_type == <a class="code" href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51a2b73d1b429e7067fc592b019190e4976">kStrideEqualNumCols</a> &amp;&amp;</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;      !<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab4efec36ef0d5bab190891c36bd9b2e3">IsWholeMatrix</a>(s2)) right = <span class="keyword">false</span>;</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;  <span class="keywordflow">if</span> (!left &amp;&amp; !right)  <span class="comment">// save some time.</span></div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;    <span class="keywordflow">return</span> std::pair&lt;bool,bool&gt;(<span class="keyword">false</span>,<span class="keyword">false</span>);</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;  <span class="keywordtype">bool</span> is_assignment = (<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index].command_type ==</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;                        <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a35d3d1a70d075561aaf91b263ea28f74">kMatrixCopy</a> &amp;&amp;</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;                        <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index].alpha == 1.0);</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html">ComputationAnalysis</a> analysis(*<a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>, <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#ac8ca96df1ecdb635738c59a88cff8835">analyzer_</a>);</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;  <span class="keywordflow">if</span> (is_assignment) {</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;    <span class="keywordflow">if</span> (analysis.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html#a68f6c05cf1aab9fd7e6a475078e38466">FirstNontrivialAccess</a>(s2) == command_index &amp;&amp;</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        analysis.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html#a05f855eac05e56f202ecb10127261127">LastWriteAccess</a>(s1) &lt; command_index &amp;&amp;</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;        analysis.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html#a3a6f864b459da77d4014835edaa0653f">LastAccess</a>(s1) &lt;</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;        analysis.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html#affc0d346da68b1a977ea4f91ac8ca780">DataInvalidatedCommand</a>(command_index, s2)) {</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;      <span class="keywordflow">return</span> std::pair&lt;bool,bool&gt;(left, right);  <span class="comment">// possible success.</span></div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;    }</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    <span class="keywordflow">if</span> (analysis.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html#a68f6c05cf1aab9fd7e6a475078e38466">FirstNontrivialAccess</a>(s2) == command_index &amp;&amp;</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;        analysis.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html#a3a6f864b459da77d4014835edaa0653f">LastAccess</a>(s1) == command_index) {</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;      <span class="keywordflow">return</span> std::pair&lt;bool,bool&gt;(left, right);  <span class="comment">// possible success.</span></div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;    }</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;  }</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;  <span class="comment">// failure.</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;  <span class="keywordflow">return</span> std::pair&lt;bool,bool&gt;(<span class="keyword">false</span>,<span class="keyword">false</span>);</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;}</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;<span class="comment">// This class is used inside the function</span></div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;<span class="comment">// `void ExtendMatrices(NnetComputation *computation)`;</span></div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;<span class="comment">// see that function&#39;s declaration in nnet-optimize-utils.h for</span></div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;<span class="comment">// a summary of what this class does.</span></div><div class="line"><a name="l01019"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MatrixExtender.html"> 1019</a></span>&#160;<span class="keyword">class </span><a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html">MatrixExtender</a> {</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160; <span class="keyword">public</span>:</div><div class="line"><a name="l01021"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a1e4ca23704d364f81f2e4500c225290c"> 1021</a></span>&#160;  <span class="keyword">typedef</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">NnetComputation::SubMatrixInfo</a> <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a1e4ca23704d364f81f2e4500c225290c">SubMatrixInfo</a>;</div><div class="line"><a name="l01022"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#ae21e72d8f14723918b89dbf6615b53b2"> 1022</a></span>&#160;  <span class="keyword">typedef</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html">NnetComputation::MatrixInfo</a> <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#ae21e72d8f14723918b89dbf6615b53b2">MatrixInfo</a>;</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html">MatrixExtender</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation);</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;  <span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a1adea5ddcf5f2d26ee01d796ec13510c">ExtendMatrices</a>();</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160; <span class="keyword">private</span>:</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;  <span class="comment">// This function returns true if a copy command from &#39;src_submatrix&#39;</span></div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;  <span class="comment">// to &#39;dest_submatrix&#39; has the properties we need to be able to</span></div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;  <span class="comment">// extend its rows to cover all of the source matrix.</span></div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;  <span class="keywordtype">bool</span> CanBeExtended(int32 dest_submatrix_index,</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;                     int32 src_submatrix_index);</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;  <span class="comment">// This actually extends the matrices... it&#39;s called only if CanBeExtended()</span></div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;  <span class="comment">// with the same args returned true.  It modifies &#39;dest_submatrix_index&#39;</span></div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;  <span class="comment">// and &#39;src_submatrix_index&#39;.</span></div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;  <span class="keywordtype">void</span> Extend(int32 *dest_submatrix_index, int32 *src_submatrix_index);</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;  <span class="comment">// This function modifies the computation to fix certain problems</span></div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;  <span class="comment">// that might have been introduced by Extend()... allocation, deallocation,</span></div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;  <span class="keywordtype">void</span> FixComputation();</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;  <span class="comment">// This function modifies the computation to fix the debug info; if needed,</span></div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;  <span class="comment">// it&#39;s called from FixComputation().</span></div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;  <span class="keywordtype">void</span> FixDebugInfo();</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;  <span class="comment">// don&#39;t extend a destination matrix if it wasn&#39;t already</span></div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;  <span class="comment">// at least &#39;min_proportion&#39; (80%) big enough to store the source.</span></div><div class="line"><a name="l01050"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a76a052939eb8507417303c9cbaef5452"> 1050</a></span>&#160;  <a class="code" href="classfloat.html">BaseFloat</a> <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a76a052939eb8507417303c9cbaef5452">min_proportion_</a>;</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;</div><div class="line"><a name="l01052"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537"> 1052</a></span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *<a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>;</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;  <span class="comment">// Indexed by matrix-index m, orig_num_rows_[m] is the value of</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;  <span class="comment">// computation_-&gt;matrices[m].num_rows when this class was initialized,</span></div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;  <span class="comment">// i.e. before we changed anything.</span></div><div class="line"><a name="l01057"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a23a3068bbd6de6b9f08b245daae44355"> 1057</a></span>&#160;  std::vector&lt;int32&gt; <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a23a3068bbd6de6b9f08b245daae44355">orig_num_rows_</a>;</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;  <span class="comment">// Indexed by matrix-index m, this vector contains true if matrix</span></div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;  <span class="comment">// m is involved in any AcceptInput() or ProvideOutput() operations.</span></div><div class="line"><a name="l01061"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#ac0d77abc89752f5c47d7141456ed1821"> 1061</a></span>&#160;  std::vector&lt;bool&gt; <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#ac0d77abc89752f5c47d7141456ed1821">is_input_or_output_</a>;</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;};</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;<span class="comment">// note: the initializer for min_proportion_ below needs to be kept in sync with</span></div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;<span class="comment">// the min_proportion variable in</span></div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;<span class="comment">// ComputationChecker::CheckComputationUndefined() in nnet-analyze.cc.</span></div><div class="line"><a name="l01067"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a8605a31b0233e3b83fdb834a7995521a"> 1067</a></span>&#160;<a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a8605a31b0233e3b83fdb834a7995521a">MatrixExtender::MatrixExtender</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation):</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;    min_proportion_(0.8),</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>(computation) {</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;  int32 num_matrices = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>.size();</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;  { <span class="comment">// set up orig_num_rows_.</span></div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a23a3068bbd6de6b9f08b245daae44355">orig_num_rows_</a>.resize(num_matrices);</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;    <span class="comment">// matrix 0 is not a real matrix so skip that index.</span></div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;    <span class="keywordflow">for</span> (int32 m = 1; m &lt; num_matrices; m++)</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a23a3068bbd6de6b9f08b245daae44355">orig_num_rows_</a>[m] = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m].num_rows;</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;  }</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;  { <span class="comment">// set up is_input_or_output_.</span></div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#ac0d77abc89752f5c47d7141456ed1821">is_input_or_output_</a>.resize(num_matrices, <span class="keyword">false</span>);</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;    std::vector&lt;NnetComputation::Command&gt;::iterator</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;      command_iter = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.begin(),</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;      command_end = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.end();</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;    <span class="keywordflow">for</span> (; command_iter != command_end; ++command_iter) {</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;      <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;command = *command_iter;</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;      <span class="comment">// make sure there are no kSwapMatrix commands; they should not be present</span></div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;      <span class="comment">// at this stage of optimization.</span></div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;      <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> != <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a8ecee91c55553bcf2d755d00328b0253">kSwapMatrix</a>);</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;      <span class="keywordflow">if</span> (command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352aaa3fd92744438323baec475cee5b9b3d">kProvideOutput</a> ||</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;          command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a6b396f5162883c2f4fb837a2af4b8895">kAcceptInput</a>) {</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;        int32 s = command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>,</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;            m = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s].matrix_index;</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#ac0d77abc89752f5c47d7141456ed1821">is_input_or_output_</a>[m] = <span class="keyword">true</span>;</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;      }</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;    }</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;  }</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;}</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;</div><div class="line"><a name="l01099"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a0b1e031e0f3c969b8006e81aff6b160d"> 1099</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a0b1e031e0f3c969b8006e81aff6b160d">MatrixExtender::CanBeExtended</a>(int32 dest_submatrix_index,</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;                                   int32 src_submatrix_index) {</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">SubMatrixInfo</a></div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;      &amp;src_submatrix = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[src_submatrix_index],</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;      &amp;dest_submatrix = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[dest_submatrix_index];</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;  <span class="keywordflow">if</span> (src_submatrix.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a515c4dd14ce4dc58f42c9a60b6bfbaba">matrix_index</a> == dest_submatrix.matrix_index)</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;  <span class="comment">// we can&#39;t resize the destination matrix if it&#39;s involved in input or output.</span></div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#ac0d77abc89752f5c47d7141456ed1821">is_input_or_output_</a>[dest_submatrix.matrix_index])</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html">MatrixInfo</a></div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;      &amp;src_matrix = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[src_submatrix.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a515c4dd14ce4dc58f42c9a60b6bfbaba">matrix_index</a>];</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;  int32 dest_matrix_orig_num_rows = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a23a3068bbd6de6b9f08b245daae44355">orig_num_rows_</a>[dest_submatrix.matrix_index],</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;      src_matrix_orig_num_rows = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a23a3068bbd6de6b9f08b245daae44355">orig_num_rows_</a>[src_submatrix.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a515c4dd14ce4dc58f42c9a60b6bfbaba">matrix_index</a>];</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;  <span class="keywordflow">if</span> (src_submatrix.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a> &lt; <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a76a052939eb8507417303c9cbaef5452">min_proportion_</a> * src_matrix_orig_num_rows)</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;  <span class="comment">// The following checks that the source submatrix covers be all of the</span></div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;  <span class="comment">// source matrix except a few final rows, and the destination submatrix goes</span></div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;  <span class="comment">// to the final row of its matrix.</span></div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;  <span class="keywordflow">return</span> (src_submatrix.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a7524bea2834a3dc08b90e5b3406ee0e8">col_offset</a> == 0 &amp;&amp;</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;          src_submatrix.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#aea941d74a486998b6fa921bc19fed05c">num_cols</a> == src_matrix.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#aea941d74a486998b6fa921bc19fed05c">num_cols</a> &amp;&amp;</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;          src_submatrix.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#acfb04e9339880d3594894f5201b70eac">row_offset</a> == 0 &amp;&amp;</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;          src_submatrix.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a> &lt; src_matrix.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a> &amp;&amp;</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;          dest_submatrix.row_offset + dest_submatrix.num_rows ==</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;          dest_matrix_orig_num_rows);</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;}</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;</div><div class="line"><a name="l01132"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#adcf5cc095cea766e998cf4cde4e625de"> 1132</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#adcf5cc095cea766e998cf4cde4e625de">MatrixExtender::Extend</a>(int32 *dest_submatrix_index,</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;                            int32 *src_submatrix_index) {</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;  <span class="comment">// copy the SubMatrixInfo to avoid iterator invalidation.</span></div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">SubMatrixInfo</a></div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;      src_submatrix = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[*src_submatrix_index],</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;      dest_submatrix = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[*dest_submatrix_index];</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;</div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html">MatrixInfo</a>  &amp;src_matrix = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[src_submatrix.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a515c4dd14ce4dc58f42c9a60b6bfbaba">matrix_index</a>],</div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;      &amp;dest_matrix = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[dest_submatrix.matrix_index];</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;  int32 new_dest_num_rows = dest_submatrix.row_offset + src_matrix.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a>;</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;  <span class="comment">// extend the destination matrix so it has enough rows to fit the entire</span></div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;  <span class="comment">// source matrix.  Note: doing this will break certain invariances in the</span></div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;  <span class="comment">// computation, principally with allocation and deallocation commands, which</span></div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;  <span class="comment">// we&#39;ll later fix up by calling FixComputation().</span></div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;  <span class="keywordflow">if</span> (new_dest_num_rows &gt; dest_matrix.num_rows) {</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;    dest_matrix.num_rows = new_dest_num_rows;</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;    <span class="comment">// make sure there&#39;s a submatrix index covering the whole of the dest matrix.</span></div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.push_back(</div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a1e4ca23704d364f81f2e4500c225290c">SubMatrixInfo</a>(dest_submatrix.matrix_index, 0, new_dest_num_rows,</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;                      0, dest_matrix.num_cols));</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;  }</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;  <span class="comment">// The following 3 statements create a new submatrix that will be</span></div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;  <span class="comment">// the destination submatrix; it&#39;s the same as the original destination</span></div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;  <span class="comment">// submatrix, but with a few extra rows.</span></div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;  *dest_submatrix_index = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.size();</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;  dest_submatrix.num_rows = src_matrix.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a>;</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.push_back(</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a1e4ca23704d364f81f2e4500c225290c">SubMatrixInfo</a>(dest_submatrix));</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;  <span class="comment">// The following 3 statements create a new submatrix that will be</span></div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;  <span class="comment">// the source submatrix; it&#39;s the same as the original source</span></div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;  <span class="comment">// submatrix, but with a few extra rows, and actually will cover</span></div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;  <span class="comment">// the entire source matrix.</span></div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;  *src_submatrix_index = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.size();</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.push_back(</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a1e4ca23704d364f81f2e4500c225290c">SubMatrixInfo</a>(src_submatrix.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a515c4dd14ce4dc58f42c9a60b6bfbaba">matrix_index</a>, 0, src_matrix.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a>,</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;                    0, src_matrix.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#aea941d74a486998b6fa921bc19fed05c">num_cols</a>));</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;}</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;</div><div class="line"><a name="l01174"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a4e7255b52c14390ceef526de72511cc5"> 1174</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a4e7255b52c14390ceef526de72511cc5">MatrixExtender::ExtendMatrices</a>() {</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;  std::vector&lt;NnetComputation::Command&gt;::iterator</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;      command_iter = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.begin(),</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;      command_end = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.end();</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;  <span class="keywordtype">bool</span> changed = <span class="keyword">false</span>;</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;  <span class="keywordflow">for</span> (; command_iter != command_end; ++command_iter) {</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;command = *command_iter;</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;    <span class="keywordflow">if</span> (command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a35d3d1a70d075561aaf91b263ea28f74">kMatrixCopy</a> &amp;&amp;</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;        command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2de3c74f7141e97502ff48c2407b78be">alpha</a> == 1.0) {</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;      int32 dest_submatrix_index = command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>,</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;          src_submatrix_index = command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>;</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a0b1e031e0f3c969b8006e81aff6b160d">CanBeExtended</a>(dest_submatrix_index, src_submatrix_index)) {</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#adcf5cc095cea766e998cf4cde4e625de">Extend</a>(&amp;command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>, &amp;command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>);</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;        changed = <span class="keyword">true</span>;</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;      }</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    }</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;  }</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;  <span class="keywordflow">if</span> (changed)</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a10fb93312fefce2859a649b0274aac56">FixComputation</a>();</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;}</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;</div><div class="line"><a name="l01195"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a10fb93312fefce2859a649b0274aac56"> 1195</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a10fb93312fefce2859a649b0274aac56">MatrixExtender::FixComputation</a>() {</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;  <span class="comment">// make sure that allocation and deallocation commands</span></div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;  <span class="comment">// operate on whole matrix.</span></div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;  std::vector&lt;NnetComputation::Command&gt;::iterator</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;      command_iter = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.begin(),</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;      command_end = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.end();</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;  std::vector&lt;int32&gt; whole_submatrices;</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ac6ad0d391be80aff8f4538b6fbf747b1">GetWholeSubmatrices</a>(&amp;whole_submatrices);</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;  <span class="keywordflow">for</span> (; command_iter != command_end; ++command_iter) {</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;command = *command_iter;</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;    <span class="keywordflow">if</span> (command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a73b5995148c3e987c4a163ad6bc9850b">kAllocMatrix</a> ||</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;        command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae77588ab7fc4ccf842de7ec941247062">kDeallocMatrix</a>) {</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;      int32 s = command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>,</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;          m = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s].matrix_index,</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;          new_s = whole_submatrices[m];</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;      <span class="keywordflow">if</span> (new_s != s) {</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;        <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;            <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s] == <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[new_s] ||</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;            <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a23a3068bbd6de6b9f08b245daae44355">orig_num_rows_</a>[m] != <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m].num_rows);</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;        command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a> = new_s;</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;      }</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;    }</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;    <span class="keywordflow">if</span> (command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a55f8cb2bfd2e2c3605dfa961eff35fa2">kSetConst</a> &amp;&amp; command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2de3c74f7141e97502ff48c2407b78be">alpha</a> == 0.0) {</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;      int32 s = command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>,</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;          m = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s].matrix_index,</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;          new_s = whole_submatrices[m];</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;      <span class="keywordflow">if</span> (new_s != s) {</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;        {</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;          <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">NnetComputation::SubMatrixInfo</a> &amp;info = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;              command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>];</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;          <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html">NnetComputation::MatrixInfo</a> &amp;mat_info = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;              info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a515c4dd14ce4dc58f42c9a60b6bfbaba">matrix_index</a>];</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;          <span class="comment">// If this command wasn&#39;t zeroing the the entirety of a matrix,</span></div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;          <span class="comment">// (before we extended the matrix), we don&#39;t need to extend it.</span></div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;          <span class="keywordflow">if</span> (!(info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#acfb04e9339880d3594894f5201b70eac">row_offset</a> == 0 &amp;&amp; info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a7524bea2834a3dc08b90e5b3406ee0e8">col_offset</a> == 0 &amp;&amp;</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;                info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#aea941d74a486998b6fa921bc19fed05c">num_cols</a> == mat_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#aea941d74a486998b6fa921bc19fed05c">num_cols</a> &amp;&amp;</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;                info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a> == <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a23a3068bbd6de6b9f08b245daae44355">orig_num_rows_</a>[info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a515c4dd14ce4dc58f42c9a60b6bfbaba">matrix_index</a>]))</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;          <span class="comment">// I know doing this via &#39;continue&#39; is odd, but it&#39;s done this way to</span></div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;          <span class="comment">// avoid invalid iterators still being in scope; I think some runtimes</span></div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;          <span class="comment">// check for it.</span></div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;        }</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;        command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a> = new_s;</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;      }</div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    }</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;  }</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;  <span class="keywordflow">if</span> (!<a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.empty())</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#aceebe1d56d0762409ab7360cd9171ef3">FixDebugInfo</a>();</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a6828e427bd8883455705e0c9b99b5f2f">RenumberComputation</a>(<a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>);</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;}</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;</div><div class="line"><a name="l01246"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#aceebe1d56d0762409ab7360cd9171ef3"> 1246</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#aceebe1d56d0762409ab7360cd9171ef3">MatrixExtender::FixDebugInfo</a>() {</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;  int32 num_matrices = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>.size();</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;  <span class="comment">// matrix zero is not a &#39;real&#39; matrix.</span></div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;  <span class="keywordflow">for</span> (int32 m = 1; m &lt; num_matrices; m++) {</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a> &amp;debug_info =</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[m];</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;    int32 new_num_rows = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m].num_rows,</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;        old_num_rows = debug_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>.size();</div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;    <span class="keywordflow">if</span> (new_num_rows != old_num_rows) {</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;      debug_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>.resize(new_num_rows);</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;      int32 num_extra_rows = new_num_rows - old_num_rows;</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;      <span class="comment">// the following should be true because min_proportion_ &gt; 0.5.</span></div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;      <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(num_extra_rows &lt;= old_num_rows);</div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;      <span class="keywordflow">for</span> (int32 r = old_num_rows; r &lt; new_num_rows; r++) {</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;        <a class="code" href="namespacekaldi_1_1nnet3.html#ac8344e7587df9247d6cc492874901d4d">Cindex</a> cindex = debug_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>[r - num_extra_rows];</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;        <span class="comment">// set the &#39;t&#39; value to kNoTime which indicates that it&#39;s not a &#39;real&#39;</span></div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;        <span class="comment">// time step, and may avoid errors in checking code.</span></div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;        cindex.second.t = <a class="code" href="namespacekaldi_1_1nnet3.html#ac952f0840a7950dff80c1a89e69656d7">kNoTime</a>;</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;        debug_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>[r] = cindex;</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;      }</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;    }</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;  }</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;}</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;</div><div class="line"><a name="l01270"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a1adea5ddcf5f2d26ee01d796ec13510c"> 1270</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a4e7255b52c14390ceef526de72511cc5">ExtendMatrices</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation) {</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html">MatrixExtender</a> ext(computation);</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;  ext.<a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a4e7255b52c14390ceef526de72511cc5">ExtendMatrices</a>();</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;}</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;</div><div class="line"><a name="l01282"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html"> 1282</a></span>&#160;<span class="keyword">class </span><a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html">ModelUpdateConsolidator</a> {</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160; <span class="keyword">public</span>:</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html">ModelUpdateConsolidator</a>(<span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;nnet,</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;                          <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation);</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;  <span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#af512f7de6c401fbdf7013d62295df9c2">ConsolidateModelUpdate</a>();</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160; <span class="keyword">private</span>:</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;  <span class="keywordtype">void</span> ConsolidateUpdateForComponent(</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;      int32 component,</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;      <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;backprop_commands);</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;  <span class="keywordtype">void</span> AddCommandsToComputation();</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;  int32 ConsolidateSubmatrices(</div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;      <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;commands,</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;      <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;submatrices);</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;  <span class="keywordtype">void</span> AppendDebugInfoForSubmatrix(</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;      int32 submatrix_index,</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;      <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a> *debug_info) <span class="keyword">const</span>;</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;</div><div class="line"><a name="l01328"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#adbabf05a7702103113a02a113015205f"> 1328</a></span>&#160;  <span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;<a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#adbabf05a7702103113a02a113015205f">nnet_</a>;</div><div class="line"><a name="l01329"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537"> 1329</a></span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *<a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>;</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;  <span class="comment">// Indexed by the original command index in *computation_ (and sized to the</span></div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;  <span class="comment">// original number of commands in *computation_ before we added anything),</span></div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;  <span class="comment">// extra_commands_[c] contains a list of commands that need to be inserted</span></div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;  <span class="comment">// just before command c in the previously existing computation.</span></div><div class="line"><a name="l01335"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#aff6dbc6bf1ea33e5ea29bebebae8617a"> 1335</a></span>&#160;  std::vector&lt;std::vector&lt;NnetComputation::Command&gt; &gt; <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#aff6dbc6bf1ea33e5ea29bebebae8617a">extra_commands_</a>;</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;  <span class="comment">// This is as list of kBackprop commands that will be placed after the</span></div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;  <span class="comment">// commands in &#39;computation_-&gt;commands&#39; and &#39;extra_commands_&#39;, but before</span></div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;  <span class="comment">// the &#39;final_deallocate_commands_&#39;.</span></div><div class="line"><a name="l01340"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#af13a24e7f0ed6969f7659518478ffdc2"> 1340</a></span>&#160;  std::vector&lt;NnetComputation::Command&gt; <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#af13a24e7f0ed6969f7659518478ffdc2">final_commands_</a>;</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;  <span class="comment">// This is a list of commands to deallocate our &#39;consolidated&#39; matrices; the</span></div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;  <span class="comment">// commands will be placed after the commands in &#39;final_commands_&#39;.</span></div><div class="line"><a name="l01343"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1637cd5c5a1274835dfb87d75fde2037"> 1343</a></span>&#160;  std::vector&lt;NnetComputation::Command&gt; <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1637cd5c5a1274835dfb87d75fde2037">final_deallocate_commands_</a>;</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;};</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;</div><div class="line"><a name="l01347"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a20efdbe0990f3fa04abb85ac56089614"> 1347</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a20efdbe0990f3fa04abb85ac56089614">ModelUpdateConsolidator::AppendDebugInfoForSubmatrix</a>(</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;    int32 submatrix_index,</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a> *debug_info)<span class="keyword"> const </span>{</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!<a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.empty());</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(static_cast&lt;size_t&gt;(submatrix_index) &lt;</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;               <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.size());</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">NnetComputation::SubMatrixInfo</a> submatrix_info =</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submatrix_index];</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;  int32 matrix_index = submatrix_info.matrix_index;</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(matrix_index &gt; 0 &amp;&amp; static_cast&lt;size_t&gt;(matrix_index) &lt;</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;               <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.size());</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a> &amp;src_info =</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[matrix_index];</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;  debug_info-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a9da2804c57d358d12d491f0c3d51d0ef">is_deriv</a> = src_info.is_deriv;</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(src_info.cindexes.size() ==</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;               <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[matrix_index].num_rows);</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;  int32 row_begin = submatrix_info.row_offset,</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;      row_end = row_begin + submatrix_info.num_rows;</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;  debug_info-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>.insert(debug_info-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>.end(),</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;                             src_info.cindexes.begin() + row_begin,</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;                             src_info.cindexes.begin() + row_end);</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;}</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;<span class="comment">// see comment by declaration in header.</span></div><div class="line"><a name="l01371"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#ad6767e6a06ceef8ceedb067c8c86d463"> 1371</a></span>&#160;int32 <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#ad6767e6a06ceef8ceedb067c8c86d463">ModelUpdateConsolidator::ConsolidateSubmatrices</a>(</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;    <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;commands,</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;    <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;submatrices) {</div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;  int32 num_submatrices = submatrices.size();</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(num_submatrices &gt; 1 &amp;&amp; commands.size() == submatrices.size());</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;  int32 first_submatrix = submatrices[0];</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;  int32 num_cols = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[first_submatrix].num_cols,</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;      num_rows = 0;</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;  <a class="code" href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51">MatrixStrideType</a> stride_type = <a class="code" href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51aae343c6085287b6272231336d4b75986">kDefaultStride</a>;</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a> debug_info;</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; num_submatrices; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;    int32 submatrix = submatrices[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;    num_rows += <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submatrix].num_rows;</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(<a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submatrix].num_cols == num_cols);</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.empty())</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;      AppendDebugInfoForSubmatrix(submatrix, &amp;debug_info);</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab4efec36ef0d5bab190891c36bd9b2e3">IsWholeMatrix</a>(submatrix)) {</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;      int32 matrix = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submatrix].matrix_index;</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[matrix].stride_type == <a class="code" href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51a2b73d1b429e7067fc592b019190e4976">kStrideEqualNumCols</a>)</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;        stride_type = <a class="code" href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51a2b73d1b429e7067fc592b019190e4976">kStrideEqualNumCols</a>;</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;    }</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;  }</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;  <span class="comment">// new_whole_submatrix is a new submatrix index corresponding to the whole</span></div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;  <span class="comment">// of a new matrix that we are creating.</span></div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;  int32 new_whole_submatrix = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a16ed03ea200a71de08070d77fd52ceb9">NewMatrix</a>(num_rows, num_cols,</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;                                                      stride_type);</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;  <span class="comment">// Add commands at the very start, to initialize and then zero this new</span></div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;  <span class="comment">// matrix.  we can later on remove the zeroing if it is not necessary.</span></div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;  extra_commands_[0].push_back(</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;      <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a>(<a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a73b5995148c3e987c4a163ad6bc9850b">kAllocMatrix</a>, new_whole_submatrix));</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;  extra_commands_[0].push_back(</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;      <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a>(0.0, <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a55f8cb2bfd2e2c3605dfa961eff35fa2">kSetConst</a>, new_whole_submatrix));</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;  final_deallocate_commands_.push_back(</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;      <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a>(<a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae77588ab7fc4ccf842de7ec941247062">kDeallocMatrix</a>, new_whole_submatrix));</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;  int32 new_matrix_index =</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[new_whole_submatrix].matrix_index;</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;  <span class="keywordflow">if</span> (!<a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.empty())</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[new_matrix_index].Swap(&amp;debug_info);</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;  int32 row_offset = 0;</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; num_submatrices; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;    int32 submatrix_index = submatrices[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;    int32 this_num_rows = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submatrix_index].num_rows;</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;    <span class="comment">// submatrix corresponding to the part of the new matrix corresponding</span></div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;    <span class="comment">// to &#39;submatrices[i]&#39;.</span></div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;    int32 new_submatrix = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a61634eedcfea10a32bdb33bca3f94f2b">NewSubMatrix</a>(new_whole_submatrix,</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;                                                     row_offset, this_num_rows,</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;                                                     0, num_cols);</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;    <span class="comment">// Just before command &#39;commands[i]&#39;, add a command that assigns to the</span></div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;    <span class="comment">// submatrix numbered &#39;new_submatrix&#39; the contents of the submatrix numbered</span></div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;    <span class="comment">// &#39;submatrices[i]&#39;.  Note: we hope that a later pass of optimization</span></div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    <span class="comment">// (VariableMergingOptimization) will remove this redundant copy by</span></div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;    <span class="comment">// having the operation that created it write directly to the location</span></div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;    <span class="comment">// we want it to be.</span></div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> c(<a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a35d3d1a70d075561aaf91b263ea28f74">kMatrixCopy</a>, new_submatrix, submatrices[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>]);</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;    extra_commands_[commands[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>]].push_back(c);</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;    row_offset += this_num_rows;</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;  }</div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(row_offset == num_rows);</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;  <span class="keywordflow">return</span> new_whole_submatrix;</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;}</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;</div><div class="line"><a name="l01434"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a9ff791337c174a7dd4d789a414c452e3"> 1434</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a9ff791337c174a7dd4d789a414c452e3">ModelUpdateConsolidator::AddCommandsToComputation</a>() {</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(<a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size() == extra_commands_.size());</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;  int32 old_num_commands = <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size(),</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;      new_num_commands = old_num_commands +</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;      <span class="keyword">static_cast&lt;</span>int32<span class="keyword">&gt;</span>(final_commands_.size() +</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;                         final_deallocate_commands_.size());</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; extra_commands_.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++)</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;    new_num_commands += static_cast&lt;int32&gt;(extra_commands_[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].size());</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;  std::vector&lt;NnetComputation::Command&gt; new_commands;</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;  new_commands.reserve(new_num_commands);</div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;  <span class="keywordflow">for</span> (int32 c = 0; c &lt; old_num_commands; c++) {</div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;    new_commands.insert(new_commands.end(),</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;                        extra_commands_[c].begin(), extra_commands_[c].end());</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;    new_commands.push_back(<a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[c]);</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;  }</div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;  new_commands.insert(new_commands.end(),</div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;                      final_commands_.begin(), final_commands_.end());</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;  new_commands.insert(new_commands.end(),</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;                      final_deallocate_commands_.begin(),</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;                      final_deallocate_commands_.end());</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.swap(new_commands);</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;}</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;</div><div class="line"><a name="l01460"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#ad691fe3a6e61eb46c08d591d4af2ea4b"> 1460</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#ad691fe3a6e61eb46c08d591d4af2ea4b">ModelUpdateConsolidator::ConsolidateUpdateForComponent</a>(</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;    int32 component_index,</div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;    <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;backprop_commands) {</div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;  <span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Component.html">Component</a> *component = nnet_.GetComponent(component_index);</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;  int32 num_backprop_commands = backprop_commands.size();</div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;  <span class="keywordtype">bool</span> need_input = (component-&gt;<a class="code" href="classkaldi_1_1nnet3_1_1Component.html#a3a4ff15fafe0c8c4885586fc2c36ca8a">Properties</a>() &amp; <a class="code" href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3adac6588b2ef2e8b52936718cf97263e7">kBackpropNeedsInput</a>) != 0,</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;      need_output = (component-&gt;<a class="code" href="classkaldi_1_1nnet3_1_1Component.html#a3a4ff15fafe0c8c4885586fc2c36ca8a">Properties</a>() &amp; <a class="code" href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a2a37e781d9be4e2cb09699a840dde841">kBackpropNeedsOutput</a>) != 0;</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;  std::vector&lt;int32&gt;  input_submatrices(num_backprop_commands),</div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;      output_submatrices(num_backprop_commands),</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;      output_deriv_submatrices(num_backprop_commands);</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; num_backprop_commands; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;    int32 command_index = backprop_commands[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;command =</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;    <span class="comment">// arg2 must be 0 because simple components don&#39;t use precomputed indexes.</span></div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83">kBackprop</a> &amp;&amp; command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a> == 0);</div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;    command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352afab6637ac4a83d6775366b4e9c42e241">kBackpropNoModelUpdate</a>;</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;    int32 input_submatrix = command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>,</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;        output_submatrix = command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ab082999af0bd106d899d3121506053a4">arg4</a>,</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;        output_deriv_submatrix = command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a27787107ac04bc94a8708c2a5c63e092">arg5</a>;</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>((input_submatrix != 0) == need_input &amp;&amp;</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;                 (output_submatrix != 0) == need_output);</div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;    input_submatrices[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = input_submatrix;</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;    output_submatrices[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = output_submatrix;</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;    output_deriv_submatrices[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = output_deriv_submatrix;</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;  }</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;  <span class="comment">// Get the sub-matrix indexes of whichever of the consolidated matrices we</span></div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;  <span class="comment">// need (will usually be input_submatrix and output_deriv_submatrix).</span></div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;  int32 input_submatrix = (need_input ?</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;                           ConsolidateSubmatrices(backprop_commands,</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;                                                  input_submatrices) : 0),</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;      output_submatrix = (need_output ?</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;                         ConsolidateSubmatrices(backprop_commands,</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;                                                output_submatrices) : 0),</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;      output_deriv_submatrix = ConsolidateSubmatrices(backprop_commands,</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;                                                      output_deriv_submatrices);</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;  int32 precomputed_indexes_index = 0,  <span class="comment">// unused since simple component</span></div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;      input_deriv_submatrix = 0,  <span class="comment">// we don&#39;t need the input-deriv.</span></div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;      memo_index = 0;  <span class="comment">// we checked that no memos were used.</span></div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> c(<a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83">kBackprop</a>, component_index, precomputed_indexes_index,</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;                             input_submatrix, output_submatrix,</div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;                             output_deriv_submatrix, input_deriv_submatrix,</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;                             memo_index);</div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;  final_commands_.push_back(c);</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;}</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;</div><div class="line"><a name="l01509"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a49ab0eb74e9ab7b96b459d319f443d02"> 1509</a></span>&#160;<a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a49ab0eb74e9ab7b96b459d319f443d02">ModelUpdateConsolidator::ModelUpdateConsolidator</a>(</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;    <span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;nnet,</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation):</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;    nnet_(nnet), <a class="code" href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>(computation),</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;    extra_commands_(computation-&gt;commands.size()) { }</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;</div><div class="line"><a name="l01515"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1d8913b401bfd339536bdd60f97d6101"> 1515</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1d8913b401bfd339536bdd60f97d6101">ModelUpdateConsolidator::ConsolidateModelUpdate</a>() {</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;  int32 num_components = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#adbabf05a7702103113a02a113015205f">nnet_</a>.<a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html#a15b5336b4413124b1fd4531f57781182">NumComponents</a>(),</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;      num_commands = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size();</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;  <span class="comment">// &#39;backprop_commands&#39; is a list, for each component (but nonempty only for</span></div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;  <span class="comment">// updatable simple components), of the command indexes for the backprop</span></div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;  <span class="comment">// commands.</span></div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;  std::vector&lt;std::vector&lt;int32&gt; &gt; backprop_commands(num_components);</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;  <span class="keywordflow">for</span> (int32 command_index = 0;</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;       command_index &lt; num_commands; command_index++) {</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;    <span class="keywordflow">if</span> (c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83">kBackprop</a>) {</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;      int32 component_index = c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>;</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;      <span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Component.html">Component</a> *component = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#adbabf05a7702103113a02a113015205f">nnet_</a>.<a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html#aec8d6dfed3e4ab080d3ff4cf6a1126e3">GetComponent</a>(component_index);</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;      int32 properties = component-&gt;<a class="code" href="classkaldi_1_1nnet3_1_1Component.html#a3a4ff15fafe0c8c4885586fc2c36ca8a">Properties</a>();</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;      <span class="keywordflow">if</span> ((properties &amp; <a class="code" href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a61132a04f6c327dffd7f053b93ae393b">kUpdatableComponent</a>) &amp;&amp;</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;          (properties &amp; <a class="code" href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a5530b2f8f01fac9e6e73fd29a65d4127">kSimpleComponent</a>) &amp;&amp;</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;          !(properties &amp; <a class="code" href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a1713e609229066c956d4c7d544c69658">kUsesMemo</a>))</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;        backprop_commands[component_index].push_back(command_index);</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;    }</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;  }</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;  <span class="keywordtype">bool</span> consolidated = <span class="keyword">false</span>;</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;  <span class="keywordflow">for</span> (int32 component = 0; component &lt; num_components; component++) {</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;    <span class="keywordflow">if</span> (backprop_commands[component].size() &gt; 1) {</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#ad691fe3a6e61eb46c08d591d4af2ea4b">ConsolidateUpdateForComponent</a>(component,</div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;                                    backprop_commands[component]);</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;      consolidated = <span class="keyword">true</span>;</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;    }</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;  }</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;  <span class="keywordflow">if</span> (!consolidated)  <span class="comment">// This is an optimization to avoid redundant computation</span></div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;    <span class="keywordflow">return</span>;           <span class="comment">// if there is nothing to do.</span></div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;  <span class="comment">// the following function call commits all the commands we stored in member</span></div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;  <span class="comment">// variables, to computation_-&gt;commands.</span></div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a9ff791337c174a7dd4d789a414c452e3">AddCommandsToComputation</a>();</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;}</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;</div><div class="line"><a name="l01551"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#af512f7de6c401fbdf7013d62295df9c2"> 1551</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1d8913b401bfd339536bdd60f97d6101">ConsolidateModelUpdate</a>(<span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;nnet,</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;                            <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation) {</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;  <span class="comment">// This following if-statement is an optimization: if the computation</span></div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;  <span class="comment">// request(s) had need_model_derivative == false, there would be nothing to</span></div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;  <span class="comment">// optimize, so don&#39;t bother trying.</span></div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;  <span class="keywordflow">if</span> (!computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a58c542fffb7e7f754148c264c90b4a5e">need_model_derivative</a>)</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html">ModelUpdateConsolidator</a> consolidator(nnet, computation);</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;  consolidator.<a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1d8913b401bfd339536bdd60f97d6101">ConsolidateModelUpdate</a>();</div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;}</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;</div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;<span class="comment">// inline</span></div><div class="line"><a name="l01564"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#afacff028a27406ccf7e72e1f40ac6288"> 1564</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#afacff028a27406ccf7e72e1f40ac6288">DerivativeTimeLimiter::GetPruneValues</a>(int32 initial_submatrix,</div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;                                           int32 new_submatrix,</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;                                           int32 *left_prune,</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;                                           int32 *right_prune)<span class="keyword"> const </span>{</div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(initial_submatrix &gt; 0 &amp;&amp; new_submatrix &gt; 0);</div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">NnetComputation::SubMatrixInfo</a></div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;      initial_info = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[initial_submatrix],</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;      new_info = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[new_submatrix];</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(initial_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a515c4dd14ce4dc58f42c9a60b6bfbaba">matrix_index</a> == new_info.matrix_index);</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;  *left_prune = new_info.row_offset - initial_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#acfb04e9339880d3594894f5201b70eac">row_offset</a>;</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;  <span class="keywordflow">if</span> (right_prune != NULL) {</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;    *right_prune = initial_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a> - new_info.num_rows - *left_prune;</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(*left_prune &gt;= 0 &amp;&amp; *right_prune &gt;= 0);</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;  }</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;}</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;</div><div class="line"><a name="l01580"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#aa7fea2a9fb72886fbc7d8bb55f025e21"> 1580</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#aa7fea2a9fb72886fbc7d8bb55f025e21">DerivativeTimeLimiter::RowIsKept</a>(</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;    int32 submatrix,</div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;    int32 row_index)<span class="keyword"> const </span>{</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(submatrix &gt; 0 &amp;&amp; submatrix &lt; computation_-&gt;submatrices.size());</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">NnetComputation::SubMatrixInfo</a> &amp;info =</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submatrix];</div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(row_index &gt;= 0 &amp;&amp;</div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;               row_index &lt; computation_-&gt;submatrices[submatrix].num_rows);</div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;  int32 matrix_index = info.matrix_index;</div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a></div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;      &amp;debug_info = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[matrix_index];</div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;  <span class="keywordflow">if</span> (!debug_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a9da2804c57d358d12d491f0c3d51d0ef">is_deriv</a>) {</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;    <span class="comment">// the derivative time limitation doesn&#39;t apply to things that aren&#39;t</span></div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;    <span class="comment">// derivatives.</span></div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;  }</div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;  int32 t = debug_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>[row_index + info.row_offset].second.t;</div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;  <span class="keywordflow">return</span> (t &gt;= min_deriv_time_ &amp;&amp; t &lt;= max_deriv_time_);</div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;}</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;<span class="comment">// modify commands to take into account the fact that some matrices are zero or</span></div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;<span class="comment">// partially zero.  Allocation commands and sizes of underlying matrices are not</span></div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;<span class="comment">// affected-- we&#39;ll work out later on, what to do with them.</span></div><div class="line"><a name="l01604"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a104e34b2a7fa8395d34e9e6e0d24ee42"> 1604</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a104e34b2a7fa8395d34e9e6e0d24ee42">DerivativeTimeLimiter::ModifyCommand</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> *command) {</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352">CommandType</a> command_type = command-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a>;</div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;  <span class="keywordflow">switch</span> (command_type) {</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a73b5995148c3e987c4a163ad6bc9850b">kAllocMatrix</a>:</div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae77588ab7fc4ccf842de7ec941247062">kDeallocMatrix</a>:</div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a55f8cb2bfd2e2c3605dfa961eff35fa2">kSetConst</a>:</div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a8ecee91c55553bcf2d755d00328b0253">kSwapMatrix</a>:</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;      <span class="keywordflow">break</span>;  <span class="comment">// we&#39;ll deal with allocation and deallocation later on.</span></div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26ebe2a579bf27a5453cb7b489ad6f69">kPropagate</a>:</div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;      <span class="comment">// Propagate commands are unchanged, except that if the output of the</span></div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;      <span class="comment">// propagate is completely outside the accepted time-range (only likely if</span></div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;      <span class="comment">// we&#39;re inside a recurrency), then we don&#39;t store stats; this is not</span></div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;      <span class="comment">// really important, and is mostly done to minimize the difference from an</span></div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;      <span class="comment">// older version of the code, to reduce the need for testing.</span></div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;      <span class="keywordflow">if</span> (submatrix_map_[command-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ab082999af0bd106d899d3121506053a4">arg4</a>] == 0)</div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;        command-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a267b75d3c5f85743c08fb319bd679b1f">arg6</a> = 0;</div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352afab6637ac4a83d6775366b4e9c42e241">kBackpropNoModelUpdate</a>:  <span class="comment">// we actually don&#39;t expect to encounter this,</span></div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;                                  <span class="comment">// but it&#39;s trivial to support as it&#39;s the</span></div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;                                  <span class="comment">// same as backprop.</span></div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83">kBackprop</a>: {</div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;      <span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Component.html">Component</a> *component = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#adbabf05a7702103113a02a113015205f">nnet_</a>.<a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html#aec8d6dfed3e4ab080d3ff4cf6a1126e3">GetComponent</a>(command-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>);</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;      int32 properties = component-&gt;<a class="code" href="classkaldi_1_1nnet3_1_1Component.html#a3a4ff15fafe0c8c4885586fc2c36ca8a">Properties</a>();</div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;      <span class="keywordflow">if</span> (!(properties &amp; <a class="code" href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a5530b2f8f01fac9e6e73fd29a65d4127">kSimpleComponent</a>)) {</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;        <span class="comment">// we don&#39;t (yet) do this optimization for non-simple Components...</span></div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;        <span class="comment">// it would be a bit more complicated as we&#39;d have to recompute the</span></div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;        <span class="comment">// PrecomputedIndexes.</span></div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;      }</div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;      int32 input_submatrix = command-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>,</div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;          output_submatrix = command-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ab082999af0bd106d899d3121506053a4">arg4</a>,</div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;          output_deriv_submatrix = command-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a27787107ac04bc94a8708c2a5c63e092">arg5</a>,</div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;          input_deriv_submatrix = command-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a267b75d3c5f85743c08fb319bd679b1f">arg6</a>;</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;      int32 mapped_input_submatrix = submatrix_map_[input_submatrix],</div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;           mapped_output_submatrix =  submatrix_map_[output_submatrix],</div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;     mapped_output_deriv_submatrix = submatrix_map_[output_deriv_submatrix],</div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;      mapped_input_deriv_submatrix = submatrix_map_[input_deriv_submatrix];</div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;</div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;      <span class="keywordflow">if</span> (mapped_output_deriv_submatrix == 0) {</div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;        <span class="comment">// completely outside range..</span></div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;        <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(mapped_input_deriv_submatrix == 0 &amp;&amp;</div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;                     mapped_input_submatrix == 0 &amp;&amp;</div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;                     mapped_output_submatrix == 0);</div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;        <span class="comment">// just delete the command.</span></div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;        command-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;        <span class="keywordflow">if</span> (command-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a299b2046550515733509b29583ea605c">arg7</a> &gt; 0)</div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;          memos_to_delete_.insert(command-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a299b2046550515733509b29583ea605c">arg7</a>);</div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mapped_output_deriv_submatrix !=</div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;                 output_deriv_submatrix &amp;&amp;</div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;                 !(properties &amp; <a class="code" href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a1713e609229066c956d4c7d544c69658">kUsesMemo</a>)) {</div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;        <span class="comment">// we&#39;re operating on a range of the input or output.</span></div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;        <span class="comment">// we can&#39;t do this type of mapping of the component uses</span></div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;        <span class="comment">// a memo, though.</span></div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;        command-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a> = mapped_input_submatrix;</div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;        command-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ab082999af0bd106d899d3121506053a4">arg4</a> = mapped_output_submatrix;</div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;        command-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a27787107ac04bc94a8708c2a5c63e092">arg5</a> = mapped_output_deriv_submatrix;</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;        command-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a267b75d3c5f85743c08fb319bd679b1f">arg6</a> = mapped_input_deriv_submatrix;</div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;      }</div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;    }</div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a35d3d1a70d075561aaf91b263ea28f74">kMatrixCopy</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a8ce789ab4782758335cc37349fb97257">kMatrixAdd</a>:</div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;      MapSimpleMatrixCommand(command);</div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a308b0ecf9083a7fde572d88f70af6258">kCopyRows</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae9638edeb0ada9a6373257fd508ae11f">kAddRows</a>:</div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;      MapIndexesCommand(command);</div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a341a9c019757a7f1172d86bad51500a5">kCopyRowsMulti</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a5161c1dfc34a4df1b19e9d3b8dc9499c">kCopyToRowsMulti</a>:</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26009d8f2bc3f61d214925ae25af9962">kAddRowsMulti</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a662aa95978d72cd24fde262e35941fad">kAddToRowsMulti</a>:</div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;      MapIndexesMultiCommand(command);</div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a86646468234ab036580a4f2e4d72af3c">kAddRowRanges</a>: {</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;      MapAddRowRangesCommand(command);</div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;    }</div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a6b396f5162883c2f4fb837a2af4b8895">kAcceptInput</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352aaa3fd92744438323baec475cee5b9b3d">kProvideOutput</a>:</div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352af9786d4042a4fcf23b29a14a6fb64126">kNoOperationPermanent</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352af67517e882c1aebe145a016945b9e6a4">kNoOperationMarker</a>:</div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;    <span class="keywordflow">default</span>:</div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Un-handled command type.&quot;</span>;</div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;  }</div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;}</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;</div><div class="line"><a name="l01686"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ac790fa54a2c9e95706a7384c687651ad"> 1686</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ac790fa54a2c9e95706a7384c687651ad">DerivativeTimeLimiter::MapSimpleMatrixCommand</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> *c) {</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;  int32 submatrix1 = c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>,</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;      submatrix2 = c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>;</div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;  int32 submatrix1_mapped = submatrix_map_if_deriv_[submatrix1],</div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;      submatrix2_mapped = submatrix_map_if_deriv_[submatrix2];</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;  <span class="keywordflow">if</span> (submatrix1_mapped == submatrix1 &amp;&amp;</div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;      submatrix2_mapped == submatrix2) {</div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;    <span class="comment">// nothing to do.</span></div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;  }</div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;  <span class="keywordflow">if</span> (submatrix1_mapped == 0 || submatrix2_mapped == 0) {</div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;    <span class="comment">// remove the operation-- it has nothing to do.</span></div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;    c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;  }</div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;  <span class="comment">// left_prune1 is the number of rows pruned away on the left for submatrix1.</span></div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;  int32 orig_num_rows = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submatrix1].num_rows,</div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;      left_prune1, left_prune2, right_prune1, right_prune2;</div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;  GetPruneValues(submatrix1, submatrix1_mapped, &amp;left_prune1, &amp;right_prune1);</div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;  GetPruneValues(submatrix2, submatrix2_mapped, &amp;left_prune2, &amp;right_prune2);</div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;  <span class="keywordflow">if</span> (left_prune1 == left_prune2 &amp;&amp; right_prune1 == right_prune2) {</div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;    <span class="comment">// we took the same number of rows away from the left and right for</span></div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;    <span class="comment">// both arguments; the normal mapped values will work in this case</span></div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;    c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a> = submatrix1_mapped;</div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;    c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a> = submatrix2_mapped;</div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;    <span class="comment">// there is some kind of mismatch- we&#39;ll prune back to what remains</span></div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;    <span class="comment">// after applying the maximum pruning on the left and right.</span></div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;    int32 left_prune = std::max(left_prune1, left_prune2),</div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;        right_prune = std::max(right_prune1, right_prune2);</div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;    <span class="keywordflow">if</span> (left_prune + right_prune &gt;= orig_num_rows) {</div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;      <span class="comment">// everything was pruned away; remove the operation.</span></div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;      c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;      int32 num_rows = orig_num_rows - left_prune - right_prune;</div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;      <span class="comment">// note: the call NewSubMatrix effectively gives us a sub-matrix of a</span></div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;      <span class="comment">// sub-matrix.</span></div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;      c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a> = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a61634eedcfea10a32bdb33bca3f94f2b">NewSubMatrix</a>(submatrix1,</div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;                                           left_prune, num_rows, 0, -1);</div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;      c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a> = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a61634eedcfea10a32bdb33bca3f94f2b">NewSubMatrix</a>(submatrix2,</div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;                                           left_prune, num_rows, 0, -1);</div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;    }</div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;  }</div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;}</div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;</div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;<span class="comment">// does the processing for a command of type kCopyRows or kAddRows, where</span></div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;<span class="comment">// 1st and 2nd args are submatrix indexes and the 3rd arg is a vector of</span></div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;<span class="comment">// row-indexes.</span></div><div class="line"><a name="l01735"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a92539dc86963420ae51faa16150cf0be"> 1735</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a92539dc86963420ae51faa16150cf0be">DerivativeTimeLimiter::MapIndexesCommand</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> *c) {</div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;  int32 output_submatrix = c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>,</div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;      input_submatrix = c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>;</div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;  int32 input_submatrix_mapped = submatrix_map_if_deriv_[input_submatrix],</div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;      output_submatrix_mapped = submatrix_map_if_deriv_[output_submatrix];</div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;  <span class="comment">// input_submatrix_mapped and output_submatrix_mapped map both submatrices to</span></div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;  <span class="comment">// just the portion that we are treating as nonzero.</span></div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;</div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;  <span class="keywordflow">if</span> (input_submatrix_mapped == 0 ||</div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;      output_submatrix_mapped == 0) {</div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;    <span class="comment">// Either input or output is all zeros; make the command a no-op.</span></div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;    <span class="comment">// It may not be obvious that in the case of kCopyRows it would</span></div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;    <span class="comment">// be valid to make this a no-op (because what if the existing</span></div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;    <span class="comment">// contents were nonzero?), but we insist that this optimization</span></div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;    <span class="comment">// come before optimizations, and we know that the originally</span></div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;    <span class="comment">// generated computation would not overwrite a nonzero value</span></div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;    <span class="comment">// (and there are no undefined values because we make sure to</span></div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;    <span class="comment">// initialize everything with zeros; ununitialized values are</span></div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;    <span class="comment">// allowed only at a later optimization stage.</span></div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;    c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;  }</div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;  <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;old_indexes = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>[c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>];</div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;</div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;  int32 left_prune_input, left_prune_output;</div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;  GetPruneValues(input_submatrix, input_submatrix_mapped,</div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;                 &amp;left_prune_input, NULL);</div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;  GetPruneValues(output_submatrix, output_submatrix_mapped,</div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;                 &amp;left_prune_output, NULL);</div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;  int32 new_num_input_rows =</div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[input_submatrix_mapped].num_rows,</div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;      new_num_output_rows =</div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[output_submatrix_mapped].num_rows;</div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;  std::vector&lt;int32&gt; new_indexes(new_num_output_rows);</div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;  <span class="keywordtype">bool</span> must_keep_command = <span class="keyword">false</span>;</div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; new_num_output_rows; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;    <span class="comment">// the index into the &#39;new_indexes&#39; vector is the row of the output</span></div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;    <span class="comment">// submatrix; the value is the row of the input submatrix.</span></div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;    int32 orig_index = old_indexes[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> + left_prune_output];</div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;    <span class="keywordflow">if</span> (orig_index == -1 ||</div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;        !RowIsKept(input_submatrix, orig_index) ||</div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;        !RowIsKept(output_submatrix_mapped, <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>)) {</div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;      new_indexes[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = -1;</div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;      int32 mapped_index = orig_index - left_prune_input;</div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;      <span class="comment">// we can do the following assert because the RowIsKept command</span></div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;      <span class="comment">// would have turned it into a -1 if not.</span></div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;      <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(mapped_index &gt;= 0 &amp;&amp; mapped_index &lt; new_num_input_rows);</div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;      new_indexes[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = mapped_index;</div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;      must_keep_command = <span class="keyword">true</span>;</div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;    }</div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;  }</div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;  <span class="keywordflow">if</span> (!must_keep_command) {</div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;    c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;  }</div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;  int32 new_indexes_index = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>.size();</div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>.push_back(new_indexes);</div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;  c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a> = output_submatrix_mapped;</div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;  c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a> = input_submatrix_mapped;</div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;  c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a> = new_indexes_index;</div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;}</div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;</div><div class="line"><a name="l01798"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a5907a076729be892104754ad91aa38d5"> 1798</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a5907a076729be892104754ad91aa38d5">DerivativeTimeLimiter::MapIndexesMultiCommand</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> *c) {</div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;  int32 dest_submatrix = c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>,</div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;      indexes_multi_arg = c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>;</div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;  int32 dest_submatrix_mapped = submatrix_map_if_deriv_[dest_submatrix];</div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;  <span class="keywordflow">if</span> (dest_submatrix_mapped == 0) {</div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;    <span class="comment">// The destination matrix is completely outside the allowed time range.</span></div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;    c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;  }</div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;  int32 left_prune;</div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;  GetPruneValues(dest_submatrix, dest_submatrix_mapped, &amp;left_prune, NULL);</div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;  int32 new_num_rows = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[dest_submatrix_mapped].num_rows;</div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;  <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;old_indexes_multi(</div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>[indexes_multi_arg]);</div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;  std::vector&lt;std::pair&lt;int32, int32&gt; &gt; new_indexes_multi(new_num_rows);</div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;  <span class="keywordtype">bool</span> must_keep_command = <span class="keyword">false</span>;</div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; new_num_rows; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;    std::pair&lt;int32,int32&gt; &amp;this_pair = new_indexes_multi[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;    this_pair = old_indexes_multi[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> + left_prune];</div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;    <span class="comment">// note: &#39;this_submatrix&#39; is the source submatrix, from where we copy or add</span></div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;    <span class="comment">// the the data; &#39;this_row&#39; is the source row.</span></div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;    int32 this_submatrix = this_pair.first,</div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;        this_row = this_pair.second;</div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;    <span class="keywordflow">if</span> (this_submatrix == -1)  <span class="comment">// don&#39;t map the (-1, -1) pairs.</span></div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;      <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;    <span class="keywordflow">if</span> (!RowIsKept(this_submatrix, this_row) ||</div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;        !RowIsKept(dest_submatrix_mapped, <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>)) {</div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;      this_pair.first = -1;</div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;      this_pair.second = -1;</div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;      <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;    }</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;    int32 this_submatrix_mapped = submatrix_map_if_deriv_[this_submatrix];</div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;    <span class="comment">// Reason for the assert below: if this_submatrix_mapped was 0, then all the</span></div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;    <span class="comment">// values in it should be not-kept, but RowIsKept above returned true, so</span></div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;    <span class="comment">// this would be a code error.</span></div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(this_submatrix_mapped != 0);</div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;</div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;    int32 this_left_prune, this_num_rows =</div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[this_submatrix_mapped].num_rows;</div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;    GetPruneValues(this_submatrix, this_submatrix_mapped,</div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;                   &amp;this_left_prune, NULL);</div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;    int32 this_row_mapped = this_row - this_left_prune;</div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;    <span class="comment">// the above assert is there because if it was going to be outside the</span></div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;    <span class="comment">// kept range, RowIsKept should have returned false above.</span></div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(this_row_mapped &gt;= 0 &amp;&amp; this_row_mapped &lt; this_num_rows);</div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;    this_pair.first = this_submatrix_mapped;</div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;    this_pair.second = this_row_mapped;</div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;    must_keep_command = <span class="keyword">true</span>;</div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;  }</div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;  <span class="keywordflow">if</span> (!must_keep_command) {</div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;    c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;  }</div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;  <span class="keywordflow">if</span> (dest_submatrix_mapped == dest_submatrix &amp;&amp;</div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;      new_indexes_multi == old_indexes_multi)  <span class="comment">// nothing changed.</span></div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;  c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a> = dest_submatrix_mapped;</div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;  c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a> = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>.size();</div><div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>.push_back(new_indexes_multi);</div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;}</div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;</div><div class="line"><a name="l01860"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a071bff9d8909e7d80b7d85a3d3b69aff"> 1860</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a071bff9d8909e7d80b7d85a3d3b69aff">DerivativeTimeLimiter::MapAddRowRangesCommand</a>(</div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> *c) {</div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;  int32 dest_submatrix = c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>,</div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;      src_submatrix = c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>,</div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;      indexes_ranges_index = c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>;</div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;  int32 dest_submatrix_mapped = submatrix_map_if_deriv_[dest_submatrix],</div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;      src_submatrix_mapped = submatrix_map_if_deriv_[src_submatrix];</div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;  <span class="keywordflow">if</span> (dest_submatrix_mapped == dest_submatrix &amp;&amp;</div><div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;      src_submatrix_mapped == src_submatrix)</div><div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;  <span class="keywordflow">if</span> (dest_submatrix_mapped == 0 || src_submatrix_mapped == 0) {</div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;    c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;  }</div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;  int32 dest_num_rows = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[dest_submatrix_mapped].num_rows,</div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;      src_num_rows = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[src_submatrix_mapped].num_rows,</div><div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;      src_left_prune, dest_left_prune;</div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;  GetPruneValues(dest_submatrix, dest_submatrix_mapped,</div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;                 &amp;dest_left_prune, NULL);</div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;  GetPruneValues(src_submatrix, src_submatrix_mapped,</div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;                 &amp;src_left_prune, NULL);</div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;  <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32,int32&gt; &gt; &amp;old_indexes_ranges(</div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a3095d45a751aaa81c1024cf9510e2ed7">indexes_ranges</a>[indexes_ranges_index]);</div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;  std::vector&lt;std::pair&lt;int32,int32&gt; &gt; new_indexes_ranges(dest_num_rows);</div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;</div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;  <span class="keywordtype">bool</span> must_keep_command = <span class="keyword">false</span>;</div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; dest_num_rows; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;    std::pair&lt;int32, int32&gt; &amp;this_pair = new_indexes_ranges[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;    this_pair = old_indexes_ranges[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> + dest_left_prune];</div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;</div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;    int32 start = this_pair.first, end = this_pair.second;</div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;    <span class="keywordflow">if</span> (!RowIsKept(dest_submatrix_mapped, <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>)) {</div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;      start = -1;</div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;      end = -1;</div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (start &gt;= 0) {</div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;      <span class="comment">// no need to change start, end if they are (-1, -1).</span></div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;      <span class="comment">// Note: this code is not optimally efficient, as RowIsKept</span></div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;      <span class="comment">// has a bunch of statements that we could cache some variables</span></div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;      <span class="comment">// for, but this command is pretty rare so not worth to optimize</span></div><div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;      <span class="comment">// at this point.</span></div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;      <span class="keywordflow">while</span> (start &lt; end &amp;&amp; !RowIsKept(src_submatrix, start))</div><div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;        start++;</div><div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;      <span class="keywordflow">while</span> (end &gt; start &amp;&amp; !RowIsKept(src_submatrix, end - 1))</div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;        end--;</div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;      <span class="keywordflow">if</span> (start == end) {</div><div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;        start = -1;</div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;        end = -1;</div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;        start -= src_left_prune;</div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;        end -= src_left_prune;</div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;        must_keep_command = <span class="keyword">true</span>;</div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;        <span class="comment">// the next assert is because if we were outside the &#39;kept&#39; part of the</span></div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;        <span class="comment">// submatrix, RowIsKept() should have instructed us to modify the value.</span></div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;        <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(start &gt;= 0 &amp;&amp; end &lt;= src_num_rows &amp;&amp; start &lt; end);</div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;      }</div><div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;    }</div><div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;    this_pair.first = start;</div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;    this_pair.second = end;</div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;  }</div><div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;  <span class="keywordflow">if</span> (must_keep_command) {</div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;    c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a> = dest_submatrix_mapped;</div><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;    c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a> = src_submatrix_mapped;</div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;    c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a> = <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a3095d45a751aaa81c1024cf9510e2ed7">indexes_ranges</a>.size();</div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a3095d45a751aaa81c1024cf9510e2ed7">indexes_ranges</a>.push_back(new_indexes_ranges);</div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;    c-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;  }</div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;}</div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;</div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;</div><div class="line"><a name="l01930"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a8217a8f0d8406fe0e5fdbdb371feebbd"> 1930</a></span>&#160;<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a8217a8f0d8406fe0e5fdbdb371feebbd">DerivativeTimeLimiter::DerivativeTimeLimiter</a>(<span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;nnet,</div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;                                             int32 min_deriv_time,</div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;                                             int32 max_deriv_time,</div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;                                             <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation):</div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#adbabf05a7702103113a02a113015205f">nnet_</a>(nnet),</div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;    min_deriv_time_(min_deriv_time),</div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;    max_deriv_time_(max_deriv_time),</div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>(computation) { }</div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;</div><div class="line"><a name="l01939"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a594bab8b25225a0b1c64109336934916"> 1939</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a594bab8b25225a0b1c64109336934916">DerivativeTimeLimiter::LimitDerivTimes</a>() {</div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a7b34d0f8ba1be1c25827f404fd1de33c">max_deriv_time_</a> &gt;= <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a7d43f793d8585fd0de88e7a428d60a6b">min_deriv_time_</a>);</div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a7d43f793d8585fd0de88e7a428d60a6b">min_deriv_time_</a> == std::numeric_limits&lt;int32&gt;::min() &amp;&amp;</div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a7b34d0f8ba1be1c25827f404fd1de33c">max_deriv_time_</a> == std::numeric_limits&lt;int32&gt;::max())</div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;    <span class="keywordflow">return</span>;  <span class="comment">// nothing to do.</span></div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;</div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ac6ad0d391be80aff8f4538b6fbf747b1">GetWholeSubmatrices</a>(&amp;<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ab7df4401facb8eb025241471ca37a9d9">whole_submatrices_</a>);</div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ab5c1a034b55e741c8e3019aaab55db03">ComputeMatrixPruneInfo</a>();</div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a8bca4ab6bca2d1728dc0b03cf863be52">ComputeSubmatrixMaps</a>();</div><div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ae00720e16e58e1065f81793469767a84">ModifyCommands</a>();</div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ad70a13d2a5ffc3f7e7370f7b4e774a73">PruneMatrices</a>();</div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a1146f4efa141a56210f9dbf1090b20f0">RemoveNoOps</a>(<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>);</div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#accb646181ec3c992ecd18442ec788d33">RemoveUnusedMemos</a>();</div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a6828e427bd8883455705e0c9b99b5f2f">RenumberComputation</a>(<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>);</div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;}</div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;</div><div class="line"><a name="l01955"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#accb646181ec3c992ecd18442ec788d33"> 1955</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#accb646181ec3c992ecd18442ec788d33">DerivativeTimeLimiter::RemoveUnusedMemos</a>() {</div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a6e33b4d185cc5638ac9a27c09d211490">memos_to_delete_</a>.empty())</div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;  <span class="keywordtype">size_t</span> num_commands = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size(),</div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;      num_memos_removed = 0;</div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> command_index = 0; command_index &lt; num_commands;</div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;       command_index++) {</div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;    <span class="keywordflow">if</span> (c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26ebe2a579bf27a5453cb7b489ad6f69">kPropagate</a> &amp;&amp;</div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a6e33b4d185cc5638ac9a27c09d211490">memos_to_delete_</a>.count(c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a27787107ac04bc94a8708c2a5c63e092">arg5</a>) != 0) {</div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;      c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a27787107ac04bc94a8708c2a5c63e092">arg5</a> = 0;</div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;      num_memos_removed++;</div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;    }</div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;  }</div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(num_memos_removed == <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a6e33b4d185cc5638ac9a27c09d211490">memos_to_delete_</a>.size());</div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;}</div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;</div><div class="line"><a name="l01972"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ab5c1a034b55e741c8e3019aaab55db03"> 1972</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ab5c1a034b55e741c8e3019aaab55db03">DerivativeTimeLimiter::ComputeMatrixPruneInfo</a>() {</div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.size() ==</div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;               <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>.size() &amp;&amp;</div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;               <span class="stringliteral">&quot;Limiting derivative times requires debug info.&quot;</span>);</div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;  <span class="keyword">const</span> int32 num_matrices = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>.size(),</div><div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;      min_deriv_time = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a7d43f793d8585fd0de88e7a428d60a6b">min_deriv_time_</a>,</div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;      max_deriv_time = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a7b34d0f8ba1be1c25827f404fd1de33c">max_deriv_time_</a>;</div><div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a1e3dad6a0a1c8cc5e5806070896de8c1">matrix_prune_info_</a>.resize(num_matrices);</div><div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;  <span class="comment">// matrix_prune_info_[0] will remain undefined.</span></div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;  <span class="keywordflow">for</span> (int32 matrix_index = 1; matrix_index &lt; num_matrices; matrix_index++) {</div><div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a> &amp;debug_info =</div><div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[matrix_index];</div><div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html">MatrixPruneInfo</a> &amp;prune_info = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a1e3dad6a0a1c8cc5e5806070896de8c1">matrix_prune_info_</a>[matrix_index];</div><div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;    <span class="keyword">const</span> std::vector&lt;Cindex&gt; &amp;cindexes = debug_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>;</div><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;    int32 num_rows = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[matrix_index].num_rows;</div><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(num_rows == static_cast&lt;int32&gt;(cindexes.size()));</div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;    int32 first_row_within_range = num_rows,</div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;        last_row_within_range = -1;</div><div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;    <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; num_rows; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;      int32 t = cindexes[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].second.t;</div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;      <span class="keywordflow">if</span> (t &gt;= min_deriv_time &amp;&amp; t &lt;= max_deriv_time) {</div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; first_row_within_range) first_row_within_range = <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>;</div><div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &gt; last_row_within_range) last_row_within_range = <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>;</div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;      }</div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;    }</div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;    <span class="keywordflow">if</span> (last_row_within_range == -1) {</div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;      prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a3080a09e5ea2e63c0b61d0ab3d0958bc">fully_inside_range</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;      prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a64221ce8a4754677e990d336b6154936">partly_inside_range</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (last_row_within_range == num_rows - 1 &amp;&amp;</div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;               first_row_within_range == 0) {</div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;      prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a3080a09e5ea2e63c0b61d0ab3d0958bc">fully_inside_range</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;      prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a64221ce8a4754677e990d336b6154936">partly_inside_range</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;      prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a3080a09e5ea2e63c0b61d0ab3d0958bc">fully_inside_range</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;      prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a64221ce8a4754677e990d336b6154936">partly_inside_range</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;      prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a1854b20fac9e366b01781d5d7c3a87e9">row_begin</a> = first_row_within_range;</div><div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;      prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a5b5e72d60df6479503b80e9ed4861fc6">row_end</a> = last_row_within_range + 1;</div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;    }</div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;  }</div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;}</div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;</div><div class="line"><a name="l02013"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a8bca4ab6bca2d1728dc0b03cf863be52"> 2013</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a8bca4ab6bca2d1728dc0b03cf863be52">DerivativeTimeLimiter::ComputeSubmatrixMaps</a>() {</div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;  int32 num_submatrices = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.size();</div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a066039f8c4f9f320876c465226f17f59">submatrix_map_</a>.resize(num_submatrices);</div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a14a83a4f58ad0342612cbb5ff943c580">submatrix_map_if_deriv_</a>.resize(num_submatrices);</div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;  <span class="comment">// index zero is for the empty submatrix.</span></div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a066039f8c4f9f320876c465226f17f59">submatrix_map_</a>[0] = 0;</div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a14a83a4f58ad0342612cbb5ff943c580">submatrix_map_if_deriv_</a>[0] = 0;</div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;  <span class="keywordflow">for</span> (int32 s = 1; s &lt; num_submatrices; s++) {</div><div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">NnetComputation::SubMatrixInfo</a> &amp;submatrix_info(<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s]);</div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;    int32 matrix_index = submatrix_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a515c4dd14ce4dc58f42c9a60b6bfbaba">matrix_index</a>;</div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;    int32 row_offset = submatrix_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#acfb04e9339880d3594894f5201b70eac">row_offset</a>,</div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;        num_rows = submatrix_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a>;</div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html">MatrixPruneInfo</a> &amp;matrix_prune_info = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a1e3dad6a0a1c8cc5e5806070896de8c1">matrix_prune_info_</a>[matrix_index];</div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;    <span class="keywordflow">if</span> (matrix_prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a3080a09e5ea2e63c0b61d0ab3d0958bc">fully_inside_range</a>) {</div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a066039f8c4f9f320876c465226f17f59">submatrix_map_</a>[s] = s;</div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!matrix_prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a64221ce8a4754677e990d336b6154936">partly_inside_range</a>) {</div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;      <span class="comment">// completely outside time range.</span></div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a066039f8c4f9f320876c465226f17f59">submatrix_map_</a>[s] = 0;</div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;      <span class="comment">// the matrix is partly inside the time range.</span></div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;      int32 pruned_row_begin = std::max(matrix_prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a1854b20fac9e366b01781d5d7c3a87e9">row_begin</a>,</div><div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;                                        row_offset),</div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;          pruned_row_end = std::min(matrix_prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a5b5e72d60df6479503b80e9ed4861fc6">row_end</a>,</div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;                                    row_offset + num_rows);</div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;      <span class="keywordflow">if</span> (pruned_row_end &lt;= pruned_row_begin) {</div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;        <span class="comment">// there was no overlap between the submatrix and the part</span></div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;        <span class="comment">// of the matrix that was inside the time range.</span></div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a066039f8c4f9f320876c465226f17f59">submatrix_map_</a>[s] = 0;</div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;        <span class="comment">// caution: this invalidates the reference &#39;submatrix_info&#39;.</span></div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;        int32 row_offset_within_submatrix =</div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;            pruned_row_begin - row_offset,</div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;            new_num_rows = pruned_row_end - pruned_row_begin;</div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a066039f8c4f9f320876c465226f17f59">submatrix_map_</a>[s] =</div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;            <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a61634eedcfea10a32bdb33bca3f94f2b">NewSubMatrix</a>(s, row_offset_within_submatrix,</div><div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;                                       new_num_rows, 0, -1);</div><div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;      }</div><div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;    }</div><div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;    <span class="keywordtype">bool</span> is_deriv = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[matrix_index].is_deriv;</div><div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a14a83a4f58ad0342612cbb5ff943c580">submatrix_map_if_deriv_</a>[s] = (is_deriv ?</div><div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;                                  <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a066039f8c4f9f320876c465226f17f59">submatrix_map_</a>[s] : s);</div><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;  }</div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;}</div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;</div><div class="line"><a name="l02057"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ae00720e16e58e1065f81793469767a84"> 2057</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ae00720e16e58e1065f81793469767a84">DerivativeTimeLimiter::ModifyCommands</a>() {</div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;  std::vector&lt;NnetComputation::Command&gt;::iterator</div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;      iter = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.begin(),</div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;      end =  <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.end();</div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;  <span class="keywordflow">for</span> (; iter != end; ++iter)</div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a104e34b2a7fa8395d34e9e6e0d24ee42">ModifyCommand</a>(&amp;(*iter));</div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;}</div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;</div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;<span class="comment">// called from PruneMatrices only for matrices that are derivatives,</span></div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;<span class="comment">// not inputs or outputs of the computation, and which are partly</span></div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;<span class="comment">// inside the time range, this function returns true if we can</span></div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;<span class="comment">// limit the size of the matrix (because variables outside the</span></div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;<span class="comment">// desired range are never accessed), and false otherwise.</span></div><div class="line"><a name="l02070"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ab1ce7f2f77d6a0b0dcd87e3b09bc7a43"> 2070</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ab1ce7f2f77d6a0b0dcd87e3b09bc7a43">DerivativeTimeLimiter::CanLimitMatrix</a>(<span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html">Analyzer</a> &amp;analyzer,</div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;                                           int32 m)<span class="keyword"> const </span>{</div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;  int32 s_whole = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ab7df4401facb8eb025241471ca37a9d9">whole_submatrices_</a>[m];  <span class="comment">// submatrix consisting of</span></div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;                                          <span class="comment">// all of the matrix m</span></div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;  int32 s_mapped = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a066039f8c4f9f320876c465226f17f59">submatrix_map_</a>[s_whole];  <span class="comment">// submatrix consisting of the time</span></div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;                                             <span class="comment">// range of the matrix m that we</span></div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;                                             <span class="comment">// plan to limit it to.</span></div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(s_mapped != 0 &amp;&amp; s_mapped != s_whole);</div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;  std::vector&lt;int32&gt; whole_variables, mapped_variables;</div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;  analyzer.<a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html#afe662460f3e8b135d96fcd057638bd28">variables</a>.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationVariables.html#a15ab7e051d1b51d4e5391c92cb283c50">AppendVariablesForSubmatrix</a>(s_whole,</div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;                                                 &amp;whole_variables);</div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;  analyzer.<a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html#afe662460f3e8b135d96fcd057638bd28">variables</a>.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationVariables.html#a15ab7e051d1b51d4e5391c92cb283c50">AppendVariablesForSubmatrix</a>(s_mapped,</div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;                                                 &amp;mapped_variables);</div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(whole_variables.size() &gt; mapped_variables.size());</div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;  std::vector&lt;int32&gt; excluded_variables(whole_variables.size() -</div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;                                        mapped_variables.size());</div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;  std::vector&lt;int32&gt;::iterator end_iter =</div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;      std::set_difference(whole_variables.begin(), whole_variables.end(),</div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;                          mapped_variables.begin(), mapped_variables.end(),</div><div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;                          excluded_variables.begin());</div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(end_iter == excluded_variables.end());</div><div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;  <span class="comment">// We want to make sure that none of the excluded variables are ever accessed,</span></div><div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;  <span class="comment">// except possibly for zeroing or setting to other constant value.  If they</span></div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;  <span class="comment">// are, we cannot prune the matrix.</span></div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;  <span class="keywordflow">for</span> (std::vector&lt;int32&gt;::iterator iter = excluded_variables.begin();</div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;       iter != end_iter; ++iter) {</div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;    int32 variable_index = *iter;</div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;    <span class="keyword">const</span> std::vector&lt;Access&gt; &amp;variable_accesses =</div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;        analyzer.<a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html#a3b73c505d462ed9086dc5fc3735202a7">variable_accesses</a>[variable_index];</div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;    std::vector&lt;Access&gt;::const_iterator viter = variable_accesses.begin(),</div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;        vend = variable_accesses.end();</div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;    <span class="keywordflow">for</span> (; viter != vend; ++viter) {</div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;      <span class="comment">// if a variable outside the pruned range of the matrix is ever accessed</span></div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;      <span class="comment">// apart from on allocation, we cannot prune.</span></div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;      int32 command_index = viter-&gt;command_index;</div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;      <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;command = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;      <span class="keywordflow">if</span> (command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> != <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a55f8cb2bfd2e2c3605dfa961eff35fa2">kSetConst</a>) {</div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;        <span class="comment">// we may one day want to look at this.. it&#39;s not really expected.</span></div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;        <a class="code" href="group__error__group.html#ga16c81ec6ff3ba04c6ff96fdaed9d854e">KALDI_VLOG</a>(3) &lt;&lt; <span class="stringliteral">&quot;Cannot prune matrix &quot;</span> &lt;&lt; m;</div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;      }</div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;    }</div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;  }</div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;}</div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;</div><div class="line"><a name="l02116"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a421b918da6c7e4b2706ae55f7be3611c"> 2116</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a421b918da6c7e4b2706ae55f7be3611c">DerivativeTimeLimiter::LimitMatrices</a>(<span class="keyword">const</span> std::vector&lt;bool&gt; &amp;will_limit) {</div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;  <span class="comment">// first modify &#39;submatrices&#39;.</span></div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;  int32 num_submatrices = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.size(),</div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;      num_matrices = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>.size();</div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;  <span class="keywordflow">for</span> (int32 s = 1; s &lt; num_submatrices; s++) {</div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">NnetComputation::SubMatrixInfo</a> &amp;submat_info = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s];</div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;    int32 m = submat_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a515c4dd14ce4dc58f42c9a60b6bfbaba">matrix_index</a>;</div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;    <span class="keywordflow">if</span> (will_limit[m]) {</div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;      <span class="comment">// we need to do something...</span></div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;      <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html">MatrixPruneInfo</a> &amp;prune_info = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a1e3dad6a0a1c8cc5e5806070896de8c1">matrix_prune_info_</a>[m];</div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;      int32 matrix_num_rows = prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a5b5e72d60df6479503b80e9ed4861fc6">row_end</a> - prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a1854b20fac9e366b01781d5d7c3a87e9">row_begin</a>;</div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;      <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(matrix_num_rows &gt; 0 &amp;&amp;</div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;                   matrix_num_rows &lt; computation_-&gt;matrices[m].num_rows);</div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;      <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a64221ce8a4754677e990d336b6154936">partly_inside_range</a>);</div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;      int32 new_row_begin = submat_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#acfb04e9339880d3594894f5201b70eac">row_offset</a> - prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a1854b20fac9e366b01781d5d7c3a87e9">row_begin</a>;</div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;      <span class="keywordflow">if</span> (new_row_begin &gt;= 0 &amp;&amp;</div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;          submat_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a> + new_row_begin &lt;= matrix_num_rows) {</div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;        <span class="comment">// If this submatrix is entirely inside the limited range of the matrix,</span></div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;        <span class="comment">// then we modify its row_offset to account for the truncation of</span></div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;        <span class="comment">// rows to the left.</span></div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;        submat_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#acfb04e9339880d3594894f5201b70eac">row_offset</a> = new_row_begin;</div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;        <span class="comment">// This submatrix is not entirely inside the kept range of the matrix.</span></div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;        <span class="comment">// We assume that this submatrix is never accessed directly except (if</span></div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;        <span class="comment">// it was the whole matrix) for in allocation and deallocation commands,</span></div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;        <span class="comment">// since when we modified the computation we ensured this.</span></div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab4efec36ef0d5bab190891c36bd9b2e3">IsWholeMatrix</a>(s)) {</div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;          <span class="comment">// If it was the whole matrix then it may be used in allocation and</span></div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;          <span class="comment">// deallocation commands, so we should modify it to be the whole of the</span></div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;          <span class="comment">// new matrix, which will have fewer rows than before.</span></div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;          submat_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a> = matrix_num_rows;</div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;          <span class="comment">// We believe this matrix should never be used.  We give it a valid</span></div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;          <span class="comment">// but stupid size of num-rows=1, num-cols=1, so that if it ever does</span></div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;          <span class="comment">// get accessed it should produce an error.</span></div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;          submat_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#acfb04e9339880d3594894f5201b70eac">row_offset</a> = 0;</div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;          submat_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a> = 1;</div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;          submat_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a7524bea2834a3dc08b90e5b3406ee0e8">col_offset</a> = 0;</div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;          submat_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#aea941d74a486998b6fa921bc19fed05c">num_cols</a> = 1;</div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;        }</div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;      }</div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;    }</div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;  }</div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;  <span class="comment">// next modify &#39;matrices&#39;</span></div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;  <span class="keywordflow">for</span> (int32 m = 1; m &lt; num_matrices; m++) {</div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;    <span class="keywordflow">if</span> (will_limit[m]) {</div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;      <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html">MatrixPruneInfo</a> &amp;prune_info = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a1e3dad6a0a1c8cc5e5806070896de8c1">matrix_prune_info_</a>[m];</div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;      <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html">NnetComputation::MatrixInfo</a> &amp;matrix_info = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m];</div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;      <span class="keywordflow">if</span> (!<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.empty()) {</div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;        <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a> &amp;debug_info =</div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;            <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[m];</div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;        std::vector&lt;Cindex&gt; &amp;cindexes = debug_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>;</div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;        <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(cindexes.size() == <span class="keyword">static_cast&lt;</span><span class="keywordtype">size_t</span><span class="keyword">&gt;</span>(matrix_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a>));</div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;        cindexes.erase(cindexes.begin() + prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a5b5e72d60df6479503b80e9ed4861fc6">row_end</a>, cindexes.end());</div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;        cindexes.erase(cindexes.begin(),</div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;                       cindexes.begin() + prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a1854b20fac9e366b01781d5d7c3a87e9">row_begin</a>);</div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;      }</div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;      matrix_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a> = prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a5b5e72d60df6479503b80e9ed4861fc6">row_end</a> - prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a1854b20fac9e366b01781d5d7c3a87e9">row_begin</a>;</div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;      <span class="comment">// num_cols stays the same.</span></div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;    }</div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;  }</div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;}</div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;</div><div class="line"><a name="l02179"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ad70a13d2a5ffc3f7e7370f7b4e774a73"> 2179</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ad70a13d2a5ffc3f7e7370f7b4e774a73">DerivativeTimeLimiter::PruneMatrices</a>() {</div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html">Analyzer</a> analyzer;</div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;  analyzer.<a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html#aab8a145e53802c80302dc498e388a2ad">Init</a>(<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#adbabf05a7702103113a02a113015205f">nnet_</a>, *<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>);</div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>.size() == <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ab7df4401facb8eb025241471ca37a9d9">whole_submatrices_</a>.size());</div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;  int32 num_matrices = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>.size();</div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;  std::vector&lt;bool&gt; will_limit(num_matrices, <span class="keyword">false</span>);</div><div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;  <span class="keywordtype">bool</span> will_limit_at_least_one = <span class="keyword">false</span>;</div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;  <span class="keywordflow">for</span> (int32 m = 1; m &lt; num_matrices; m++) {</div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html">MatrixAccesses</a> &amp;accesses = analyzer.<a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html#a1451c041c35be895025d122f136b9959">matrix_accesses</a>[m];</div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html">MatrixPruneInfo</a> &amp;matrix_prune_info = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a1e3dad6a0a1c8cc5e5806070896de8c1">matrix_prune_info_</a>[m];</div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;    <span class="keywordflow">if</span> (matrix_prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a3080a09e5ea2e63c0b61d0ab3d0958bc">fully_inside_range</a> ||</div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;        accesses.<a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#aa8a8ede92285acbe2795e8570b81c9ae">is_input</a> || accesses.<a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#a7464ec491eeba4c23632a6ae583e9429">is_output</a> ||</div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;        !<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[m].is_deriv)</div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;      <span class="keywordflow">continue</span>;  <span class="comment">// nothing to do: it&#39;s inside the time-range or not a</span></div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;                 <span class="comment">// derivative.</span></div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;    <span class="comment">// if we got here it&#39;s not completely inside the time range, not an input or</span></div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;    <span class="comment">// an output, and it&#39;s a derivative.</span></div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;    <span class="keywordflow">if</span> (!matrix_prune_info.<a class="code" href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a64221ce8a4754677e990d336b6154936">partly_inside_range</a>) {</div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;      <span class="comment">// completely outside time range.  we can prune the matrix if it is not an</span></div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;      <span class="comment">// input or output, and is never accessed apart from allocation.</span></div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="namespacekaldi_1_1nnet3.html#ac879380727c26962a7aaa4a6de9dc4d4">MatrixIsUnused</a>(analyzer, *<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>, m))</div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;          <a class="code" href="namespacekaldi_1_1nnet3.html#af53fca33c55f05968eab8ec1009509e6">RemoveCommandsForUnusedMatrix</a>(analyzer, m, <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>);</div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;      <span class="comment">// the matrix is partly inside the time range, it&#39;s a derivative, and not</span></div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;      <span class="comment">// an input or an output.</span></div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ab1ce7f2f77d6a0b0dcd87e3b09bc7a43">CanLimitMatrix</a>(analyzer, m)) {</div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;        will_limit[m] = <span class="keyword">true</span>;</div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;        will_limit_at_least_one = <span class="keyword">true</span>;</div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;      }</div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;    }</div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;  }</div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;  <span class="keywordflow">if</span> (will_limit_at_least_one)</div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a421b918da6c7e4b2706ae55f7be3611c">LimitMatrices</a>(will_limit);</div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;}</div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;</div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;</div><div class="line"><a name="l02215"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a6ed9b871bd28649b80165dc1af5d1a98"> 2215</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a6ed9b871bd28649b80165dc1af5d1a98">LimitDerivativeTimes</a>(<span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;nnet,</div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;                          int32 min_deriv_time,</div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;                          int32 max_deriv_time,</div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;                          <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation) {</div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html">DerivativeTimeLimiter</a> limiter(nnet, min_deriv_time, max_deriv_time,</div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;                                computation);</div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;  limiter.<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a594bab8b25225a0b1c64109336934916">LimitDerivTimes</a>();</div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;}</div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;</div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;</div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;<span class="comment">  This helper function, used in ReplaceRowWithMatrixOps, detects</span></div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;<span class="comment">  when the vector &#39;indexes&#39; has a &#39;special structure&#39;.  The special structure</span></div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;<span class="comment">  is:</span></div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;<span class="comment">    zero or more -1&#39;s, then</span></div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;<span class="comment">    a consecutive nonempty sequence of nonnegative numbers, e.g. 6 7 8 9 10, then</span></div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;<span class="comment">    zero or more -1&#39;s.</span></div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;<span class="comment"></span></div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;<span class="comment">  Note: this function assumes that any negative elements of &#39;indexes&#39; are -1.</span></div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;<span class="comment">  If there are elements less than -1, then it is an error, but this function</span></div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;<span class="comment">  does not thoroughly check for that.  &#39;indexes&#39; is required to be a nonempty</span></div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;<span class="comment">  vector.</span></div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;<span class="comment"></span></div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;<span class="comment">  If &#39;indexes&#39; has the special structure then this function returns true</span></div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;<span class="comment">  and sets the following values, which will explain with the following</span></div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;<span class="comment">  example in mind: &#39;indexes = [ -1, -1, 5 6 7 8, -1 ]&#39;.</span></div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;<span class="comment">     - &#39;*first_nonnegative_pos&#39; is set to the number of initial -1&#39;s (and also</span></div><div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;<span class="comment">       the location of the first nonnegative element): 2 in this case.</span></div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;<span class="comment">     - &#39;*first_nonnegative_value&#39; is set to the value of the first nonnegative</span></div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;<span class="comment">       element (5 in this case)</span></div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;<span class="comment">     - &#39;*num_nonnegative_values&#39; is set to the number of nonnegative values in</span></div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;<span class="comment">       the sequence (4 in this case).</span></div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;<span class="comment">  If &#39;indexes&#39; does not have this special structure, then this function returns</span></div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;<span class="comment">  false, and the values of &#39;*first_nonnegative_pos&#39;,</span></div><div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;<span class="comment">  &#39;*first_nonnegative_value&#39; and &#39;*num_nonnegative_indexes&#39; on exit are</span></div><div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;<span class="comment">  undefined.</span></div><div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l02252"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a68068a73dabd55faade8d658a56f277b"> 2252</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a68068a73dabd55faade8d658a56f277b">IndexesHaveSpecialStructure</a>(<span class="keyword">const</span> std::vector&lt;int32&gt; &amp;indexes,</div><div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;                                        int32 *first_nonnegative_pos,</div><div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;                                        int32 *first_nonnegative_value,</div><div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;                                        int32 *num_nonnegative_indexes) {</div><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!indexes.empty());</div><div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;  <span class="keyword">const</span> int32 *indexes_ptr = &amp;(indexes[0]);</div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;  <span class="keywordtype">size_t</span> pos = 0, size = indexes.size();</div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;</div><div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;  <span class="comment">// Find the first nonnegative element of &#39;indexes&#39;.</span></div><div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;  <span class="keywordflow">for</span> (; pos &lt; size; ++pos)</div><div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;    <span class="keywordflow">if</span> (indexes_ptr[pos] &gt;= 0)</div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;  <span class="keywordflow">if</span> (pos == size)</div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// all -1&#39;s... should not happen, but not our problem.</span></div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;  *first_nonnegative_pos = <span class="keyword">static_cast&lt;</span>int32<span class="keyword">&gt;</span>(pos);</div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;  int32 <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a> = indexes_ptr[pos];</div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;  *first_nonnegative_value = <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a>;</div><div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;  <span class="comment">// Find the first element after &#39;*first_nonnegative_index&#39; that isn&#39;t</span></div><div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;  <span class="comment">// consecutive.</span></div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;  <span class="keywordflow">for</span> (; pos &lt; size; ++pos,++<a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a>)</div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;    <span class="keywordflow">if</span> (indexes_ptr[pos] != n)</div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;</div><div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;  *num_nonnegative_indexes = n - *first_nonnegative_value;</div><div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;</div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;  <span class="comment">// Check that the remaining values are all &lt;0 (assumed equal to -1, but</span></div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;  <span class="comment">// checking &lt;0 may be faster as just one instruction).</span></div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;  <span class="keywordflow">for</span> (; pos &lt; size; ++pos)</div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;    <span class="keywordflow">if</span> (indexes_ptr[pos] &gt;= 0)</div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// does not have the special structure.</span></div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;</div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;}</div><div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;</div><div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;</div><div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;</div><div class="line"><a name="l02288"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a281a103d9beaef2e5d64370754800cd1"> 2288</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a281a103d9beaef2e5d64370754800cd1">ReplaceRowWithMatrixOps</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation) {</div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;  <span class="keywordtype">bool</span> ans = <span class="keyword">false</span>;</div><div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;  int32 num_commands = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size(),</div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;      num_indexes = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>.size();</div><div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;  <span class="keywordflow">for</span> (int32 command_index = 0; command_index &lt; num_commands;</div><div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;       command_index++) {</div><div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;    <span class="comment">// non-const because we&#39;ll be changing it.</span></div><div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;</div><div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;    int32 first_nonnegative_pos,</div><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;        first_nonnegative_value,</div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;        num_nonnegative_indexes;</div><div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;    <span class="keywordflow">switch</span> (c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a>) {</div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a308b0ecf9083a7fde572d88f70af6258">kCopyRows</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae9638edeb0ada9a6373257fd508ae11f">kAddRows</a>: {</div><div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;        int32 indexes_index = c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>;</div><div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;        <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(indexes_index &lt; num_indexes);</div><div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;        <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;indexes = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>[indexes_index];</div><div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="namespacekaldi_1_1nnet3.html#a68068a73dabd55faade8d658a56f277b">IndexesHaveSpecialStructure</a>(indexes,</div><div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;                                        &amp;first_nonnegative_pos,</div><div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;                                        &amp;first_nonnegative_value,</div><div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;                                        &amp;num_nonnegative_indexes)) {</div><div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;          ans = <span class="keyword">true</span>;</div><div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;          c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a> = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a61634eedcfea10a32bdb33bca3f94f2b">NewSubMatrix</a>(c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>, first_nonnegative_pos,</div><div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;                                             num_nonnegative_indexes,</div><div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;                                             0, -1);</div><div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;          c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a> = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a61634eedcfea10a32bdb33bca3f94f2b">NewSubMatrix</a>(c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>, first_nonnegative_value,</div><div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;                                             num_nonnegative_indexes,</div><div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;                                             0, -1);</div><div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;          c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = (c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a308b0ecf9083a7fde572d88f70af6258">kCopyRows</a> ? <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a35d3d1a70d075561aaf91b263ea28f74">kMatrixCopy</a> :</div><div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;                            <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a8ce789ab4782758335cc37349fb97257">kMatrixAdd</a>);</div><div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;        }</div><div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;      }</div><div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;      <span class="keywordflow">default</span>:</div><div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;    }</div><div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;  }</div><div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;  <span class="keywordflow">return</span> ans;</div><div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;}</div><div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;</div><div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;</div><div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;</div><div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;<span class="comment">  This function, used in SnipSingleRowOp(),</span></div><div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;<span class="comment">  finds the number of leading, and trailing, negative numbers</span></div><div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;<span class="comment">  in a vector of integers.  For instance, if vec is</span></div><div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;<span class="comment">    [ -1 -1 2 3 -1 4 5 -1 ]</span></div><div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;<span class="comment">  then &#39;*num_leading_negatives&#39; will be set to 2 and &#39;*num_trailing_negatives&#39;</span></div><div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;<span class="comment">  will be set to 1.  If all the numbers in &#39;vec&#39; are all negative, or &#39;vec&#39; is</span></div><div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;<span class="comment">  empty, it is an error and this function will invoke KALDI_ERR.</span></div><div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l02339"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#aba9b56c9f5c5545ab2ab957cec8c56cc"> 2339</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#aba9b56c9f5c5545ab2ab957cec8c56cc">FindNumLeadingAndTrailingNegatives</a>(<span class="keyword">const</span> std::vector&lt;int32&gt; &amp;vec,</div><div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;                                               int32 *num_leading_negatives,</div><div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;                                               int32 *num_trailing_negatives) {</div><div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!vec.empty());</div><div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;  <span class="keyword">const</span> int32 *begin = &amp;(vec[0]), *ptr = begin, *end = ptr + vec.size();</div><div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;  <span class="keywordflow">while</span> (ptr != end &amp;&amp; *ptr &lt; 0)</div><div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;    ptr++;</div><div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;  <span class="comment">// note regarding error message: we assume all negative numbers are -1, due to</span></div><div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;  <span class="comment">// the way this is called, but it only affects how we describe the error.</span></div><div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(ptr != end &amp;&amp; <span class="stringliteral">&quot;Vector consists entirely of -1&#39;s.&quot;</span>);</div><div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;  *num_leading_negatives = ptr - begin;</div><div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;  <span class="keyword">const</span> int32 *ptr2 = end - 1;</div><div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;  <span class="comment">// the following while loop should terminate before falling off the vector,</span></div><div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;  <span class="comment">// because we&#39;ve established above (in the assertion) that the vector contains</span></div><div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;  <span class="comment">// at least one nonnegative number.</span></div><div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;  <span class="keywordflow">while</span> (*ptr2 &lt; 0)</div><div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;    ptr2--;</div><div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(ptr2 &gt;= begin);  <span class="comment">// or would be code error.</span></div><div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;  *num_trailing_negatives = end - 1 - ptr2;</div><div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;}</div><div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;</div><div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;<span class="comment">// This function, called from SnipRowOps, is called when it encounters commands</span></div><div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;<span class="comment">// of type kAddRows; it modifies such commands when the indexes have leading or</span></div><div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;<span class="comment">// trailing -1&#39;s,h, to make them operate on a smaller submatrix.  It returns</span></div><div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;<span class="comment">// true if it made a change, and false otherwise.</span></div><div class="line"><a name="l02364"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a59e6e35ab79257514b799d2ebe48ed20"> 2364</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a59e6e35ab79257514b799d2ebe48ed20">SnipSingleRowOp</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation,</div><div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;                            int32 command_index) {</div><div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(static_cast&lt;size_t&gt;(c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>) &lt; computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>.size());</div><div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;  <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;indexes = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>[c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>];</div><div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;  int32 num_leading_negatives, num_trailing_negatives;</div><div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#aba9b56c9f5c5545ab2ab957cec8c56cc">FindNumLeadingAndTrailingNegatives</a>(indexes,</div><div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;                                    &amp;num_leading_negatives,</div><div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;                                    &amp;num_trailing_negatives);</div><div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;  <span class="keywordflow">if</span> (num_leading_negatives == 0 &amp;&amp; num_trailing_negatives == 0)</div><div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;</div><div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;  int32 new_num_rows = <span class="keyword">static_cast&lt;</span>int32<span class="keyword">&gt;</span>(indexes.size()) -</div><div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;      num_leading_negatives - num_trailing_negatives;</div><div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(new_num_rows &gt; 0);</div><div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;  std::vector&lt;int32&gt; new_indexes(indexes.begin() + num_leading_negatives,</div><div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;                                 indexes.begin() + num_leading_negatives +</div><div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;                                 new_num_rows);</div><div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;  c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a> = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>.size();</div><div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;  computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>.push_back(std::vector&lt;int32&gt;());</div><div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;  computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>.back().swap(new_indexes);</div><div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;  c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a> = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a61634eedcfea10a32bdb33bca3f94f2b">NewSubMatrix</a>(c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>,</div><div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;                                     num_leading_negatives, new_num_rows,</div><div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;                                     0, -1);</div><div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;  <span class="comment">// made a change.</span></div><div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;}</div><div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;</div><div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;</div><div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;</div><div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;<span class="comment">  This function, used in SnipSingleRowOp(), finds the number of leading, and</span></div><div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;<span class="comment">  trailing, negative values in a vector of pairs of integers.  In particular,</span></div><div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;<span class="comment">  it finds the number of leading and trailing pairs whose .first value is negative</span></div><div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;<span class="comment">  (in practice we&#39;ll only encounter either (-1,-1) pairs, or pairs of both</span></div><div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;<span class="comment">  nonnegative values).</span></div><div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;<span class="comment"></span></div><div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;<span class="comment">  For instance, if vec is</span></div><div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;<span class="comment">    [ (-1,-1) (-1,-1) (80,2) (81,3) (-1,-1) (80,4) (81,5) (-1,-1) ]</span></div><div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;<span class="comment">  then &#39;*num_leading_negatives&#39; will be set to 2 and &#39;*num_trailing_negatives&#39;</span></div><div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;<span class="comment">  will be set to 1.  If all the .first numbers in &#39;vec&#39; are all negative, or</span></div><div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;<span class="comment">  &#39;vec&#39; is empty, it is an error and this function will invoke KALDI_ERR.</span></div><div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l02406"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#abbf4a43da0663edcee53e2942e53ae2e"> 2406</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#aba9b56c9f5c5545ab2ab957cec8c56cc">FindNumLeadingAndTrailingNegatives</a>(</div><div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;    <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;vec,</div><div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;    int32 *num_leading_negatives,</div><div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;    int32 *num_trailing_negatives) {</div><div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!vec.empty());</div><div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;  <span class="keyword">const</span> std::pair&lt;int32, int32&gt; *begin = &amp;(vec[0]), *ptr = begin,</div><div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;      *end = ptr + vec.size();</div><div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;  <span class="keywordflow">while</span> (ptr != end &amp;&amp; ptr-&gt;first &lt; 0)</div><div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;    ptr++;</div><div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;  <span class="comment">// note regarding error message: we assume all negative numbers are -1, due to</span></div><div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;  <span class="comment">// the way this is called, but it only affects how we describe the error.</span></div><div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(ptr != end &amp;&amp; <span class="stringliteral">&quot;Vector consists entirely of -1&#39;s.&quot;</span>);</div><div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;  *num_leading_negatives = ptr - begin;</div><div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;  <span class="keyword">const</span> std::pair&lt;int32, int32&gt; *ptr2 = end - 1;</div><div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;  <span class="comment">// the following while loop should terminate before falling off the vector,</span></div><div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;  <span class="comment">// because we&#39;ve established above (in the assertion) that the vector contains</span></div><div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;  <span class="comment">// at least one nonnegative number.</span></div><div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;  <span class="keywordflow">while</span> (ptr2-&gt;first &lt; 0)</div><div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;    ptr2--;</div><div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(ptr2 &gt;= begin);  <span class="comment">// would be code error.</span></div><div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;  *num_trailing_negatives = end - 1 - ptr2;</div><div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;}</div><div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;</div><div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;</div><div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;<span class="comment">// This function, called from SnipRowOps, is called when it encounters commands</span></div><div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;<span class="comment">// of type kAddRowsMulti, kAddToRowsMulti, or kCopyToRowsMulti; have leading or</span></div><div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;<span class="comment">// trailing (-1,-1) pairs, to make them operate on a smaller submatrix.  It</span></div><div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;<span class="comment">// returns true if it made a change, and false otherwise.</span></div><div class="line"><a name="l02434"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#af8b9a053089365f8c8d0f3e5436d66a4"> 2434</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="namespacekaldi_1_1nnet3.html#af8b9a053089365f8c8d0f3e5436d66a4">SnipMultiRowOp</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation,</div><div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;                           int32 command_index) {</div><div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(static_cast&lt;size_t&gt;(c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>) &lt; computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>.size());</div><div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;  <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;indexes_multi =</div><div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;      computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>[c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>];</div><div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;  int32 num_leading_negatives, num_trailing_negatives;</div><div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#aba9b56c9f5c5545ab2ab957cec8c56cc">FindNumLeadingAndTrailingNegatives</a>(indexes_multi,</div><div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;                                    &amp;num_leading_negatives,</div><div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;                                    &amp;num_trailing_negatives);</div><div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;  <span class="keywordflow">if</span> (num_leading_negatives == 0 &amp;&amp; num_trailing_negatives == 0)</div><div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;</div><div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;  int32 new_num_rows = <span class="keyword">static_cast&lt;</span>int32<span class="keyword">&gt;</span>(indexes_multi.size()) -</div><div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;      num_leading_negatives - num_trailing_negatives;</div><div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(new_num_rows &gt; 0);</div><div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;  std::vector&lt;std::pair&lt;int32, int32&gt; &gt; new_indexes_multi(</div><div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;      indexes_multi.begin() + num_leading_negatives,</div><div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;      indexes_multi.begin() + num_leading_negatives + new_num_rows);</div><div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;  c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a> = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>.size();</div><div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;  computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>.push_back(std::vector&lt;std::pair&lt;int32, int32&gt; &gt;());</div><div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;  computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>.back().swap(new_indexes_multi);</div><div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;  c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a> = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a61634eedcfea10a32bdb33bca3f94f2b">NewSubMatrix</a>(c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>,</div><div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;                                     num_leading_negatives, new_num_rows,</div><div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;                                     0, -1);</div><div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;  <span class="comment">// made a change.</span></div><div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;}</div><div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;</div><div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;</div><div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;</div><div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;<span class="comment">  This function, used in SnipRangeRowOp(), finds the number of leading and</span></div><div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;<span class="comment">  trailing values in a vector of pairs of integers, that are the same (i.e.</span></div><div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;<span class="comment">  pairs of the form (x, x) for any x.  [This is how we represent an empty</span></div><div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;<span class="comment">  range, which is a kind of no-op, in commands of kCopyRowRanges or</span></div><div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;<span class="comment">  kAddRowRanges.</span></div><div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;<span class="comment"></span></div><div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;<span class="comment">  For instance, if vec is</span></div><div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;<span class="comment">    [ (0,0) (0,0) (4,5) (6,8) (0,0) (10,12) (14,20) (0,0) ]</span></div><div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;<span class="comment">  then &#39;*num_leading_identicals&#39; will be set to 2 and &#39;*num_trailing_identicals&#39;</span></div><div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;<span class="comment">  will be set to 1.  If all pairs in &#39;vec&#39; are identical, or &#39;vec&#39; is empty, it</span></div><div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;<span class="comment">  is an error and this function will invoke KALDI_ERR.</span></div><div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l02477"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#abd9243d8740392f619af25f0653afa9e"> 2477</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#abd9243d8740392f619af25f0653afa9e">FindNumLeadingAndTrailingIdenticals</a>(</div><div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;    <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;vec,</div><div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;    int32 *num_leading_identicals,</div><div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;    int32 *num_trailing_identicals) {</div><div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!vec.empty());</div><div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;  <span class="keyword">const</span> std::pair&lt;int32, int32&gt; *begin = &amp;(vec[0]), *ptr = begin,</div><div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;      *end = ptr + vec.size();</div><div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;  <span class="keywordflow">while</span> (ptr != end &amp;&amp; ptr-&gt;first == ptr-&gt;second)</div><div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;    ptr++;</div><div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;  <span class="comment">// note regarding error message: we assume all pairs of identical numbers are</span></div><div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;  <span class="comment">// -1, due to the way this is called, but it only affects how we describe the</span></div><div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;  <span class="comment">// error.</span></div><div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(ptr != end &amp;&amp; <span class="stringliteral">&quot;Vector consists entirely of -1&#39;s.&quot;</span>);</div><div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;  *num_leading_identicals = ptr - begin;</div><div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;  <span class="keyword">const</span> std::pair&lt;int32, int32&gt; *ptr2 = end - 1;</div><div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;  <span class="comment">// the following while loop should terminate before falling off the vector,</span></div><div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;  <span class="comment">// because we&#39;ve established above (in the assertion) that the vector contains</span></div><div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;  <span class="comment">// at least one nonnegative number.</span></div><div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;  <span class="keywordflow">while</span> (ptr2-&gt;first == ptr2-&gt;second)</div><div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;    ptr2--;</div><div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(ptr2 &gt;= begin);  <span class="comment">// would be code error.</span></div><div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;  *num_trailing_identicals = end - 1 - ptr2;</div><div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;}</div><div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;</div><div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;</div><div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;<span class="comment">// This function, called from SnipRowOps, is called when it encounters commands</span></div><div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;<span class="comment">// of type kAddRowRanges that have leading or trailing (x, x) pairs [i.e. pairs</span></div><div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;<span class="comment">// of identical values; these are how we represent empty ranges], to make them</span></div><div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;<span class="comment">// operate on a smaller submatrix.  It returns true if it made a change, and</span></div><div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;<span class="comment">// false otherwise.</span></div><div class="line"><a name="l02507"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a3c29cb7ac7e40e18309451b6f8a193bd"> 2507</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a3c29cb7ac7e40e18309451b6f8a193bd">SnipRangesRowOp</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation,</div><div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;                            int32 command_index) {</div><div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(static_cast&lt;size_t&gt;(c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>) &lt; computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a3095d45a751aaa81c1024cf9510e2ed7">indexes_ranges</a>.size());</div><div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;  <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;indexes_ranges =</div><div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;      computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a3095d45a751aaa81c1024cf9510e2ed7">indexes_ranges</a>[c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>];</div><div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;  int32 num_leading_identicals, num_trailing_identicals;</div><div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#abd9243d8740392f619af25f0653afa9e">FindNumLeadingAndTrailingIdenticals</a>(indexes_ranges,</div><div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;                                    &amp;num_leading_identicals,</div><div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;                                    &amp;num_trailing_identicals);</div><div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;  <span class="keywordflow">if</span> (num_leading_identicals == 0 &amp;&amp; num_trailing_identicals == 0)</div><div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;</div><div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;  int32 new_num_rows = <span class="keyword">static_cast&lt;</span>int32<span class="keyword">&gt;</span>(indexes_ranges.size()) -</div><div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;      num_leading_identicals - num_trailing_identicals;</div><div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(new_num_rows &gt; 0);</div><div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;  std::vector&lt;std::pair&lt;int32, int32&gt; &gt; new_indexes_ranges(</div><div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;      indexes_ranges.begin() + num_leading_identicals,</div><div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;      indexes_ranges.begin() + num_leading_identicals + new_num_rows);</div><div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;  c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a> = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a3095d45a751aaa81c1024cf9510e2ed7">indexes_ranges</a>.size();</div><div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;  computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a3095d45a751aaa81c1024cf9510e2ed7">indexes_ranges</a>.push_back(std::vector&lt;std::pair&lt;int32, int32&gt; &gt;());</div><div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;  computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a3095d45a751aaa81c1024cf9510e2ed7">indexes_ranges</a>.back().swap(new_indexes_ranges);</div><div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;  c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a> = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a61634eedcfea10a32bdb33bca3f94f2b">NewSubMatrix</a>(c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>,</div><div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;                                     num_leading_identicals, new_num_rows,</div><div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;                                     0, -1);</div><div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;  <span class="comment">// made a change.</span></div><div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;}</div><div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;</div><div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;</div><div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;</div><div class="line"><a name="l02537"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a590c38bb0c9acc4ad1f626237f1a4169"> 2537</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a590c38bb0c9acc4ad1f626237f1a4169">SnipRowOps</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation) {</div><div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;  <span class="keywordtype">bool</span> ans = <span class="keyword">false</span>;</div><div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;  int32 num_commands = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size();</div><div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;  <span class="keywordflow">for</span> (int32 command_index = 0; command_index &lt; num_commands;</div><div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;       command_index++) {</div><div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;    <span class="comment">// non-const because we&#39;ll be changing it.</span></div><div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;</div><div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;    <span class="comment">// note: we can&#39;t do the snipping for commands of type case kCopyRows and case</span></div><div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;    <span class="comment">// kCopyRowsMulti, because the -1&#39;s aren&#39;t a pure no-op; they have the</span></div><div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;    <span class="comment">// meaning of setting the destination value to zero, so we can&#39;t prune</span></div><div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;    <span class="comment">// them away.</span></div><div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;</div><div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;    <span class="keywordflow">switch</span> (c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a>) {</div><div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae9638edeb0ada9a6373257fd508ae11f">kAddRows</a>: {</div><div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="namespacekaldi_1_1nnet3.html#a59e6e35ab79257514b799d2ebe48ed20">SnipSingleRowOp</a>(computation, command_index))</div><div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;          ans = <span class="keyword">true</span>;</div><div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;      }</div><div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26009d8f2bc3f61d214925ae25af9962">kAddRowsMulti</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a662aa95978d72cd24fde262e35941fad">kAddToRowsMulti</a>:</div><div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a5161c1dfc34a4df1b19e9d3b8dc9499c">kCopyToRowsMulti</a>: {</div><div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="namespacekaldi_1_1nnet3.html#af8b9a053089365f8c8d0f3e5436d66a4">SnipMultiRowOp</a>(computation, command_index))</div><div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;          ans = <span class="keyword">true</span>;</div><div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;      }</div><div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a86646468234ab036580a4f2e4d72af3c">kAddRowRanges</a>: {</div><div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="namespacekaldi_1_1nnet3.html#a3c29cb7ac7e40e18309451b6f8a193bd">SnipRangesRowOp</a>(computation, command_index))</div><div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;          ans = <span class="keyword">true</span>;</div><div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;      }</div><div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;      <span class="keywordflow">default</span>:</div><div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;    }</div><div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;  }</div><div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;  <span class="keywordflow">return</span> ans;</div><div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;}</div><div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;</div><div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;</div><div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;</div><div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;<span class="comment">// This class implements the internals of the function SplitRowOps() which is</span></div><div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;<span class="comment">// declared in nnet-optimize-utils.h.</span></div><div class="line"><a name="l02578"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html"> 2578</a></span>&#160;<span class="keyword">class </span><a class="code" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html">RowOpsSplitter</a> {</div><div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160; <span class="keyword">public</span>:</div><div class="line"><a name="l02580"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#adc9b18c1d651afbbff474ffa6cf29d77"> 2580</a></span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#adc9b18c1d651afbbff474ffa6cf29d77">RowOpsSplitter</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation): <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>(computation) { }</div><div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;</div><div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;  <span class="comment">// Attempts to perform the optimization.  Returns true if it made any change</span></div><div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;  <span class="comment">// to the computation.</span></div><div class="line"><a name="l02584"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a2867a317eb29f40c427ab677c0502ab5"> 2584</a></span>&#160;  <span class="keywordtype">bool</span> <a class="code" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a2867a317eb29f40c427ab677c0502ab5">Split</a>() {</div><div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;    <span class="keywordflow">return</span> SplitIndexes() &amp;&amp; SplitCommands();</div><div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;  }</div><div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;</div><div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160; <span class="keyword">private</span>:</div><div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;</div><div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;  <span class="comment">// This function sets up split_info_, which describes how we can split up</span></div><div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;  <span class="comment">// the vectors that are elements of computation_-&gt;indexes_multi.</span></div><div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;  <span class="comment">// It will return true if it successfully split at least one of those</span></div><div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;  <span class="comment">// vectors, and false otherwise.</span></div><div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;  <span class="keywordtype">bool</span> SplitIndexes();</div><div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;</div><div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;  <span class="comment">// This function modifies the commands in the computation.  It returns</span></div><div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;  <span class="comment">// true if it made any change.</span></div><div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;  <span class="keywordtype">bool</span> SplitCommands();</div><div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;</div><div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;</div><div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;  <span class="comment">// This function attempts to optimize the command in</span></div><div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;  <span class="comment">// computation_-&gt;commands[command_index].  It returns true if it made any</span></div><div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;  <span class="comment">// change.  If we are going to have to insert an extra command into the</span></div><div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;  <span class="comment">// computation, this function will append an element to new_commands_.</span></div><div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;  <span class="keywordtype">bool</span> SplitCommand(int32 command_index);</div><div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;</div><div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;  <span class="comment">// Below, define a multi-index as an element of NnetComputation::indexes_multi,</span></div><div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;  <span class="comment">// for example,</span></div><div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;  <span class="comment">// const std::vector&lt;std::pair&lt;int32,int32&gt; &gt; &amp;multi_index = computation_-&gt;indexes_multi[1];</span></div><div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;  <span class="comment">// It is a list of pairs.</span></div><div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;</div><div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;  <span class="comment">// This struct appears as an element of the list inside MultiIndexSplitInfo.</span></div><div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;  <span class="comment">// It helps us describe how we can split up a multi-index (a list of pairs)</span></div><div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;  <span class="comment">// into a sequence of ranges where the .first value is constant across the</span></div><div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;  <span class="comment">// range.</span></div><div class="line"><a name="l02616"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html"> 2616</a></span>&#160;  <span class="keyword">struct </span><a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html">SingleSplitInfo</a> {</div><div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;    <span class="comment">// &#39;offset&#39; is the index into the vector of pairs that forms the</span></div><div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;    <span class="comment">// start of this range.  In the example where we are splitting up</span></div><div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;    <span class="comment">// ((10,2), (10,3), (10,4), (15,3), (15,5), (15,7))</span></div><div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;    <span class="comment">// there would be two instances of struct SingleSplitInfo, with</span></div><div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;    <span class="comment">// offset = 0 and offset = 3.</span></div><div class="line"><a name="l02622"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#a37530671a271e2e54ce7c6f8762a7421"> 2622</a></span>&#160;    int32 <a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#a37530671a271e2e54ce7c6f8762a7421">offset</a>;</div><div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;    <span class="comment">// &#39;size&#39; is the number of pairs in this range; in the example</span></div><div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;    <span class="comment">// above, both &#39;size&#39; elements would be 3.</span></div><div class="line"><a name="l02625"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#aa1728750481b853c3246037c1ba1c68b"> 2625</a></span>&#160;    int32 <a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#aa1728750481b853c3246037c1ba1c68b">size</a>;</div><div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;    <span class="comment">// first_value is the value of the .first index throughout this range; in</span></div><div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;    <span class="comment">// the example above, it would be 10 and 15 respectively.  It represents a</span></div><div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;    <span class="comment">// submatrix index.</span></div><div class="line"><a name="l02629"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#a5b453b78ae9c6939b8961da23c8c987c"> 2629</a></span>&#160;    int32 <a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#a5b453b78ae9c6939b8961da23c8c987c">first_value</a>;</div><div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;</div><div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;    <span class="comment">// initial_second_value is the minimum value of .second for any element in</span></div><div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;    <span class="comment">// this range: it would be 2 and 3 respectively in the example above.</span></div><div class="line"><a name="l02633"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#ac0b46c3dd51edd4418492743565ee2ab"> 2633</a></span>&#160;    int32 <a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#ac0b46c3dd51edd4418492743565ee2ab">min_second_value</a>;</div><div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;</div><div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;    <span class="comment">// second_value_range is the highest value of .second for any element in</span></div><div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;    <span class="comment">// this range, plus one, minus min_second_value.  (It&#39;s the number of rows</span></div><div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;    <span class="comment">// in the other submatrix of the operation).</span></div><div class="line"><a name="l02638"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#a8b8b798a5c4c75c2a6a104bfa156808a"> 2638</a></span>&#160;    int32 <a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#a8b8b798a5c4c75c2a6a104bfa156808a">second_value_range</a>;</div><div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;</div><div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;    <span class="comment">// If the .second values in the range are consecutive then</span></div><div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;    <span class="comment">// &#39;second_value_offsets&#39; will be empty.  Otherwise it will</span></div><div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;    <span class="comment">// be a vector of size &#39;size&#39;, containing numbers in the</span></div><div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;    <span class="comment">// range 0 ... second_value_range - 1, such that</span></div><div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;    <span class="comment">// min_second_value + second_value_offsets[i] gives</span></div><div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;    <span class="comment">// the .second value at the corresponding position in the range.</span></div><div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;    <span class="comment">// In the second range of the example above, the range</span></div><div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;    <span class="comment">// consisting of ((15,3), (15,5), (15,7)), &#39;second_value_offsets</span></div><div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;    <span class="comment">// would be the vector (0, 2, 4).</span></div><div class="line"><a name="l02649"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#ae99e4ce52adf069a641d61427aed351b"> 2649</a></span>&#160;    std::vector&lt;int32&gt; <a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#ae99e4ce52adf069a641d61427aed351b">second_value_offsets</a>;</div><div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;  };</div><div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;</div><div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;  <span class="comment">// An instance of the struct MultiIndexSplitInfo will be created for each multi-index,</span></div><div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;  <span class="comment">// i.e. for each element of  NnetComputation::indexes_multi.</span></div><div class="line"><a name="l02654"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html"> 2654</a></span>&#160;  <span class="keyword">struct </span><a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html">MultiIndexSplitInfo</a> {</div><div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;    <span class="comment">// If we can split this multi-index into at most two ranges, this</span></div><div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;    <span class="comment">// vector will be nonempty; otherwise it will be empty.</span></div><div class="line"><a name="l02657"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db"> 2657</a></span>&#160;    std::vector&lt;SingleSplitInfo&gt; <a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db">splits</a>;</div><div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;  };</div><div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;</div><div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;  <span class="comment">// GetSplitInfo() attempts to take a range of a</span></div><div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;  <span class="comment">// std::vector&lt;std::pair&lt;int32, int32&gt; &gt;, as represented by begin and end</span></div><div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;  <span class="comment">// iterators, and to extract its information into an object of type</span></div><div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;  <span class="comment">// SingleSplitInfo.  (all except for the .offset member, which will have</span></div><div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;  <span class="comment">// been set by calling code).</span></div><div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;  <span class="comment">// It return true if successful, and false otherwise.  The only reasons that</span></div><div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;  <span class="comment">// it might return false are that the range contains -1&#39;s or does not contain</span></div><div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;  <span class="comment">// all-identical .first members).</span></div><div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;  <span class="keywordtype">bool</span> GetSplitInfo(std::vector&lt;std::pair&lt;int32, int32&gt; &gt;::const_iterator begin,</div><div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;                    std::vector&lt;std::pair&lt;int32, int32&gt; &gt;::const_iterator end,</div><div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;                    <a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html">SingleSplitInfo</a> *info);</div><div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;</div><div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;  <span class="comment">// computation_ is the computation that we are modifying.</span></div><div class="line"><a name="l02673"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a36d13565d1302a2bf74127b141ba3537"> 2673</a></span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *<a class="code" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>;</div><div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;  <span class="comment">// split_info_ will contain information about how we can split up the members</span></div><div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;  <span class="comment">// of computation_-&gt;indexes_multi into ranges.</span></div><div class="line"><a name="l02676"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a2e4b2c10e3fa4daad72c553006aa7c53"> 2676</a></span>&#160;  std::vector&lt;MultiIndexSplitInfo&gt; <a class="code" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a2e4b2c10e3fa4daad72c553006aa7c53">split_info_</a>;</div><div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;  <span class="comment">// The following is a list of additional commands that we are going to insert</span></div><div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;  <span class="comment">// into computation_, of the form (command-index, command) where command-index</span></div><div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;  <span class="comment">// is a command index just before which we will insert the new command.</span></div><div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;  <span class="comment">// (this is the format accepted by the function InsertCommands()).</span></div><div class="line"><a name="l02681"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a20fdcf4e5960cc4202a0415153b5e19b"> 2681</a></span>&#160;  std::vector&lt;std::pair&lt;int32, NnetComputation::Command&gt; &gt; <a class="code" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a20fdcf4e5960cc4202a0415153b5e19b">new_commands_</a>;</div><div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;</div><div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;};</div><div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;</div><div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;</div><div class="line"><a name="l02686"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a0708ed4c4b812eb5a8b6b5e5d68f0e48"> 2686</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a0708ed4c4b812eb5a8b6b5e5d68f0e48">RowOpsSplitter::GetSplitInfo</a>(</div><div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;    std::vector&lt;std::pair&lt;int32, int32&gt; &gt;::const_iterator begin,</div><div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;    std::vector&lt;std::pair&lt;int32, int32&gt; &gt;::const_iterator end,</div><div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html">SingleSplitInfo</a> *info) {</div><div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;  <span class="comment">// max_size_ratio must be &gt; 1.0, and could in principle be a float.  It is</span></div><div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;  <span class="comment">// there to prevent us from making changes to the computation which would end</span></div><div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;  <span class="comment">// up wastefully launching too many kernels that would do nothing.</span></div><div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;  <span class="keyword">const</span> int32 max_size_ratio = 2;</div><div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;</div><div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;  int32 size = end - begin;</div><div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(size != 0);</div><div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;  int32 first = begin-&gt;first;</div><div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;  <span class="keywordflow">if</span> (first &lt; 0)</div><div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;  info-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#aa1728750481b853c3246037c1ba1c68b">size</a> = size;</div><div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;  info-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#a5b453b78ae9c6939b8961da23c8c987c">first_value</a> = first;</div><div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;  int32 initial_second_value = begin-&gt;second,</div><div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;      min_second_value = initial_second_value,</div><div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;      max_second_value = initial_second_value;</div><div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;  info-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#ae99e4ce52adf069a641d61427aed351b">second_value_offsets</a>.resize(size);</div><div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;  <span class="keywordtype">bool</span> is_consecutive = <span class="keyword">true</span>;</div><div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; size; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;    int32 second = begin[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].second;</div><div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;    <span class="keywordflow">if</span> (begin[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].first != first || second &lt; 0) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;    info-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#ae99e4ce52adf069a641d61427aed351b">second_value_offsets</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = second;</div><div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;    <span class="keywordflow">if</span> (second != initial_second_value + <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>)</div><div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;      is_consecutive = <span class="keyword">false</span>;</div><div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;    <span class="keywordflow">if</span> (second &lt; min_second_value) min_second_value = second;</div><div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;    <span class="keywordflow">if</span> (second &gt; max_second_value) max_second_value = second;</div><div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;  }</div><div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;  info-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#ac0b46c3dd51edd4418492743565ee2ab">min_second_value</a> = min_second_value;</div><div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;  info-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#a8b8b798a5c4c75c2a6a104bfa156808a">second_value_range</a> = max_second_value + 1 - min_second_value;</div><div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;  <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#a8b8b798a5c4c75c2a6a104bfa156808a">second_value_range</a> &gt; size * max_size_ratio)</div><div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;  <span class="keywordflow">if</span> (is_consecutive) {</div><div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;    info-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#ae99e4ce52adf069a641d61427aed351b">second_value_offsets</a>.clear();</div><div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;    <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; size; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++)</div><div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;      info-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#ae99e4ce52adf069a641d61427aed351b">second_value_offsets</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] -= min_second_value;</div><div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;  }</div><div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;}</div><div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;</div><div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;</div><div class="line"><a name="l02730"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#ac47c74355b808fa46848090718a6f05f"> 2730</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#ac47c74355b808fa46848090718a6f05f">RowOpsSplitter::SplitIndexes</a>() {</div><div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;  <span class="keywordtype">bool</span> ans = <span class="keyword">false</span>;</div><div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;  int32 num_indexes_multi = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>.size();</div><div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;  split_info_.resize(num_indexes_multi);</div><div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;  <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; num_indexes_multi; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;    <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32,int32&gt; &gt; &amp;multi_index =</div><div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html">MultiIndexSplitInfo</a> &amp;split_info = split_info_[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;</div><div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;    int32 num_pairs = multi_index.size();</div><div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(num_pairs &gt; 0);</div><div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;    <span class="comment">// &#39;split_point&#39; will be set to the first index j for which</span></div><div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;    <span class="comment">// multi_index[j-1].first != multi_index[j].first, or -1</span></div><div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;    <span class="comment">// if no such j exists.</span></div><div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;    int32 split_point = -1, initial_first = multi_index[0].first;</div><div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;    <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#a37d972ae0b47b9099e30983131d31916">j</a> = 1; <a class="code" href="namespacernnlm.html#a37d972ae0b47b9099e30983131d31916">j</a> &lt; num_pairs; <a class="code" href="namespacernnlm.html#a37d972ae0b47b9099e30983131d31916">j</a>++) {</div><div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;      <span class="keywordflow">if</span> (multi_index[<a class="code" href="namespacernnlm.html#a37d972ae0b47b9099e30983131d31916">j</a>].first != initial_first) {</div><div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;        split_point = <a class="code" href="namespacernnlm.html#a37d972ae0b47b9099e30983131d31916">j</a>;</div><div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;      }</div><div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;    }</div><div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;    <span class="keywordflow">if</span> (split_point == -1) {</div><div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;      split_info.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db">splits</a>.resize(1);</div><div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;      split_info.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db">splits</a>[0].offset = 0;</div><div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;      <span class="keywordflow">if</span> (!GetSplitInfo(multi_index.begin(), multi_index.end(),</div><div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;                        &amp;(split_info.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db">splits</a>[0]))) {</div><div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;        split_info.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db">splits</a>.clear();</div><div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;        ans = <span class="keyword">true</span>;</div><div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;      }</div><div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;      split_info.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db">splits</a>.resize(2);</div><div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;      split_info.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db">splits</a>[0].offset = 0;</div><div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;      split_info.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db">splits</a>[1].offset = split_point;</div><div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;</div><div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;      std::vector&lt;std::pair&lt;int32,int32&gt; &gt;::const_iterator mid_iter =</div><div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;          multi_index.begin() + split_point;</div><div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;      <span class="keywordflow">if</span> (!GetSplitInfo(multi_index.begin(), mid_iter,</div><div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;                        &amp;(split_info.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db">splits</a>[0])) ||</div><div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;          !GetSplitInfo(mid_iter, multi_index.end(),</div><div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;                        &amp;(split_info.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db">splits</a>[1]))) {</div><div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;        split_info.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db">splits</a>.clear();</div><div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;        ans = <span class="keyword">true</span>;</div><div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;      }</div><div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;    }</div><div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;  }</div><div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;  <span class="keywordflow">return</span> ans;</div><div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;}</div><div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;</div><div class="line"><a name="l02780"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a8f9f90f42e150720274c1aa1194b2cf3"> 2780</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a8f9f90f42e150720274c1aa1194b2cf3">RowOpsSplitter::SplitCommand</a>(int32 c) {</div><div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;command = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[c];</div><div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352">CommandType</a> command_type = command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a>;</div><div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;  <span class="comment">// For commands that are not of the following four types, return false: we</span></div><div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;  <span class="comment">// won&#39;t be changing these commands.</span></div><div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;  <span class="keywordflow">switch</span> (command_type) {</div><div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26009d8f2bc3f61d214925ae25af9962">kAddRowsMulti</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a341a9c019757a7f1172d86bad51500a5">kCopyRowsMulti</a>:</div><div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a662aa95978d72cd24fde262e35941fad">kAddToRowsMulti</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a5161c1dfc34a4df1b19e9d3b8dc9499c">kCopyToRowsMulti</a>: <span class="keywordflow">break</span>;</div><div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;    <span class="keywordflow">default</span>: <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;  }</div><div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;  int32 indexes_multi_index = command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>;</div><div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(indexes_multi_index &lt;</div><div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;               static_cast&lt;int32&gt;(split_info_.size()));</div><div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html">MultiIndexSplitInfo</a> &amp;split_info = split_info_[indexes_multi_index];</div><div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;  <span class="keywordflow">if</span> (split_info.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db">splits</a>.empty())</div><div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// these indexes couldn&#39;t be split: e.g. they contained more</span></div><div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;                   <span class="comment">// than two distinct .first elements, or there were other</span></div><div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;                   <span class="comment">// reasons.</span></div><div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;</div><div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;  <span class="comment">// we&#39;ll be splitting the command into either one or two pieces.</span></div><div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;  std::vector&lt;NnetComputation::Command&gt; split_commands(</div><div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;      split_info.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db">splits</a>.size());</div><div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; split_info.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db">splits</a>.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html">SingleSplitInfo</a> &amp;split = split_info.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db">splits</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;command_out = split_commands[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;    command_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2de3c74f7141e97502ff48c2407b78be">alpha</a> = command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2de3c74f7141e97502ff48c2407b78be">alpha</a>;</div><div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;    command_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a> = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a61634eedcfea10a32bdb33bca3f94f2b">NewSubMatrix</a>(</div><div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;        command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>, split.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#a37530671a271e2e54ce7c6f8762a7421">offset</a>, split.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#aa1728750481b853c3246037c1ba1c68b">size</a>, 0, -1);</div><div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;    command_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a> = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a61634eedcfea10a32bdb33bca3f94f2b">NewSubMatrix</a>(</div><div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;        split.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#a5b453b78ae9c6939b8961da23c8c987c">first_value</a>, split.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#ac0b46c3dd51edd4418492743565ee2ab">min_second_value</a>,</div><div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;        split.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#a8b8b798a5c4c75c2a6a104bfa156808a">second_value_range</a>, 0, -1);</div><div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;</div><div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;    <span class="keywordflow">if</span> (split.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#ae99e4ce52adf069a641d61427aed351b">second_value_offsets</a>.empty()) {</div><div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;      <span class="comment">// The .second elements are consecutive.</span></div><div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;      <span class="keywordflow">switch</span> (command_type) {</div><div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26009d8f2bc3f61d214925ae25af9962">kAddRowsMulti</a>:</div><div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;          command_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a8ce789ab4782758335cc37349fb97257">kMatrixAdd</a>;</div><div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a341a9c019757a7f1172d86bad51500a5">kCopyRowsMulti</a>:</div><div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;          command_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a35d3d1a70d075561aaf91b263ea28f74">kMatrixCopy</a>;</div><div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a662aa95978d72cd24fde262e35941fad">kAddToRowsMulti</a>:</div><div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;          command_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a8ce789ab4782758335cc37349fb97257">kMatrixAdd</a>;</div><div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;          <a class="code" href="namespacekaldi.html#aa3e99328db564bc2bf6397fa1eaee4d7">std::swap</a>(command_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>, command_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>);</div><div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a5161c1dfc34a4df1b19e9d3b8dc9499c">kCopyToRowsMulti</a>:</div><div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;          command_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a35d3d1a70d075561aaf91b263ea28f74">kMatrixCopy</a>;</div><div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;          <a class="code" href="namespacekaldi.html#aa3e99328db564bc2bf6397fa1eaee4d7">std::swap</a>(command_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>, command_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>);</div><div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;        <span class="keywordflow">default</span>:  <span class="comment">// will never be reached.</span></div><div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;      }</div><div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;      <span class="comment">// Indexes are not consecutive: it needs to be a kAddRows or kCopyRows</span></div><div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;      <span class="comment">// command.</span></div><div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;      command_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a> = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>.size();</div><div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;      <span class="keywordflow">switch</span> (command_type) {</div><div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26009d8f2bc3f61d214925ae25af9962">kAddRowsMulti</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a341a9c019757a7f1172d86bad51500a5">kCopyRowsMulti</a>: {</div><div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;          command_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = (command_type == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26009d8f2bc3f61d214925ae25af9962">kAddRowsMulti</a> ?</div><div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;                                      <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae9638edeb0ada9a6373257fd508ae11f">kAddRows</a> : <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a308b0ecf9083a7fde572d88f70af6258">kCopyRows</a>);</div><div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;          <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>.push_back(split.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#ae99e4ce52adf069a641d61427aed351b">second_value_offsets</a>);</div><div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;        }</div><div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a5161c1dfc34a4df1b19e9d3b8dc9499c">kCopyToRowsMulti</a>:  {</div><div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;          <span class="comment">// We can&#39;t operate on this command because of what would happen</span></div><div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;          <span class="comment">// with values of &#39;indexes&#39; (see the variable in the block for</span></div><div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;          <span class="comment">// kAddToRowsMulti) which were -1.  Rows of the output would be</span></div><div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;          <span class="comment">// set to zero, which is not the behavior we want here; we&#39;d want</span></div><div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;          <span class="comment">// them to be unaffected.</span></div><div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;          <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;        }</div><div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a662aa95978d72cd24fde262e35941fad">kAddToRowsMulti</a>: {</div><div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;          command_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae9638edeb0ada9a6373257fd508ae11f">kAddRows</a>;</div><div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;          <a class="code" href="namespacekaldi.html#aa3e99328db564bc2bf6397fa1eaee4d7">std::swap</a>(command_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>, command_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>);</div><div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;          <span class="comment">// invert the indexes.</span></div><div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;          std::vector&lt;int32&gt; indexes(split.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#a8b8b798a5c4c75c2a6a104bfa156808a">second_value_range</a>, -1);</div><div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;          <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; split.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#aa1728750481b853c3246037c1ba1c68b">size</a>; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;            <span class="comment">// the following assert should always succeed because the</span></div><div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;            <span class="comment">// AddToRowsMulti and CopyToRowsMulti should never have</span></div><div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;            <span class="comment">// duplicate destinations in their indexes.</span></div><div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;            <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(indexes[split.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#ae99e4ce52adf069a641d61427aed351b">second_value_offsets</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>]] &gt;= 0);</div><div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;            indexes[split.<a class="code" href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#ae99e4ce52adf069a641d61427aed351b">second_value_offsets</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>]] = <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>;</div><div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;          }</div><div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;          <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>.push_back(indexes);</div><div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;          <span class="keywordflow">break</span>;</div><div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;        }</div><div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;          <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Code error: un-handled case.&quot;</span>;</div><div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;      }</div><div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;    }</div><div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;  }</div><div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;  command = split_commands[0];</div><div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;  <span class="comment">// note: for now, split_commands.size() will be 1 or 2.</span></div><div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 1; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; split_commands.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;    new_commands_.resize(new_commands_.size() + 1);</div><div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;    <span class="comment">// we&#39;ll want to insert this command right after command c,</span></div><div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;    <span class="comment">// which is the same as just before command c + 1.</span></div><div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;    new_commands_.back().first = c + 1;</div><div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;    new_commands_.back().second = split_commands[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;  }</div><div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;  <span class="comment">// We made a change.</span></div><div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;}</div><div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;</div><div class="line"><a name="l02883"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a464801e09b6b4e3d2b20730f6002016c"> 2883</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a464801e09b6b4e3d2b20730f6002016c">RowOpsSplitter::SplitCommands</a>() {</div><div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;  <span class="keywordtype">bool</span> ans = <span class="keyword">false</span>;</div><div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;  int32 num_commands = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size();</div><div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;  <span class="keywordflow">for</span> (int32 c = 0; c &lt; num_commands; c++)</div><div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;    <span class="keywordflow">if</span> (SplitCommand(c))</div><div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;      ans = <span class="keyword">true</span>;</div><div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;  <span class="keywordflow">if</span> (!new_commands_.empty())</div><div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;    <a class="code" href="namespacekaldi_1_1nnet3.html#a0cc731e05d6603b7d4d0191f9f1c9d32">InsertCommands</a>(&amp;new_commands_, <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>);</div><div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;  <span class="keywordflow">return</span> ans;</div><div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;}</div><div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;</div><div class="line"><a name="l02894"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#acd48d2ca65dc0a73952effbec24ccfb1"> 2894</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="namespacekaldi_1_1nnet3.html#acd48d2ca65dc0a73952effbec24ccfb1">SplitRowOps</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation) {</div><div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html">RowOpsSplitter</a> splitter(computation);</div><div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;  <span class="keywordflow">return</span> splitter.<a class="code" href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a2867a317eb29f40c427ab677c0502ab5">Split</a>();</div><div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;}</div><div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;</div><div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;</div><div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;<span class="comment">   This function finds and returns the &#39;n-stride&#39; of the vector of Indexes, or</span></div><div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;<span class="comment">   returns 0 if it does not exist because the Indexes lack the required regular</span></div><div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;<span class="comment">   structure.  This function relates to &#39;shortcut&#39; compilation and is used in</span></div><div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;<span class="comment">   class IoSpecificationIsDecomposable().  There is an overloaded version of</span></div><div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;<span class="comment">   this function that works with Cindex input, that has almost exactly</span></div><div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;<span class="comment">   the same code.</span></div><div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;<span class="comment"></span></div><div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;<span class="comment">   It is used to discover regular structure in vectors of indexes.  We are</span></div><div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;<span class="comment">   interested in the structure on the &#39;n&#39; index; in particular, the stride on</span></div><div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;<span class="comment">   the &#39;n&#39; index.  We expect the vector &#39;indexes&#39; to contain &#39;n&#39; values of the</span></div><div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;<span class="comment">   form 0, 1, ... N-1 (where the value of N can be obtained easily by looking at</span></div><div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;<span class="comment">   the .n value of the last element of &#39;indexes&#39;).  And we expect the &#39;n&#39; values</span></div><div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;<span class="comment">   of Indexes that are otherwise the same to be separated by a fixed stride,</span></div><div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;<span class="comment">   which we will return.</span></div><div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;<span class="comment"></span></div><div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;<span class="comment">   If the stride is inconsistent or one of our other requirements (see below) is</span></div><div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;<span class="comment">   not fulfilled, we will return 0.  If it&#39;s always consistent and our</span></div><div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;<span class="comment">   requirements are fulfilled we&#39;ll return the stride.  If &#39;full_check&#39; is true</span></div><div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;<span class="comment">   we do an exhaustive check for consistency; otherwise we do a randomized</span></div><div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;<span class="comment">   check.</span></div><div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;<span class="comment"></span></div><div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;<span class="comment">   The full definition of &#39;consistency&#39; is as follows:</span></div><div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;<span class="comment"></span></div><div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;<span class="comment">   For some n_stride &gt;= 1 (which we&#39;ll return), and with N as the number of</span></div><div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;<span class="comment">   &#39;n&#39; values (which should be numbered 0, 1, ... N-1):</span></div><div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;<span class="comment"></span></div><div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;<span class="comment">     - For any Index with n &lt; N-1 located at position i, an Index with one</span></div><div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;<span class="comment">       greater &#39;n&#39; but otherwise the same must exist at position i + n_stride</span></div><div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;<span class="comment">     - For any Index with n &gt; 0 located at position i, an Index with one</span></div><div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;<span class="comment">       smaller &#39;n&#39; but otherwise the same must exist at position i - n_stride.</span></div><div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;<span class="comment">     - The input must be arranged in blocks of size block_size = n_stride * N,</span></div><div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;<span class="comment">       which these strides never cross.  &quot;Strides never cross&quot; is an informal</span></div><div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;<span class="comment">       definition: we can formalize this by saying that for an Index with n == 0</span></div><div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;<span class="comment">       at position i, we must have (i / block_size) == ((i + n_stride*(N-1)) /</span></div><div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;<span class="comment">       block_size), with integer division.</span></div><div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;<span class="comment">   The above conditions imply that the size of the input must be a multiple</span></div><div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;<span class="comment">   of the n-stride.</span></div><div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;<span class="comment"></span></div><div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;<span class="comment">   Reminder: we return 0 if the regular structure is not found, and the n-stride</span></div><div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;<span class="comment">   if the regular structure is found.</span></div><div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l02942"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a79122735e3f124a6865ff339f40ec191"> 2942</a></span>&#160;<span class="keyword">static</span> int32 <a class="code" href="namespacekaldi_1_1nnet3.html#a79122735e3f124a6865ff339f40ec191">FindNStride</a>(<span class="keyword">const</span> std::vector&lt;Index&gt; &amp;indexes,</div><div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;                         <span class="keywordtype">bool</span> full_check) {</div><div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;  <span class="comment">// First find candidate stride.  Later we&#39;ll check for consistency.</span></div><div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;  int32 size = indexes.size();</div><div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(size &gt; 0);</div><div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;  int32 N = indexes[size-1].n + 1,</div><div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;        n_stride = -1;</div><div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;  <span class="keywordflow">if</span> (N &lt;= 1) {</div><div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;    <span class="comment">// we wouldn&#39;t be able to determine the stride if N &lt;= 1.</span></div><div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;  }</div><div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1Index.html">Index</a> index(indexes[0]);</div><div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;  <span class="keywordflow">if</span> (index.<a class="code" href="structkaldi_1_1nnet3_1_1Index.html#aad8b608072a1b6dcd9e91de38ee2925f">n</a> != 0 || size % N != 0) {</div><div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;    <span class="comment">// for the n stride to be positive, we must start with an index with n == 0.</span></div><div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;    <span class="comment">// if indexes.size() is not divisible by N, we have no hope of finding the</span></div><div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;    <span class="comment">// regular structure.</span></div><div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;  }</div><div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;  index.<a class="code" href="structkaldi_1_1nnet3_1_1Index.html#aad8b608072a1b6dcd9e91de38ee2925f">n</a> = 1;</div><div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;  <span class="comment">// First check the two most common strides, which are 1</span></div><div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;  <span class="comment">// and size / N.</span></div><div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;  <span class="keywordflow">if</span> (indexes[1] == index) {</div><div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;    n_stride = 1;</div><div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (indexes[size / N] == index) {</div><div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;    n_stride = size / N;</div><div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;    int32 stride;</div><div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;    <span class="comment">// try the other possible strides one by one (for subsampling</span></div><div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;    <span class="comment">// layers of convnets, we might see strides of 2, for instance).</span></div><div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;    <span class="keywordflow">for</span> (stride = 2; stride &lt; size / N; stride++) {</div><div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;      <span class="keywordflow">if</span> (size % stride == 0 &amp;&amp; indexes[stride] == index) {</div><div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;        n_stride = stride;</div><div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;      }</div><div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;    }</div><div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;    <span class="keywordflow">if</span> (n_stride == -1) {</div><div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;      <span class="comment">// if we fell off the loop then we found no candidates, which is strange</span></div><div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;      <span class="comment">// and means we did not find the expected structure; we&#39;ll return 0 as we</span></div><div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;      <span class="comment">// failed.</span></div><div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;    }</div><div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;  }</div><div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;  <span class="comment">// Now is the checking phase.</span></div><div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;</div><div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;  <span class="comment">// to understand block_size, see the comment above this functcion.</span></div><div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;  int32 block_size = n_stride * N;</div><div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;</div><div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;  std::vector&lt;int32&gt; indexes_to_check;</div><div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;  <span class="keywordflow">if</span> (full_check) {</div><div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;    indexes_to_check.resize(size);</div><div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;    <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; size; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++)</div><div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;      indexes_to_check[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>;</div><div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;    int32 num_to_check = std::min&lt;int32&gt;(5, size);</div><div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;    indexes_to_check.resize(num_to_check);</div><div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;    <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#a37d972ae0b47b9099e30983131d31916">j</a> = 0; <a class="code" href="namespacernnlm.html#a37d972ae0b47b9099e30983131d31916">j</a> &lt; num_to_check; <a class="code" href="namespacernnlm.html#a37d972ae0b47b9099e30983131d31916">j</a>++)</div><div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;      indexes_to_check[<a class="code" href="namespacernnlm.html#a37d972ae0b47b9099e30983131d31916">j</a>] = <a class="code" href="namespacekaldi.html#a0361eab3c5ebb78e6be060e6fa78e1a1">RandInt</a>(0, size - 1);</div><div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;    <a class="code" href="namespacekaldi.html#a3dd7a9cc33032bfb870b4b6c053822db">SortAndUniq</a>(&amp;indexes_to_check);</div><div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;  }</div><div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;  <span class="keywordflow">for</span> (std::vector&lt;int32&gt;::iterator iter = indexes_to_check.begin();</div><div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;       iter != indexes_to_check.end(); ++iter) {</div><div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;    int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = *iter;</div><div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1Index.html">Index</a> index = indexes[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;    int32 <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a> = index.<a class="code" href="structkaldi_1_1nnet3_1_1Index.html#aad8b608072a1b6dcd9e91de38ee2925f">n</a>;</div><div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;    <span class="keywordflow">if</span> (n &lt; N - 1) {</div><div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;      index.<a class="code" href="structkaldi_1_1nnet3_1_1Index.html#aad8b608072a1b6dcd9e91de38ee2925f">n</a> = n + 1;</div><div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;      <span class="keywordflow">if</span> (i + n_stride &gt;= size || indexes[i + n_stride] != index)</div><div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;    }</div><div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;    <span class="keywordflow">if</span> (n == 0) {</div><div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;      <span class="keywordflow">if</span> (i / block_size != (i + n_stride * (N-1)) / block_size) {</div><div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;        <span class="comment">// this is a check that the input divides into blocks of size n_stride *</span></div><div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;        <span class="comment">// N and the N different versions of the same Index are always within a</span></div><div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;        <span class="comment">// block (i.e. that the n stride never crosses over the block; having</span></div><div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;        <span class="comment">// the same Index repeated within different blocks actually would not</span></div><div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;        <span class="comment">// matter).</span></div><div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;      }</div><div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;    } <span class="keywordflow">else</span> { <span class="comment">// n &gt; 0</span></div><div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;      index.<a class="code" href="structkaldi_1_1nnet3_1_1Index.html#aad8b608072a1b6dcd9e91de38ee2925f">n</a> = n - 1;</div><div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;      <span class="keywordflow">if</span> (i - n_stride &lt; 0 || indexes[i - n_stride] != index)</div><div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;    }</div><div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;  }</div><div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;  <span class="keywordflow">return</span> n_stride;</div><div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;}</div><div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;</div><div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;</div><div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;<span class="comment">// This is almost exactly the same as the version of FindNStride declared above</span></div><div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;<span class="comment">// that takes a vector of Indexes as input.  Comments have been removed from</span></div><div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;<span class="comment">// this version; see the other version for documentation.</span></div><div class="line"><a name="l03033"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#af4426490c64581d8189bf8c671e5a893"> 3033</a></span>&#160;<span class="keyword">static</span> int32 <a class="code" href="namespacekaldi_1_1nnet3.html#a79122735e3f124a6865ff339f40ec191">FindNStride</a>(<span class="keyword">const</span> std::vector&lt;Cindex&gt; &amp;cindexes,</div><div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;                         <span class="keywordtype">bool</span> full_check) {</div><div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;  int32 size = cindexes.size();</div><div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(size &gt; 0);</div><div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;  int32 N = cindexes[size-1].second.n + 1,</div><div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;      n_stride = 0;</div><div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;  <span class="keywordflow">if</span> (N &lt;= 1)</div><div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#ac8344e7587df9247d6cc492874901d4d">Cindex</a> cindex(cindexes[0]);</div><div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;  <span class="keywordflow">if</span> (cindex.second.n != 0 || size % N != 0)</div><div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;  cindex.second.n = 1;</div><div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;  <span class="keywordflow">if</span> (cindexes[1] == cindex) {</div><div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;    n_stride = 1;</div><div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cindexes[size / N] == cindex) {</div><div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;    n_stride = size / N;</div><div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;    int32 stride;</div><div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;    <span class="keywordflow">for</span> (stride = 2; stride &lt; size / N; stride++) {</div><div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;      <span class="keywordflow">if</span> (size % stride == 0 &amp;&amp; cindexes[stride] == cindex) {</div><div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;        n_stride = stride;</div><div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;      }</div><div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;    }</div><div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;    <span class="keywordflow">if</span> (stride == size / N)</div><div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;  }</div><div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;  int32 block_size = n_stride * N;</div><div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;  std::vector&lt;int32&gt; indexes_to_check;</div><div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;  <span class="keywordflow">if</span> (full_check) {</div><div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;    indexes_to_check.resize(size);</div><div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;    <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; size; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++)</div><div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;      indexes_to_check[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>;</div><div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;    int32 num_to_check = std::min&lt;int32&gt;(5, size);</div><div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;    indexes_to_check.resize(num_to_check);</div><div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;    <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#a37d972ae0b47b9099e30983131d31916">j</a> = 0; <a class="code" href="namespacernnlm.html#a37d972ae0b47b9099e30983131d31916">j</a> &lt; num_to_check; <a class="code" href="namespacernnlm.html#a37d972ae0b47b9099e30983131d31916">j</a>++)</div><div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;      indexes_to_check[<a class="code" href="namespacernnlm.html#a37d972ae0b47b9099e30983131d31916">j</a>] = <a class="code" href="namespacekaldi.html#a0361eab3c5ebb78e6be060e6fa78e1a1">RandInt</a>(0, size - 1);</div><div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;    <a class="code" href="namespacekaldi.html#a3dd7a9cc33032bfb870b4b6c053822db">SortAndUniq</a>(&amp;indexes_to_check);</div><div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;  }</div><div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;  <span class="keywordflow">for</span> (std::vector&lt;int32&gt;::iterator iter = indexes_to_check.begin();</div><div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;       iter != indexes_to_check.end(); ++iter) {</div><div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;    int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = *iter;</div><div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;    <a class="code" href="namespacekaldi_1_1nnet3.html#ac8344e7587df9247d6cc492874901d4d">Cindex</a> cindex = cindexes[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;    int32 <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a> = cindex.second.n;</div><div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;    <span class="keywordflow">if</span> (n &lt; N - 1) {</div><div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;      cindex.second.n = n + 1;</div><div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;      <span class="keywordflow">if</span> (i + n_stride &gt;= size || cindexes[i + n_stride] != cindex)</div><div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;    }</div><div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;    <span class="keywordflow">if</span> (n == 0) {</div><div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;      <span class="keywordflow">if</span> (i / block_size != (i + n_stride * (N-1)) / block_size)</div><div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;      cindex.second.n = n - 1;</div><div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;      <span class="keywordflow">if</span> (i - n_stride &lt; 0 || cindexes[i - n_stride] != cindex)</div><div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;    }</div><div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;  }</div><div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;  <span class="keywordflow">return</span> n_stride;</div><div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;}</div><div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;</div><div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;</div><div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;<span class="comment">  This function, used in shortcut compilation, converts a vector of Indexes</span></div><div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;<span class="comment">  having a range of &#39;n&#39; values (0, 1, ... old_N - 1), to a vector of</span></div><div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;<span class="comment">  Indexes that&#39;s otherwise the same, but has a different range of &#39;n&#39; values</span></div><div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;<span class="comment">  (0, 1, ... new_N - 1).</span></div><div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;<span class="comment"></span></div><div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;<span class="comment">  The input vector is expected to have a stride &#39;n_stride &gt; 0&#39;, as</span></div><div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;<span class="comment">  would be returned by FindNStride, and the output vector will be given the</span></div><div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;<span class="comment">  same n-stride.</span></div><div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03106"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a4a1bed82d2cb5fbdc695bf32053117ad"> 3106</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a4a1bed82d2cb5fbdc695bf32053117ad">ConvertNumNValues</a>(int32 n_stride, int32 old_N, int32 new_N,</div><div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;                              <span class="keyword">const</span> std::vector&lt;Index&gt; &amp;indexes_in,</div><div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;                              std::vector&lt;Index&gt; *indexes_out) {</div><div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;  int32 size_in = indexes_in.size();</div><div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(size_in &gt; 0 &amp;&amp; indexes_in[size_in - 1].<a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a> == old_N - 1);</div><div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;  int32 block_size_in = n_stride * old_N,</div><div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;      block_size_out = n_stride * new_N;</div><div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;</div><div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;  indexes_out-&gt;resize((size_in / old_N) * new_N);</div><div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;  <span class="keywordflow">for</span> (int32 i_in = 0; i_in &lt; size_in; i_in++) {</div><div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;    <span class="keywordflow">if</span> (indexes_in[i_in].<a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a> != 0)</div><div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160;      <span class="keywordflow">continue</span>;</div><div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1Index.html">Index</a> index(indexes_in[i_in]);</div><div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;    int32 block_index = i_in / block_size_in,</div><div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;        offset_within_block = i_in % block_size_in;</div><div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;</div><div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;</div><div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;    int32 i_out = block_index * block_size_out +</div><div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;        offset_within_block;</div><div class="line"><a name="l03125"></a><span class="lineno"> 3125</span>&#160;    <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a> = 0; <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a> &lt; new_N; <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a>++, i_out += n_stride) {</div><div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;      index.<a class="code" href="structkaldi_1_1nnet3_1_1Index.html#aad8b608072a1b6dcd9e91de38ee2925f">n</a> = <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a>;</div><div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;      (*indexes_out)[i_out] = index;</div><div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;    }</div><div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;  }</div><div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;}</div><div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;</div><div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;</div><div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;</div><div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;<span class="comment">// This class implements the internals of the ExpandComputation() function (used</span></div><div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;<span class="comment">// in shortcut compilation); see comment by the declaration of</span></div><div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;<span class="comment">// ExpandComputation() in nnet-optimize-utils.h for overview.  (It relates to</span></div><div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;<span class="comment">// shortcut compilation).</span></div><div class="line"><a name="l03138"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html"> 3138</a></span>&#160;<span class="keyword">class </span><a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html">ComputationExpander</a> {</div><div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160; <span class="keyword">public</span>:</div><div class="line"><a name="l03140"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a357897f866f5c4ab0b3536d31ddf4284"> 3140</a></span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a357897f866f5c4ab0b3536d31ddf4284">ComputationExpander</a>(<span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;nnet,</div><div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;                      <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1MiscComputationInfo.html">MiscComputationInfo</a> &amp;misc_info,</div><div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;                      <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> &amp;computation,</div><div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;                      <span class="keywordtype">bool</span> need_debug_info,</div><div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160;                      int32 num_n_values,</div><div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;                      <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *expanded_computation):</div><div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#adbabf05a7702103113a02a113015205f">nnet_</a>(nnet), misc_info_(misc_info),</div><div class="line"><a name="l03147"></a><span class="lineno"> 3147</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>(computation),</div><div class="line"><a name="l03148"></a><span class="lineno"> 3148</span>&#160;      need_debug_info_(need_debug_info),</div><div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;      num_n_values_(num_n_values),</div><div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;      expanded_computation_(expanded_computation) {</div><div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(num_n_values &gt; 2);</div><div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;  }</div><div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160;</div><div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;  <span class="comment">// This function call implements the functionality of the class,</span></div><div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;  <span class="comment">// expanding the computation.</span></div><div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160;  <span class="keywordtype">void</span> Expand();</div><div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;</div><div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160; <span class="keyword">private</span>:</div><div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;  <span class="comment">// This function sets up and computes the &#39;n_stride_&#39; vector (see comment</span></div><div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;  <span class="comment">// by the declaration of &#39;n_stride_&#39; for what this is.</span></div><div class="line"><a name="l03161"></a><span class="lineno"> 3161</span>&#160;  <span class="keywordtype">void</span> InitStrideInfo();</div><div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160;</div><div class="line"><a name="l03163"></a><span class="lineno"> 3163</span>&#160;  <span class="comment">// This function sets up the &#39;matrices&#39; vector in &#39;expanded_computation_&#39;.</span></div><div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;  <span class="comment">// It&#39;s quite simple: it just multiplies all the num-rows by num_n_values_ and</span></div><div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;  <span class="comment">// divides by 2, and leaves the num-cols the same.</span></div><div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160;  <span class="keywordtype">void</span> ComputeMatrixInfo();</div><div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160;</div><div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;  <span class="comment">// This function, only called if need_debug_info_ is true, sets up</span></div><div class="line"><a name="l03169"></a><span class="lineno"> 3169</span>&#160;  <span class="comment">// the &#39;matrix_debug_info&#39; vector in &#39;expanded_computation_&#39;.</span></div><div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160;  <span class="keywordtype">void</span> ComputeDebugInfo();</div><div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;</div><div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;  <span class="comment">// This function sets up the &#39;submatrices&#39; vector in &#39;expanded_computation_&#39;.</span></div><div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;  <span class="comment">// Column ranges always stay the same, but for row ranges it&#39;s a little</span></div><div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;  <span class="comment">// more complicated.</span></div><div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;  <span class="keywordtype">void</span> ComputeSubmatrixInfo();</div><div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;</div><div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160;  <span class="comment">// Expands a command of type kCopyRows or kAddRows; involves adding a new</span></div><div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;  <span class="comment">// element of &#39;indexes&#39; to expanded_computation_.</span></div><div class="line"><a name="l03179"></a><span class="lineno"> 3179</span>&#160;  <span class="keywordtype">void</span> ExpandRowsCommand(<span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c_in,</div><div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;                         <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> *c_out);</div><div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;</div><div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;  <span class="comment">// Expands a command of type kCopyRowsMulti or kAddRowsMulti, kCopyToRowsMulti</span></div><div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160;  <span class="comment">// or kAddToRowsMulti; involves adding a new element of &#39;indexes_multi&#39; to</span></div><div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160;  <span class="comment">// expanded_computation_.</span></div><div class="line"><a name="l03185"></a><span class="lineno"> 3185</span>&#160;  <span class="keywordtype">void</span> ExpandRowsMultiCommand(<span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c_in,</div><div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160;                              <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> *c_out);</div><div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;</div><div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160;</div><div class="line"><a name="l03189"></a><span class="lineno"> 3189</span>&#160;  <span class="comment">// Expands a command of type kAddRowRanges; involves adding a new element of</span></div><div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160;  <span class="comment">// &#39;indexes_ranges&#39; to expanded_computation_.</span></div><div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;  <span class="keywordtype">void</span> ExpandRowRangesCommand(<span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c_in,</div><div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;                              <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> *c_out);</div><div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;</div><div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;</div><div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160;  <span class="comment">// This function computes all the PrecomputedIndexes in the</span></div><div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160;  <span class="comment">// &#39;component_precomputed_indexes&#39; member of &#39;expanded_computation_&#39;.</span></div><div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;  <span class="comment">// They are all generated from scratch, by using the Component::PrecomputedIndexes()</span></div><div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;  <span class="comment">// member function.  The &#39;input_indexes&#39; and &#39;output_indexes&#39; arguments are worked</span></div><div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;  <span class="comment">// out from the &#39;debug_info&#39; [if we&#39;re not generating debug_info we specially generate</span></div><div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160;  <span class="comment">// it for the specific matrices in question], and the &#39;need_backprop&#39;</span></div><div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;  <span class="comment">// argument is worked out by seeing whether there is a call to Backprop() with</span></div><div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160;  <span class="comment">// the same precomputed-indexes element.</span></div><div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;  <span class="keywordtype">void</span> ComputePrecomputedIndexes();</div><div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;</div><div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;  <span class="comment">// Computes the &#39;commands&#39; member of the output.  This function also adds as</span></div><div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;  <span class="comment">// needed to &#39;indexes&#39;, &#39;indexes_multi&#39; and &#39;indexes_ranges&#39; in the output.</span></div><div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160;  <span class="comment">// Later on we can call RenumberComputation() to remove any duplicates that</span></div><div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;  <span class="comment">// might result from this.</span></div><div class="line"><a name="l03209"></a><span class="lineno"> 3209</span>&#160;  <span class="keywordtype">void</span> ComputeCommands();</div><div class="line"><a name="l03210"></a><span class="lineno"> 3210</span>&#160;</div><div class="line"><a name="l03211"></a><span class="lineno"> 3211</span>&#160;</div><div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160;  <span class="comment">// This command ensure that the debug-info in expanded_computation_ for the</span></div><div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;  <span class="comment">// matrix underlying the submatrix with index &#39;submatrix_index&#39;, exists and is</span></div><div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;  <span class="comment">// set up.  In some cases we need the debug info for some matrices in order to</span></div><div class="line"><a name="l03215"></a><span class="lineno"> 3215</span>&#160;  <span class="comment">// do the expansion, even if debug info is not requested for the output; in</span></div><div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;  <span class="comment">// those cases we set it up temporarily and clear it before we finish.</span></div><div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;  <span class="keywordtype">void</span> EnsureDebugInfoExists(int32 submatrix_index);</div><div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;</div><div class="line"><a name="l03219"></a><span class="lineno"> 3219</span>&#160;</div><div class="line"><a name="l03220"></a><span class="lineno"> 3220</span>&#160;</div><div class="line"><a name="l03221"></a><span class="lineno"> 3221</span>&#160;  <span class="comment">// This function is used in mapping row-indexes into sub-matrices from the</span></div><div class="line"><a name="l03222"></a><span class="lineno"> 3222</span>&#160;  <span class="comment">// old to the new computation.  It is mostly a wrapper for</span></div><div class="line"><a name="l03223"></a><span class="lineno"> 3223</span>&#160;  <span class="comment">// GetNewMatrixLocationInfo, but designed to give row indexes into</span></div><div class="line"><a name="l03224"></a><span class="lineno"> 3224</span>&#160;  <span class="comment">// submatrices rather than matrices; see the documentation for</span></div><div class="line"><a name="l03225"></a><span class="lineno"> 3225</span>&#160;  <span class="comment">// GetNewMatrixLocationinfo() for details and an explanation of the</span></div><div class="line"><a name="l03226"></a><span class="lineno"> 3226</span>&#160;  <span class="comment">// interface.</span></div><div class="line"><a name="l03227"></a><span class="lineno"> 3227</span>&#160;  <span class="comment">// This function assumes that ComputeSubmatrixInfo() has already</span></div><div class="line"><a name="l03228"></a><span class="lineno"> 3228</span>&#160;  <span class="comment">// been called.</span></div><div class="line"><a name="l03229"></a><span class="lineno"> 3229</span>&#160;  <span class="comment">// Note: it returns true if the index &#39;old_row_index&#39; into submatrix</span></div><div class="line"><a name="l03230"></a><span class="lineno"> 3230</span>&#160;  <span class="comment">// indexed &#39;submat_index&#39; corresponds to an Index with n=0; otherwise</span></div><div class="line"><a name="l03231"></a><span class="lineno"> 3231</span>&#160;  <span class="comment">// it returns false and does not set the output values.</span></div><div class="line"><a name="l03232"></a><span class="lineno"> 3232</span>&#160;  <span class="comment">// If it returns true, it will set &#39;*new_row_index&#39; to be the row-index</span></div><div class="line"><a name="l03233"></a><span class="lineno"> 3233</span>&#160;  <span class="comment">// into the new submatrix, that corresponds to the same Cindex that</span></div><div class="line"><a name="l03234"></a><span class="lineno"> 3234</span>&#160;  <span class="comment">// &#39;old_row_index&#39; points to in the old computation; and it will set</span></div><div class="line"><a name="l03235"></a><span class="lineno"> 3235</span>&#160;  <span class="comment">// &#39;*n_stride&#39; to the n stride of the corresponding matrix (this is the</span></div><div class="line"><a name="l03236"></a><span class="lineno"> 3236</span>&#160;  <span class="comment">// same in the old and new computations).</span></div><div class="line"><a name="l03237"></a><span class="lineno"> 3237</span>&#160;  <span class="keywordtype">bool</span> GetNewSubmatLocationInfo(int32 submat_index,</div><div class="line"><a name="l03238"></a><span class="lineno"> 3238</span>&#160;                                int32 old_row_index,</div><div class="line"><a name="l03239"></a><span class="lineno"> 3239</span>&#160;                                int32 *new_row_index,</div><div class="line"><a name="l03240"></a><span class="lineno"> 3240</span>&#160;                                int32 *n_stride) <span class="keyword">const</span>;</div><div class="line"><a name="l03241"></a><span class="lineno"> 3241</span>&#160;</div><div class="line"><a name="l03242"></a><span class="lineno"> 3242</span>&#160;</div><div class="line"><a name="l03258"></a><span class="lineno"> 3258</span>&#160;  int32 GetNewMatrixLocationInfo(int32 old_matrix_index,</div><div class="line"><a name="l03259"></a><span class="lineno"> 3259</span>&#160;                                 int32 old_row_index) <span class="keyword">const</span>;</div><div class="line"><a name="l03260"></a><span class="lineno"> 3260</span>&#160;</div><div class="line"><a name="l03261"></a><span class="lineno"> 3261</span>&#160;</div><div class="line"><a name="l03262"></a><span class="lineno"> 3262</span>&#160;  <span class="comment">// This function &#39;expands&#39; a set of indexes; it&#39;s called from</span></div><div class="line"><a name="l03263"></a><span class="lineno"> 3263</span>&#160;  <span class="comment">// ComputePrecomputedIndexes().  The indexes are expected to</span></div><div class="line"><a name="l03264"></a><span class="lineno"> 3264</span>&#160;  <span class="comment">// have the normal kind of regularity.</span></div><div class="line"><a name="l03265"></a><span class="lineno"> 3265</span>&#160;  <span class="keywordtype">void</span> ExpandIndexes(<span class="keyword">const</span> std::vector&lt;Index&gt; &amp;indexes,</div><div class="line"><a name="l03266"></a><span class="lineno"> 3266</span>&#160;                     std::vector&lt;Index&gt; *indexes_expanded) <span class="keyword">const</span>;</div><div class="line"><a name="l03267"></a><span class="lineno"> 3267</span>&#160;</div><div class="line"><a name="l03268"></a><span class="lineno"> 3268</span>&#160;</div><div class="line"><a name="l03269"></a><span class="lineno"> 3269</span>&#160;</div><div class="line"><a name="l03270"></a><span class="lineno"> 3270</span>&#160;  <span class="comment">// This &#39;n_stride_&#39; vector is indexed by the matrix-index in the computation,</span></div><div class="line"><a name="l03271"></a><span class="lineno"> 3271</span>&#160;  <span class="comment">// i.e. the same value that you would use to index computation_.matrix_info and</span></div><div class="line"><a name="l03272"></a><span class="lineno"> 3272</span>&#160;  <span class="comment">// expanded_computation_-&gt;matrix_info.  For each matrix-index m &gt; 0 it</span></div><div class="line"><a name="l03273"></a><span class="lineno"> 3273</span>&#160;  <span class="comment">// contains the stride of the &#39;n&#39; values in the Indexes.  This is worked out</span></div><div class="line"><a name="l03274"></a><span class="lineno"> 3274</span>&#160;  <span class="comment">// from the debug_info of the input computation.  For example, if</span></div><div class="line"><a name="l03275"></a><span class="lineno"> 3275</span>&#160;  <span class="comment">// the n stride is 3, and we have an Index (n, t, x) = (0, 50, 88) at the</span></div><div class="line"><a name="l03276"></a><span class="lineno"> 3276</span>&#160;  <span class="comment">// 11&#39;th row of the matrix, then we would expect to have an Index</span></div><div class="line"><a name="l03277"></a><span class="lineno"> 3277</span>&#160;  <span class="comment">// (n, t, x) = (1, 50, 88) at the 11 + 3 = 14&#39;th row of the matrix.</span></div><div class="line"><a name="l03278"></a><span class="lineno"> 3278</span>&#160;  <span class="comment">// The input and output computations will always have the same n-stride, so</span></div><div class="line"><a name="l03279"></a><span class="lineno"> 3279</span>&#160;  <span class="comment">// there is only one variable.</span></div><div class="line"><a name="l03280"></a><span class="lineno"> 3280</span>&#160;  <span class="comment">//</span></div><div class="line"><a name="l03281"></a><span class="lineno"> 3281</span>&#160;  <span class="comment">// Let&#39;s define num-n-in = 2, and num-n-out = num_n_values_, and suppose</span></div><div class="line"><a name="l03282"></a><span class="lineno"> 3282</span>&#160;  <span class="comment">// we&#39;re dealing with a matrix that has an n stride of &quot;n-stride&quot;.</span></div><div class="line"><a name="l03283"></a><span class="lineno"> 3283</span>&#160;  <span class="comment">// We expect the (input, output) matrices to be arranged in blocks of num-rows</span></div><div class="line"><a name="l03284"></a><span class="lineno"> 3284</span>&#160;  <span class="comment">// (n-stride * num-n-in), (n-stride * num-n-out) respectively, where</span></div><div class="line"><a name="l03285"></a><span class="lineno"> 3285</span>&#160;  <span class="comment">// the n-stride never crosses the block boundaries.  We check this.</span></div><div class="line"><a name="l03286"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#af983142dc68170e669067284f55e06b8"> 3286</a></span>&#160;  std::vector&lt;int32&gt; <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#af983142dc68170e669067284f55e06b8">n_stride_</a>;</div><div class="line"><a name="l03287"></a><span class="lineno"> 3287</span>&#160;</div><div class="line"><a name="l03288"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#adbabf05a7702103113a02a113015205f"> 3288</a></span>&#160;  <span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;<a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#adbabf05a7702103113a02a113015205f">nnet_</a>;</div><div class="line"><a name="l03289"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a96c233d2a3038b6ce3f46adc9eeac6c8"> 3289</a></span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1MiscComputationInfo.html">MiscComputationInfo</a> &amp;<a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a96c233d2a3038b6ce3f46adc9eeac6c8">misc_info_</a>;</div><div class="line"><a name="l03290"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a81b35995b5ef2650f6367cb1299ef0fd"> 3290</a></span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> &amp;<a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a81b35995b5ef2650f6367cb1299ef0fd">computation_</a>;</div><div class="line"><a name="l03291"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a0ad00746c585650630f59ba3b3c3dad1"> 3291</a></span>&#160;  <span class="keywordtype">bool</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a0ad00746c585650630f59ba3b3c3dad1">need_debug_info_</a>;</div><div class="line"><a name="l03292"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a9a0388f6e3ce9318db544eef95415305"> 3292</a></span>&#160;  int32 <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a9a0388f6e3ce9318db544eef95415305">num_n_values_</a>;</div><div class="line"><a name="l03293"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#afa02f703a75537d153178d8ad1e104ad"> 3293</a></span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *<a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#afa02f703a75537d153178d8ad1e104ad">expanded_computation_</a>;</div><div class="line"><a name="l03294"></a><span class="lineno"> 3294</span>&#160;};</div><div class="line"><a name="l03295"></a><span class="lineno"> 3295</span>&#160;</div><div class="line"><a name="l03296"></a><span class="lineno"> 3296</span>&#160;</div><div class="line"><a name="l03297"></a><span class="lineno"> 3297</span>&#160;</div><div class="line"><a name="l03298"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a87cbe94f28fe1fbbbcde4e650b5fbfe2"> 3298</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a87cbe94f28fe1fbbbcde4e650b5fbfe2">ComputationExpander::ExpandRowsCommand</a>(</div><div class="line"><a name="l03299"></a><span class="lineno"> 3299</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c_in,</div><div class="line"><a name="l03300"></a><span class="lineno"> 3300</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> *c_out) {</div><div class="line"><a name="l03301"></a><span class="lineno"> 3301</span>&#160;  <span class="comment">// we need to expand the row-indexes in c_in.arg3, and put the index of the</span></div><div class="line"><a name="l03302"></a><span class="lineno"> 3302</span>&#160;  <span class="comment">// resulting vector&lt;int&gt; in expanded_computation_-&gt;indexes, in &#39;c_out-&gt;arg3&#39;.</span></div><div class="line"><a name="l03303"></a><span class="lineno"> 3303</span>&#160;</div><div class="line"><a name="l03304"></a><span class="lineno"> 3304</span>&#160;  int32 s1 = c_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>, s2 = c_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>;</div><div class="line"><a name="l03305"></a><span class="lineno"> 3305</span>&#160;</div><div class="line"><a name="l03306"></a><span class="lineno"> 3306</span>&#160;  <span class="comment">// The command that gets called is something like</span></div><div class="line"><a name="l03307"></a><span class="lineno"> 3307</span>&#160;  <span class="comment">// submat1.AddRows(submat2, indexes) if submat1 is the submatrix referred to in</span></div><div class="line"><a name="l03308"></a><span class="lineno"> 3308</span>&#160;  <span class="comment">// &#39;s1&#39; and submat2 is the submatrix referred to in &#39;s2&#39;.</span></div><div class="line"><a name="l03309"></a><span class="lineno"> 3309</span>&#160;  <span class="comment">// &#39;indexes&#39; has the same size as the num-rows of submat1, and the values</span></div><div class="line"><a name="l03310"></a><span class="lineno"> 3310</span>&#160;  <span class="comment">// in the vector are row-indexes into s2.</span></div><div class="line"><a name="l03311"></a><span class="lineno"> 3311</span>&#160;  int32 old_arg3 = c_out-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>;</div><div class="line"><a name="l03312"></a><span class="lineno"> 3312</span>&#160;  c_out-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a> = expanded_computation_-&gt;indexes.size();</div><div class="line"><a name="l03313"></a><span class="lineno"> 3313</span>&#160;  c_out-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2de3c74f7141e97502ff48c2407b78be">alpha</a> = c_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2de3c74f7141e97502ff48c2407b78be">alpha</a>;</div><div class="line"><a name="l03314"></a><span class="lineno"> 3314</span>&#160;  expanded_computation_-&gt;indexes.push_back(std::vector&lt;int32&gt;());</div><div class="line"><a name="l03315"></a><span class="lineno"> 3315</span>&#160;  std::vector&lt;int32&gt; &amp;new_indexes = expanded_computation_-&gt;indexes.back();</div><div class="line"><a name="l03316"></a><span class="lineno"> 3316</span>&#160;  <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;old_indexes = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">indexes</a>[old_arg3];</div><div class="line"><a name="l03317"></a><span class="lineno"> 3317</span>&#160;</div><div class="line"><a name="l03318"></a><span class="lineno"> 3318</span>&#160;  int32 old_size = old_indexes.size(),</div><div class="line"><a name="l03319"></a><span class="lineno"> 3319</span>&#160;      num_n_values = num_n_values_,</div><div class="line"><a name="l03320"></a><span class="lineno"> 3320</span>&#160;      new_s1_size = expanded_computation_-&gt;submatrices[s1].num_rows,</div><div class="line"><a name="l03321"></a><span class="lineno"> 3321</span>&#160;      new_s2_size = expanded_computation_-&gt;submatrices[s2].num_rows;</div><div class="line"><a name="l03322"></a><span class="lineno"> 3322</span>&#160;</div><div class="line"><a name="l03323"></a><span class="lineno"> 3323</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(old_size == <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s1].num_rows);</div><div class="line"><a name="l03324"></a><span class="lineno"> 3324</span>&#160;</div><div class="line"><a name="l03325"></a><span class="lineno"> 3325</span>&#160;  new_indexes.resize(new_s1_size, -1);</div><div class="line"><a name="l03326"></a><span class="lineno"> 3326</span>&#160;</div><div class="line"><a name="l03327"></a><span class="lineno"> 3327</span>&#160;</div><div class="line"><a name="l03328"></a><span class="lineno"> 3328</span>&#160;  <span class="comment">// A note on the variable names: i1 and i2 are indexes into the destination</span></div><div class="line"><a name="l03329"></a><span class="lineno"> 3329</span>&#160;  <span class="comment">// submatrix and the source submatrix respectively, of the CopyRows or AddRows</span></div><div class="line"><a name="l03330"></a><span class="lineno"> 3330</span>&#160;  <span class="comment">// command.</span></div><div class="line"><a name="l03331"></a><span class="lineno"> 3331</span>&#160;  <span class="comment">// &quot;n0&quot; in the variable name means that this corresponds to an Index with n==0.</span></div><div class="line"><a name="l03332"></a><span class="lineno"> 3332</span>&#160;  <span class="comment">// things without &quot;new&quot; in the name refer to the old computation; things with</span></div><div class="line"><a name="l03333"></a><span class="lineno"> 3333</span>&#160;  <span class="comment">// &quot;new&quot; in the name refer to the computation that we are generating.</span></div><div class="line"><a name="l03334"></a><span class="lineno"> 3334</span>&#160;  <span class="keywordflow">for</span> (int32 i1 = 0; i1 &lt; old_size; i1++) {</div><div class="line"><a name="l03335"></a><span class="lineno"> 3335</span>&#160;    int32 new_i1_n0, n_stride1;</div><div class="line"><a name="l03336"></a><span class="lineno"> 3336</span>&#160;    <span class="keywordflow">if</span> (GetNewSubmatLocationInfo(s1, i1, &amp;new_i1_n0, &amp;n_stride1)) {</div><div class="line"><a name="l03337"></a><span class="lineno"> 3337</span>&#160;      <span class="comment">// GetNewSubmatLocationInfo() returns true if this corresponds to</span></div><div class="line"><a name="l03338"></a><span class="lineno"> 3338</span>&#160;      <span class="comment">// a Cindex with n == 0.</span></div><div class="line"><a name="l03339"></a><span class="lineno"> 3339</span>&#160;      int32 i2 = old_indexes[i1];  <span class="comment">// note: i2 is the row index into submatrix s2.</span></div><div class="line"><a name="l03340"></a><span class="lineno"> 3340</span>&#160;      int32 new_i2_n0, n_stride2;</div><div class="line"><a name="l03341"></a><span class="lineno"> 3341</span>&#160;      <span class="keywordflow">if</span> (i2 &lt; 0) {  <span class="comment">// if i2 is -1, we&#39;ll just leave any relevant positions in</span></div><div class="line"><a name="l03342"></a><span class="lineno"> 3342</span>&#160;                     <span class="comment">// &#39;new_indexes&#39; with -1&#39;s in them.</span></div><div class="line"><a name="l03343"></a><span class="lineno"> 3343</span>&#160;        <span class="keywordflow">continue</span>;</div><div class="line"><a name="l03344"></a><span class="lineno"> 3344</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03345"></a><span class="lineno"> 3345</span>&#160;        <span class="keywordtype">bool</span> ans = GetNewSubmatLocationInfo(s2, i2, &amp;new_i2_n0, &amp;n_stride2);</div><div class="line"><a name="l03346"></a><span class="lineno"> 3346</span>&#160;        <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(ans);  <span class="comment">// source should also be for n==0, because we don&#39;t</span></div><div class="line"><a name="l03347"></a><span class="lineno"> 3347</span>&#160;                            <span class="comment">// (or at least shouldn&#39;t) create computations that</span></div><div class="line"><a name="l03348"></a><span class="lineno"> 3348</span>&#160;                            <span class="comment">// mix up the &#39;n&#39; values</span></div><div class="line"><a name="l03349"></a><span class="lineno"> 3349</span>&#160;</div><div class="line"><a name="l03350"></a><span class="lineno"> 3350</span>&#160;        int32 new_i1 = new_i1_n0, new_i2 = new_i2_n0;</div><div class="line"><a name="l03351"></a><span class="lineno"> 3351</span>&#160;        <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a> = 0; <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a> &lt; num_n_values;</div><div class="line"><a name="l03352"></a><span class="lineno"> 3352</span>&#160;             ++<a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a>, new_i1 += n_stride1, new_i2 += n_stride2) {</div><div class="line"><a name="l03353"></a><span class="lineno"> 3353</span>&#160;          <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(new_i1 &lt; new_s1_size &amp;&amp; new_i2 &lt; new_s2_size);</div><div class="line"><a name="l03354"></a><span class="lineno"> 3354</span>&#160;          new_indexes[new_i1] = new_i2;</div><div class="line"><a name="l03355"></a><span class="lineno"> 3355</span>&#160;        }</div><div class="line"><a name="l03356"></a><span class="lineno"> 3356</span>&#160;      }</div><div class="line"><a name="l03357"></a><span class="lineno"> 3357</span>&#160;    }</div><div class="line"><a name="l03358"></a><span class="lineno"> 3358</span>&#160;  }</div><div class="line"><a name="l03359"></a><span class="lineno"> 3359</span>&#160;}</div><div class="line"><a name="l03360"></a><span class="lineno"> 3360</span>&#160;</div><div class="line"><a name="l03361"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a6b2ebb0f18100bdd03194aac19da1e09"> 3361</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a6b2ebb0f18100bdd03194aac19da1e09">ComputationExpander::ExpandRowsMultiCommand</a>(</div><div class="line"><a name="l03362"></a><span class="lineno"> 3362</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c_in,</div><div class="line"><a name="l03363"></a><span class="lineno"> 3363</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> *c_out) {</div><div class="line"><a name="l03364"></a><span class="lineno"> 3364</span>&#160;  <span class="comment">// we need to expand the (submatrix,row)-index pairs in c_in.arg2, and put the</span></div><div class="line"><a name="l03365"></a><span class="lineno"> 3365</span>&#160;  <span class="comment">// index of the resulting vector&lt;int&gt; in expanded_computation_-&gt;indexes_multi,</span></div><div class="line"><a name="l03366"></a><span class="lineno"> 3366</span>&#160;  <span class="comment">// in &#39;c_out-&gt;arg2&#39;.</span></div><div class="line"><a name="l03367"></a><span class="lineno"> 3367</span>&#160;</div><div class="line"><a name="l03368"></a><span class="lineno"> 3368</span>&#160;  int32 s1 = c_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>,</div><div class="line"><a name="l03369"></a><span class="lineno"> 3369</span>&#160;      num_rows_old = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s1].num_rows,</div><div class="line"><a name="l03370"></a><span class="lineno"> 3370</span>&#160;      num_rows_new = expanded_computation_-&gt;submatrices[s1].num_rows;</div><div class="line"><a name="l03371"></a><span class="lineno"> 3371</span>&#160;</div><div class="line"><a name="l03372"></a><span class="lineno"> 3372</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(num_rows_old % 2 == 0);</div><div class="line"><a name="l03373"></a><span class="lineno"> 3373</span>&#160;  int32 num_n_values = num_n_values_;</div><div class="line"><a name="l03374"></a><span class="lineno"> 3374</span>&#160;</div><div class="line"><a name="l03375"></a><span class="lineno"> 3375</span>&#160;  int32 old_arg2 = c_out-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>;</div><div class="line"><a name="l03376"></a><span class="lineno"> 3376</span>&#160;  c_out-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a> = expanded_computation_-&gt;indexes_multi.size();</div><div class="line"><a name="l03377"></a><span class="lineno"> 3377</span>&#160;  expanded_computation_-&gt;indexes_multi.push_back(</div><div class="line"><a name="l03378"></a><span class="lineno"> 3378</span>&#160;      std::vector&lt;std::pair&lt;int32, int32&gt; &gt;());</div><div class="line"><a name="l03379"></a><span class="lineno"> 3379</span>&#160;  std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;new_indexes_multi =</div><div class="line"><a name="l03380"></a><span class="lineno"> 3380</span>&#160;      expanded_computation_-&gt;indexes_multi.back();</div><div class="line"><a name="l03381"></a><span class="lineno"> 3381</span>&#160;  <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;old_indexes_multi =</div><div class="line"><a name="l03382"></a><span class="lineno"> 3382</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">indexes_multi</a>[old_arg2];</div><div class="line"><a name="l03383"></a><span class="lineno"> 3383</span>&#160;  <span class="comment">// old_indexes_multi is a vector that has the same size as the num-rows</span></div><div class="line"><a name="l03384"></a><span class="lineno"> 3384</span>&#160;  <span class="comment">// of submatrix s1.  It contains pairs that are either (-1, -1), or</span></div><div class="line"><a name="l03385"></a><span class="lineno"> 3385</span>&#160;  <span class="comment">// pairs (submatrix-index, row-index) referring to other submatrices</span></div><div class="line"><a name="l03386"></a><span class="lineno"> 3386</span>&#160;  <span class="comment">// in the computation.</span></div><div class="line"><a name="l03387"></a><span class="lineno"> 3387</span>&#160;</div><div class="line"><a name="l03388"></a><span class="lineno"> 3388</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(static_cast&lt;int32&gt;(old_indexes_multi.size()) == num_rows_old);</div><div class="line"><a name="l03389"></a><span class="lineno"> 3389</span>&#160;</div><div class="line"><a name="l03390"></a><span class="lineno"> 3390</span>&#160;</div><div class="line"><a name="l03391"></a><span class="lineno"> 3391</span>&#160;  new_indexes_multi.resize(num_rows_new,</div><div class="line"><a name="l03392"></a><span class="lineno"> 3392</span>&#160;                           std::pair&lt;int32,int32&gt;(-1, -1));</div><div class="line"><a name="l03393"></a><span class="lineno"> 3393</span>&#160;</div><div class="line"><a name="l03394"></a><span class="lineno"> 3394</span>&#160;  <span class="keywordflow">for</span> (int32 i1 = 0; i1 &lt; num_rows_old; i1++) {</div><div class="line"><a name="l03395"></a><span class="lineno"> 3395</span>&#160;    int32 new_i1_n0, n_stride1;</div><div class="line"><a name="l03396"></a><span class="lineno"> 3396</span>&#160;    <span class="keywordflow">if</span> (GetNewSubmatLocationInfo(s1, i1, &amp;new_i1_n0, &amp;n_stride1)) {</div><div class="line"><a name="l03397"></a><span class="lineno"> 3397</span>&#160;      <span class="comment">// GetNewSubmatLocationInfo() returns true if this corresponds to</span></div><div class="line"><a name="l03398"></a><span class="lineno"> 3398</span>&#160;      <span class="comment">// a Cindex with n == 0.</span></div><div class="line"><a name="l03399"></a><span class="lineno"> 3399</span>&#160;      int32 s2 = old_indexes_multi[i1].first,</div><div class="line"><a name="l03400"></a><span class="lineno"> 3400</span>&#160;          i2 = old_indexes_multi[i1].second;</div><div class="line"><a name="l03401"></a><span class="lineno"> 3401</span>&#160;      int32 new_i2_n0, n_stride2;</div><div class="line"><a name="l03402"></a><span class="lineno"> 3402</span>&#160;      <span class="keywordflow">if</span> (s2 &lt; 0) {  <span class="comment">// if s2 is -1, we don&#39;t have to do anything... we&#39;d have</span></div><div class="line"><a name="l03403"></a><span class="lineno"> 3403</span>&#160;                     <span class="comment">// to fill any relevant positions in &#39;new_indexes_multi&#39;</span></div><div class="line"><a name="l03404"></a><span class="lineno"> 3404</span>&#160;                     <span class="comment">// with (-1,-1)&#39;s, but it&#39;s filled with that by default.</span></div><div class="line"><a name="l03405"></a><span class="lineno"> 3405</span>&#160;        <span class="keywordflow">continue</span>;</div><div class="line"><a name="l03406"></a><span class="lineno"> 3406</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03407"></a><span class="lineno"> 3407</span>&#160;        <span class="keywordtype">bool</span> ans = GetNewSubmatLocationInfo(s2, i2, &amp;new_i2_n0, &amp;n_stride2);</div><div class="line"><a name="l03408"></a><span class="lineno"> 3408</span>&#160;        <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(ans);  <span class="comment">// source should also be for n==0, because we don&#39;t</span></div><div class="line"><a name="l03409"></a><span class="lineno"> 3409</span>&#160;                            <span class="comment">// (or at least shouldn&#39;t) create computations that</span></div><div class="line"><a name="l03410"></a><span class="lineno"> 3410</span>&#160;                            <span class="comment">// mix up the &#39;n&#39; values</span></div><div class="line"><a name="l03411"></a><span class="lineno"> 3411</span>&#160;</div><div class="line"><a name="l03412"></a><span class="lineno"> 3412</span>&#160;        int32 new_i1 = new_i1_n0, new_i2 = new_i2_n0;</div><div class="line"><a name="l03413"></a><span class="lineno"> 3413</span>&#160;</div><div class="line"><a name="l03414"></a><span class="lineno"> 3414</span>&#160;        <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a> = 0; <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a> &lt; num_n_values;</div><div class="line"><a name="l03415"></a><span class="lineno"> 3415</span>&#160;             <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a>++, new_i1 += n_stride1, new_i2 += n_stride2) {</div><div class="line"><a name="l03416"></a><span class="lineno"> 3416</span>&#160;          new_indexes_multi[new_i1].first = s2;</div><div class="line"><a name="l03417"></a><span class="lineno"> 3417</span>&#160;          new_indexes_multi[new_i1].second = new_i2;</div><div class="line"><a name="l03418"></a><span class="lineno"> 3418</span>&#160;        }</div><div class="line"><a name="l03419"></a><span class="lineno"> 3419</span>&#160;      }</div><div class="line"><a name="l03420"></a><span class="lineno"> 3420</span>&#160;    }</div><div class="line"><a name="l03421"></a><span class="lineno"> 3421</span>&#160;  }</div><div class="line"><a name="l03422"></a><span class="lineno"> 3422</span>&#160;}</div><div class="line"><a name="l03423"></a><span class="lineno"> 3423</span>&#160;</div><div class="line"><a name="l03424"></a><span class="lineno"> 3424</span>&#160;</div><div class="line"><a name="l03425"></a><span class="lineno"> 3425</span>&#160;</div><div class="line"><a name="l03426"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a9bfd022e9b1b6b8bf5494afbcd8aff9d"> 3426</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a9bfd022e9b1b6b8bf5494afbcd8aff9d">ComputationExpander::ExpandRowRangesCommand</a>(</div><div class="line"><a name="l03427"></a><span class="lineno"> 3427</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c_in,</div><div class="line"><a name="l03428"></a><span class="lineno"> 3428</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> *c_out) {</div><div class="line"><a name="l03429"></a><span class="lineno"> 3429</span>&#160;  <span class="comment">// we need to expand the pairs of row-indexes in c_in.arg2, and put the index</span></div><div class="line"><a name="l03430"></a><span class="lineno"> 3430</span>&#160;  <span class="comment">// of the resulting vector&lt;int&gt; in expanded_computation_-&gt;indexes_ranges, in</span></div><div class="line"><a name="l03431"></a><span class="lineno"> 3431</span>&#160;  <span class="comment">// &#39;c_out-&gt;arg2&#39;.</span></div><div class="line"><a name="l03432"></a><span class="lineno"> 3432</span>&#160;</div><div class="line"><a name="l03433"></a><span class="lineno"> 3433</span>&#160;  int32 s1 = c_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>, s2 = c_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>,</div><div class="line"><a name="l03434"></a><span class="lineno"> 3434</span>&#160;      num_rows_old = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s1].num_rows,</div><div class="line"><a name="l03435"></a><span class="lineno"> 3435</span>&#160;      num_rows_new = expanded_computation_-&gt;submatrices[s1].num_rows;</div><div class="line"><a name="l03436"></a><span class="lineno"> 3436</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(static_cast&lt;size_t&gt;(c_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>) &lt;</div><div class="line"><a name="l03437"></a><span class="lineno"> 3437</span>&#160;               <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a3095d45a751aaa81c1024cf9510e2ed7">indexes_ranges</a>.size());</div><div class="line"><a name="l03438"></a><span class="lineno"> 3438</span>&#160;  int32 num_n_values = num_n_values_;</div><div class="line"><a name="l03439"></a><span class="lineno"> 3439</span>&#160;</div><div class="line"><a name="l03440"></a><span class="lineno"> 3440</span>&#160;  int32 old_arg3 = c_out-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a>;</div><div class="line"><a name="l03441"></a><span class="lineno"> 3441</span>&#160;  c_out-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">arg3</a> = expanded_computation_-&gt;indexes_ranges.size();</div><div class="line"><a name="l03442"></a><span class="lineno"> 3442</span>&#160;  expanded_computation_-&gt;indexes_ranges.push_back(</div><div class="line"><a name="l03443"></a><span class="lineno"> 3443</span>&#160;      std::vector&lt;std::pair&lt;int32, int32&gt; &gt;());</div><div class="line"><a name="l03444"></a><span class="lineno"> 3444</span>&#160;  std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;new_indexes_ranges =</div><div class="line"><a name="l03445"></a><span class="lineno"> 3445</span>&#160;      expanded_computation_-&gt;indexes_ranges.back();</div><div class="line"><a name="l03446"></a><span class="lineno"> 3446</span>&#160;  <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;old_indexes_ranges =</div><div class="line"><a name="l03447"></a><span class="lineno"> 3447</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a3095d45a751aaa81c1024cf9510e2ed7">indexes_ranges</a>[old_arg3];</div><div class="line"><a name="l03448"></a><span class="lineno"> 3448</span>&#160;  <span class="comment">// old_indexes_ranges is a vector that has the same size as the num-rows of</span></div><div class="line"><a name="l03449"></a><span class="lineno"> 3449</span>&#160;  <span class="comment">// submatrix s1.  It contains pairs that are either two copies of the same</span></div><div class="line"><a name="l03450"></a><span class="lineno"> 3450</span>&#160;  <span class="comment">// value (in practice the pair (-1, -1)), or pairs (begin-row-index,</span></div><div class="line"><a name="l03451"></a><span class="lineno"> 3451</span>&#160;  <span class="comment">// end-row-index) representing the (begin,end) of a range in submatrix s2.</span></div><div class="line"><a name="l03452"></a><span class="lineno"> 3452</span>&#160;  <span class="comment">// Note: end-row-index is one past the end of the range, as for C++ iterators.</span></div><div class="line"><a name="l03453"></a><span class="lineno"> 3453</span>&#160;</div><div class="line"><a name="l03454"></a><span class="lineno"> 3454</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(static_cast&lt;int32&gt;(old_indexes_ranges.size()) == num_rows_old);</div><div class="line"><a name="l03455"></a><span class="lineno"> 3455</span>&#160;</div><div class="line"><a name="l03456"></a><span class="lineno"> 3456</span>&#160;  new_indexes_ranges.resize(num_rows_new,</div><div class="line"><a name="l03457"></a><span class="lineno"> 3457</span>&#160;                           std::pair&lt;int32,int32&gt;(-1, -1));</div><div class="line"><a name="l03458"></a><span class="lineno"> 3458</span>&#160;</div><div class="line"><a name="l03459"></a><span class="lineno"> 3459</span>&#160;  <span class="keywordflow">for</span> (int32 i1 = 0; i1 &lt; num_rows_old; i1++) {</div><div class="line"><a name="l03460"></a><span class="lineno"> 3460</span>&#160;    int32 new_i1_n0, n_stride1;</div><div class="line"><a name="l03461"></a><span class="lineno"> 3461</span>&#160;    <span class="keywordflow">if</span> (GetNewSubmatLocationInfo(s1, i1, &amp;new_i1_n0, &amp;n_stride1)) {</div><div class="line"><a name="l03462"></a><span class="lineno"> 3462</span>&#160;      <span class="comment">// GetNewSubmatLocationInfo() returns true if this corresponds to</span></div><div class="line"><a name="l03463"></a><span class="lineno"> 3463</span>&#160;      <span class="comment">// a Cindex with n == 0.</span></div><div class="line"><a name="l03464"></a><span class="lineno"> 3464</span>&#160;      int32 i2_begin = old_indexes_ranges[i1].first,</div><div class="line"><a name="l03465"></a><span class="lineno"> 3465</span>&#160;          i2_end = old_indexes_ranges[i1].second;</div><div class="line"><a name="l03466"></a><span class="lineno"> 3466</span>&#160;      <span class="keywordflow">if</span> (i2_end == i2_begin)</div><div class="line"><a name="l03467"></a><span class="lineno"> 3467</span>&#160;        <span class="keywordflow">continue</span>;  <span class="comment">// (-1, -1) pair, meaning an empty range.</span></div><div class="line"><a name="l03468"></a><span class="lineno"> 3468</span>&#160;                   <span class="comment">// &#39;new_indexes_ranges&#39; is filled with (-1, -1) pairs as a</span></div><div class="line"><a name="l03469"></a><span class="lineno"> 3469</span>&#160;                   <span class="comment">// default so we don&#39;t have to do anything for these</span></div><div class="line"><a name="l03470"></a><span class="lineno"> 3470</span>&#160;                   <span class="comment">// elements.</span></div><div class="line"><a name="l03471"></a><span class="lineno"> 3471</span>&#160;      int32 i2_last = i2_end - 1;</div><div class="line"><a name="l03472"></a><span class="lineno"> 3472</span>&#160;      int32 new_i2_n0_begin, new_i2_n0_last,</div><div class="line"><a name="l03473"></a><span class="lineno"> 3473</span>&#160;          n_stride2;  <span class="comment">// only 1 stride variable; both calls will output</span></div><div class="line"><a name="l03474"></a><span class="lineno"> 3474</span>&#160;                          <span class="comment">// the same value.</span></div><div class="line"><a name="l03475"></a><span class="lineno"> 3475</span>&#160;</div><div class="line"><a name="l03476"></a><span class="lineno"> 3476</span>&#160;      <span class="keywordtype">bool</span> ans1 = GetNewSubmatLocationInfo(s2, i2_begin, &amp;new_i2_n0_begin,</div><div class="line"><a name="l03477"></a><span class="lineno"> 3477</span>&#160;                                           &amp;n_stride2),</div><div class="line"><a name="l03478"></a><span class="lineno"> 3478</span>&#160;          ans2 = GetNewSubmatLocationInfo(s2, i2_last, &amp;new_i2_n0_last,</div><div class="line"><a name="l03479"></a><span class="lineno"> 3479</span>&#160;                                          &amp;n_stride2);</div><div class="line"><a name="l03480"></a><span class="lineno"> 3480</span>&#160;      <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(ans1 &amp;&amp; ans2 &amp;&amp; new_i2_n0_last &gt;= new_i2_n0_begin &amp;&amp;</div><div class="line"><a name="l03481"></a><span class="lineno"> 3481</span>&#160;                   new_i2_n0_begin &gt;= 0 &amp;&amp; n_stride1 &gt; 0 &amp;&amp; n_stride2 &gt; 0);</div><div class="line"><a name="l03482"></a><span class="lineno"> 3482</span>&#160;      <span class="comment">// source should also be for n==0, because we don&#39;t (or at least</span></div><div class="line"><a name="l03483"></a><span class="lineno"> 3483</span>&#160;      <span class="comment">// shouldn&#39;t) create computations that mix up the &#39;n&#39; values</span></div><div class="line"><a name="l03484"></a><span class="lineno"> 3484</span>&#160;</div><div class="line"><a name="l03485"></a><span class="lineno"> 3485</span>&#160;</div><div class="line"><a name="l03486"></a><span class="lineno"> 3486</span>&#160;      int32 new_i1 = new_i1_n0,</div><div class="line"><a name="l03487"></a><span class="lineno"> 3487</span>&#160;          new_i2_begin = new_i2_n0_begin,</div><div class="line"><a name="l03488"></a><span class="lineno"> 3488</span>&#160;          new_i2_end = new_i2_n0_last + 1;</div><div class="line"><a name="l03489"></a><span class="lineno"> 3489</span>&#160;      <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a> = 0; <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a> &lt; num_n_values;</div><div class="line"><a name="l03490"></a><span class="lineno"> 3490</span>&#160;           <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a>++, new_i1 += n_stride1, new_i2_begin += n_stride2,</div><div class="line"><a name="l03491"></a><span class="lineno"> 3491</span>&#160;               new_i2_end += n_stride2) {</div><div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;        new_indexes_ranges[new_i1].first = new_i2_begin;</div><div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;        new_indexes_ranges[new_i1].second = new_i2_end;</div><div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160;      }</div><div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;    }</div><div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;  }</div><div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;}</div><div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;</div><div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;</div><div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;</div><div class="line"><a name="l03501"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a47b759979e43092bbb39fc8897f6b143"> 3501</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a47b759979e43092bbb39fc8897f6b143">ComputationExpander::ComputeCommands</a>() {</div><div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;  int32 num_commands = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size();</div><div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160;  expanded_computation_-&gt;commands.resize(num_commands);</div><div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;  <span class="keywordflow">for</span> (int32 command_index = 0; command_index &lt; num_commands;</div><div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160;       command_index++) {</div><div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c_out =</div><div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;        expanded_computation_-&gt;commands[command_index];</div><div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160;    c_out = c;</div><div class="line"><a name="l03510"></a><span class="lineno"> 3510</span>&#160;    <span class="comment">// Commands that only operate on submatrices, components and</span></div><div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;    <span class="comment">// precomputed-indexes do not have to be changed because we&#39;ll take care of</span></div><div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160;    <span class="comment">// the expansion by suitably redefining the matrices and submatrices, and</span></div><div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;    <span class="comment">// recreating the precomputed-indexes.</span></div><div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;    <span class="comment">// However, commands that require, &#39;indexes&#39;, &#39;indexes_multi&#39; or</span></div><div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;    <span class="comment">// &#39;indexes_ranges&#39; do need to be modified.</span></div><div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;    <span class="keywordflow">switch</span> (c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a>) {</div><div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a73b5995148c3e987c4a163ad6bc9850b">kAllocMatrix</a>:</div><div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae77588ab7fc4ccf842de7ec941247062">kDeallocMatrix</a>:</div><div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a55f8cb2bfd2e2c3605dfa961eff35fa2">kSetConst</a>:</div><div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a8ecee91c55553bcf2d755d00328b0253">kSwapMatrix</a>:</div><div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26ebe2a579bf27a5453cb7b489ad6f69">kPropagate</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83">kBackprop</a>:</div><div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352afab6637ac4a83d6775366b4e9c42e241">kBackpropNoModelUpdate</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a35d3d1a70d075561aaf91b263ea28f74">kMatrixCopy</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a8ce789ab4782758335cc37349fb97257">kMatrixAdd</a>:</div><div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l03524"></a><span class="lineno"> 3524</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a308b0ecf9083a7fde572d88f70af6258">kCopyRows</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae9638edeb0ada9a6373257fd508ae11f">kAddRows</a>:</div><div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;        ExpandRowsCommand(c, &amp;c_out);</div><div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a341a9c019757a7f1172d86bad51500a5">kCopyRowsMulti</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26009d8f2bc3f61d214925ae25af9962">kAddRowsMulti</a>:</div><div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a5161c1dfc34a4df1b19e9d3b8dc9499c">kCopyToRowsMulti</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a662aa95978d72cd24fde262e35941fad">kAddToRowsMulti</a>:</div><div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;        ExpandRowsMultiCommand(c, &amp;c_out);</div><div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a86646468234ab036580a4f2e4d72af3c">kAddRowRanges</a>:</div><div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;        ExpandRowRangesCommand(c, &amp;c_out);</div><div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a19758aa995e3baa1aa2cef6528d10fb9">kCompressMatrix</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a0260a200407f88708e5c2793506e4ada">kDecompressMatrix</a>:</div><div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a6b396f5162883c2f4fb837a2af4b8895">kAcceptInput</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352aaa3fd92744438323baec475cee5b9b3d">kProvideOutput</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>:</div><div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352af9786d4042a4fcf23b29a14a6fb64126">kNoOperationPermanent</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352af67517e882c1aebe145a016945b9e6a4">kNoOperationMarker</a>:</div><div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;      <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a967844c2c7775d280d15738cbe852536">kNoOperationLabel</a>: <span class="keywordflow">case</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352add9060e8c7434f250048082c634d9a6d">kGotoLabel</a>:</div><div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;      <span class="keywordflow">default</span>:</div><div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160;        <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Un-handled command type&quot;</span>;</div><div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;    }</div><div class="line"><a name="l03542"></a><span class="lineno"> 3542</span>&#160;  }</div><div class="line"><a name="l03543"></a><span class="lineno"> 3543</span>&#160;}</div><div class="line"><a name="l03544"></a><span class="lineno"> 3544</span>&#160;</div><div class="line"><a name="l03545"></a><span class="lineno"> 3545</span>&#160;</div><div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;</div><div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;</div><div class="line"><a name="l03548"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a652f9fe87cd1b276eb349312151054f8"> 3548</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a652f9fe87cd1b276eb349312151054f8">ComputationExpander::InitStrideInfo</a>() {</div><div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;  <span class="comment">// note: the zeroth matrix is not a real matrix, it&#39;s the empty matrix.</span></div><div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;  int32 num_matrices = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>.size();</div><div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160;  n_stride_.resize(num_matrices);</div><div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;  n_stride_[0] = 0;</div><div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;</div><div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160;  <span class="comment">// the input computation to class ComputationExpander is required to</span></div><div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;  <span class="comment">// have its debug info set up.</span></div><div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.empty());</div><div class="line"><a name="l03557"></a><span class="lineno"> 3557</span>&#160;  <span class="keywordflow">for</span> (int32 m = 1; m &lt; num_matrices; m++) {</div><div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;    int32 num_rows = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m].num_rows;</div><div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a> &amp;debug_info = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[m];</div><div class="line"><a name="l03560"></a><span class="lineno"> 3560</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(debug_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>.size() == num_rows);</div><div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160;    <span class="keywordtype">bool</span> full_check = <span class="keyword">true</span>;  <span class="comment">// TODO: eventually change this to false.</span></div><div class="line"><a name="l03562"></a><span class="lineno"> 3562</span>&#160;    int32 n_stride = <a class="code" href="namespacekaldi_1_1nnet3.html#a79122735e3f124a6865ff339f40ec191">FindNStride</a>(debug_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>, full_check);</div><div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160;    <span class="keywordflow">if</span> (n_stride == 0) {</div><div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Problem encountered in &#39;shortcut&#39; compilation: the computation &quot;</span></div><div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160;                &lt;&lt; <span class="stringliteral">&quot;does not have the expected structure.  Try compiling with &quot;</span></div><div class="line"><a name="l03566"></a><span class="lineno"> 3566</span>&#160;                &lt;&lt; <span class="stringliteral">&quot;--use-shortcut=false.&quot;</span>;</div><div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;    }</div><div class="line"><a name="l03568"></a><span class="lineno"> 3568</span>&#160;    n_stride_[m] = n_stride;</div><div class="line"><a name="l03569"></a><span class="lineno"> 3569</span>&#160;  }</div><div class="line"><a name="l03570"></a><span class="lineno"> 3570</span>&#160;}</div><div class="line"><a name="l03571"></a><span class="lineno"> 3571</span>&#160;</div><div class="line"><a name="l03572"></a><span class="lineno"> 3572</span>&#160;</div><div class="line"><a name="l03573"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a740071247a178d84b8bf2b17901509b4"> 3573</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a740071247a178d84b8bf2b17901509b4">ComputationExpander::Expand</a>() {</div><div class="line"><a name="l03574"></a><span class="lineno"> 3574</span>&#160;  InitStrideInfo();</div><div class="line"><a name="l03575"></a><span class="lineno"> 3575</span>&#160;  ComputeMatrixInfo();</div><div class="line"><a name="l03576"></a><span class="lineno"> 3576</span>&#160;  <span class="keywordflow">if</span> (need_debug_info_)</div><div class="line"><a name="l03577"></a><span class="lineno"> 3577</span>&#160;    ComputeDebugInfo();</div><div class="line"><a name="l03578"></a><span class="lineno"> 3578</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l03579"></a><span class="lineno"> 3579</span>&#160;    expanded_computation_-&gt;matrix_debug_info.clear();</div><div class="line"><a name="l03580"></a><span class="lineno"> 3580</span>&#160;  ComputeSubmatrixInfo();</div><div class="line"><a name="l03581"></a><span class="lineno"> 3581</span>&#160;  ComputePrecomputedIndexes();</div><div class="line"><a name="l03582"></a><span class="lineno"> 3582</span>&#160;  ComputeCommands();</div><div class="line"><a name="l03583"></a><span class="lineno"> 3583</span>&#160;</div><div class="line"><a name="l03584"></a><span class="lineno"> 3584</span>&#160;  expanded_computation_-&gt;need_model_derivative =</div><div class="line"><a name="l03585"></a><span class="lineno"> 3585</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a58c542fffb7e7f754148c264c90b4a5e">need_model_derivative</a>;</div><div class="line"><a name="l03586"></a><span class="lineno"> 3586</span>&#160;}</div><div class="line"><a name="l03587"></a><span class="lineno"> 3587</span>&#160;</div><div class="line"><a name="l03588"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#aecd7fa564d816a5025ca66346f6b80fe"> 3588</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#aecd7fa564d816a5025ca66346f6b80fe">ComputationExpander::ComputeMatrixInfo</a>() {</div><div class="line"><a name="l03589"></a><span class="lineno"> 3589</span>&#160;  int32 num_matrices = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>.size();</div><div class="line"><a name="l03590"></a><span class="lineno"> 3590</span>&#160;  expanded_computation_-&gt;matrices.resize(num_matrices);</div><div class="line"><a name="l03591"></a><span class="lineno"> 3591</span>&#160;  <span class="comment">// Matrix zero is a special case; it&#39;s the empty matrix.</span></div><div class="line"><a name="l03592"></a><span class="lineno"> 3592</span>&#160;  expanded_computation_-&gt;matrices[0] = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[0];</div><div class="line"><a name="l03593"></a><span class="lineno"> 3593</span>&#160;  int32 old_num_n_values = 2,</div><div class="line"><a name="l03594"></a><span class="lineno"> 3594</span>&#160;      new_num_n_values = num_n_values_;</div><div class="line"><a name="l03595"></a><span class="lineno"> 3595</span>&#160;  <span class="keywordflow">for</span> (int32 m = 1; m &lt; num_matrices; m++) {</div><div class="line"><a name="l03596"></a><span class="lineno"> 3596</span>&#160;    expanded_computation_-&gt;matrices[m] = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m];</div><div class="line"><a name="l03597"></a><span class="lineno"> 3597</span>&#160;    expanded_computation_-&gt;matrices[m].num_rows =</div><div class="line"><a name="l03598"></a><span class="lineno"> 3598</span>&#160;        (<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m].num_rows / old_num_n_values) *</div><div class="line"><a name="l03599"></a><span class="lineno"> 3599</span>&#160;        new_num_n_values;</div><div class="line"><a name="l03600"></a><span class="lineno"> 3600</span>&#160;  }</div><div class="line"><a name="l03601"></a><span class="lineno"> 3601</span>&#160;}</div><div class="line"><a name="l03602"></a><span class="lineno"> 3602</span>&#160;</div><div class="line"><a name="l03603"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a349da8d95ac1defe31a714e52954bbde"> 3603</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a349da8d95ac1defe31a714e52954bbde">ComputationExpander::ComputeDebugInfo</a>() {</div><div class="line"><a name="l03604"></a><span class="lineno"> 3604</span>&#160;  int32 num_matrices = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>.size();</div><div class="line"><a name="l03605"></a><span class="lineno"> 3605</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.size() == num_matrices);</div><div class="line"><a name="l03606"></a><span class="lineno"> 3606</span>&#160;  expanded_computation_-&gt;matrix_debug_info.resize(num_matrices);</div><div class="line"><a name="l03607"></a><span class="lineno"> 3607</span>&#160;  <span class="comment">// Matrix zero is a special case; it&#39;s the empty matrix.</span></div><div class="line"><a name="l03608"></a><span class="lineno"> 3608</span>&#160;  expanded_computation_-&gt;matrix_debug_info[0] =</div><div class="line"><a name="l03609"></a><span class="lineno"> 3609</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[0];</div><div class="line"><a name="l03610"></a><span class="lineno"> 3610</span>&#160;  int32 num_n_values = num_n_values_;</div><div class="line"><a name="l03611"></a><span class="lineno"> 3611</span>&#160;  <span class="keywordflow">for</span> (int32 m = 1; m &lt; num_matrices; m++) {</div><div class="line"><a name="l03612"></a><span class="lineno"> 3612</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a> &amp;info_in =</div><div class="line"><a name="l03613"></a><span class="lineno"> 3613</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[m];</div><div class="line"><a name="l03614"></a><span class="lineno"> 3614</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a> &amp;info_out =</div><div class="line"><a name="l03615"></a><span class="lineno"> 3615</span>&#160;        expanded_computation_-&gt;matrix_debug_info[m];</div><div class="line"><a name="l03616"></a><span class="lineno"> 3616</span>&#160;    info_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a9da2804c57d358d12d491f0c3d51d0ef">is_deriv</a> = info_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a9da2804c57d358d12d491f0c3d51d0ef">is_deriv</a>;</div><div class="line"><a name="l03617"></a><span class="lineno"> 3617</span>&#160;    int32 num_rows_in = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m].num_rows,</div><div class="line"><a name="l03618"></a><span class="lineno"> 3618</span>&#160;        num_rows_out = expanded_computation_-&gt;matrices[m].num_rows;</div><div class="line"><a name="l03619"></a><span class="lineno"> 3619</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(num_rows_in == info_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>.size());</div><div class="line"><a name="l03620"></a><span class="lineno"> 3620</span>&#160;    info_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>.resize(num_rows_out);</div><div class="line"><a name="l03621"></a><span class="lineno"> 3621</span>&#160;    <span class="keyword">const</span> <a class="code" href="namespacekaldi_1_1nnet3.html#ac8344e7587df9247d6cc492874901d4d">Cindex</a> *cindexes_in = &amp;(info_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>[0]);</div><div class="line"><a name="l03622"></a><span class="lineno"> 3622</span>&#160;    <a class="code" href="namespacekaldi_1_1nnet3.html#ac8344e7587df9247d6cc492874901d4d">Cindex</a> *cindexes_out = &amp;(info_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>[0]);</div><div class="line"><a name="l03623"></a><span class="lineno"> 3623</span>&#160;    <span class="keywordflow">for</span> (int32 r = 0; r &lt; num_rows_in; r++) {</div><div class="line"><a name="l03624"></a><span class="lineno"> 3624</span>&#160;      <span class="keywordflow">if</span> (info_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>[r].second.n == 0) {</div><div class="line"><a name="l03625"></a><span class="lineno"> 3625</span>&#160;        int32 new_r = GetNewMatrixLocationInfo(m, r),</div><div class="line"><a name="l03626"></a><span class="lineno"> 3626</span>&#160;            n_stride = n_stride_[m];</div><div class="line"><a name="l03627"></a><span class="lineno"> 3627</span>&#160;        <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a> = 0; <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a> &lt; num_n_values; <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a>++) {</div><div class="line"><a name="l03628"></a><span class="lineno"> 3628</span>&#160;          int32 r_out = new_r + <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a> * n_stride;</div><div class="line"><a name="l03629"></a><span class="lineno"> 3629</span>&#160;          cindexes_out[r_out] = cindexes_in[r];</div><div class="line"><a name="l03630"></a><span class="lineno"> 3630</span>&#160;          cindexes_out[r_out].second.n = <a class="code" href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">n</a>;</div><div class="line"><a name="l03631"></a><span class="lineno"> 3631</span>&#160;        }</div><div class="line"><a name="l03632"></a><span class="lineno"> 3632</span>&#160;      }</div><div class="line"><a name="l03633"></a><span class="lineno"> 3633</span>&#160;    }</div><div class="line"><a name="l03634"></a><span class="lineno"> 3634</span>&#160;  }</div><div class="line"><a name="l03635"></a><span class="lineno"> 3635</span>&#160;}</div><div class="line"><a name="l03636"></a><span class="lineno"> 3636</span>&#160;</div><div class="line"><a name="l03637"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#ac0618c08b05537029106fab90e16dfe0"> 3637</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#ac0618c08b05537029106fab90e16dfe0">ComputationExpander::ComputeSubmatrixInfo</a>() {</div><div class="line"><a name="l03638"></a><span class="lineno"> 3638</span>&#160;  int32 num_submatrices = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>.size();</div><div class="line"><a name="l03639"></a><span class="lineno"> 3639</span>&#160;  expanded_computation_-&gt;submatrices.resize(num_submatrices);</div><div class="line"><a name="l03640"></a><span class="lineno"> 3640</span>&#160;  <span class="comment">// Sub-matrix zero is a special case; it&#39;s the empty submatrix.</span></div><div class="line"><a name="l03641"></a><span class="lineno"> 3641</span>&#160;  expanded_computation_-&gt;submatrices[0] = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[0];</div><div class="line"><a name="l03642"></a><span class="lineno"> 3642</span>&#160;  <span class="keywordflow">for</span> (int32 s = 1; s &lt; num_submatrices; s++) {</div><div class="line"><a name="l03643"></a><span class="lineno"> 3643</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">NnetComputation::SubMatrixInfo</a> &amp;info_in = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[s];</div><div class="line"><a name="l03644"></a><span class="lineno"> 3644</span>&#160;    int32 m = info_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a515c4dd14ce4dc58f42c9a60b6bfbaba">matrix_index</a>;</div><div class="line"><a name="l03645"></a><span class="lineno"> 3645</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a> &amp;debug_info_in =</div><div class="line"><a name="l03646"></a><span class="lineno"> 3646</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[m];</div><div class="line"><a name="l03647"></a><span class="lineno"> 3647</span>&#160;</div><div class="line"><a name="l03648"></a><span class="lineno"> 3648</span>&#160;    <span class="comment">// we may need to change the row_offset and num_rows.</span></div><div class="line"><a name="l03649"></a><span class="lineno"> 3649</span>&#160;    int32 first_row_in = info_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#acfb04e9339880d3594894f5201b70eac">row_offset</a>,</div><div class="line"><a name="l03650"></a><span class="lineno"> 3650</span>&#160;        last_row_in = first_row_in + info_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a> - 1;</div><div class="line"><a name="l03651"></a><span class="lineno"> 3651</span>&#160;    <span class="keywordflow">if</span> (!(debug_info_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>[first_row_in].second.n == 0 &amp;&amp;</div><div class="line"><a name="l03652"></a><span class="lineno"> 3652</span>&#160;          debug_info_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>[last_row_in].second.n == 1)) {</div><div class="line"><a name="l03653"></a><span class="lineno"> 3653</span>&#160;      std::ostringstream computation_ss;</div><div class="line"><a name="l03654"></a><span class="lineno"> 3654</span>&#160;      std::vector&lt;std::string&gt; submat_strings;</div><div class="line"><a name="l03655"></a><span class="lineno"> 3655</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#abf2fedad8e73e55adba8dba14361967f">GetSubmatrixStrings</a>(<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#adbabf05a7702103113a02a113015205f">nnet_</a>, &amp;submat_strings);</div><div class="line"><a name="l03656"></a><span class="lineno"> 3656</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a849faa82711b6faa8551205167721bfa">Print</a>(computation_ss, <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#adbabf05a7702103113a02a113015205f">nnet_</a>);</div><div class="line"><a name="l03657"></a><span class="lineno"> 3657</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Submatrix s&quot;</span> &lt;&lt; s &lt;&lt; <span class="stringliteral">&quot; = &quot;</span> &lt;&lt; submat_strings[s]</div><div class="line"><a name="l03658"></a><span class="lineno"> 3658</span>&#160;                &lt;&lt; <span class="stringliteral">&quot; has strange dimensions.  Computation is: &quot;</span></div><div class="line"><a name="l03659"></a><span class="lineno"> 3659</span>&#160;                &lt;&lt; computation_ss.str();</div><div class="line"><a name="l03660"></a><span class="lineno"> 3660</span>&#160;    }</div><div class="line"><a name="l03661"></a><span class="lineno"> 3661</span>&#160;</div><div class="line"><a name="l03662"></a><span class="lineno"> 3662</span>&#160;    int32 first_row_out = GetNewMatrixLocationInfo(m, first_row_in),</div><div class="line"><a name="l03663"></a><span class="lineno"> 3663</span>&#160;        last_row_out = GetNewMatrixLocationInfo(m, last_row_in),</div><div class="line"><a name="l03664"></a><span class="lineno"> 3664</span>&#160;        new_num_rows = (last_row_out + 1 - first_row_out);</div><div class="line"><a name="l03665"></a><span class="lineno"> 3665</span>&#160;</div><div class="line"><a name="l03666"></a><span class="lineno"> 3666</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">NnetComputation::SubMatrixInfo</a> &amp;info_out =</div><div class="line"><a name="l03667"></a><span class="lineno"> 3667</span>&#160;        expanded_computation_-&gt;submatrices[s];</div><div class="line"><a name="l03668"></a><span class="lineno"> 3668</span>&#160;    info_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a515c4dd14ce4dc58f42c9a60b6bfbaba">matrix_index</a> = m;</div><div class="line"><a name="l03669"></a><span class="lineno"> 3669</span>&#160;    info_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#acfb04e9339880d3594894f5201b70eac">row_offset</a> = first_row_out;</div><div class="line"><a name="l03670"></a><span class="lineno"> 3670</span>&#160;    info_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a> = new_num_rows;</div><div class="line"><a name="l03671"></a><span class="lineno"> 3671</span>&#160;    info_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a7524bea2834a3dc08b90e5b3406ee0e8">col_offset</a> = info_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a7524bea2834a3dc08b90e5b3406ee0e8">col_offset</a>;</div><div class="line"><a name="l03672"></a><span class="lineno"> 3672</span>&#160;    info_out.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#aea941d74a486998b6fa921bc19fed05c">num_cols</a> = info_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#aea941d74a486998b6fa921bc19fed05c">num_cols</a>;</div><div class="line"><a name="l03673"></a><span class="lineno"> 3673</span>&#160;  }</div><div class="line"><a name="l03674"></a><span class="lineno"> 3674</span>&#160;}</div><div class="line"><a name="l03675"></a><span class="lineno"> 3675</span>&#160;</div><div class="line"><a name="l03676"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#aad666818585d567208e5833cd3ed6ea4"> 3676</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#aad666818585d567208e5833cd3ed6ea4">ComputationExpander::ComputePrecomputedIndexes</a>() {</div><div class="line"><a name="l03677"></a><span class="lineno"> 3677</span>&#160;  <span class="comment">// for each element of &#39;component_precomputed_indexes&#39;,</span></div><div class="line"><a name="l03678"></a><span class="lineno"> 3678</span>&#160;  <span class="comment">// we will try to work out the command-index of the associated</span></div><div class="line"><a name="l03679"></a><span class="lineno"> 3679</span>&#160;  <span class="comment">// Propagate() command and of the associated Backprop() command,</span></div><div class="line"><a name="l03680"></a><span class="lineno"> 3680</span>&#160;  <span class="comment">// if it exists.</span></div><div class="line"><a name="l03681"></a><span class="lineno"> 3681</span>&#160;  <span class="comment">// We expect that each such element will be associated with</span></div><div class="line"><a name="l03682"></a><span class="lineno"> 3682</span>&#160;  <span class="comment">// exactly one Propagate() command and at most one Backprop() command.</span></div><div class="line"><a name="l03683"></a><span class="lineno"> 3683</span>&#160;  int32 num_commands = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size(),</div><div class="line"><a name="l03684"></a><span class="lineno"> 3684</span>&#160;    num_precomputed_indexes = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab8ae09d46a89f34a89b970a24156481d">component_precomputed_indexes</a>.size();</div><div class="line"><a name="l03685"></a><span class="lineno"> 3685</span>&#160;</div><div class="line"><a name="l03686"></a><span class="lineno"> 3686</span>&#160;  std::vector&lt;bool&gt; need_backprop(num_precomputed_indexes, <span class="keyword">false</span>);</div><div class="line"><a name="l03687"></a><span class="lineno"> 3687</span>&#160;</div><div class="line"><a name="l03688"></a><span class="lineno"> 3688</span>&#160;  std::vector&lt;int32&gt; component_index(num_precomputed_indexes, -1);</div><div class="line"><a name="l03689"></a><span class="lineno"> 3689</span>&#160;</div><div class="line"><a name="l03690"></a><span class="lineno"> 3690</span>&#160;  <span class="keywordflow">for</span> (int32 command_index = 0; command_index &lt; num_commands; command_index++) {</div><div class="line"><a name="l03691"></a><span class="lineno"> 3691</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;c = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l03692"></a><span class="lineno"> 3692</span>&#160;</div><div class="line"><a name="l03693"></a><span class="lineno"> 3693</span>&#160;    <span class="keywordflow">if</span> (c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26ebe2a579bf27a5453cb7b489ad6f69">kPropagate</a> &amp;&amp; c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a> &gt; 0) {</div><div class="line"><a name="l03694"></a><span class="lineno"> 3694</span>&#160;      <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a> &lt; num_precomputed_indexes);</div><div class="line"><a name="l03695"></a><span class="lineno"> 3695</span>&#160;      component_index[c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>] = c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>;</div><div class="line"><a name="l03696"></a><span class="lineno"> 3696</span>&#160;    }</div><div class="line"><a name="l03697"></a><span class="lineno"> 3697</span>&#160;    <span class="keywordflow">if</span> ((c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83">kBackprop</a> ||</div><div class="line"><a name="l03698"></a><span class="lineno"> 3698</span>&#160;         c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352afab6637ac4a83d6775366b4e9c42e241">kBackpropNoModelUpdate</a>) &amp;&amp; c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a> &gt; 0) {</div><div class="line"><a name="l03699"></a><span class="lineno"> 3699</span>&#160;      <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a> &lt; num_precomputed_indexes);</div><div class="line"><a name="l03700"></a><span class="lineno"> 3700</span>&#160;      need_backprop[c.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>] = <span class="keyword">true</span>;</div><div class="line"><a name="l03701"></a><span class="lineno"> 3701</span>&#160;    }</div><div class="line"><a name="l03702"></a><span class="lineno"> 3702</span>&#160;  }</div><div class="line"><a name="l03703"></a><span class="lineno"> 3703</span>&#160;</div><div class="line"><a name="l03704"></a><span class="lineno"> 3704</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> p = 1;</div><div class="line"><a name="l03705"></a><span class="lineno"> 3705</span>&#160;       p &lt; expanded_computation_-&gt;component_precomputed_indexes.size();</div><div class="line"><a name="l03706"></a><span class="lineno"> 3706</span>&#160;       ++p)</div><div class="line"><a name="l03707"></a><span class="lineno"> 3707</span>&#160;    <span class="keyword">delete</span> expanded_computation_-&gt;component_precomputed_indexes[p].data;</div><div class="line"><a name="l03708"></a><span class="lineno"> 3708</span>&#160;  expanded_computation_-&gt;component_precomputed_indexes.clear();</div><div class="line"><a name="l03709"></a><span class="lineno"> 3709</span>&#160;  expanded_computation_-&gt;component_precomputed_indexes.resize(</div><div class="line"><a name="l03710"></a><span class="lineno"> 3710</span>&#160;      num_precomputed_indexes);</div><div class="line"><a name="l03711"></a><span class="lineno"> 3711</span>&#160;</div><div class="line"><a name="l03712"></a><span class="lineno"> 3712</span>&#160;  <span class="keywordflow">for</span> (int32 p = 1; p &lt; num_precomputed_indexes; ++p) {</div><div class="line"><a name="l03713"></a><span class="lineno"> 3713</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1PrecomputedIndexesInfo.html">NnetComputation::PrecomputedIndexesInfo</a> &amp;old_info =</div><div class="line"><a name="l03714"></a><span class="lineno"> 3714</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab8ae09d46a89f34a89b970a24156481d">component_precomputed_indexes</a>[p];</div><div class="line"><a name="l03715"></a><span class="lineno"> 3715</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1PrecomputedIndexesInfo.html">NnetComputation::PrecomputedIndexesInfo</a> &amp;new_info =</div><div class="line"><a name="l03716"></a><span class="lineno"> 3716</span>&#160;        expanded_computation_-&gt;component_precomputed_indexes[p];</div><div class="line"><a name="l03717"></a><span class="lineno"> 3717</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!old_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1PrecomputedIndexesInfo.html#a910c43bfaec0fcc760c761ee67501ea8">input_indexes</a>.empty() &amp;&amp;</div><div class="line"><a name="l03718"></a><span class="lineno"> 3718</span>&#160;                 !old_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1PrecomputedIndexesInfo.html#ac02949595ba936e91eb7ccbfdfd98c2a">output_indexes</a>.empty() &amp;&amp;</div><div class="line"><a name="l03719"></a><span class="lineno"> 3719</span>&#160;                 <span class="stringliteral">&quot;Input/output indexes not present in precomputed info of &quot;</span></div><div class="line"><a name="l03720"></a><span class="lineno"> 3720</span>&#160;                 <span class="stringliteral">&quot;computation to be expanded.&quot;</span>);</div><div class="line"><a name="l03721"></a><span class="lineno"> 3721</span>&#160;    <span class="comment">// note: we could place these expanded indexes into &#39;new_info.input_indexes&#39;</span></div><div class="line"><a name="l03722"></a><span class="lineno"> 3722</span>&#160;    <span class="comment">// and &#39;new_info.output_indexes&#39;, but we actually don&#39;t need to keep them</span></div><div class="line"><a name="l03723"></a><span class="lineno"> 3723</span>&#160;    <span class="comment">// there, because they are only required to be kept in computations where</span></div><div class="line"><a name="l03724"></a><span class="lineno"> 3724</span>&#160;    <span class="comment">// the n indexes consist of the set (0, 1), and the computation we&#39;re</span></div><div class="line"><a name="l03725"></a><span class="lineno"> 3725</span>&#160;    <span class="comment">// creating has more distinct n indexes than that.</span></div><div class="line"><a name="l03726"></a><span class="lineno"> 3726</span>&#160;    std::vector&lt;Index&gt; input_indexes, output_indexes;</div><div class="line"><a name="l03727"></a><span class="lineno"> 3727</span>&#160;    ExpandIndexes(old_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1PrecomputedIndexesInfo.html#a910c43bfaec0fcc760c761ee67501ea8">input_indexes</a>, &amp;input_indexes);</div><div class="line"><a name="l03728"></a><span class="lineno"> 3728</span>&#160;    ExpandIndexes(old_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1PrecomputedIndexesInfo.html#ac02949595ba936e91eb7ccbfdfd98c2a">output_indexes</a>, &amp;output_indexes);</div><div class="line"><a name="l03729"></a><span class="lineno"> 3729</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(component_index[p] &gt;= 0);</div><div class="line"><a name="l03730"></a><span class="lineno"> 3730</span>&#160;    <span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Component.html">Component</a> *component = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#adbabf05a7702103113a02a113015205f">nnet_</a>.<a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html#aec8d6dfed3e4ab080d3ff4cf6a1126e3">GetComponent</a>(component_index[p]);</div><div class="line"><a name="l03731"></a><span class="lineno"> 3731</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ComponentPrecomputedIndexes.html">ComponentPrecomputedIndexes</a> *expanded_precomputed_indexes =</div><div class="line"><a name="l03732"></a><span class="lineno"> 3732</span>&#160;        component-&gt;<a class="code" href="classkaldi_1_1nnet3_1_1Component.html#ad3829084b3e064ff320153ff4b6cfd44">PrecomputeIndexes</a>(misc_info_, input_indexes,</div><div class="line"><a name="l03733"></a><span class="lineno"> 3733</span>&#160;                                     output_indexes, need_backprop[p]);</div><div class="line"><a name="l03734"></a><span class="lineno"> 3734</span>&#160;    <span class="comment">// this object should not be null because it was not NULL the</span></div><div class="line"><a name="l03735"></a><span class="lineno"> 3735</span>&#160;    <span class="comment">// last time we generated it from the same component, for the</span></div><div class="line"><a name="l03736"></a><span class="lineno"> 3736</span>&#160;    <span class="comment">// same computation.</span></div><div class="line"><a name="l03737"></a><span class="lineno"> 3737</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(expanded_precomputed_indexes != NULL);</div><div class="line"><a name="l03738"></a><span class="lineno"> 3738</span>&#160;    new_info.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1PrecomputedIndexesInfo.html#aac3f15181923193b59c8cf2f1433d88b">data</a> = expanded_precomputed_indexes;</div><div class="line"><a name="l03739"></a><span class="lineno"> 3739</span>&#160;  }</div><div class="line"><a name="l03740"></a><span class="lineno"> 3740</span>&#160;}</div><div class="line"><a name="l03741"></a><span class="lineno"> 3741</span>&#160;</div><div class="line"><a name="l03742"></a><span class="lineno"> 3742</span>&#160;</div><div class="line"><a name="l03743"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#ae75e6d0c1a5e33b7b6a02175357f0fcd"> 3743</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#ae75e6d0c1a5e33b7b6a02175357f0fcd">ComputationExpander::GetNewSubmatLocationInfo</a>(</div><div class="line"><a name="l03744"></a><span class="lineno"> 3744</span>&#160;    int32 submat_index, int32 old_row_index,</div><div class="line"><a name="l03745"></a><span class="lineno"> 3745</span>&#160;    int32 *new_row_index, int32 *n_stride)<span class="keyword"> const </span>{</div><div class="line"><a name="l03746"></a><span class="lineno"> 3746</span>&#160;  int32 matrix_index = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submat_index].matrix_index,</div><div class="line"><a name="l03747"></a><span class="lineno"> 3747</span>&#160;   old_row_offset = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[submat_index].row_offset,</div><div class="line"><a name="l03748"></a><span class="lineno"> 3748</span>&#160;   new_row_offset = expanded_computation_-&gt;submatrices[submat_index].row_offset;</div><div class="line"><a name="l03749"></a><span class="lineno"> 3749</span>&#160;</div><div class="line"><a name="l03750"></a><span class="lineno"> 3750</span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a> &amp;debug_info_in =</div><div class="line"><a name="l03751"></a><span class="lineno"> 3751</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[matrix_index];</div><div class="line"><a name="l03752"></a><span class="lineno"> 3752</span>&#160;  <span class="keywordflow">if</span> (debug_info_in.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>[old_row_index + old_row_offset].second.n != 0)</div><div class="line"><a name="l03753"></a><span class="lineno"> 3753</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l03754"></a><span class="lineno"> 3754</span>&#160;  *new_row_index = (GetNewMatrixLocationInfo(matrix_index,</div><div class="line"><a name="l03755"></a><span class="lineno"> 3755</span>&#160;                                             old_row_index + old_row_offset) -</div><div class="line"><a name="l03756"></a><span class="lineno"> 3756</span>&#160;                    new_row_offset);</div><div class="line"><a name="l03757"></a><span class="lineno"> 3757</span>&#160;  *n_stride = n_stride_[matrix_index];</div><div class="line"><a name="l03758"></a><span class="lineno"> 3758</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03759"></a><span class="lineno"> 3759</span>&#160;}</div><div class="line"><a name="l03760"></a><span class="lineno"> 3760</span>&#160;</div><div class="line"><a name="l03761"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#aaa7be32bf8cc53a5cfb20eb89280dd06"> 3761</a></span>&#160;int32 <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#aaa7be32bf8cc53a5cfb20eb89280dd06">ComputationExpander::GetNewMatrixLocationInfo</a>(</div><div class="line"><a name="l03762"></a><span class="lineno"> 3762</span>&#160;    int32 matrix_index, int32 old_row_index)<span class="keyword"> const </span>{</div><div class="line"><a name="l03763"></a><span class="lineno"> 3763</span>&#160;  <span class="comment">// to understand &#39;block_size&#39;, read the comment for FindNStride().</span></div><div class="line"><a name="l03764"></a><span class="lineno"> 3764</span>&#160;  int32 n_stride = n_stride_[matrix_index],</div><div class="line"><a name="l03765"></a><span class="lineno"> 3765</span>&#160;      old_num_n_values = 2, new_num_n_values = num_n_values_,</div><div class="line"><a name="l03766"></a><span class="lineno"> 3766</span>&#160;      old_block_size = old_num_n_values * n_stride,</div><div class="line"><a name="l03767"></a><span class="lineno"> 3767</span>&#160;      new_block_size = new_num_n_values * n_stride,</div><div class="line"><a name="l03768"></a><span class="lineno"> 3768</span>&#160;      block_index = old_row_index / old_block_size,</div><div class="line"><a name="l03769"></a><span class="lineno"> 3769</span>&#160;      offset_within_block = old_row_index % old_block_size;</div><div class="line"><a name="l03770"></a><span class="lineno"> 3770</span>&#160;</div><div class="line"><a name="l03771"></a><span class="lineno"> 3771</span>&#160;  <span class="comment">// within each block, we can show, given our assumptions, that</span></div><div class="line"><a name="l03772"></a><span class="lineno"> 3772</span>&#160;  <span class="comment">// we must first have a sub-block of &#39;n_stride&#39; values all with</span></div><div class="line"><a name="l03773"></a><span class="lineno"> 3773</span>&#160;  <span class="comment">// n == 0, then another sub-clock of &#39;n_stride&#39; values all with</span></div><div class="line"><a name="l03774"></a><span class="lineno"> 3774</span>&#160;  <span class="comment">// n == 1, and so on.  [except there is no &#39;and so on&#39; for the</span></div><div class="line"><a name="l03775"></a><span class="lineno"> 3775</span>&#160;  <span class="comment">// input computation, where we expect the &#39;n&#39; values to be the</span></div><div class="line"><a name="l03776"></a><span class="lineno"> 3776</span>&#160;  <span class="comment">// set {0, 1}.]</span></div><div class="line"><a name="l03777"></a><span class="lineno"> 3777</span>&#160;  int32 old_n_value = offset_within_block / n_stride,</div><div class="line"><a name="l03778"></a><span class="lineno"> 3778</span>&#160;      index_within_subblock = offset_within_block % n_stride;</div><div class="line"><a name="l03779"></a><span class="lineno"> 3779</span>&#160;  <span class="keyword">const</span> std::vector&lt;Cindex&gt; &amp;cindexes =</div><div class="line"><a name="l03780"></a><span class="lineno"> 3780</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[matrix_index].cindexes;</div><div class="line"><a name="l03781"></a><span class="lineno"> 3781</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(old_n_value == cindexes[old_row_index].second.n &amp;&amp;</div><div class="line"><a name="l03782"></a><span class="lineno"> 3782</span>&#160;               (old_n_value == 0 || old_n_value == 1));</div><div class="line"><a name="l03783"></a><span class="lineno"> 3783</span>&#160;  <span class="comment">// Search for CAVEAT in the comment for this function to see what this is</span></div><div class="line"><a name="l03784"></a><span class="lineno"> 3784</span>&#160;  <span class="comment">// about.  Mapping old_n_value == 1 -&gt; new_n_value == new_num_n_values - 1</span></div><div class="line"><a name="l03785"></a><span class="lineno"> 3785</span>&#160;  <span class="comment">// just happens to be useful for the way we use this function... it maps the</span></div><div class="line"><a name="l03786"></a><span class="lineno"> 3786</span>&#160;  <span class="comment">// end of an old submatrix to the end of a new submatrix.</span></div><div class="line"><a name="l03787"></a><span class="lineno"> 3787</span>&#160;  int32 new_n_value = (old_n_value == 0 ? 0 : new_num_n_values - 1);</div><div class="line"><a name="l03788"></a><span class="lineno"> 3788</span>&#160;</div><div class="line"><a name="l03789"></a><span class="lineno"> 3789</span>&#160;  <span class="keywordflow">return</span> block_index * new_block_size + index_within_subblock +</div><div class="line"><a name="l03790"></a><span class="lineno"> 3790</span>&#160;      new_n_value * n_stride;</div><div class="line"><a name="l03791"></a><span class="lineno"> 3791</span>&#160;}</div><div class="line"><a name="l03792"></a><span class="lineno"> 3792</span>&#160;</div><div class="line"><a name="l03793"></a><span class="lineno"> 3793</span>&#160;</div><div class="line"><a name="l03794"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a0d39b8710ac9abb65b0812bc1a82f52e"> 3794</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a0d39b8710ac9abb65b0812bc1a82f52e">ComputationExpander::ExpandIndexes</a>(</div><div class="line"><a name="l03795"></a><span class="lineno"> 3795</span>&#160;    <span class="keyword">const</span> std::vector&lt;Index&gt; &amp;indexes,</div><div class="line"><a name="l03796"></a><span class="lineno"> 3796</span>&#160;    std::vector&lt;Index&gt; *indexes_expanded)<span class="keyword"> const </span>{</div><div class="line"><a name="l03797"></a><span class="lineno"> 3797</span>&#160;  <span class="keywordtype">bool</span> full_check = <span class="keyword">false</span>;</div><div class="line"><a name="l03798"></a><span class="lineno"> 3798</span>&#160;  int32 n_stride = <a class="code" href="namespacekaldi_1_1nnet3.html#a79122735e3f124a6865ff339f40ec191">FindNStride</a>(indexes, full_check);</div><div class="line"><a name="l03799"></a><span class="lineno"> 3799</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(n_stride &gt; 0);</div><div class="line"><a name="l03800"></a><span class="lineno"> 3800</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a4a1bed82d2cb5fbdc695bf32053117ad">ConvertNumNValues</a>(n_stride, 2, num_n_values_,</div><div class="line"><a name="l03801"></a><span class="lineno"> 3801</span>&#160;                    indexes, indexes_expanded);</div><div class="line"><a name="l03802"></a><span class="lineno"> 3802</span>&#160;}</div><div class="line"><a name="l03803"></a><span class="lineno"> 3803</span>&#160;</div><div class="line"><a name="l03804"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#af8007bfceb176a3f8f7f3efb765c9062"> 3804</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#af8007bfceb176a3f8f7f3efb765c9062">ExpandComputation</a>(<span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;nnet,</div><div class="line"><a name="l03805"></a><span class="lineno"> 3805</span>&#160;                       <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1MiscComputationInfo.html">MiscComputationInfo</a> &amp;misc_info,</div><div class="line"><a name="l03806"></a><span class="lineno"> 3806</span>&#160;                       <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> &amp;computation,</div><div class="line"><a name="l03807"></a><span class="lineno"> 3807</span>&#160;                       <span class="keywordtype">bool</span> need_debug_info,</div><div class="line"><a name="l03808"></a><span class="lineno"> 3808</span>&#160;                       int32 num_n_values,</div><div class="line"><a name="l03809"></a><span class="lineno"> 3809</span>&#160;                       <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *expanded_computation) {</div><div class="line"><a name="l03810"></a><span class="lineno"> 3810</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html">ComputationExpander</a> expander(nnet, misc_info, computation,</div><div class="line"><a name="l03811"></a><span class="lineno"> 3811</span>&#160;                               need_debug_info, num_n_values,</div><div class="line"><a name="l03812"></a><span class="lineno"> 3812</span>&#160;                               expanded_computation);</div><div class="line"><a name="l03813"></a><span class="lineno"> 3813</span>&#160;  expander.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a740071247a178d84b8bf2b17901509b4">Expand</a>();</div><div class="line"><a name="l03814"></a><span class="lineno"> 3814</span>&#160;}</div><div class="line"><a name="l03815"></a><span class="lineno"> 3815</span>&#160;</div><div class="line"><a name="l03816"></a><span class="lineno"> 3816</span>&#160;</div><div class="line"><a name="l03817"></a><span class="lineno"> 3817</span>&#160;</div><div class="line"><a name="l03818"></a><span class="lineno"> 3818</span>&#160;<span class="comment">// This helper function is used in RequestIsDecomposable(); you can work out</span></div><div class="line"><a name="l03819"></a><span class="lineno"> 3819</span>&#160;<span class="comment">// what it does, and why, from the documentation of RequestIsDecomposable() in</span></div><div class="line"><a name="l03820"></a><span class="lineno"> 3820</span>&#160;<span class="comment">// the header.  This function does basically the same thing, except</span></div><div class="line"><a name="l03821"></a><span class="lineno"> 3821</span>&#160;<span class="comment">// at a lower level, for an IoSpecification rather than a ComputationRequest.</span></div><div class="line"><a name="l03822"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a4d88467d1a24ad6a2b21d4b8923615ca"> 3822</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a4d88467d1a24ad6a2b21d4b8923615ca">IoSpecificationIsDecomposable</a>(<span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1IoSpecification.html">IoSpecification</a> &amp;io_spec,</div><div class="line"><a name="l03823"></a><span class="lineno"> 3823</span>&#160;                                          <a class="code" href="structkaldi_1_1nnet3_1_1IoSpecification.html">IoSpecification</a> *mini_io_spec,</div><div class="line"><a name="l03824"></a><span class="lineno"> 3824</span>&#160;                                          int32 *num_n_values_out) {</div><div class="line"><a name="l03825"></a><span class="lineno"> 3825</span>&#160;  mini_io_spec-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1IoSpecification.html#a9b45b3e13bd9167aab02e17e08916231">name</a> = io_spec.<a class="code" href="structkaldi_1_1nnet3_1_1IoSpecification.html#a9b45b3e13bd9167aab02e17e08916231">name</a>;</div><div class="line"><a name="l03826"></a><span class="lineno"> 3826</span>&#160;  mini_io_spec-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1IoSpecification.html#a4e836d0aae6b13f7b0c0f4959060f9dd">has_deriv</a> = io_spec.<a class="code" href="structkaldi_1_1nnet3_1_1IoSpecification.html#a4e836d0aae6b13f7b0c0f4959060f9dd">has_deriv</a>;</div><div class="line"><a name="l03827"></a><span class="lineno"> 3827</span>&#160;  <span class="keyword">const</span> std::vector&lt;Index&gt; &amp;indexes = io_spec.<a class="code" href="structkaldi_1_1nnet3_1_1IoSpecification.html#aa3daaa77b972f8dace077e94b418aab1">indexes</a>;</div><div class="line"><a name="l03828"></a><span class="lineno"> 3828</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!indexes.empty() &amp;&amp; <span class="stringliteral">&quot;Empty Indexes in computation request&quot;</span>);</div><div class="line"><a name="l03829"></a><span class="lineno"> 3829</span>&#160;</div><div class="line"><a name="l03830"></a><span class="lineno"> 3830</span>&#160;  <span class="keywordtype">bool</span> full_check = <span class="keyword">true</span>;  <span class="comment">// We might eventually change this to false, for</span></div><div class="line"><a name="l03831"></a><span class="lineno"> 3831</span>&#160;                           <span class="comment">// efficiency.</span></div><div class="line"><a name="l03832"></a><span class="lineno"> 3832</span>&#160;  int32 num_n_values = indexes.back().n + 1;</div><div class="line"><a name="l03833"></a><span class="lineno"> 3833</span>&#160;  <span class="keywordflow">if</span> (num_n_values &lt;= 2) {</div><div class="line"><a name="l03834"></a><span class="lineno"> 3834</span>&#160;    <span class="comment">// Computations with 2 or fewer &#39;n&#39; values are not decomposable, as there</span></div><div class="line"><a name="l03835"></a><span class="lineno"> 3835</span>&#160;    <span class="comment">// would be no speed benefit in shortcut compilation (which relies on</span></div><div class="line"><a name="l03836"></a><span class="lineno"> 3836</span>&#160;    <span class="comment">// compiling an otherwise similar computation with n == 2).</span></div><div class="line"><a name="l03837"></a><span class="lineno"> 3837</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l03838"></a><span class="lineno"> 3838</span>&#160;  }</div><div class="line"><a name="l03839"></a><span class="lineno"> 3839</span>&#160;  *num_n_values_out = num_n_values;</div><div class="line"><a name="l03840"></a><span class="lineno"> 3840</span>&#160;</div><div class="line"><a name="l03841"></a><span class="lineno"> 3841</span>&#160;  int32 n_stride = <a class="code" href="namespacekaldi_1_1nnet3.html#a79122735e3f124a6865ff339f40ec191">FindNStride</a>(indexes, full_check);</div><div class="line"><a name="l03842"></a><span class="lineno"> 3842</span>&#160;</div><div class="line"><a name="l03843"></a><span class="lineno"> 3843</span>&#160;  <span class="keywordflow">if</span> (n_stride == 0)</div><div class="line"><a name="l03844"></a><span class="lineno"> 3844</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l03845"></a><span class="lineno"> 3845</span>&#160;</div><div class="line"><a name="l03846"></a><span class="lineno"> 3846</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a4a1bed82d2cb5fbdc695bf32053117ad">ConvertNumNValues</a>(n_stride, num_n_values, 2,</div><div class="line"><a name="l03847"></a><span class="lineno"> 3847</span>&#160;                    indexes, &amp;(mini_io_spec-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1IoSpecification.html#aa3daaa77b972f8dace077e94b418aab1">indexes</a>));</div><div class="line"><a name="l03848"></a><span class="lineno"> 3848</span>&#160;</div><div class="line"><a name="l03849"></a><span class="lineno"> 3849</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03850"></a><span class="lineno"> 3850</span>&#160;}</div><div class="line"><a name="l03851"></a><span class="lineno"> 3851</span>&#160;</div><div class="line"><a name="l03852"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a54a0b9eb6a79c232605aa83476d44bb0"> 3852</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a54a0b9eb6a79c232605aa83476d44bb0">RequestIsDecomposable</a>(<span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html">ComputationRequest</a> &amp;request,</div><div class="line"><a name="l03853"></a><span class="lineno"> 3853</span>&#160;                           <a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html">ComputationRequest</a> *mini_request,</div><div class="line"><a name="l03854"></a><span class="lineno"> 3854</span>&#160;                           int32 *num_n_values) {</div><div class="line"><a name="l03855"></a><span class="lineno"> 3855</span>&#160;  <span class="keywordtype">size_t</span> num_inputs = request.<a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a56ccdfeff2303e6dee20771d1a4fad78">inputs</a>.size(),</div><div class="line"><a name="l03856"></a><span class="lineno"> 3856</span>&#160;      num_outputs = request.<a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a75f6d03596c9241ae8d5791e6d0d84aa">outputs</a>.size();</div><div class="line"><a name="l03857"></a><span class="lineno"> 3857</span>&#160;  mini_request-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a56ccdfeff2303e6dee20771d1a4fad78">inputs</a>.resize(num_inputs);</div><div class="line"><a name="l03858"></a><span class="lineno"> 3858</span>&#160;  mini_request-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a75f6d03596c9241ae8d5791e6d0d84aa">outputs</a>.resize(num_outputs);</div><div class="line"><a name="l03859"></a><span class="lineno"> 3859</span>&#160;  mini_request-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a58c542fffb7e7f754148c264c90b4a5e">need_model_derivative</a> = request.<a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a58c542fffb7e7f754148c264c90b4a5e">need_model_derivative</a>;</div><div class="line"><a name="l03860"></a><span class="lineno"> 3860</span>&#160;  mini_request-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a5c5011f4cb4b2fc21775a3308c9cecda">store_component_stats</a> = request.<a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a5c5011f4cb4b2fc21775a3308c9cecda">store_component_stats</a>;</div><div class="line"><a name="l03861"></a><span class="lineno"> 3861</span>&#160;  mini_request-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a4b8ac2055ef655ccb4cd6fdbdcabf000">misc_info</a> = request.<a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a4b8ac2055ef655ccb4cd6fdbdcabf000">misc_info</a>;</div><div class="line"><a name="l03862"></a><span class="lineno"> 3862</span>&#160;</div><div class="line"><a name="l03863"></a><span class="lineno"> 3863</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(num_inputs != 0 &amp;&amp; num_outputs != 0);</div><div class="line"><a name="l03864"></a><span class="lineno"> 3864</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; num_inputs; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l03865"></a><span class="lineno"> 3865</span>&#160;    int32 this_num_n_values = 0;</div><div class="line"><a name="l03866"></a><span class="lineno"> 3866</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="namespacekaldi_1_1nnet3.html#a4d88467d1a24ad6a2b21d4b8923615ca">IoSpecificationIsDecomposable</a>(request.<a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a56ccdfeff2303e6dee20771d1a4fad78">inputs</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>],</div><div class="line"><a name="l03867"></a><span class="lineno"> 3867</span>&#160;                                       &amp;(mini_request-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a56ccdfeff2303e6dee20771d1a4fad78">inputs</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>]),</div><div class="line"><a name="l03868"></a><span class="lineno"> 3868</span>&#160;                                       &amp;this_num_n_values))</div><div class="line"><a name="l03869"></a><span class="lineno"> 3869</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l03870"></a><span class="lineno"> 3870</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> == 0) {</div><div class="line"><a name="l03871"></a><span class="lineno"> 3871</span>&#160;      *num_n_values = this_num_n_values;</div><div class="line"><a name="l03872"></a><span class="lineno"> 3872</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03873"></a><span class="lineno"> 3873</span>&#160;      <span class="keywordflow">if</span> (this_num_n_values != *num_n_values)</div><div class="line"><a name="l03874"></a><span class="lineno"> 3874</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// .. which would be odd.</span></div><div class="line"><a name="l03875"></a><span class="lineno"> 3875</span>&#160;    }</div><div class="line"><a name="l03876"></a><span class="lineno"> 3876</span>&#160;  }</div><div class="line"><a name="l03877"></a><span class="lineno"> 3877</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; num_outputs; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l03878"></a><span class="lineno"> 3878</span>&#160;    int32 this_num_n_values = 0;</div><div class="line"><a name="l03879"></a><span class="lineno"> 3879</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="namespacekaldi_1_1nnet3.html#a4d88467d1a24ad6a2b21d4b8923615ca">IoSpecificationIsDecomposable</a>(request.<a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a75f6d03596c9241ae8d5791e6d0d84aa">outputs</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>],</div><div class="line"><a name="l03880"></a><span class="lineno"> 3880</span>&#160;                                       &amp;(mini_request-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a75f6d03596c9241ae8d5791e6d0d84aa">outputs</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>]),</div><div class="line"><a name="l03881"></a><span class="lineno"> 3881</span>&#160;                                       &amp;this_num_n_values))</div><div class="line"><a name="l03882"></a><span class="lineno"> 3882</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l03883"></a><span class="lineno"> 3883</span>&#160;    <span class="keywordflow">if</span> (this_num_n_values != *num_n_values)</div><div class="line"><a name="l03884"></a><span class="lineno"> 3884</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// .. which would be odd.</span></div><div class="line"><a name="l03885"></a><span class="lineno"> 3885</span>&#160;  }</div><div class="line"><a name="l03886"></a><span class="lineno"> 3886</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03887"></a><span class="lineno"> 3887</span>&#160;}</div><div class="line"><a name="l03888"></a><span class="lineno"> 3888</span>&#160;</div><div class="line"><a name="l03889"></a><span class="lineno"> 3889</span>&#160;</div><div class="line"><a name="l03890"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html"> 3890</a></span>&#160;<span class="keyword">class </span><a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html">ComputationLoopedOptimizer</a> {</div><div class="line"><a name="l03891"></a><span class="lineno"> 3891</span>&#160; <span class="keyword">public</span>:</div><div class="line"><a name="l03892"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#ab3fd960e56dece4b5af4efa3fc35d98f"> 3892</a></span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#ab3fd960e56dece4b5af4efa3fc35d98f">ComputationLoopedOptimizer</a>(<span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;nnet,</div><div class="line"><a name="l03893"></a><span class="lineno"> 3893</span>&#160;                             <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation):</div><div class="line"><a name="l03894"></a><span class="lineno"> 3894</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#adbabf05a7702103113a02a113015205f">nnet_</a>(nnet), <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>(computation) { }</div><div class="line"><a name="l03895"></a><span class="lineno"> 3895</span>&#160;  <span class="keywordtype">bool</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a602819d33d3a59c128aa4e865e610e14">Optimize</a>();</div><div class="line"><a name="l03896"></a><span class="lineno"> 3896</span>&#160;</div><div class="line"><a name="l03897"></a><span class="lineno"> 3897</span>&#160; <span class="keyword">private</span>:</div><div class="line"><a name="l03898"></a><span class="lineno"> 3898</span>&#160;</div><div class="line"><a name="l03899"></a><span class="lineno"> 3899</span>&#160;  <span class="comment">// Figures out the time shift between the successive computation requests.</span></div><div class="line"><a name="l03900"></a><span class="lineno"> 3900</span>&#160;  <span class="keyword">static</span> int32 FindTimeShift(<span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> &amp;computation);</div><div class="line"><a name="l03901"></a><span class="lineno"> 3901</span>&#160;</div><div class="line"><a name="l03902"></a><span class="lineno"> 3902</span>&#160;  <span class="comment">// This function creates a mapping from a matrix-index &gt; 0,</span></div><div class="line"><a name="l03903"></a><span class="lineno"> 3903</span>&#160;  <span class="comment">// to a pair (unique_id, time_offset) that represents the debug-info</span></div><div class="line"><a name="l03904"></a><span class="lineno"> 3904</span>&#160;  <span class="comment">// for that matrix-id in computation.debug_info (these terms are explained</span></div><div class="line"><a name="l03905"></a><span class="lineno"> 3905</span>&#160;  <span class="comment">// below).</span></div><div class="line"><a name="l03906"></a><span class="lineno"> 3906</span>&#160;  <span class="comment">//</span></div><div class="line"><a name="l03907"></a><span class="lineno"> 3907</span>&#160;  <span class="comment">// The output vector &#39;matrix_to_pair&#39; is indexed by the matrix-index in the</span></div><div class="line"><a name="l03908"></a><span class="lineno"> 3908</span>&#160;  <span class="comment">// computation (the zeroth member is not valid).</span></div><div class="line"><a name="l03909"></a><span class="lineno"> 3909</span>&#160;  <span class="comment">//</span></div><div class="line"><a name="l03910"></a><span class="lineno"> 3910</span>&#160;  <span class="comment">// The &#39;time_offset&#39; is equal to the &#39;t&#39; value of the first member of the</span></div><div class="line"><a name="l03911"></a><span class="lineno"> 3911</span>&#160;  <span class="comment">// cindexes vector for with t != kNoTime.  The &#39;unique_id&#39; is an integer that</span></div><div class="line"><a name="l03912"></a><span class="lineno"> 3912</span>&#160;  <span class="comment">// uniquely identifies what we get from subtracting the &#39;time_offset&#39; from</span></div><div class="line"><a name="l03913"></a><span class="lineno"> 3913</span>&#160;  <span class="comment">// each &#39;t&#39; value of that &#39;cindexes&#39; vector for which t != kNoTime, and then</span></div><div class="line"><a name="l03914"></a><span class="lineno"> 3914</span>&#160;  <span class="comment">// pairing it up with the &#39;is_deriv&#39; value of the DebugInfo.  That is, if two</span></div><div class="line"><a name="l03915"></a><span class="lineno"> 3915</span>&#160;  <span class="comment">// &#39;cindexes&#39; vectors differ only by a time offset, and the &#39;is_deriv&#39; values</span></div><div class="line"><a name="l03916"></a><span class="lineno"> 3916</span>&#160;  <span class="comment">// are the same they will map to the same unique_id.</span></div><div class="line"><a name="l03917"></a><span class="lineno"> 3917</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> CreateMatrixPairs(<span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> &amp;computation,</div><div class="line"><a name="l03918"></a><span class="lineno"> 3918</span>&#160;                                std::vector&lt;std::pair&lt;int32, int32&gt; &gt; *matrix_to_pair);</div><div class="line"><a name="l03919"></a><span class="lineno"> 3919</span>&#160;</div><div class="line"><a name="l03920"></a><span class="lineno"> 3920</span>&#160;  <span class="comment">// This helper function, used in CreateMatrixPairs, find the value &#39;t&#39; which</span></div><div class="line"><a name="l03921"></a><span class="lineno"> 3921</span>&#160;  <span class="comment">// is the first (*cindexes)[i].second.t that is not kNoTime; it then subtracts</span></div><div class="line"><a name="l03922"></a><span class="lineno"> 3922</span>&#160;  <span class="comment">// that &#39;t&#39; value from all (*cindexes)[i].second.t that are not kNoTime.  If</span></div><div class="line"><a name="l03923"></a><span class="lineno"> 3923</span>&#160;  <span class="comment">// all the &#39;t&#39; values are kNoTime, which we don&#39;t expect to happen, we throw</span></div><div class="line"><a name="l03924"></a><span class="lineno"> 3924</span>&#160;  <span class="comment">// an error.</span></div><div class="line"><a name="l03925"></a><span class="lineno"> 3925</span>&#160;  <span class="keyword">static</span> <span class="keyword">inline</span> int32 NormalizeCindexes(std::vector&lt;Cindex&gt; *cindexes);</div><div class="line"><a name="l03926"></a><span class="lineno"> 3926</span>&#160;</div><div class="line"><a name="l03927"></a><span class="lineno"> 3927</span>&#160;</div><div class="line"><a name="l03928"></a><span class="lineno"> 3928</span>&#160;  <span class="comment">// This very simple helper function reverses the map &#39;matrix_to_pair&#39; so we can</span></div><div class="line"><a name="l03929"></a><span class="lineno"> 3929</span>&#160;  <span class="comment">// do the reverse lookup.  It outputs a map from pair to matrix index m, where</span></div><div class="line"><a name="l03930"></a><span class="lineno"> 3930</span>&#160;  <span class="comment">// 1 &lt;= m &lt; matrix_to_pair.size().</span></div><div class="line"><a name="l03931"></a><span class="lineno"> 3931</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> GetPairToMatrixMap(</div><div class="line"><a name="l03932"></a><span class="lineno"> 3932</span>&#160;      std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;matrix_to_pair,</div><div class="line"><a name="l03933"></a><span class="lineno"> 3933</span>&#160;      unordered_map&lt;std::pair&lt;int32, int32&gt;, int32, <a class="code" href="structkaldi_1_1PairHasher.html">PairHasher&lt;int32&gt;</a> &gt; *pair_to_matrix);</div><div class="line"><a name="l03934"></a><span class="lineno"> 3934</span>&#160;</div><div class="line"><a name="l03935"></a><span class="lineno"> 3935</span>&#160;</div><div class="line"><a name="l03936"></a><span class="lineno"> 3936</span>&#160;  <span class="comment">// Given a vector of lists, one list for each segment, of the active matrices</span></div><div class="line"><a name="l03937"></a><span class="lineno"> 3937</span>&#160;  <span class="comment">// at the end of that segment, this function converts those lists into a</span></div><div class="line"><a name="l03938"></a><span class="lineno"> 3938</span>&#160;  <span class="comment">// different representation where each matrix is represented as a pair instead</span></div><div class="line"><a name="l03939"></a><span class="lineno"> 3939</span>&#160;  <span class="comment">// of as a single int32.  &#39;active_pairs&#39; will have the same dimensions as</span></div><div class="line"><a name="l03940"></a><span class="lineno"> 3940</span>&#160;  <span class="comment">// &#39;active_matrices&#39;.</span></div><div class="line"><a name="l03941"></a><span class="lineno"> 3941</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> ConvertListsToPairLists(</div><div class="line"><a name="l03942"></a><span class="lineno"> 3942</span>&#160;      <span class="keyword">const</span> std::vector&lt;std::vector&lt;int32&gt; &gt; &amp;active_matrices,</div><div class="line"><a name="l03943"></a><span class="lineno"> 3943</span>&#160;      <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;matrix_to_pair,</div><div class="line"><a name="l03944"></a><span class="lineno"> 3944</span>&#160;      std::vector&lt;std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &gt; *active_pairs);</div><div class="line"><a name="l03945"></a><span class="lineno"> 3945</span>&#160;</div><div class="line"><a name="l03946"></a><span class="lineno"> 3946</span>&#160;  <span class="comment">// This function, used in FindFirstRepeat, tells us whether the two lists a</span></div><div class="line"><a name="l03947"></a><span class="lineno"> 3947</span>&#160;  <span class="comment">// and b are the same except for a possible time-shift.</span></div><div class="line"><a name="l03948"></a><span class="lineno"> 3948</span>&#160;  <span class="comment">// Each element of a or b is of the form (matrix-unique-index, time-offset).</span></div><div class="line"><a name="l03949"></a><span class="lineno"> 3949</span>&#160;  <span class="comment">// Let&#39;s suppose we have two pairs p1=(m1, o1) and p2=(m2, o2).</span></div><div class="line"><a name="l03950"></a><span class="lineno"> 3950</span>&#160;  <span class="comment">// For p2 to be equal to p1 except for a possible shift of value &#39;shift&#39;, we</span></div><div class="line"><a name="l03951"></a><span class="lineno"> 3951</span>&#160;  <span class="comment">// require m2 == m1 and either o2 == o1 + &#39;shift&#39; or o2 == o1.</span></div><div class="line"><a name="l03952"></a><span class="lineno"> 3952</span>&#160;  <span class="comment">// This function returns true if a.size() == b.size() and for each</span></div><div class="line"><a name="l03953"></a><span class="lineno"> 3953</span>&#160;  <span class="comment">// i, b[i].first == a[i].first and b[i].second is either</span></div><div class="line"><a name="l03954"></a><span class="lineno"> 3954</span>&#160;  <span class="comment">// a[i].second or a[i].second + shift.</span></div><div class="line"><a name="l03955"></a><span class="lineno"> 3955</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">bool</span> ListsAreEqualExceptForPossibleShift(</div><div class="line"><a name="l03956"></a><span class="lineno"> 3956</span>&#160;      <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;a,</div><div class="line"><a name="l03957"></a><span class="lineno"> 3957</span>&#160;      <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;b,</div><div class="line"><a name="l03958"></a><span class="lineno"> 3958</span>&#160;      int32 shift);</div><div class="line"><a name="l03959"></a><span class="lineno"> 3959</span>&#160;</div><div class="line"><a name="l03960"></a><span class="lineno"> 3960</span>&#160;  <span class="comment">// This function looks in the matrix &#39;active_pairs&#39; for the first pair of</span></div><div class="line"><a name="l03961"></a><span class="lineno"> 3961</span>&#160;  <span class="comment">// identical values, i.e. it is looking for i &lt; j for which</span></div><div class="line"><a name="l03962"></a><span class="lineno"> 3962</span>&#160;  <span class="comment">// normalized_active_pairs[i] == normalized_active_pairs[j].  (However, the</span></div><div class="line"><a name="l03963"></a><span class="lineno"> 3963</span>&#160;  <span class="comment">// pair i,j must satisfy an extra condition, see below).  If a pair</span></div><div class="line"><a name="l03964"></a><span class="lineno"> 3964</span>&#160;  <span class="comment">// i,j exists satisfying these conditions, this function outputs them to *seg1</span></div><div class="line"><a name="l03965"></a><span class="lineno"> 3965</span>&#160;  <span class="comment">// and *seg2, and returns true; otherwise it returns false.</span></div><div class="line"><a name="l03966"></a><span class="lineno"> 3966</span>&#160;  <span class="comment">//</span></div><div class="line"><a name="l03967"></a><span class="lineno"> 3967</span>&#160;  <span class="comment">// Extra condition:</span></div><div class="line"><a name="l03968"></a><span class="lineno"> 3968</span>&#160;  <span class="comment">// It turns out that under some circumstances, we can</span></div><div class="line"><a name="l03969"></a><span class="lineno"> 3969</span>&#160;  <span class="comment">// fine repeats that were not &quot;really&quot; repeats (the matrices were not time</span></div><div class="line"><a name="l03970"></a><span class="lineno"> 3970</span>&#160;  <span class="comment">// shifted) The situation was a bit obscure (it was a non-recurrent setup with</span></div><div class="line"><a name="l03971"></a><span class="lineno"> 3971</span>&#160;  <span class="comment">// a lot of extra-right-context, where some inputs were never used), but to</span></div><div class="line"><a name="l03972"></a><span class="lineno"> 3972</span>&#160;  <span class="comment">// prevent it happening again we are now checking in addition to the above,</span></div><div class="line"><a name="l03973"></a><span class="lineno"> 3973</span>&#160;  <span class="comment">// that the time-shift between the segments (i.e. time_offsets[j] -</span></div><div class="line"><a name="l03974"></a><span class="lineno"> 3974</span>&#160;  <span class="comment">// time_offsets[i]), has the &quot;expected value&quot; based on the assumption that</span></div><div class="line"><a name="l03975"></a><span class="lineno"> 3975</span>&#160;  <span class="comment">// each segment should be shifted relative to the previous segment, by</span></div><div class="line"><a name="l03976"></a><span class="lineno"> 3976</span>&#160;  <span class="comment">// &#39;time_shift_per_segment&#39;.</span></div><div class="line"><a name="l03977"></a><span class="lineno"> 3977</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">bool</span> FindFirstRepeat(</div><div class="line"><a name="l03978"></a><span class="lineno"> 3978</span>&#160;      <span class="keyword">const</span> std::vector&lt;std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &gt; &amp;active_pairs,</div><div class="line"><a name="l03979"></a><span class="lineno"> 3979</span>&#160;      int32 time_shift_per_segment,</div><div class="line"><a name="l03980"></a><span class="lineno"> 3980</span>&#160;      int32 *seg1, int32 *seg2);</div><div class="line"><a name="l03981"></a><span class="lineno"> 3981</span>&#160;</div><div class="line"><a name="l03982"></a><span class="lineno"> 3982</span>&#160;</div><div class="line"><a name="l03983"></a><span class="lineno"> 3983</span>&#160;  <span class="comment">// &#39;pair_list1&#39; is the list of active (unique-id, time-offset) pairs for one</span></div><div class="line"><a name="l03984"></a><span class="lineno"> 3984</span>&#160;  <span class="comment">// segment of the computation and &#39;pair_list2&#39; is the same list for a later</span></div><div class="line"><a name="l03985"></a><span class="lineno"> 3985</span>&#160;  <span class="comment">// segment.  The map &#39;pair_to_matrix&#39; can convert these back into matrix</span></div><div class="line"><a name="l03986"></a><span class="lineno"> 3986</span>&#160;  <span class="comment">// indexes.  This function will output two lists of matrices.  These will just</span></div><div class="line"><a name="l03987"></a><span class="lineno"> 3987</span>&#160;  <span class="comment">// be &#39;pair_list1&#39; and &#39;pair_list2&#39; converted back into matrix indexes,</span></div><div class="line"><a name="l03988"></a><span class="lineno"> 3988</span>&#160;  <span class="comment">// except we omit pairs which are identical (i.e. the time-offset was zero).</span></div><div class="line"><a name="l03989"></a><span class="lineno"> 3989</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> GetIdentifiedMatrices(</div><div class="line"><a name="l03990"></a><span class="lineno"> 3990</span>&#160;      <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;pair_list1,</div><div class="line"><a name="l03991"></a><span class="lineno"> 3991</span>&#160;      <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;pair_list2,</div><div class="line"><a name="l03992"></a><span class="lineno"> 3992</span>&#160;      <span class="keyword">const</span> unordered_map&lt;std::pair&lt;int32, int32&gt;, int32, <a class="code" href="structkaldi_1_1PairHasher.html">PairHasher&lt;int32&gt;</a> &gt; &amp;pair_to_matrix,</div><div class="line"><a name="l03993"></a><span class="lineno"> 3993</span>&#160;      std::vector&lt;int32&gt; *matrix_list1,</div><div class="line"><a name="l03994"></a><span class="lineno"> 3994</span>&#160;      std::vector&lt;int32&gt; *matrix_list2);</div><div class="line"><a name="l03995"></a><span class="lineno"> 3995</span>&#160;</div><div class="line"><a name="l03996"></a><span class="lineno"> 3996</span>&#160;</div><div class="line"><a name="l03997"></a><span class="lineno"> 3997</span>&#160;  <span class="comment">// This function just does some checking (via asserts), that</span></div><div class="line"><a name="l03998"></a><span class="lineno"> 3998</span>&#160;  <span class="comment">// the lists of matrices &#39;list1&#39; and &#39;list2&#39; are of the same length,</span></div><div class="line"><a name="l03999"></a><span class="lineno"> 3999</span>&#160;  <span class="comment">// that time_difference &gt; 0, that each matrix with index m = list2[i] is of the</span></div><div class="line"><a name="l04000"></a><span class="lineno"> 4000</span>&#160;  <span class="comment">// same dimension as the list1[i], with Cindexes that are the same except for</span></div><div class="line"><a name="l04001"></a><span class="lineno"> 4001</span>&#160;  <span class="comment">// the time index being greater by &#39;time_difference&#39;</span></div><div class="line"><a name="l04002"></a><span class="lineno"> 4002</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> CheckIdentifiedMatrices(</div><div class="line"><a name="l04003"></a><span class="lineno"> 4003</span>&#160;      <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> &amp;computation,</div><div class="line"><a name="l04004"></a><span class="lineno"> 4004</span>&#160;      <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;list1,</div><div class="line"><a name="l04005"></a><span class="lineno"> 4005</span>&#160;      <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;list2,</div><div class="line"><a name="l04006"></a><span class="lineno"> 4006</span>&#160;      int32 time_difference);</div><div class="line"><a name="l04007"></a><span class="lineno"> 4007</span>&#160;</div><div class="line"><a name="l04008"></a><span class="lineno"> 4008</span>&#160;</div><div class="line"><a name="l04009"></a><span class="lineno"> 4009</span>&#160;  <span class="comment">// Given two command indexes command1 &lt; command2 pointing to commands of type</span></div><div class="line"><a name="l04010"></a><span class="lineno"> 4010</span>&#160;  <span class="comment">// kNoOperationMarker, this function modifies the computation by</span></div><div class="line"><a name="l04011"></a><span class="lineno"> 4011</span>&#160;  <span class="comment">// removing all commands after command2, replacing command2 with a kGotoLabel</span></div><div class="line"><a name="l04012"></a><span class="lineno"> 4012</span>&#160;  <span class="comment">// command pointing to command1  and then inserting just before command1</span></div><div class="line"><a name="l04013"></a><span class="lineno"> 4013</span>&#160;  <span class="comment">// a marker of type kNoOperationLabel.</span></div><div class="line"><a name="l04014"></a><span class="lineno"> 4014</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> FormInfiniteLoop(int32 command1, int32 command2,</div><div class="line"><a name="l04015"></a><span class="lineno"> 4015</span>&#160;                               <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation);</div><div class="line"><a name="l04016"></a><span class="lineno"> 4016</span>&#160;</div><div class="line"><a name="l04017"></a><span class="lineno"> 4017</span>&#160;  <span class="comment">// This is to be called after FormInfiniteLoop.  It inserts, just before</span></div><div class="line"><a name="l04018"></a><span class="lineno"> 4018</span>&#160;  <span class="comment">// the final kGotoLabel command, commands that initialize</span></div><div class="line"><a name="l04019"></a><span class="lineno"> 4019</span>&#160;  <span class="comment">// each of the matrices in list &#39;matrices1&#39; from the corresponding</span></div><div class="line"><a name="l04020"></a><span class="lineno"> 4020</span>&#160;  <span class="comment">// matrix in &#39;matrices2&#39;, using the kAllocMatrixFromOther command.</span></div><div class="line"><a name="l04021"></a><span class="lineno"> 4021</span>&#160;  <span class="comment">// This effectively does, for example, matrices1[i] = matrices2[i],</span></div><div class="line"><a name="l04022"></a><span class="lineno"> 4022</span>&#160;  <span class="comment">// and it&#39;s implemented as a shallow swap.</span></div><div class="line"><a name="l04023"></a><span class="lineno"> 4023</span>&#160;  <span class="comment">// It does this in such an order that even if the two lists are</span></div><div class="line"><a name="l04024"></a><span class="lineno"> 4024</span>&#160;  <span class="comment">// not disjoint, the right thing happens.</span></div><div class="line"><a name="l04025"></a><span class="lineno"> 4025</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> AddMatrixSwapCommands(</div><div class="line"><a name="l04026"></a><span class="lineno"> 4026</span>&#160;      <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;matrices1,</div><div class="line"><a name="l04027"></a><span class="lineno"> 4027</span>&#160;      <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;matrices2,</div><div class="line"><a name="l04028"></a><span class="lineno"> 4028</span>&#160;      <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation);</div><div class="line"><a name="l04029"></a><span class="lineno"> 4029</span>&#160;</div><div class="line"><a name="l04030"></a><span class="lineno"> 4030</span>&#160;</div><div class="line"><a name="l04031"></a><span class="lineno"> 4031</span>&#160;  <span class="comment">// Called from AddMatrixSwapCommands, this function figures out for us</span></div><div class="line"><a name="l04032"></a><span class="lineno"> 4032</span>&#160;  <span class="comment">// an acceptable order in which to execute the kAllocMatrixFromOther</span></div><div class="line"><a name="l04033"></a><span class="lineno"> 4033</span>&#160;  <span class="comment">// commands.  This is easy to do if matrices1 and matrices2 are disjoint</span></div><div class="line"><a name="l04034"></a><span class="lineno"> 4034</span>&#160;  <span class="comment">// sets, but has to be done more carefully if they overlap.</span></div><div class="line"><a name="l04035"></a><span class="lineno"> 4035</span>&#160;  <span class="comment">// The output is a list of pairs where each pair (a, b) comes from</span></div><div class="line"><a name="l04036"></a><span class="lineno"> 4036</span>&#160;  <span class="comment">// from matrices1 and matrices2 in the same position, i.e.</span></div><div class="line"><a name="l04037"></a><span class="lineno"> 4037</span>&#160;  <span class="comment">// a = matrices1[i] and b = matrices2[i].</span></div><div class="line"><a name="l04038"></a><span class="lineno"> 4038</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> GetMatrixSwapOrder(</div><div class="line"><a name="l04039"></a><span class="lineno"> 4039</span>&#160;      <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;matrices1,</div><div class="line"><a name="l04040"></a><span class="lineno"> 4040</span>&#160;      <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;matrices2,</div><div class="line"><a name="l04041"></a><span class="lineno"> 4041</span>&#160;      std::vector&lt;std::pair&lt;int32, int32&gt; &gt; *swaps);</div><div class="line"><a name="l04042"></a><span class="lineno"> 4042</span>&#160;</div><div class="line"><a name="l04043"></a><span class="lineno"> 4043</span>&#160;</div><div class="line"><a name="l04044"></a><span class="lineno"> 4044</span>&#160;</div><div class="line"><a name="l04055"></a><span class="lineno"> 4055</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">void</span> FindActiveMatrices(<span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> &amp;computation,</div><div class="line"><a name="l04056"></a><span class="lineno"> 4056</span>&#160;                                 <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html">Analyzer</a> &amp;analyzer,</div><div class="line"><a name="l04057"></a><span class="lineno"> 4057</span>&#160;                                 <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;splice_point_commands,</div><div class="line"><a name="l04058"></a><span class="lineno"> 4058</span>&#160;                                 std::vector&lt;std::vector&lt;int32&gt; &gt; *active_matrices);</div><div class="line"><a name="l04059"></a><span class="lineno"> 4059</span>&#160;</div><div class="line"><a name="l04060"></a><span class="lineno"> 4060</span>&#160;</div><div class="line"><a name="l04061"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#adbabf05a7702103113a02a113015205f"> 4061</a></span>&#160;  <span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;<a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#adbabf05a7702103113a02a113015205f">nnet_</a>;</div><div class="line"><a name="l04062"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a36d13565d1302a2bf74127b141ba3537"> 4062</a></span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *<a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>;</div><div class="line"><a name="l04063"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#ac8ca96df1ecdb635738c59a88cff8835"> 4063</a></span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html">Analyzer</a> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#ac8ca96df1ecdb635738c59a88cff8835">analyzer_</a>;</div><div class="line"><a name="l04064"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#ac0eab3be8e97f0ed110d0998bc2bc0a1"> 4064</a></span>&#160;  std::vector&lt;std::pair&lt;int32, int32&gt; &gt; <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#ac0eab3be8e97f0ed110d0998bc2bc0a1">matrix_to_pair_</a>;</div><div class="line"><a name="l04065"></a><span class="lineno"> 4065</span>&#160;</div><div class="line"><a name="l04066"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#af8364fb4b69f001a20545ea5b1a2c65f"> 4066</a></span>&#160;  std::vector&lt;int32&gt; <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#af8364fb4b69f001a20545ea5b1a2c65f">splice_point_commands_</a>;</div><div class="line"><a name="l04067"></a><span class="lineno"> 4067</span>&#160;};</div><div class="line"><a name="l04068"></a><span class="lineno"> 4068</span>&#160;</div><div class="line"><a name="l04069"></a><span class="lineno"> 4069</span>&#160;<span class="comment">// static</span></div><div class="line"><a name="l04070"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a40b93bc9e9fe7dccea10334ecf8edf2a"> 4070</a></span>&#160;int32 <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a40b93bc9e9fe7dccea10334ecf8edf2a">ComputationLoopedOptimizer::FindTimeShift</a>(</div><div class="line"><a name="l04071"></a><span class="lineno"> 4071</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> &amp;computation) {</div><div class="line"><a name="l04072"></a><span class="lineno"> 4072</span>&#160;  std::vector&lt;int32&gt; segment_ends;</div><div class="line"><a name="l04073"></a><span class="lineno"> 4073</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a0a04e946fa68432f4e723944ce8ab281">GetCommandsOfType</a>(computation, <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352af67517e882c1aebe145a016945b9e6a4">kNoOperationMarker</a>, &amp;segment_ends);</div><div class="line"><a name="l04074"></a><span class="lineno"> 4074</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(segment_ends.size() &gt;= 3);</div><div class="line"><a name="l04075"></a><span class="lineno"> 4075</span>&#160;  <span class="comment">// Ignore the first segment as it tends to be a special case</span></div><div class="line"><a name="l04076"></a><span class="lineno"> 4076</span>&#160;  <span class="comment">// (it has more left context),</span></div><div class="line"><a name="l04077"></a><span class="lineno"> 4077</span>&#160;  int32 second_segment_begin = segment_ends[0],</div><div class="line"><a name="l04078"></a><span class="lineno"> 4078</span>&#160;      third_segment_begin = segment_ends[1],</div><div class="line"><a name="l04079"></a><span class="lineno"> 4079</span>&#160;      fourth_segment_begin = segment_ends[2];</div><div class="line"><a name="l04080"></a><span class="lineno"> 4080</span>&#160;  int32 first_output_command_seg2 = -1,</div><div class="line"><a name="l04081"></a><span class="lineno"> 4081</span>&#160;      first_output_command_seg3 = -1;</div><div class="line"><a name="l04082"></a><span class="lineno"> 4082</span>&#160;  <span class="keywordflow">for</span> (int32 c = second_segment_begin; c &lt; third_segment_begin; c++)</div><div class="line"><a name="l04083"></a><span class="lineno"> 4083</span>&#160;    <span class="keywordflow">if</span> (computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[c].command_type == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352aaa3fd92744438323baec475cee5b9b3d">kProvideOutput</a> &amp;&amp;</div><div class="line"><a name="l04084"></a><span class="lineno"> 4084</span>&#160;        first_output_command_seg2 &lt; 0)</div><div class="line"><a name="l04085"></a><span class="lineno"> 4085</span>&#160;      first_output_command_seg2 = c;</div><div class="line"><a name="l04086"></a><span class="lineno"> 4086</span>&#160;  <span class="keywordflow">for</span> (int32 c = third_segment_begin; c &lt; fourth_segment_begin; c++)</div><div class="line"><a name="l04087"></a><span class="lineno"> 4087</span>&#160;    <span class="keywordflow">if</span> (computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[c].command_type == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352aaa3fd92744438323baec475cee5b9b3d">kProvideOutput</a> &amp;&amp;</div><div class="line"><a name="l04088"></a><span class="lineno"> 4088</span>&#160;        first_output_command_seg3 &lt; 0)</div><div class="line"><a name="l04089"></a><span class="lineno"> 4089</span>&#160;      first_output_command_seg3 = c;</div><div class="line"><a name="l04090"></a><span class="lineno"> 4090</span>&#160;  <span class="keywordflow">if</span> (first_output_command_seg2 &lt; 0 ||</div><div class="line"><a name="l04091"></a><span class="lineno"> 4091</span>&#160;      first_output_command_seg3 &lt; 0)</div><div class="line"><a name="l04092"></a><span class="lineno"> 4092</span>&#160;    <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Could not locate output commands for segments 2 and 3.&quot;</span>;</div><div class="line"><a name="l04093"></a><span class="lineno"> 4093</span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a></div><div class="line"><a name="l04094"></a><span class="lineno"> 4094</span>&#160;      &amp;command2 = computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[first_output_command_seg2],</div><div class="line"><a name="l04095"></a><span class="lineno"> 4095</span>&#160;      &amp;command3 = computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[first_output_command_seg3];</div><div class="line"><a name="l04096"></a><span class="lineno"> 4096</span>&#160;  int32 seg2_node = command2.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">arg2</a>, seg3_node = command3.arg2;</div><div class="line"><a name="l04097"></a><span class="lineno"> 4097</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(seg2_node == seg3_node);</div><div class="line"><a name="l04098"></a><span class="lineno"> 4098</span>&#160;  int32 seg2_submatrix = command2.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>,</div><div class="line"><a name="l04099"></a><span class="lineno"> 4099</span>&#160;      seg3_submatrix = command3.arg1;</div><div class="line"><a name="l04100"></a><span class="lineno"> 4100</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab4efec36ef0d5bab190891c36bd9b2e3">IsWholeMatrix</a>(seg2_submatrix) &amp;&amp;</div><div class="line"><a name="l04101"></a><span class="lineno"> 4101</span>&#160;               computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab4efec36ef0d5bab190891c36bd9b2e3">IsWholeMatrix</a>(seg3_submatrix));</div><div class="line"><a name="l04102"></a><span class="lineno"> 4102</span>&#160;  int32 seg2_matrix = computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[seg2_submatrix].matrix_index,</div><div class="line"><a name="l04103"></a><span class="lineno"> 4103</span>&#160;      seg3_matrix = computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">submatrices</a>[seg3_submatrix].matrix_index;</div><div class="line"><a name="l04104"></a><span class="lineno"> 4104</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[seg2_matrix].num_rows ==</div><div class="line"><a name="l04105"></a><span class="lineno"> 4105</span>&#160;               computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[seg3_matrix].num_rows);</div><div class="line"><a name="l04106"></a><span class="lineno"> 4106</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.empty());</div><div class="line"><a name="l04107"></a><span class="lineno"> 4107</span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a></div><div class="line"><a name="l04108"></a><span class="lineno"> 4108</span>&#160;      &amp;debug_info2 = computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[seg2_matrix],</div><div class="line"><a name="l04109"></a><span class="lineno"> 4109</span>&#160;      &amp;debug_info3 = computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[seg3_matrix];</div><div class="line"><a name="l04110"></a><span class="lineno"> 4110</span>&#160;  int32 t_offset = debug_info3.cindexes[0].second.t -</div><div class="line"><a name="l04111"></a><span class="lineno"> 4111</span>&#160;      debug_info2.cindexes[0].second.t;</div><div class="line"><a name="l04112"></a><span class="lineno"> 4112</span>&#160;  int32 num_rows = debug_info2.cindexes.size();</div><div class="line"><a name="l04113"></a><span class="lineno"> 4113</span>&#160;  <span class="keywordflow">for</span> (int32 r = 0; r &lt; num_rows; r++) {</div><div class="line"><a name="l04114"></a><span class="lineno"> 4114</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(debug_info3.cindexes[r].second.t ==</div><div class="line"><a name="l04115"></a><span class="lineno"> 4115</span>&#160;                 debug_info2.cindexes[r].second.t + t_offset);</div><div class="line"><a name="l04116"></a><span class="lineno"> 4116</span>&#160;  }</div><div class="line"><a name="l04117"></a><span class="lineno"> 4117</span>&#160;  <span class="keywordflow">return</span> t_offset;</div><div class="line"><a name="l04118"></a><span class="lineno"> 4118</span>&#160;}</div><div class="line"><a name="l04119"></a><span class="lineno"> 4119</span>&#160;</div><div class="line"><a name="l04120"></a><span class="lineno"> 4120</span>&#160;<span class="comment">// static inline</span></div><div class="line"><a name="l04121"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a75060dc1f93ff9085cc6a6f0bf2d2f30"> 4121</a></span>&#160;int32 <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a75060dc1f93ff9085cc6a6f0bf2d2f30">ComputationLoopedOptimizer::NormalizeCindexes</a>(</div><div class="line"><a name="l04122"></a><span class="lineno"> 4122</span>&#160;    std::vector&lt;Cindex&gt; *cindexes) {</div><div class="line"><a name="l04123"></a><span class="lineno"> 4123</span>&#160;  std::vector&lt;Cindex&gt;::iterator iter = cindexes-&gt;begin(),</div><div class="line"><a name="l04124"></a><span class="lineno"> 4124</span>&#160;      end = cindexes-&gt;end();</div><div class="line"><a name="l04125"></a><span class="lineno"> 4125</span>&#160;  int32 ans;</div><div class="line"><a name="l04126"></a><span class="lineno"> 4126</span>&#160;  <span class="keywordflow">for</span> (; iter != end; iter++) {</div><div class="line"><a name="l04127"></a><span class="lineno"> 4127</span>&#160;    <span class="keywordflow">if</span> (iter-&gt;second.t != <a class="code" href="namespacekaldi_1_1nnet3.html#ac952f0840a7950dff80c1a89e69656d7">kNoTime</a>) {</div><div class="line"><a name="l04128"></a><span class="lineno"> 4128</span>&#160;      ans = iter-&gt;second.t;</div><div class="line"><a name="l04129"></a><span class="lineno"> 4129</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l04130"></a><span class="lineno"> 4130</span>&#160;    }</div><div class="line"><a name="l04131"></a><span class="lineno"> 4131</span>&#160;  }</div><div class="line"><a name="l04132"></a><span class="lineno"> 4132</span>&#160;  <span class="keywordflow">if</span> (iter == end) {</div><div class="line"><a name="l04133"></a><span class="lineno"> 4133</span>&#160;    <span class="comment">// this should not happen.</span></div><div class="line"><a name="l04134"></a><span class="lineno"> 4134</span>&#160;    <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;All t values are kNoTime in matrix.&quot;</span>;</div><div class="line"><a name="l04135"></a><span class="lineno"> 4135</span>&#160;  }</div><div class="line"><a name="l04136"></a><span class="lineno"> 4136</span>&#160;  iter = cindexes-&gt;begin();</div><div class="line"><a name="l04137"></a><span class="lineno"> 4137</span>&#160;  <span class="keywordflow">for</span> (; iter != end; iter++)</div><div class="line"><a name="l04138"></a><span class="lineno"> 4138</span>&#160;    <span class="keywordflow">if</span> (iter-&gt;second.t != <a class="code" href="namespacekaldi_1_1nnet3.html#ac952f0840a7950dff80c1a89e69656d7">kNoTime</a>)</div><div class="line"><a name="l04139"></a><span class="lineno"> 4139</span>&#160;      iter-&gt;second.t -= ans;</div><div class="line"><a name="l04140"></a><span class="lineno"> 4140</span>&#160;  <span class="keywordflow">return</span> ans;</div><div class="line"><a name="l04141"></a><span class="lineno"> 4141</span>&#160;}</div><div class="line"><a name="l04142"></a><span class="lineno"> 4142</span>&#160;</div><div class="line"><a name="l04143"></a><span class="lineno"> 4143</span>&#160;<span class="comment">// static</span></div><div class="line"><a name="l04144"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#afffba6e2f4c37c755f2ab63893d2d8b9"> 4144</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#afffba6e2f4c37c755f2ab63893d2d8b9">ComputationLoopedOptimizer::CreateMatrixPairs</a>(</div><div class="line"><a name="l04145"></a><span class="lineno"> 4145</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> &amp;computation,</div><div class="line"><a name="l04146"></a><span class="lineno"> 4146</span>&#160;    std::vector&lt;std::pair&lt;int32, int32&gt; &gt; *matrix_to_pair) {</div><div class="line"><a name="l04147"></a><span class="lineno"> 4147</span>&#160;  <span class="keyword">typedef</span> unordered_map&lt;std::vector&lt;Cindex&gt;, int32,</div><div class="line"><a name="l04148"></a><span class="lineno"> 4148</span>&#160;                        <a class="code" href="structkaldi_1_1nnet3_1_1CindexVectorHasher.html">CindexVectorHasher</a>&gt; MapType;</div><div class="line"><a name="l04149"></a><span class="lineno"> 4149</span>&#160;  int32 cur_vector_id = 1;</div><div class="line"><a name="l04150"></a><span class="lineno"> 4150</span>&#160;  <span class="comment">// Note: cindex_map just maps the vector&lt;Cindex&gt; to a unique value,</span></div><div class="line"><a name="l04151"></a><span class="lineno"> 4151</span>&#160;  <span class="comment">// and then we manually work out a unique id that takes into</span></div><div class="line"><a name="l04152"></a><span class="lineno"> 4152</span>&#160;  <span class="comment">// account the &#39;is_deriv&#39; values.</span></div><div class="line"><a name="l04153"></a><span class="lineno"> 4153</span>&#160;  MapType cindex_map;</div><div class="line"><a name="l04154"></a><span class="lineno"> 4154</span>&#160;  int32 num_matrices = computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>.size();</div><div class="line"><a name="l04155"></a><span class="lineno"> 4155</span>&#160;  matrix_to_pair-&gt;resize(num_matrices);</div><div class="line"><a name="l04156"></a><span class="lineno"> 4156</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.size() == num_matrices);</div><div class="line"><a name="l04157"></a><span class="lineno"> 4157</span>&#160;  <span class="keywordflow">for</span> (int32 m = 1; m &lt; num_matrices; m++) {</div><div class="line"><a name="l04158"></a><span class="lineno"> 4158</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[m].cindexes.empty());</div><div class="line"><a name="l04159"></a><span class="lineno"> 4159</span>&#160;    std::vector&lt;Cindex&gt; cindexes = computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[m].cindexes;</div><div class="line"><a name="l04160"></a><span class="lineno"> 4160</span>&#160;    int32 t_offset = NormalizeCindexes(&amp;cindexes);</div><div class="line"><a name="l04161"></a><span class="lineno"> 4161</span>&#160;    MapType::const_iterator iter = cindex_map.find(cindexes);</div><div class="line"><a name="l04162"></a><span class="lineno"> 4162</span>&#160;    int32 vector_id;</div><div class="line"><a name="l04163"></a><span class="lineno"> 4163</span>&#160;    <span class="keywordflow">if</span> (iter != cindex_map.end()) {</div><div class="line"><a name="l04164"></a><span class="lineno"> 4164</span>&#160;      vector_id = iter-&gt;second;</div><div class="line"><a name="l04165"></a><span class="lineno"> 4165</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04166"></a><span class="lineno"> 4166</span>&#160;      vector_id = cur_vector_id++;</div><div class="line"><a name="l04167"></a><span class="lineno"> 4167</span>&#160;      cindex_map[cindexes] = vector_id;</div><div class="line"><a name="l04168"></a><span class="lineno"> 4168</span>&#160;    }</div><div class="line"><a name="l04169"></a><span class="lineno"> 4169</span>&#160;    <span class="keywordtype">bool</span> is_deriv = computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[m].is_deriv;</div><div class="line"><a name="l04170"></a><span class="lineno"> 4170</span>&#160;    int32 unique_id = 2 * vector_id + (is_deriv ? 1 : 0);</div><div class="line"><a name="l04171"></a><span class="lineno"> 4171</span>&#160;    (*matrix_to_pair)[m].first = unique_id;</div><div class="line"><a name="l04172"></a><span class="lineno"> 4172</span>&#160;    (*matrix_to_pair)[m].second = t_offset;</div><div class="line"><a name="l04173"></a><span class="lineno"> 4173</span>&#160;  }</div><div class="line"><a name="l04174"></a><span class="lineno"> 4174</span>&#160;}</div><div class="line"><a name="l04175"></a><span class="lineno"> 4175</span>&#160;</div><div class="line"><a name="l04176"></a><span class="lineno"> 4176</span>&#160;<span class="comment">// static</span></div><div class="line"><a name="l04177"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#ac797c8d6a701fb10dc8de13d2db3dcbe"> 4177</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#ac797c8d6a701fb10dc8de13d2db3dcbe">ComputationLoopedOptimizer::GetPairToMatrixMap</a>(</div><div class="line"><a name="l04178"></a><span class="lineno"> 4178</span>&#160;      std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;matrix_to_pair,</div><div class="line"><a name="l04179"></a><span class="lineno"> 4179</span>&#160;      unordered_map&lt;std::pair&lt;int32, int32&gt;, int32, <a class="code" href="structkaldi_1_1PairHasher.html">PairHasher&lt;int32&gt;</a> &gt; *pair_to_matrix) {</div><div class="line"><a name="l04180"></a><span class="lineno"> 4180</span>&#160;  int32 num_matrices = matrix_to_pair.size();</div><div class="line"><a name="l04181"></a><span class="lineno"> 4181</span>&#160;  <span class="comment">// actually there are one fewer matrices than num_matrices.</span></div><div class="line"><a name="l04182"></a><span class="lineno"> 4182</span>&#160;  pair_to_matrix-&gt;clear();</div><div class="line"><a name="l04183"></a><span class="lineno"> 4183</span>&#160;  <span class="keywordflow">for</span> (int32 m = 1; m &lt; num_matrices; m++)</div><div class="line"><a name="l04184"></a><span class="lineno"> 4184</span>&#160;    (*pair_to_matrix)[matrix_to_pair[m]] = m;</div><div class="line"><a name="l04185"></a><span class="lineno"> 4185</span>&#160;}</div><div class="line"><a name="l04186"></a><span class="lineno"> 4186</span>&#160;</div><div class="line"><a name="l04187"></a><span class="lineno"> 4187</span>&#160;</div><div class="line"><a name="l04188"></a><span class="lineno"> 4188</span>&#160;<span class="comment">// static</span></div><div class="line"><a name="l04189"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a72907a94f0ef8ddc489134dad4fba1aa"> 4189</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a72907a94f0ef8ddc489134dad4fba1aa">ComputationLoopedOptimizer::ConvertListsToPairLists</a>(</div><div class="line"><a name="l04190"></a><span class="lineno"> 4190</span>&#160;      <span class="keyword">const</span> std::vector&lt;std::vector&lt;int32&gt; &gt; &amp;active_matrices,</div><div class="line"><a name="l04191"></a><span class="lineno"> 4191</span>&#160;      <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;matrix_to_pair,</div><div class="line"><a name="l04192"></a><span class="lineno"> 4192</span>&#160;      std::vector&lt;std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &gt; *active_pairs) {</div><div class="line"><a name="l04193"></a><span class="lineno"> 4193</span>&#160;  active_pairs-&gt;clear();</div><div class="line"><a name="l04194"></a><span class="lineno"> 4194</span>&#160;  active_pairs-&gt;resize(active_matrices.size());</div><div class="line"><a name="l04195"></a><span class="lineno"> 4195</span>&#160;  int32 num_matrices = matrix_to_pair.size();</div><div class="line"><a name="l04196"></a><span class="lineno"> 4196</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> seg = 0; seg &lt; active_matrices.size(); seg++) {</div><div class="line"><a name="l04197"></a><span class="lineno"> 4197</span>&#160;    <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;this_active_matrix_list = active_matrices[seg];</div><div class="line"><a name="l04198"></a><span class="lineno"> 4198</span>&#160;    std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;this_active_pair_list =</div><div class="line"><a name="l04199"></a><span class="lineno"> 4199</span>&#160;        (*active_pairs)[seg];</div><div class="line"><a name="l04200"></a><span class="lineno"> 4200</span>&#160;    this_active_pair_list.resize(this_active_matrix_list.size());</div><div class="line"><a name="l04201"></a><span class="lineno"> 4201</span>&#160;    std::vector&lt;int32&gt;::const_iterator iter = this_active_matrix_list.begin(),</div><div class="line"><a name="l04202"></a><span class="lineno"> 4202</span>&#160;        end = this_active_matrix_list.end();</div><div class="line"><a name="l04203"></a><span class="lineno"> 4203</span>&#160;    std::vector&lt;std::pair&lt;int32, int32&gt; &gt;::iterator</div><div class="line"><a name="l04204"></a><span class="lineno"> 4204</span>&#160;        out_iter = this_active_pair_list.begin();</div><div class="line"><a name="l04205"></a><span class="lineno"> 4205</span>&#160;    <span class="keywordflow">for</span> (; iter != end; ++iter, ++out_iter) {</div><div class="line"><a name="l04206"></a><span class="lineno"> 4206</span>&#160;      <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(*iter &gt; 0 &amp;&amp; *iter &lt; num_matrices);</div><div class="line"><a name="l04207"></a><span class="lineno"> 4207</span>&#160;      *out_iter = matrix_to_pair[*iter];</div><div class="line"><a name="l04208"></a><span class="lineno"> 4208</span>&#160;    }</div><div class="line"><a name="l04209"></a><span class="lineno"> 4209</span>&#160;  }</div><div class="line"><a name="l04210"></a><span class="lineno"> 4210</span>&#160;}</div><div class="line"><a name="l04211"></a><span class="lineno"> 4211</span>&#160;</div><div class="line"><a name="l04212"></a><span class="lineno"> 4212</span>&#160;<span class="comment">// static</span></div><div class="line"><a name="l04213"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a0208954d6ae356dca488033ecea40274"> 4213</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a0208954d6ae356dca488033ecea40274">ComputationLoopedOptimizer::ListsAreEqualExceptForPossibleShift</a>(</div><div class="line"><a name="l04214"></a><span class="lineno"> 4214</span>&#160;    <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;a,</div><div class="line"><a name="l04215"></a><span class="lineno"> 4215</span>&#160;    <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;b,</div><div class="line"><a name="l04216"></a><span class="lineno"> 4216</span>&#160;    int32 shift) {</div><div class="line"><a name="l04217"></a><span class="lineno"> 4217</span>&#160;  <span class="keywordtype">size_t</span> size = a.size();</div><div class="line"><a name="l04218"></a><span class="lineno"> 4218</span>&#160;  <span class="keywordflow">if</span> (b.size() != size)</div><div class="line"><a name="l04219"></a><span class="lineno"> 4219</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l04220"></a><span class="lineno"> 4220</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; size; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l04221"></a><span class="lineno"> 4221</span>&#160;    <span class="keyword">const</span> std::pair&lt;int32, int32&gt; &amp;p1 = a[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>],</div><div class="line"><a name="l04222"></a><span class="lineno"> 4222</span>&#160;        &amp;p2 = b[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l04223"></a><span class="lineno"> 4223</span>&#160;    <span class="keywordflow">if</span> (p1.first != p2.first)</div><div class="line"><a name="l04224"></a><span class="lineno"> 4224</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l04225"></a><span class="lineno"> 4225</span>&#160;    <span class="keywordflow">if</span> (p2.second != p1.second + shift &amp;&amp; p2.second != p1.second)</div><div class="line"><a name="l04226"></a><span class="lineno"> 4226</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l04227"></a><span class="lineno"> 4227</span>&#160;  }</div><div class="line"><a name="l04228"></a><span class="lineno"> 4228</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l04229"></a><span class="lineno"> 4229</span>&#160;}</div><div class="line"><a name="l04230"></a><span class="lineno"> 4230</span>&#160;</div><div class="line"><a name="l04231"></a><span class="lineno"> 4231</span>&#160;<span class="comment">// static</span></div><div class="line"><a name="l04232"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a45761855efc1786f2089e550ec71712a"> 4232</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a45761855efc1786f2089e550ec71712a">ComputationLoopedOptimizer::FindFirstRepeat</a>(</div><div class="line"><a name="l04233"></a><span class="lineno"> 4233</span>&#160;    <span class="keyword">const</span> std::vector&lt;std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &gt; &amp;active_pairs,</div><div class="line"><a name="l04234"></a><span class="lineno"> 4234</span>&#160;    int32 time_shift_per_segment,</div><div class="line"><a name="l04235"></a><span class="lineno"> 4235</span>&#160;    int32 *seg1, int32 *seg2) {</div><div class="line"><a name="l04236"></a><span class="lineno"> 4236</span>&#160;  int32 num_segments = active_pairs.size();</div><div class="line"><a name="l04237"></a><span class="lineno"> 4237</span>&#160;  <span class="comment">// This algorithm may seem like it would be very slow, but the number of</span></div><div class="line"><a name="l04238"></a><span class="lineno"> 4238</span>&#160;  <span class="comment">// segments will normally be quite small (e.g. 10), and the comparison of</span></div><div class="line"><a name="l04239"></a><span class="lineno"> 4239</span>&#160;  <span class="comment">// elements of &#39;active_pairs&#39; should be fast in cases where they</span></div><div class="line"><a name="l04240"></a><span class="lineno"> 4240</span>&#160;  <span class="comment">// differ.</span></div><div class="line"><a name="l04241"></a><span class="lineno"> 4241</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(num_segments &gt;= 2);</div><div class="line"><a name="l04242"></a><span class="lineno"> 4242</span>&#160;</div><div class="line"><a name="l04243"></a><span class="lineno"> 4243</span>&#160;  <span class="keywordflow">for</span> (int32 s = 0; s &lt; num_segments; s++) {</div><div class="line"><a name="l04244"></a><span class="lineno"> 4244</span>&#160;    <span class="keywordflow">for</span> (int32 t = s + 1; t &lt; num_segments; t++) {</div><div class="line"><a name="l04245"></a><span class="lineno"> 4245</span>&#160;      <span class="keywordflow">if</span> (ListsAreEqualExceptForPossibleShift(active_pairs[s],</div><div class="line"><a name="l04246"></a><span class="lineno"> 4246</span>&#160;                                              active_pairs[t],</div><div class="line"><a name="l04247"></a><span class="lineno"> 4247</span>&#160;                                              (t - s) * time_shift_per_segment)) {</div><div class="line"><a name="l04248"></a><span class="lineno"> 4248</span>&#160;        *seg1 = s;</div><div class="line"><a name="l04249"></a><span class="lineno"> 4249</span>&#160;        *seg2 = t;</div><div class="line"><a name="l04250"></a><span class="lineno"> 4250</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l04251"></a><span class="lineno"> 4251</span>&#160;      }</div><div class="line"><a name="l04252"></a><span class="lineno"> 4252</span>&#160;    }</div><div class="line"><a name="l04253"></a><span class="lineno"> 4253</span>&#160;  }</div><div class="line"><a name="l04254"></a><span class="lineno"> 4254</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l04255"></a><span class="lineno"> 4255</span>&#160;}</div><div class="line"><a name="l04256"></a><span class="lineno"> 4256</span>&#160;</div><div class="line"><a name="l04257"></a><span class="lineno"> 4257</span>&#160;<span class="comment">// static</span></div><div class="line"><a name="l04258"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a50e8cbb0a710d4d2862d8b19c72902bc"> 4258</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a50e8cbb0a710d4d2862d8b19c72902bc">ComputationLoopedOptimizer::GetIdentifiedMatrices</a>(</div><div class="line"><a name="l04259"></a><span class="lineno"> 4259</span>&#160;    <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;pair_list1,</div><div class="line"><a name="l04260"></a><span class="lineno"> 4260</span>&#160;    <span class="keyword">const</span> std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &amp;pair_list2,</div><div class="line"><a name="l04261"></a><span class="lineno"> 4261</span>&#160;    <span class="keyword">const</span> unordered_map&lt;std::pair&lt;int32, int32&gt;, int32, <a class="code" href="structkaldi_1_1PairHasher.html">PairHasher&lt;int32&gt;</a> &gt; &amp;pair_to_matrix,</div><div class="line"><a name="l04262"></a><span class="lineno"> 4262</span>&#160;    std::vector&lt;int32&gt; *matrix_list1,</div><div class="line"><a name="l04263"></a><span class="lineno"> 4263</span>&#160;    std::vector&lt;int32&gt; *matrix_list2) {</div><div class="line"><a name="l04264"></a><span class="lineno"> 4264</span>&#160;  <span class="keywordtype">size_t</span> size = pair_list1.size();</div><div class="line"><a name="l04265"></a><span class="lineno"> 4265</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(pair_list2.size() == size);</div><div class="line"><a name="l04266"></a><span class="lineno"> 4266</span>&#160;  matrix_list1-&gt;clear();</div><div class="line"><a name="l04267"></a><span class="lineno"> 4267</span>&#160;  matrix_list2-&gt;clear();</div><div class="line"><a name="l04268"></a><span class="lineno"> 4268</span>&#160;  matrix_list1-&gt;reserve(size);</div><div class="line"><a name="l04269"></a><span class="lineno"> 4269</span>&#160;  matrix_list2-&gt;reserve(size);</div><div class="line"><a name="l04270"></a><span class="lineno"> 4270</span>&#160;  std::vector&lt;std::pair&lt;int32, int32&gt; &gt;::const_iterator</div><div class="line"><a name="l04271"></a><span class="lineno"> 4271</span>&#160;      iter1 = pair_list1.begin(), end1 = pair_list1.end(),</div><div class="line"><a name="l04272"></a><span class="lineno"> 4272</span>&#160;      iter2 = pair_list2.begin();</div><div class="line"><a name="l04273"></a><span class="lineno"> 4273</span>&#160;  <span class="keywordflow">for</span> (; iter1 != end1; ++iter1, ++iter2) {</div><div class="line"><a name="l04274"></a><span class="lineno"> 4274</span>&#160;    <span class="keywordflow">if</span> (iter1-&gt;second == iter2-&gt;second)</div><div class="line"><a name="l04275"></a><span class="lineno"> 4275</span>&#160;      <span class="keywordflow">continue</span>;</div><div class="line"><a name="l04276"></a><span class="lineno"> 4276</span>&#160;    <span class="comment">// skip those that have no time shift, we won&#39;t have to do any swapping for</span></div><div class="line"><a name="l04277"></a><span class="lineno"> 4277</span>&#160;    <span class="comment">// those.</span></div><div class="line"><a name="l04278"></a><span class="lineno"> 4278</span>&#160;    unordered_map&lt;std::pair&lt;int32, int32&gt;, int32,</div><div class="line"><a name="l04279"></a><span class="lineno"> 4279</span>&#160;                  <a class="code" href="structkaldi_1_1PairHasher.html">PairHasher&lt;int32&gt;</a> &gt;::const_iterator</div><div class="line"><a name="l04280"></a><span class="lineno"> 4280</span>&#160;        map_iter1 = pair_to_matrix.find(*iter1),</div><div class="line"><a name="l04281"></a><span class="lineno"> 4281</span>&#160;        map_iter2 = pair_to_matrix.find(*iter2);</div><div class="line"><a name="l04282"></a><span class="lineno"> 4282</span>&#160;    <span class="keywordflow">if</span> (map_iter1 == pair_to_matrix.end() ||</div><div class="line"><a name="l04283"></a><span class="lineno"> 4283</span>&#160;        map_iter2 == pair_to_matrix.end())</div><div class="line"><a name="l04284"></a><span class="lineno"> 4284</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Could not find pair in map (code error)&quot;</span>;</div><div class="line"><a name="l04285"></a><span class="lineno"> 4285</span>&#160;    matrix_list1-&gt;push_back(map_iter1-&gt;second);</div><div class="line"><a name="l04286"></a><span class="lineno"> 4286</span>&#160;    matrix_list2-&gt;push_back(map_iter2-&gt;second);</div><div class="line"><a name="l04287"></a><span class="lineno"> 4287</span>&#160;  }</div><div class="line"><a name="l04288"></a><span class="lineno"> 4288</span>&#160;}</div><div class="line"><a name="l04289"></a><span class="lineno"> 4289</span>&#160;</div><div class="line"><a name="l04290"></a><span class="lineno"> 4290</span>&#160;</div><div class="line"><a name="l04291"></a><span class="lineno"> 4291</span>&#160;</div><div class="line"><a name="l04292"></a><span class="lineno"> 4292</span>&#160;<span class="comment">// static</span></div><div class="line"><a name="l04293"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a768ce6ef8c9f2cd1b13dee1164c38213"> 4293</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a768ce6ef8c9f2cd1b13dee1164c38213">ComputationLoopedOptimizer::FindActiveMatrices</a>(</div><div class="line"><a name="l04294"></a><span class="lineno"> 4294</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> &amp;computation,</div><div class="line"><a name="l04295"></a><span class="lineno"> 4295</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html">Analyzer</a> &amp;analyzer,</div><div class="line"><a name="l04296"></a><span class="lineno"> 4296</span>&#160;    <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;splice_point_commands,</div><div class="line"><a name="l04297"></a><span class="lineno"> 4297</span>&#160;    std::vector&lt;std::vector&lt;int32&gt; &gt; *active_matrices) {</div><div class="line"><a name="l04298"></a><span class="lineno"> 4298</span>&#160;  int32 num_matrices = computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>.size();</div><div class="line"><a name="l04299"></a><span class="lineno"> 4299</span>&#160;  int32 num_splice_points = splice_point_commands.size();</div><div class="line"><a name="l04300"></a><span class="lineno"> 4300</span>&#160;  active_matrices-&gt;clear();</div><div class="line"><a name="l04301"></a><span class="lineno"> 4301</span>&#160;  active_matrices-&gt;resize(num_splice_points);</div><div class="line"><a name="l04302"></a><span class="lineno"> 4302</span>&#160;  <span class="comment">// this object just makes available some extra functions, vs. the Analyzer</span></div><div class="line"><a name="l04303"></a><span class="lineno"> 4303</span>&#160;  <span class="comment">// object.</span></div><div class="line"><a name="l04304"></a><span class="lineno"> 4304</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html">ComputationAnalysis</a> analysis(computation, analyzer);</div><div class="line"><a name="l04305"></a><span class="lineno"> 4305</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(<a class="code" href="namespacekaldi.html#a81dfa76eeac63eba502e32ee58e37d57">IsSortedAndUniq</a>(splice_point_commands));</div><div class="line"><a name="l04306"></a><span class="lineno"> 4306</span>&#160;</div><div class="line"><a name="l04307"></a><span class="lineno"> 4307</span>&#160;  <span class="comment">// the following vector gives us, for each matrix index, a submatrix index</span></div><div class="line"><a name="l04308"></a><span class="lineno"> 4308</span>&#160;  <span class="comment">// that covers the whole of that matrix (needed by interface of &#39;analysis&#39; object).</span></div><div class="line"><a name="l04309"></a><span class="lineno"> 4309</span>&#160;  std::vector&lt;int32&gt; whole_submatrices;</div><div class="line"><a name="l04310"></a><span class="lineno"> 4310</span>&#160;  computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ac6ad0d391be80aff8f4538b6fbf747b1">GetWholeSubmatrices</a>(&amp;whole_submatrices);</div><div class="line"><a name="l04311"></a><span class="lineno"> 4311</span>&#160;  <span class="keywordflow">for</span> (int32 m = 1; m &lt; num_matrices; m++) {</div><div class="line"><a name="l04312"></a><span class="lineno"> 4312</span>&#160;    <span class="comment">// the following are command indexes, comparable with the indexes</span></div><div class="line"><a name="l04313"></a><span class="lineno"> 4313</span>&#160;    <span class="comment">// in &#39;splice_point_commands&#39;.</span></div><div class="line"><a name="l04314"></a><span class="lineno"> 4314</span>&#160;    int32 s = whole_submatrices[m],  <span class="comment">// submatrix consisting of the whole of</span></div><div class="line"><a name="l04315"></a><span class="lineno"> 4315</span>&#160;                                     <span class="comment">// &#39;m&#39;.</span></div><div class="line"><a name="l04316"></a><span class="lineno"> 4316</span>&#160;        first_access = analysis.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html#a68f6c05cf1aab9fd7e6a475078e38466">FirstNontrivialAccess</a>(s),</div><div class="line"><a name="l04317"></a><span class="lineno"> 4317</span>&#160;        last_access = analysis.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html#a3a6f864b459da77d4014835edaa0653f">LastAccess</a>(s);</div><div class="line"><a name="l04318"></a><span class="lineno"> 4318</span>&#160;    <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; num_splice_points; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l04319"></a><span class="lineno"> 4319</span>&#160;      int32 splice_point = splice_point_commands[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l04320"></a><span class="lineno"> 4320</span>&#160;      <span class="keywordflow">if</span> (first_access &lt; splice_point &amp;&amp; last_access &gt; splice_point) {</div><div class="line"><a name="l04321"></a><span class="lineno"> 4321</span>&#160;        <span class="comment">// If the block of time during which the matrix is accessed, includes</span></div><div class="line"><a name="l04322"></a><span class="lineno"> 4322</span>&#160;        <span class="comment">// this command index, then the matrix is considered &#39;active&#39; at this</span></div><div class="line"><a name="l04323"></a><span class="lineno"> 4323</span>&#160;        <span class="comment">// time.</span></div><div class="line"><a name="l04324"></a><span class="lineno"> 4324</span>&#160;        (*active_matrices)[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].push_back(m);</div><div class="line"><a name="l04325"></a><span class="lineno"> 4325</span>&#160;      }</div><div class="line"><a name="l04326"></a><span class="lineno"> 4326</span>&#160;    }</div><div class="line"><a name="l04327"></a><span class="lineno"> 4327</span>&#160;  }</div><div class="line"><a name="l04328"></a><span class="lineno"> 4328</span>&#160;}</div><div class="line"><a name="l04329"></a><span class="lineno"> 4329</span>&#160;</div><div class="line"><a name="l04330"></a><span class="lineno"> 4330</span>&#160;<span class="comment">// static</span></div><div class="line"><a name="l04331"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a283d532b71865991e14f83433b440332"> 4331</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a283d532b71865991e14f83433b440332">ComputationLoopedOptimizer::CheckIdentifiedMatrices</a>(</div><div class="line"><a name="l04332"></a><span class="lineno"> 4332</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> &amp;computation,</div><div class="line"><a name="l04333"></a><span class="lineno"> 4333</span>&#160;    <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;list1,</div><div class="line"><a name="l04334"></a><span class="lineno"> 4334</span>&#160;    <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;list2,</div><div class="line"><a name="l04335"></a><span class="lineno"> 4335</span>&#160;    int32 time_difference) {</div><div class="line"><a name="l04336"></a><span class="lineno"> 4336</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(time_difference &gt; 0);</div><div class="line"><a name="l04337"></a><span class="lineno"> 4337</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(list1.size() == list2.size());</div><div class="line"><a name="l04338"></a><span class="lineno"> 4338</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.empty());</div><div class="line"><a name="l04339"></a><span class="lineno"> 4339</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; list1.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l04340"></a><span class="lineno"> 4340</span>&#160;    int32 m1 = list1[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>], m2 = list2[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l04341"></a><span class="lineno"> 4341</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html">NnetComputation::MatrixInfo</a></div><div class="line"><a name="l04342"></a><span class="lineno"> 4342</span>&#160;        &amp;matrix_info1 = computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m1],</div><div class="line"><a name="l04343"></a><span class="lineno"> 4343</span>&#160;        &amp;matrix_info2 = computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>[m2];</div><div class="line"><a name="l04344"></a><span class="lineno"> 4344</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(matrix_info1.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#a71978616b0acd678d1f284943acd6586">num_rows</a> == matrix_info2.num_rows &amp;&amp;</div><div class="line"><a name="l04345"></a><span class="lineno"> 4345</span>&#160;                 matrix_info1.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#aea941d74a486998b6fa921bc19fed05c">num_cols</a> == matrix_info2.num_cols &amp;&amp;</div><div class="line"><a name="l04346"></a><span class="lineno"> 4346</span>&#160;                 matrix_info1.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#aff7fe31cc8e3cc6b36b37d139e4f1470">stride_type</a> == matrix_info2.stride_type);</div><div class="line"><a name="l04347"></a><span class="lineno"> 4347</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">NnetComputation::MatrixDebugInfo</a></div><div class="line"><a name="l04348"></a><span class="lineno"> 4348</span>&#160;        &amp;debug_info1 = computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[m1],</div><div class="line"><a name="l04349"></a><span class="lineno"> 4349</span>&#160;        &amp;debug_info2 = computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>[m2];</div><div class="line"><a name="l04350"></a><span class="lineno"> 4350</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(debug_info1.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a9da2804c57d358d12d491f0c3d51d0ef">is_deriv</a> == debug_info2.is_deriv);</div><div class="line"><a name="l04351"></a><span class="lineno"> 4351</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(debug_info1.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>.size() == debug_info2.cindexes.size());</div><div class="line"><a name="l04352"></a><span class="lineno"> 4352</span>&#160;    std::vector&lt;Cindex&gt;::const_iterator iter1 = debug_info1.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>.begin(),</div><div class="line"><a name="l04353"></a><span class="lineno"> 4353</span>&#160;        end1 = debug_info1.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">cindexes</a>.end(),</div><div class="line"><a name="l04354"></a><span class="lineno"> 4354</span>&#160;        iter2 = debug_info2.cindexes.begin();</div><div class="line"><a name="l04355"></a><span class="lineno"> 4355</span>&#160;    <span class="keywordflow">for</span> (; iter1 != end1; iter1++,iter2++) {</div><div class="line"><a name="l04356"></a><span class="lineno"> 4356</span>&#160;      <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(iter2-&gt;first == iter1-&gt;first &amp;&amp;</div><div class="line"><a name="l04357"></a><span class="lineno"> 4357</span>&#160;                   iter2-&gt;second.n == iter1-&gt;second.n &amp;&amp;</div><div class="line"><a name="l04358"></a><span class="lineno"> 4358</span>&#160;                   ((iter1-&gt;second.t == <a class="code" href="namespacekaldi_1_1nnet3.html#ac952f0840a7950dff80c1a89e69656d7">kNoTime</a> &amp;&amp; iter2-&gt;second.t == <a class="code" href="namespacekaldi_1_1nnet3.html#ac952f0840a7950dff80c1a89e69656d7">kNoTime</a>) ||</div><div class="line"><a name="l04359"></a><span class="lineno"> 4359</span>&#160;                    iter2-&gt;second.t == iter1-&gt;second.t + time_difference) &amp;&amp;</div><div class="line"><a name="l04360"></a><span class="lineno"> 4360</span>&#160;                   iter2-&gt;second.x == iter1-&gt;second.x);</div><div class="line"><a name="l04361"></a><span class="lineno"> 4361</span>&#160;    }</div><div class="line"><a name="l04362"></a><span class="lineno"> 4362</span>&#160;  }</div><div class="line"><a name="l04363"></a><span class="lineno"> 4363</span>&#160;}</div><div class="line"><a name="l04364"></a><span class="lineno"> 4364</span>&#160;</div><div class="line"><a name="l04365"></a><span class="lineno"> 4365</span>&#160;</div><div class="line"><a name="l04366"></a><span class="lineno"> 4366</span>&#160;<span class="comment">// static</span></div><div class="line"><a name="l04367"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a69d4034713b69fe896cf7fd0566c3216"> 4367</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a69d4034713b69fe896cf7fd0566c3216">ComputationLoopedOptimizer::GetMatrixSwapOrder</a>(</div><div class="line"><a name="l04368"></a><span class="lineno"> 4368</span>&#160;    <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;matrices1,</div><div class="line"><a name="l04369"></a><span class="lineno"> 4369</span>&#160;    <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;matrices2,</div><div class="line"><a name="l04370"></a><span class="lineno"> 4370</span>&#160;    std::vector&lt;std::pair&lt;int32, int32&gt; &gt; *swaps) {</div><div class="line"><a name="l04371"></a><span class="lineno"> 4371</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(matrices1.size() == matrices2.size());</div><div class="line"><a name="l04372"></a><span class="lineno"> 4372</span>&#160;  swaps-&gt;clear();</div><div class="line"><a name="l04373"></a><span class="lineno"> 4373</span>&#160;  int32 num_matrices = matrices1.size();</div><div class="line"><a name="l04374"></a><span class="lineno"> 4374</span>&#160;  std::vector&lt;bool&gt; processed(num_matrices, <span class="keyword">false</span>);</div><div class="line"><a name="l04375"></a><span class="lineno"> 4375</span>&#160;  std::vector&lt;int32&gt; queue;</div><div class="line"><a name="l04376"></a><span class="lineno"> 4376</span>&#160;</div><div class="line"><a name="l04377"></a><span class="lineno"> 4377</span>&#160;  <span class="comment">// num_loops is just for infinite-loop detection.</span></div><div class="line"><a name="l04378"></a><span class="lineno"> 4378</span>&#160;  int32 num_loops = 0;</div><div class="line"><a name="l04379"></a><span class="lineno"> 4379</span>&#160;  <span class="keywordflow">for</span> (; <span class="keyword">static_cast&lt;</span>int32<span class="keyword">&gt;</span>(swaps-&gt;size()) &lt; num_matrices; num_loops++) {</div><div class="line"><a name="l04380"></a><span class="lineno"> 4380</span>&#160;    <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; num_matrices; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l04381"></a><span class="lineno"> 4381</span>&#160;      <span class="keywordflow">if</span> (processed[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>])</div><div class="line"><a name="l04382"></a><span class="lineno"> 4382</span>&#160;        <span class="keywordflow">continue</span>;</div><div class="line"><a name="l04383"></a><span class="lineno"> 4383</span>&#160;      int32 m1 = matrices1[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>], m2 = matrices2[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l04384"></a><span class="lineno"> 4384</span>&#160;      std::vector&lt;int32&gt;::const_iterator iter =</div><div class="line"><a name="l04385"></a><span class="lineno"> 4385</span>&#160;          std::lower_bound(matrices2.begin(), matrices2.end(), m1);</div><div class="line"><a name="l04386"></a><span class="lineno"> 4386</span>&#160;      <span class="keywordflow">if</span> (iter == matrices2.end() || *iter != m1) {</div><div class="line"><a name="l04387"></a><span class="lineno"> 4387</span>&#160;        <span class="comment">// Matrix m1 does not appear in the list &#39;matrices2&#39;, so</span></div><div class="line"><a name="l04388"></a><span class="lineno"> 4388</span>&#160;        <span class="comment">// we are safe to process it at any time.</span></div><div class="line"><a name="l04389"></a><span class="lineno"> 4389</span>&#160;        swaps-&gt;push_back(std::pair&lt;int32,int32&gt;(m1, m2));</div><div class="line"><a name="l04390"></a><span class="lineno"> 4390</span>&#160;        processed[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <span class="keyword">true</span>;</div><div class="line"><a name="l04391"></a><span class="lineno"> 4391</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04392"></a><span class="lineno"> 4392</span>&#160;        int32 m1_pos_in_matrices2 = iter - matrices2.begin();</div><div class="line"><a name="l04393"></a><span class="lineno"> 4393</span>&#160;        <span class="keywordflow">if</span> (processed[m1_pos_in_matrices2]) {</div><div class="line"><a name="l04394"></a><span class="lineno"> 4394</span>&#160;          <span class="comment">// We&#39;re safe to do this swap now, because the matrix m1 has already</span></div><div class="line"><a name="l04395"></a><span class="lineno"> 4395</span>&#160;          <span class="comment">// appeared on the RHS of a swap, and by this point has been</span></div><div class="line"><a name="l04396"></a><span class="lineno"> 4396</span>&#160;          <span class="comment">// deallocated, in effect.</span></div><div class="line"><a name="l04397"></a><span class="lineno"> 4397</span>&#160;          swaps-&gt;push_back(std::pair&lt;int32,int32&gt;(m1, m2));</div><div class="line"><a name="l04398"></a><span class="lineno"> 4398</span>&#160;          processed[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <span class="keyword">true</span>;</div><div class="line"><a name="l04399"></a><span class="lineno"> 4399</span>&#160;        }</div><div class="line"><a name="l04400"></a><span class="lineno"> 4400</span>&#160;        <span class="comment">// else do nothing, we cannot process m1 yet because</span></div><div class="line"><a name="l04401"></a><span class="lineno"> 4401</span>&#160;        <span class="comment">// at this point in the computation it is still allocated.</span></div><div class="line"><a name="l04402"></a><span class="lineno"> 4402</span>&#160;      }</div><div class="line"><a name="l04403"></a><span class="lineno"> 4403</span>&#160;    }</div><div class="line"><a name="l04404"></a><span class="lineno"> 4404</span>&#160;    <span class="comment">// The following assert is to check that we don&#39;t loop infinitely.  We can</span></div><div class="line"><a name="l04405"></a><span class="lineno"> 4405</span>&#160;    <span class="comment">// prove that infinite looping won&#39;t happen, after on proving that there can</span></div><div class="line"><a name="l04406"></a><span class="lineno"> 4406</span>&#160;    <span class="comment">// be no cycles like (m1, m2), (m2, m3), (m3, m1) (the length of 3 is chosen</span></div><div class="line"><a name="l04407"></a><span class="lineno"> 4407</span>&#160;    <span class="comment">// arbitrarily as an example).  If such a cycle existed, we can reach a</span></div><div class="line"><a name="l04408"></a><span class="lineno"> 4408</span>&#160;    <span class="comment">// contradiction based on the time-index (t) of the first cindex in m1.</span></div><div class="line"><a name="l04409"></a><span class="lineno"> 4409</span>&#160;    <span class="comment">// Define t1 = that time index, t2 the same for m2, t3 the same for m3.  The</span></div><div class="line"><a name="l04410"></a><span class="lineno"> 4410</span>&#160;    <span class="comment">// existence of the three pairs [as pairs like (matrices1[i], matrices2[i])]</span></div><div class="line"><a name="l04411"></a><span class="lineno"> 4411</span>&#160;    <span class="comment">// implies that t2 &gt; t1, t3 &gt; t2, and t1 &gt; t3 respectively, but this is</span></div><div class="line"><a name="l04412"></a><span class="lineno"> 4412</span>&#160;    <span class="comment">// impossible.</span></div><div class="line"><a name="l04413"></a><span class="lineno"> 4413</span>&#160;    <span class="comment">// This shows that all chains of dependencies must terminate.</span></div><div class="line"><a name="l04414"></a><span class="lineno"> 4414</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(num_loops &lt;= num_matrices);</div><div class="line"><a name="l04415"></a><span class="lineno"> 4415</span>&#160;  }</div><div class="line"><a name="l04416"></a><span class="lineno"> 4416</span>&#160;}</div><div class="line"><a name="l04417"></a><span class="lineno"> 4417</span>&#160;</div><div class="line"><a name="l04418"></a><span class="lineno"> 4418</span>&#160;<span class="comment">// static</span></div><div class="line"><a name="l04419"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#ae93293e76f4dc9049065601362e9bc2e"> 4419</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#ae93293e76f4dc9049065601362e9bc2e">ComputationLoopedOptimizer::AddMatrixSwapCommands</a>(</div><div class="line"><a name="l04420"></a><span class="lineno"> 4420</span>&#160;    <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;matrices1,</div><div class="line"><a name="l04421"></a><span class="lineno"> 4421</span>&#160;    <span class="keyword">const</span> std::vector&lt;int32&gt; &amp;matrices2,</div><div class="line"><a name="l04422"></a><span class="lineno"> 4422</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation) {</div><div class="line"><a name="l04423"></a><span class="lineno"> 4423</span>&#160;  std::vector&lt;std::pair&lt;int32, int32&gt; &gt; swaps;</div><div class="line"><a name="l04424"></a><span class="lineno"> 4424</span>&#160;  <span class="comment">// Note: in &#39;easy&#39; cases where matrices1 and matrices2 are disjoint,</span></div><div class="line"><a name="l04425"></a><span class="lineno"> 4425</span>&#160;  <span class="comment">// &#39;swaps&#39; will just be the vector { (matrices1[0],matrices2[0]),</span></div><div class="line"><a name="l04426"></a><span class="lineno"> 4426</span>&#160;  <span class="comment">// (matrices1[1],matrices2[1]), ... },</span></div><div class="line"><a name="l04427"></a><span class="lineno"> 4427</span>&#160;  <span class="comment">// but in some cases these may need to get reordered.</span></div><div class="line"><a name="l04428"></a><span class="lineno"> 4428</span>&#160;  GetMatrixSwapOrder(matrices1, matrices2, &amp;swaps);</div><div class="line"><a name="l04429"></a><span class="lineno"> 4429</span>&#160;</div><div class="line"><a name="l04430"></a><span class="lineno"> 4430</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> goto_label_command = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.back();</div><div class="line"><a name="l04431"></a><span class="lineno"> 4431</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(goto_label_command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352add9060e8c7434f250048082c634d9a6d">kGotoLabel</a>);</div><div class="line"><a name="l04432"></a><span class="lineno"> 4432</span>&#160;  computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.pop_back();</div><div class="line"><a name="l04433"></a><span class="lineno"> 4433</span>&#160;</div><div class="line"><a name="l04434"></a><span class="lineno"> 4434</span>&#160;  <span class="comment">// the following vector gives us, for each matrix index, a submatrix index</span></div><div class="line"><a name="l04435"></a><span class="lineno"> 4435</span>&#160;  <span class="comment">// that covers the whole of that matrix (needed because the commands</span></div><div class="line"><a name="l04436"></a><span class="lineno"> 4436</span>&#160;  <span class="comment">// require submatrix indexes)</span></div><div class="line"><a name="l04437"></a><span class="lineno"> 4437</span>&#160;  std::vector&lt;int32&gt; whole_submatrices;</div><div class="line"><a name="l04438"></a><span class="lineno"> 4438</span>&#160;  computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ac6ad0d391be80aff8f4538b6fbf747b1">GetWholeSubmatrices</a>(&amp;whole_submatrices);</div><div class="line"><a name="l04439"></a><span class="lineno"> 4439</span>&#160;  <span class="keywordtype">size_t</span> num_matrices = whole_submatrices.size();</div><div class="line"><a name="l04440"></a><span class="lineno"> 4440</span>&#160;</div><div class="line"><a name="l04441"></a><span class="lineno"> 4441</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; swaps.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l04442"></a><span class="lineno"> 4442</span>&#160;    int32 m1 = swaps[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].first, m2 = swaps[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].second;</div><div class="line"><a name="l04443"></a><span class="lineno"> 4443</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(static_cast&lt;size_t&gt;(m1) &lt; num_matrices &amp;&amp;</div><div class="line"><a name="l04444"></a><span class="lineno"> 4444</span>&#160;                 static_cast&lt;size_t&gt;(m2) &lt; num_matrices);</div><div class="line"><a name="l04445"></a><span class="lineno"> 4445</span>&#160;    int32 s1 = whole_submatrices[m1], s2 = whole_submatrices[m2];</div><div class="line"><a name="l04446"></a><span class="lineno"> 4446</span>&#160;    computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.push_back(</div><div class="line"><a name="l04447"></a><span class="lineno"> 4447</span>&#160;        <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a>(<a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a8ecee91c55553bcf2d755d00328b0253">kSwapMatrix</a>, s1, s2));</div><div class="line"><a name="l04448"></a><span class="lineno"> 4448</span>&#160;  }</div><div class="line"><a name="l04449"></a><span class="lineno"> 4449</span>&#160;  computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.push_back(goto_label_command);</div><div class="line"><a name="l04450"></a><span class="lineno"> 4450</span>&#160;}</div><div class="line"><a name="l04451"></a><span class="lineno"> 4451</span>&#160;</div><div class="line"><a name="l04452"></a><span class="lineno"> 4452</span>&#160;<span class="comment">// static</span></div><div class="line"><a name="l04453"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a70c1595b263268a6a0ec5bd2468151bc"> 4453</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a70c1595b263268a6a0ec5bd2468151bc">ComputationLoopedOptimizer::FormInfiniteLoop</a>(</div><div class="line"><a name="l04454"></a><span class="lineno"> 4454</span>&#160;    int32 command1, int32 command2,</div><div class="line"><a name="l04455"></a><span class="lineno"> 4455</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation) {</div><div class="line"><a name="l04456"></a><span class="lineno"> 4456</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(static_cast&lt;int32&gt;(computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size()) &gt;=</div><div class="line"><a name="l04457"></a><span class="lineno"> 4457</span>&#160;               command2 + 1 &amp;&amp; command1 &lt; command2);</div><div class="line"><a name="l04458"></a><span class="lineno"> 4458</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(</div><div class="line"><a name="l04459"></a><span class="lineno"> 4459</span>&#160;      computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command1].command_type == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352af9786d4042a4fcf23b29a14a6fb64126">kNoOperationPermanent</a> &amp;&amp;</div><div class="line"><a name="l04460"></a><span class="lineno"> 4460</span>&#160;      computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command2].command_type == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352af9786d4042a4fcf23b29a14a6fb64126">kNoOperationPermanent</a>);</div><div class="line"><a name="l04461"></a><span class="lineno"> 4461</span>&#160;  <span class="comment">// Remove any commands after &#39;command2&#39;.</span></div><div class="line"><a name="l04462"></a><span class="lineno"> 4462</span>&#160;  computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.resize(command2 + 1);</div><div class="line"><a name="l04463"></a><span class="lineno"> 4463</span>&#160;  computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command2].command_type = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352add9060e8c7434f250048082c634d9a6d">kGotoLabel</a>;</div><div class="line"><a name="l04464"></a><span class="lineno"> 4464</span>&#160;  computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command2].arg1 = command1;</div><div class="line"><a name="l04465"></a><span class="lineno"> 4465</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> c(<a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a967844c2c7775d280d15738cbe852536">kNoOperationLabel</a>);</div><div class="line"><a name="l04466"></a><span class="lineno"> 4466</span>&#160;  computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.insert(computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.begin() + command1,</div><div class="line"><a name="l04467"></a><span class="lineno"> 4467</span>&#160;                               c);</div><div class="line"><a name="l04468"></a><span class="lineno"> 4468</span>&#160;  <span class="comment">// Now the kNoOperationLabel command is at position &#39;command1&#39;.</span></div><div class="line"><a name="l04469"></a><span class="lineno"> 4469</span>&#160;}</div><div class="line"><a name="l04470"></a><span class="lineno"> 4470</span>&#160;</div><div class="line"><a name="l04471"></a><span class="lineno"> 4471</span>&#160;</div><div class="line"><a name="l04472"></a><span class="lineno"> 4472</span>&#160;</div><div class="line"><a name="l04473"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#acdecf85ba9844b9db2d0649ff34139c8"> 4473</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#acdecf85ba9844b9db2d0649ff34139c8">ComputationLoopedOptimizer::Optimize</a>() {</div><div class="line"><a name="l04474"></a><span class="lineno"> 4474</span>&#160;  analyzer_.Init(<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#adbabf05a7702103113a02a113015205f">nnet_</a>, *<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>);</div><div class="line"><a name="l04475"></a><span class="lineno"> 4475</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(!<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">matrix_debug_info</a>.empty() &amp;&amp;</div><div class="line"><a name="l04476"></a><span class="lineno"> 4476</span>&#160;               <span class="stringliteral">&quot;You must request matrix debug info when compiling &quot;</span></div><div class="line"><a name="l04477"></a><span class="lineno"> 4477</span>&#160;               <span class="stringliteral">&quot;looped computations.&quot;</span>);</div><div class="line"><a name="l04478"></a><span class="lineno"> 4478</span>&#160;</div><div class="line"><a name="l04479"></a><span class="lineno"> 4479</span>&#160;  <span class="comment">// get the indexes of potential splice points, one per segment of the</span></div><div class="line"><a name="l04480"></a><span class="lineno"> 4480</span>&#160;  <span class="comment">// computation.  We locate the splice points where kNoOperationPermanent is.</span></div><div class="line"><a name="l04481"></a><span class="lineno"> 4481</span>&#160;  <span class="comment">// This is guaranteed to be after the inputs have been received, and before</span></div><div class="line"><a name="l04482"></a><span class="lineno"> 4482</span>&#160;  <span class="comment">// the bulk of the computation in the segment, and of course before we provide</span></div><div class="line"><a name="l04483"></a><span class="lineno"> 4483</span>&#160;  <span class="comment">// the output.  It happens that by choosing this as the splice point we avoid</span></div><div class="line"><a name="l04484"></a><span class="lineno"> 4484</span>&#160;  <span class="comment">// certain problems that would arise, for instance, if we chose the segment</span></div><div class="line"><a name="l04485"></a><span class="lineno"> 4485</span>&#160;  <span class="comment">// boundaries (kNoOperationMarker).</span></div><div class="line"><a name="l04486"></a><span class="lineno"> 4486</span>&#160;  std::vector&lt;int32&gt; splice_points;</div><div class="line"><a name="l04487"></a><span class="lineno"> 4487</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a0a04e946fa68432f4e723944ce8ab281">GetCommandsOfType</a>(*<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>, <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352af9786d4042a4fcf23b29a14a6fb64126">kNoOperationPermanent</a>,</div><div class="line"><a name="l04488"></a><span class="lineno"> 4488</span>&#160;                    &amp;splice_points);</div><div class="line"><a name="l04489"></a><span class="lineno"> 4489</span>&#160;  int32 time_shift_per_segment = FindTimeShift(*<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>);</div><div class="line"><a name="l04490"></a><span class="lineno"> 4490</span>&#160;</div><div class="line"><a name="l04491"></a><span class="lineno"> 4491</span>&#160;</div><div class="line"><a name="l04492"></a><span class="lineno"> 4492</span>&#160;  std::vector&lt;std::vector&lt;int32&gt; &gt; active_matrices;</div><div class="line"><a name="l04493"></a><span class="lineno"> 4493</span>&#160;  <span class="comment">// Find the list of matrices active at each of the potential splice points.</span></div><div class="line"><a name="l04494"></a><span class="lineno"> 4494</span>&#160;  FindActiveMatrices(*<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>, analyzer_, splice_points,</div><div class="line"><a name="l04495"></a><span class="lineno"> 4495</span>&#160;                     &amp;active_matrices);</div><div class="line"><a name="l04496"></a><span class="lineno"> 4496</span>&#160;</div><div class="line"><a name="l04497"></a><span class="lineno"> 4497</span>&#160;  <span class="comment">// Find a representation of the matrices of the computation as pairs</span></div><div class="line"><a name="l04498"></a><span class="lineno"> 4498</span>&#160;  <span class="comment">// (unique_id, time_offset) that are more amenable to finding</span></div><div class="line"><a name="l04499"></a><span class="lineno"> 4499</span>&#160;  <span class="comment">// matrices that represet lists of Cindexes that differ only by</span></div><div class="line"><a name="l04500"></a><span class="lineno"> 4500</span>&#160;  <span class="comment">// a time offset.</span></div><div class="line"><a name="l04501"></a><span class="lineno"> 4501</span>&#160;  std::vector&lt;std::pair&lt;int32, int32&gt; &gt; matrix_to_pair;</div><div class="line"><a name="l04502"></a><span class="lineno"> 4502</span>&#160;  CreateMatrixPairs(*<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>, &amp;matrix_to_pair);</div><div class="line"><a name="l04503"></a><span class="lineno"> 4503</span>&#160;</div><div class="line"><a name="l04504"></a><span class="lineno"> 4504</span>&#160;  <span class="comment">// Create the reverse map from pair to matrix index; we&#39;ll need it later.</span></div><div class="line"><a name="l04505"></a><span class="lineno"> 4505</span>&#160;  unordered_map&lt;std::pair&lt;int32, int32&gt;, int32, <a class="code" href="structkaldi_1_1PairHasher.html">PairHasher&lt;int32&gt;</a> &gt; pair_to_matrix;</div><div class="line"><a name="l04506"></a><span class="lineno"> 4506</span>&#160;  GetPairToMatrixMap(matrix_to_pair, &amp;pair_to_matrix);</div><div class="line"><a name="l04507"></a><span class="lineno"> 4507</span>&#160;</div><div class="line"><a name="l04508"></a><span class="lineno"> 4508</span>&#160;  <span class="comment">// get lists of matrix per splice-point in the pair representation.</span></div><div class="line"><a name="l04509"></a><span class="lineno"> 4509</span>&#160;  std::vector&lt;std::vector&lt;std::pair&lt;int32, int32&gt; &gt; &gt; pair_lists;</div><div class="line"><a name="l04510"></a><span class="lineno"> 4510</span>&#160;  ConvertListsToPairLists(active_matrices, matrix_to_pair,</div><div class="line"><a name="l04511"></a><span class="lineno"> 4511</span>&#160;                          &amp;pair_lists);</div><div class="line"><a name="l04512"></a><span class="lineno"> 4512</span>&#160;</div><div class="line"><a name="l04513"></a><span class="lineno"> 4513</span>&#160;  <span class="comment">// Note: seg1 and seg2 are indexes into &#39;splice_points&#39;, representing</span></div><div class="line"><a name="l04514"></a><span class="lineno"> 4514</span>&#160;  <span class="comment">// potential splice points (located near the beginnings of segments).</span></div><div class="line"><a name="l04515"></a><span class="lineno"> 4515</span>&#160;  int32 seg1, seg2;</div><div class="line"><a name="l04516"></a><span class="lineno"> 4516</span>&#160;  <span class="keywordflow">if</span> (!FindFirstRepeat(pair_lists,</div><div class="line"><a name="l04517"></a><span class="lineno"> 4517</span>&#160;                       time_shift_per_segment,</div><div class="line"><a name="l04518"></a><span class="lineno"> 4518</span>&#160;                       &amp;seg1, &amp;seg2)) {</div><div class="line"><a name="l04519"></a><span class="lineno"> 4519</span>&#160;    <a class="code" href="group__error__group.html#ga16c81ec6ff3ba04c6ff96fdaed9d854e">KALDI_VLOG</a>(2) &lt;&lt; <span class="stringliteral">&quot;Could not find repeats of variables.&quot;</span>;</div><div class="line"><a name="l04520"></a><span class="lineno"> 4520</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l04521"></a><span class="lineno"> 4521</span>&#160;  }</div><div class="line"><a name="l04522"></a><span class="lineno"> 4522</span>&#160;</div><div class="line"><a name="l04523"></a><span class="lineno"> 4523</span>&#160;  std::vector&lt;int32&gt; seg1_matrices, seg2_matrices;</div><div class="line"><a name="l04524"></a><span class="lineno"> 4524</span>&#160;  GetIdentifiedMatrices(pair_lists[seg1], pair_lists[seg2],</div><div class="line"><a name="l04525"></a><span class="lineno"> 4525</span>&#160;                        pair_to_matrix,</div><div class="line"><a name="l04526"></a><span class="lineno"> 4526</span>&#160;                        &amp;seg1_matrices, &amp;seg2_matrices);</div><div class="line"><a name="l04527"></a><span class="lineno"> 4527</span>&#160;</div><div class="line"><a name="l04528"></a><span class="lineno"> 4528</span>&#160;  int32 time_difference = time_shift_per_segment * (seg2 - seg1);</div><div class="line"><a name="l04529"></a><span class="lineno"> 4529</span>&#160;  CheckIdentifiedMatrices(*<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>, seg1_matrices, seg2_matrices,</div><div class="line"><a name="l04530"></a><span class="lineno"> 4530</span>&#160;                          time_difference);</div><div class="line"><a name="l04531"></a><span class="lineno"> 4531</span>&#160;</div><div class="line"><a name="l04532"></a><span class="lineno"> 4532</span>&#160;  FormInfiniteLoop(splice_points[seg1], splice_points[seg2], <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>);</div><div class="line"><a name="l04533"></a><span class="lineno"> 4533</span>&#160;</div><div class="line"><a name="l04534"></a><span class="lineno"> 4534</span>&#160;  AddMatrixSwapCommands(seg1_matrices, seg2_matrices, <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>);</div><div class="line"><a name="l04535"></a><span class="lineno"> 4535</span>&#160;</div><div class="line"><a name="l04536"></a><span class="lineno"> 4536</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a6828e427bd8883455705e0c9b99b5f2f">RenumberComputation</a>(<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>);</div><div class="line"><a name="l04537"></a><span class="lineno"> 4537</span>&#160;</div><div class="line"><a name="l04538"></a><span class="lineno"> 4538</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a8953a6af8e449d7cc12efeb115c5f8d2">FixGotoLabel</a>(<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>);</div><div class="line"><a name="l04539"></a><span class="lineno"> 4539</span>&#160;</div><div class="line"><a name="l04540"></a><span class="lineno"> 4540</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l04541"></a><span class="lineno"> 4541</span>&#160;}</div><div class="line"><a name="l04542"></a><span class="lineno"> 4542</span>&#160;</div><div class="line"><a name="l04543"></a><span class="lineno"> 4543</span>&#160;</div><div class="line"><a name="l04544"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#abb347167ff71d1cd8a2ab35b6eb2f636"> 4544</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#abb347167ff71d1cd8a2ab35b6eb2f636">OptimizeLoopedComputation</a>(<span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;nnet,</div><div class="line"><a name="l04545"></a><span class="lineno"> 4545</span>&#160;                               <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation) {</div><div class="line"><a name="l04546"></a><span class="lineno"> 4546</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html">ComputationLoopedOptimizer</a> optimizer(nnet, computation);</div><div class="line"><a name="l04547"></a><span class="lineno"> 4547</span>&#160;  optimizer.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#acdecf85ba9844b9db2d0649ff34139c8">Optimize</a>();</div><div class="line"><a name="l04548"></a><span class="lineno"> 4548</span>&#160;}</div><div class="line"><a name="l04549"></a><span class="lineno"> 4549</span>&#160;</div><div class="line"><a name="l04550"></a><span class="lineno"> 4550</span>&#160;</div><div class="line"><a name="l04551"></a><span class="lineno"> 4551</span>&#160;</div><div class="line"><a name="l04552"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a8953a6af8e449d7cc12efeb115c5f8d2"> 4552</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a8953a6af8e449d7cc12efeb115c5f8d2">FixGotoLabel</a>(<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation) {</div><div class="line"><a name="l04553"></a><span class="lineno"> 4553</span>&#160;  int32 num_commands = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size();</div><div class="line"><a name="l04554"></a><span class="lineno"> 4554</span>&#160;  <span class="keywordflow">if</span> (num_commands == 0)</div><div class="line"><a name="l04555"></a><span class="lineno"> 4555</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l04556"></a><span class="lineno"> 4556</span>&#160;  <span class="keywordflow">for</span> (int32 c = num_commands - 1; c &gt;= 0; c--) {</div><div class="line"><a name="l04557"></a><span class="lineno"> 4557</span>&#160;    <span class="keywordflow">if</span> (computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[c].command_type == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352add9060e8c7434f250048082c634d9a6d">kGotoLabel</a>) {</div><div class="line"><a name="l04558"></a><span class="lineno"> 4558</span>&#160;      int32 dest_command = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[c].arg1;</div><div class="line"><a name="l04559"></a><span class="lineno"> 4559</span>&#160;      <span class="keywordflow">if</span> (static_cast&lt;size_t&gt;(dest_command) &lt;  computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size() &amp;&amp;</div><div class="line"><a name="l04560"></a><span class="lineno"> 4560</span>&#160;          computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[dest_command].command_type == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a967844c2c7775d280d15738cbe852536">kNoOperationLabel</a>)</div><div class="line"><a name="l04561"></a><span class="lineno"> 4561</span>&#160;        <span class="keywordflow">return</span>;  <span class="comment">// nothing to fix.</span></div><div class="line"><a name="l04562"></a><span class="lineno"> 4562</span>&#160;      <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#a873684cefeb665f3d5e6b495de57fc0d">d</a> = 0; <a class="code" href="namespacernnlm.html#a873684cefeb665f3d5e6b495de57fc0d">d</a> + 1 &lt; num_commands; <a class="code" href="namespacernnlm.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>++) {</div><div class="line"><a name="l04563"></a><span class="lineno"> 4563</span>&#160;        <span class="keywordflow">if</span> (computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[<a class="code" href="namespacernnlm.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>].command_type == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a967844c2c7775d280d15738cbe852536">kNoOperationLabel</a>) {</div><div class="line"><a name="l04564"></a><span class="lineno"> 4564</span>&#160;          computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[c].arg1 = <a class="code" href="namespacernnlm.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>;</div><div class="line"><a name="l04565"></a><span class="lineno"> 4565</span>&#160;          <span class="keywordflow">return</span>;</div><div class="line"><a name="l04566"></a><span class="lineno"> 4566</span>&#160;        }</div><div class="line"><a name="l04567"></a><span class="lineno"> 4567</span>&#160;      }</div><div class="line"><a name="l04568"></a><span class="lineno"> 4568</span>&#160;      <a class="code" href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a> &lt;&lt; <span class="stringliteral">&quot;Label not found.&quot;</span>;</div><div class="line"><a name="l04569"></a><span class="lineno"> 4569</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[c].command_type == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352aaa3fd92744438323baec475cee5b9b3d">kProvideOutput</a>) {</div><div class="line"><a name="l04570"></a><span class="lineno"> 4570</span>&#160;      <span class="comment">// sometimes kProvideOutput commands are temporarily ordered after</span></div><div class="line"><a name="l04571"></a><span class="lineno"> 4571</span>&#160;      <span class="comment">// the kGotoLabel command, and we need to work in that case.</span></div><div class="line"><a name="l04572"></a><span class="lineno"> 4572</span>&#160;      <span class="keywordflow">continue</span>;</div><div class="line"><a name="l04573"></a><span class="lineno"> 4573</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04574"></a><span class="lineno"> 4574</span>&#160;      <span class="comment">// it loks like there is no &#39;goto&#39; command in this computation-</span></div><div class="line"><a name="l04575"></a><span class="lineno"> 4575</span>&#160;      <span class="comment">// if there were, it would be right at the end, possibly followed by</span></div><div class="line"><a name="l04576"></a><span class="lineno"> 4576</span>&#160;      <span class="comment">// kProvideOutput commands.</span></div><div class="line"><a name="l04577"></a><span class="lineno"> 4577</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l04578"></a><span class="lineno"> 4578</span>&#160;    }</div><div class="line"><a name="l04579"></a><span class="lineno"> 4579</span>&#160;  }</div><div class="line"><a name="l04580"></a><span class="lineno"> 4580</span>&#160;}</div><div class="line"><a name="l04581"></a><span class="lineno"> 4581</span>&#160;</div><div class="line"><a name="l04582"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#ac879380727c26962a7aaa4a6de9dc4d4"> 4582</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="namespacekaldi_1_1nnet3.html#ac879380727c26962a7aaa4a6de9dc4d4">MatrixIsUnused</a>(<span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html">Analyzer</a> &amp;analyzer,</div><div class="line"><a name="l04583"></a><span class="lineno"> 4583</span>&#160;                    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> &amp;computation,</div><div class="line"><a name="l04584"></a><span class="lineno"> 4584</span>&#160;                    int32 m) {</div><div class="line"><a name="l04585"></a><span class="lineno"> 4585</span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html">MatrixAccesses</a> &amp;accesses = analyzer.<a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html#a1451c041c35be895025d122f136b9959">matrix_accesses</a>[m];</div><div class="line"><a name="l04586"></a><span class="lineno"> 4586</span>&#160;  <span class="keywordflow">if</span> (accesses.<a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#aa8a8ede92285acbe2795e8570b81c9ae">is_input</a> || accesses.<a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#a7464ec491eeba4c23632a6ae583e9429">is_output</a>)</div><div class="line"><a name="l04587"></a><span class="lineno"> 4587</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l04588"></a><span class="lineno"> 4588</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; accesses.<a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#a36b3030ce98db1e72110930473d8b93e">accesses</a>.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l04589"></a><span class="lineno"> 4589</span>&#160;    int32 command_index = accesses.<a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#a36b3030ce98db1e72110930473d8b93e">accesses</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].command_index;</div><div class="line"><a name="l04590"></a><span class="lineno"> 4590</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;command =</div><div class="line"><a name="l04591"></a><span class="lineno"> 4591</span>&#160;        computation.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l04592"></a><span class="lineno"> 4592</span>&#160;    <span class="keywordflow">if</span> (command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> != <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a> &amp;&amp;</div><div class="line"><a name="l04593"></a><span class="lineno"> 4593</span>&#160;        command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> != <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a55f8cb2bfd2e2c3605dfa961eff35fa2">kSetConst</a>) {</div><div class="line"><a name="l04594"></a><span class="lineno"> 4594</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l04595"></a><span class="lineno"> 4595</span>&#160;    }</div><div class="line"><a name="l04596"></a><span class="lineno"> 4596</span>&#160;  }</div><div class="line"><a name="l04597"></a><span class="lineno"> 4597</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l04598"></a><span class="lineno"> 4598</span>&#160;}</div><div class="line"><a name="l04599"></a><span class="lineno"> 4599</span>&#160;</div><div class="line"><a name="l04600"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#af53fca33c55f05968eab8ec1009509e6"> 4600</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#af53fca33c55f05968eab8ec1009509e6">RemoveCommandsForUnusedMatrix</a>(<span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html">Analyzer</a> &amp;analyzer,</div><div class="line"><a name="l04601"></a><span class="lineno"> 4601</span>&#160;                                   int32 m,</div><div class="line"><a name="l04602"></a><span class="lineno"> 4602</span>&#160;                                   <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation) {</div><div class="line"><a name="l04603"></a><span class="lineno"> 4603</span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html">MatrixAccesses</a> &amp;accesses = analyzer.<a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html#a1451c041c35be895025d122f136b9959">matrix_accesses</a>[m];</div><div class="line"><a name="l04604"></a><span class="lineno"> 4604</span>&#160;  <span class="keywordflow">if</span> (accesses.<a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#a6a26bfae0a795d6987c7db2476fdda1a">allocate_command</a> &gt;= 0) {</div><div class="line"><a name="l04605"></a><span class="lineno"> 4605</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;command = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[</div><div class="line"><a name="l04606"></a><span class="lineno"> 4606</span>&#160;        accesses.<a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#a6a26bfae0a795d6987c7db2476fdda1a">allocate_command</a>];</div><div class="line"><a name="l04607"></a><span class="lineno"> 4607</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a> ||</div><div class="line"><a name="l04608"></a><span class="lineno"> 4608</span>&#160;                 command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a73b5995148c3e987c4a163ad6bc9850b">kAllocMatrix</a>);</div><div class="line"><a name="l04609"></a><span class="lineno"> 4609</span>&#160;    command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l04610"></a><span class="lineno"> 4610</span>&#160;  }</div><div class="line"><a name="l04611"></a><span class="lineno"> 4611</span>&#160;  <span class="keywordflow">if</span> (accesses.<a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#a7ca773444a9de6d9f8c01f693ec4ab16">deallocate_command</a> &gt;= 0) {</div><div class="line"><a name="l04612"></a><span class="lineno"> 4612</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;command = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[</div><div class="line"><a name="l04613"></a><span class="lineno"> 4613</span>&#160;        accesses.<a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#a7ca773444a9de6d9f8c01f693ec4ab16">deallocate_command</a>];</div><div class="line"><a name="l04614"></a><span class="lineno"> 4614</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a> ||</div><div class="line"><a name="l04615"></a><span class="lineno"> 4615</span>&#160;                 command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae77588ab7fc4ccf842de7ec941247062">kDeallocMatrix</a>);</div><div class="line"><a name="l04616"></a><span class="lineno"> 4616</span>&#160;    command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l04617"></a><span class="lineno"> 4617</span>&#160;  }</div><div class="line"><a name="l04618"></a><span class="lineno"> 4618</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; accesses.<a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#a36b3030ce98db1e72110930473d8b93e">accesses</a>.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l04619"></a><span class="lineno"> 4619</span>&#160;    int32 command_index = accesses.<a class="code" href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#a36b3030ce98db1e72110930473d8b93e">accesses</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].command_index;</div><div class="line"><a name="l04620"></a><span class="lineno"> 4620</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a> &amp;command = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[command_index];</div><div class="line"><a name="l04621"></a><span class="lineno"> 4621</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a> ||</div><div class="line"><a name="l04622"></a><span class="lineno"> 4622</span>&#160;                 command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a55f8cb2bfd2e2c3605dfa961eff35fa2">kSetConst</a>);</div><div class="line"><a name="l04623"></a><span class="lineno"> 4623</span>&#160;    command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> = <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kNoOperation</a>;</div><div class="line"><a name="l04624"></a><span class="lineno"> 4624</span>&#160;  }</div><div class="line"><a name="l04625"></a><span class="lineno"> 4625</span>&#160;}</div><div class="line"><a name="l04626"></a><span class="lineno"> 4626</span>&#160;</div><div class="line"><a name="l04627"></a><span class="lineno"> 4627</span>&#160;</div><div class="line"><a name="l04628"></a><span class="lineno"> 4628</span>&#160;</div><div class="line"><a name="l04629"></a><span class="lineno"> 4629</span>&#160;<span class="comment">// This comparison operator is used in the function InsertCommands()</span></div><div class="line"><a name="l04630"></a><span class="lineno"> 4630</span>&#160;<span class="comment">// to sort a list of these pairs by the .first element.</span></div><div class="line"><a name="l04631"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1CommandPairComparator.html"> 4631</a></span>&#160;<span class="keyword">struct </span><a class="code" href="structkaldi_1_1nnet3_1_1CommandPairComparator.html">CommandPairComparator</a> {</div><div class="line"><a name="l04632"></a><span class="lineno"> 4632</span>&#160;  <span class="comment">// operator () should be viewed as a &#39;&lt;&#39; operator that only looks at</span></div><div class="line"><a name="l04633"></a><span class="lineno"> 4633</span>&#160;  <span class="comment">// the .first element, treating the .second elements as equal.</span></div><div class="line"><a name="l04634"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1CommandPairComparator.html#a0ef8df1e34ea03262a7c6b01098f41d4"> 4634</a></span>&#160;  <span class="keywordtype">bool</span> operator () (<span class="keyword">const</span> std::pair&lt;int32, NnetComputation::Command&gt; &amp;p1,</div><div class="line"><a name="l04635"></a><span class="lineno"> 4635</span>&#160;                    <span class="keyword">const</span> std::pair&lt;int32, NnetComputation::Command&gt; &amp;p2)<span class="keyword"> const </span>{</div><div class="line"><a name="l04636"></a><span class="lineno"> 4636</span>&#160;    <span class="keywordflow">return</span> p1.first &lt; p2.first;</div><div class="line"><a name="l04637"></a><span class="lineno"> 4637</span>&#160;  }</div><div class="line"><a name="l04638"></a><span class="lineno"> 4638</span>&#160;};</div><div class="line"><a name="l04639"></a><span class="lineno"> 4639</span>&#160;</div><div class="line"><a name="l04640"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a0cc731e05d6603b7d4d0191f9f1c9d32"> 4640</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a0cc731e05d6603b7d4d0191f9f1c9d32">InsertCommands</a>(</div><div class="line"><a name="l04641"></a><span class="lineno"> 4641</span>&#160;    std::vector&lt;std::pair&lt;int32, NnetComputation::Command&gt; &gt; *new_commands,</div><div class="line"><a name="l04642"></a><span class="lineno"> 4642</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation) {</div><div class="line"><a name="l04643"></a><span class="lineno"> 4643</span>&#160;  int32 num_new_commands = new_commands-&gt;size(),</div><div class="line"><a name="l04644"></a><span class="lineno"> 4644</span>&#160;      num_old_commands = computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size();</div><div class="line"><a name="l04645"></a><span class="lineno"> 4645</span>&#160;  <span class="keywordflow">if</span> (num_new_commands == 0)</div><div class="line"><a name="l04646"></a><span class="lineno"> 4646</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l04647"></a><span class="lineno"> 4647</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1CommandPairComparator.html">CommandPairComparator</a> comparison_operator;</div><div class="line"><a name="l04648"></a><span class="lineno"> 4648</span>&#160;  <span class="comment">// use std::stable_sort so that for entries in &#39;new_commands&#39; that</span></div><div class="line"><a name="l04649"></a><span class="lineno"> 4649</span>&#160;  <span class="comment">// have the same .first value, they stay in the same order they were</span></div><div class="line"><a name="l04650"></a><span class="lineno"> 4650</span>&#160;  <span class="comment">// in before sorting.</span></div><div class="line"><a name="l04651"></a><span class="lineno"> 4651</span>&#160;  std::stable_sort(new_commands-&gt;begin(), new_commands-&gt;end(),</div><div class="line"><a name="l04652"></a><span class="lineno"> 4652</span>&#160;                   comparison_operator);</div><div class="line"><a name="l04653"></a><span class="lineno"> 4653</span>&#160;</div><div class="line"><a name="l04654"></a><span class="lineno"> 4654</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="namespacekaldi.html#a0361eab3c5ebb78e6be060e6fa78e1a1">RandInt</a>(0, 3) == 0) {   <span class="comment">// check &#39;new_commands&#39;</span></div><div class="line"><a name="l04655"></a><span class="lineno"> 4655</span>&#160;    <span class="keywordflow">for</span> (int32 <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> + 1 &lt; num_new_commands; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l04656"></a><span class="lineno"> 4656</span>&#160;      <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>((*new_commands)[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].first &lt;= (*new_commands)[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>+1].first &amp;&amp;</div><div class="line"><a name="l04657"></a><span class="lineno"> 4657</span>&#160;                   (*new_commands)[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].first &gt;= 0 &amp;&amp;</div><div class="line"><a name="l04658"></a><span class="lineno"> 4658</span>&#160;                   (*new_commands)[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>+1].first &lt;= num_old_commands);</div><div class="line"><a name="l04659"></a><span class="lineno"> 4659</span>&#160;    }</div><div class="line"><a name="l04660"></a><span class="lineno"> 4660</span>&#160;  }</div><div class="line"><a name="l04661"></a><span class="lineno"> 4661</span>&#160;  std::vector&lt;NnetComputation::Command&gt; merged_commands;</div><div class="line"><a name="l04662"></a><span class="lineno"> 4662</span>&#160;  merged_commands.reserve(num_old_commands + num_new_commands);</div><div class="line"><a name="l04663"></a><span class="lineno"> 4663</span>&#160;</div><div class="line"><a name="l04664"></a><span class="lineno"> 4664</span>&#160;  std::vector&lt;std::pair&lt;int32, NnetComputation::Command&gt; &gt;::const_iterator</div><div class="line"><a name="l04665"></a><span class="lineno"> 4665</span>&#160;      new_commands_iter = new_commands-&gt;begin(),</div><div class="line"><a name="l04666"></a><span class="lineno"> 4666</span>&#160;      new_commands_end = new_commands-&gt;end();</div><div class="line"><a name="l04667"></a><span class="lineno"> 4667</span>&#160;</div><div class="line"><a name="l04668"></a><span class="lineno"> 4668</span>&#160;  <span class="keywordflow">for</span> (int32 old_command_index = 0; old_command_index &lt;= num_old_commands;</div><div class="line"><a name="l04669"></a><span class="lineno"> 4669</span>&#160;       old_command_index++) {</div><div class="line"><a name="l04670"></a><span class="lineno"> 4670</span>&#160;    <span class="keywordflow">while</span> (new_commands_iter != new_commands_end &amp;&amp;</div><div class="line"><a name="l04671"></a><span class="lineno"> 4671</span>&#160;           new_commands_iter-&gt;first &lt;= old_command_index) {</div><div class="line"><a name="l04672"></a><span class="lineno"> 4672</span>&#160;      merged_commands.push_back(new_commands_iter-&gt;second);</div><div class="line"><a name="l04673"></a><span class="lineno"> 4673</span>&#160;      ++new_commands_iter;</div><div class="line"><a name="l04674"></a><span class="lineno"> 4674</span>&#160;    }</div><div class="line"><a name="l04675"></a><span class="lineno"> 4675</span>&#160;    <span class="keywordflow">if</span> (old_command_index &lt; num_old_commands)</div><div class="line"><a name="l04676"></a><span class="lineno"> 4676</span>&#160;      merged_commands.push_back(computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[old_command_index]);</div><div class="line"><a name="l04677"></a><span class="lineno"> 4677</span>&#160;  }</div><div class="line"><a name="l04678"></a><span class="lineno"> 4678</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(merged_commands.size() == num_old_commands +</div><div class="line"><a name="l04679"></a><span class="lineno"> 4679</span>&#160;               num_new_commands);</div><div class="line"><a name="l04680"></a><span class="lineno"> 4680</span>&#160;  <span class="comment">// copy to &#39;computation-&gt;commands&#39; via shallow swap.</span></div><div class="line"><a name="l04681"></a><span class="lineno"> 4681</span>&#160;  computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.swap(merged_commands);</div><div class="line"><a name="l04682"></a><span class="lineno"> 4682</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a8953a6af8e449d7cc12efeb115c5f8d2">FixGotoLabel</a>(computation);</div><div class="line"><a name="l04683"></a><span class="lineno"> 4683</span>&#160;}</div><div class="line"><a name="l04684"></a><span class="lineno"> 4684</span>&#160;</div><div class="line"><a name="l04690"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html"> 4690</a></span>&#160;<span class="keyword">class </span><a class="code" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html">MemoryCompressionOptimizer</a> {</div><div class="line"><a name="l04691"></a><span class="lineno"> 4691</span>&#160; <span class="keyword">public</span>:</div><div class="line"><a name="l04692"></a><span class="lineno"> 4692</span>&#160;</div><div class="line"><a name="l04703"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a9c5be1c635342710540a8f6c675625d8"> 4703</a></span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a9c5be1c635342710540a8f6c675625d8">MemoryCompressionOptimizer</a>(<span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;nnet,</div><div class="line"><a name="l04704"></a><span class="lineno"> 4704</span>&#160;                             int32 memory_compression_level,</div><div class="line"><a name="l04705"></a><span class="lineno"> 4705</span>&#160;                             int32 middle_command,</div><div class="line"><a name="l04706"></a><span class="lineno"> 4706</span>&#160;                             <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation):</div><div class="line"><a name="l04707"></a><span class="lineno"> 4707</span>&#160;      <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#adbabf05a7702103113a02a113015205f">nnet_</a>(nnet), memory_compression_level_(memory_compression_level),</div><div class="line"><a name="l04708"></a><span class="lineno"> 4708</span>&#160;      middle_command_(middle_command), <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>(computation) { }</div><div class="line"><a name="l04709"></a><span class="lineno"> 4709</span>&#160;</div><div class="line"><a name="l04710"></a><span class="lineno"> 4710</span>&#160;  <span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a602819d33d3a59c128aa4e865e610e14">Optimize</a>();</div><div class="line"><a name="l04711"></a><span class="lineno"> 4711</span>&#160; <span class="keyword">private</span>:</div><div class="line"><a name="l04712"></a><span class="lineno"> 4712</span>&#160;</div><div class="line"><a name="l04713"></a><span class="lineno"> 4713</span>&#160;  <span class="comment">// This function, called from Compress(), figures out whether we can compress</span></div><div class="line"><a name="l04714"></a><span class="lineno"> 4714</span>&#160;  <span class="comment">// matrix m, and if so, adds an entry to compress_info_.</span></div><div class="line"><a name="l04715"></a><span class="lineno"> 4715</span>&#160;  <span class="keywordtype">void</span> ProcessMatrix(int32 m);</div><div class="line"><a name="l04716"></a><span class="lineno"> 4716</span>&#160;</div><div class="line"><a name="l04717"></a><span class="lineno"> 4717</span>&#160;  <span class="comment">// This function modifies the commands in &#39;*computation_&#39;, taking</span></div><div class="line"><a name="l04718"></a><span class="lineno"> 4718</span>&#160;  <span class="comment">// as input the commands in compress_info_.</span></div><div class="line"><a name="l04719"></a><span class="lineno"> 4719</span>&#160;  <span class="keywordtype">void</span> ModifyComputation();</div><div class="line"><a name="l04720"></a><span class="lineno"> 4720</span>&#160;</div><div class="line"><a name="l04721"></a><span class="lineno"> 4721</span>&#160;  <span class="comment">// While deciding what matrices to compress we will create a list of structs</span></div><div class="line"><a name="l04722"></a><span class="lineno"> 4722</span>&#160;  <span class="comment">// of type MatrixCompressInfo.  Later we copy-and-modify the commands in the</span></div><div class="line"><a name="l04723"></a><span class="lineno"> 4723</span>&#160;  <span class="comment">// computation, putting the compression commands into their appropriate place.</span></div><div class="line"><a name="l04724"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html"> 4724</a></span>&#160;  <span class="keyword">struct </span><a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html">MatrixCompressInfo</a> {</div><div class="line"><a name="l04725"></a><span class="lineno"> 4725</span>&#160;    <span class="comment">// m is the matrix-index of the matrix we&#39;re going to compress.</span></div><div class="line"><a name="l04726"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#ae9d62983f13507bd8805be92eb61a2a4"> 4726</a></span>&#160;    int32 <a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#ae9d62983f13507bd8805be92eb61a2a4">m</a>;</div><div class="line"><a name="l04727"></a><span class="lineno"> 4727</span>&#160;    <span class="comment">// compression_command_index is the command-index of the command</span></div><div class="line"><a name="l04728"></a><span class="lineno"> 4728</span>&#160;    <span class="comment">// *after* which we will place the compression command.  Normally</span></div><div class="line"><a name="l04729"></a><span class="lineno"> 4729</span>&#160;    <span class="comment">// this will be some type of propagation.</span></div><div class="line"><a name="l04730"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#a3177807d10c7537255bcfdc9122b1212"> 4730</a></span>&#160;    int32 <a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#a3177807d10c7537255bcfdc9122b1212">compression_command_index</a>;</div><div class="line"><a name="l04731"></a><span class="lineno"> 4731</span>&#160;    <span class="comment">// compression_command_index is the command-index of the command</span></div><div class="line"><a name="l04732"></a><span class="lineno"> 4732</span>&#160;    <span class="comment">// *before* which we will place the uncompression command.  Normally</span></div><div class="line"><a name="l04733"></a><span class="lineno"> 4733</span>&#160;    <span class="comment">// this will be some type of backprop.</span></div><div class="line"><a name="l04734"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#a0551990c4556cf74e0f29c68c3294e31"> 4734</a></span>&#160;    int32 <a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#a0551990c4556cf74e0f29c68c3294e31">uncompression_command_index</a>;</div><div class="line"><a name="l04735"></a><span class="lineno"> 4735</span>&#160;    <span class="comment">// &#39;compression_type&#39; (e.g. kCompressedMatrixInt8) determines the type</span></div><div class="line"><a name="l04736"></a><span class="lineno"> 4736</span>&#160;    <span class="comment">// we compress the BaseFloats to.</span></div><div class="line"><a name="l04737"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#ad965a774d4c06790fec9f890f9698128"> 4737</a></span>&#160;    <a class="code" href="namespacekaldi.html#a6a81f9c498a2d703ea343d906a827b6f">CuCompressedMatrixType</a> <a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#ad965a774d4c06790fec9f890f9698128">compression_type</a>;</div><div class="line"><a name="l04738"></a><span class="lineno"> 4738</span>&#160;    <span class="comment">// &#39;range&#39; determines range of values that the compressed values can</span></div><div class="line"><a name="l04739"></a><span class="lineno"> 4739</span>&#160;    <span class="comment">// be in: for signed types they are in [-range, range], for unsigned</span></div><div class="line"><a name="l04740"></a><span class="lineno"> 4740</span>&#160;    <span class="comment">// types, in [0, range].</span></div><div class="line"><a name="l04741"></a><span class="lineno"> 4741</span>&#160;    <span class="comment">// As a special case, range = 0 means that the compression just stores the</span></div><div class="line"><a name="l04742"></a><span class="lineno"> 4742</span>&#160;    <span class="comment">// sign (-1, 0 or 1) of the input, and decompresses it to -1, 0 or 1; this</span></div><div class="line"><a name="l04743"></a><span class="lineno"> 4743</span>&#160;    <span class="comment">// is useful for ReLUs.</span></div><div class="line"><a name="l04744"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#a54fa0913d637257d7c7afa7a393b9fdf"> 4744</a></span>&#160;    <a class="code" href="classfloat.html">BaseFloat</a> <a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#a54fa0913d637257d7c7afa7a393b9fdf">range</a>;</div><div class="line"><a name="l04745"></a><span class="lineno"> 4745</span>&#160;    <span class="comment">// this is provided to the initializer of CuCompressedMatrix; it should</span></div><div class="line"><a name="l04746"></a><span class="lineno"> 4746</span>&#160;    <span class="comment">// be true if the values being compressed are potentially outside of</span></div><div class="line"><a name="l04747"></a><span class="lineno"> 4747</span>&#160;    <span class="comment">// the representable range.</span></div><div class="line"><a name="l04748"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#a1c577ae5458f02e60819f016514cdeed"> 4748</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#a1c577ae5458f02e60819f016514cdeed">truncate</a>;</div><div class="line"><a name="l04749"></a><span class="lineno"><a class="line" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#af204d5e92149d32574e14fc5416092af"> 4749</a></span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#af204d5e92149d32574e14fc5416092af">MatrixCompressInfo</a>(int32 m, int32 forward_command_index,</div><div class="line"><a name="l04750"></a><span class="lineno"> 4750</span>&#160;                       int32 backward_command_index,</div><div class="line"><a name="l04751"></a><span class="lineno"> 4751</span>&#160;                       <a class="code" href="namespacekaldi.html#a6a81f9c498a2d703ea343d906a827b6f">CuCompressedMatrixType</a> compression_type,</div><div class="line"><a name="l04752"></a><span class="lineno"> 4752</span>&#160;                       <a class="code" href="classfloat.html">BaseFloat</a> range, <span class="keywordtype">bool</span> truncate):</div><div class="line"><a name="l04753"></a><span class="lineno"> 4753</span>&#160;        m(m), compression_command_index(forward_command_index),</div><div class="line"><a name="l04754"></a><span class="lineno"> 4754</span>&#160;        uncompression_command_index(backward_command_index),</div><div class="line"><a name="l04755"></a><span class="lineno"> 4755</span>&#160;        compression_type(compression_type), range(range),</div><div class="line"><a name="l04756"></a><span class="lineno"> 4756</span>&#160;        truncate(truncate) { }</div><div class="line"><a name="l04757"></a><span class="lineno"> 4757</span>&#160;</div><div class="line"><a name="l04758"></a><span class="lineno"> 4758</span>&#160;  };</div><div class="line"><a name="l04759"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a863b06831c83977ed474b5896a02a579"> 4759</a></span>&#160;  std::vector&lt;MatrixCompressInfo&gt; <a class="code" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a863b06831c83977ed474b5896a02a579">compress_info_</a>;</div><div class="line"><a name="l04760"></a><span class="lineno"> 4760</span>&#160;</div><div class="line"><a name="l04761"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#adbabf05a7702103113a02a113015205f"> 4761</a></span>&#160;  <span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;<a class="code" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#adbabf05a7702103113a02a113015205f">nnet_</a>;</div><div class="line"><a name="l04762"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a715006dc6c8d8855816051d40a2c1944"> 4762</a></span>&#160;  int32 <a class="code" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a715006dc6c8d8855816051d40a2c1944">memory_compression_level_</a>;</div><div class="line"><a name="l04763"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#ac098379dcf820792fc77cd03a42c759e"> 4763</a></span>&#160;  int32 <a class="code" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#ac098379dcf820792fc77cd03a42c759e">middle_command_</a>;</div><div class="line"><a name="l04764"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a36d13565d1302a2bf74127b141ba3537"> 4764</a></span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *<a class="code" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>;</div><div class="line"><a name="l04765"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#ac8ca96df1ecdb635738c59a88cff8835"> 4765</a></span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1Analyzer.html">Analyzer</a> <a class="code" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#ac8ca96df1ecdb635738c59a88cff8835">analyzer_</a>;</div><div class="line"><a name="l04766"></a><span class="lineno"> 4766</span>&#160;};</div><div class="line"><a name="l04767"></a><span class="lineno"> 4767</span>&#160;</div><div class="line"><a name="l04768"></a><span class="lineno"> 4768</span>&#160;</div><div class="line"><a name="l04769"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a3cdcac57cf79079fc211c29b6d4cb8dc"> 4769</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a3cdcac57cf79079fc211c29b6d4cb8dc">MemoryCompressionOptimizer::ModifyComputation</a>() {</div><div class="line"><a name="l04770"></a><span class="lineno"> 4770</span>&#160;  <span class="comment">// whole_submatrices[m] is the submatrix-index of the submatrix that</span></div><div class="line"><a name="l04771"></a><span class="lineno"> 4771</span>&#160;  <span class="comment">// represents the whole of matrix m.</span></div><div class="line"><a name="l04772"></a><span class="lineno"> 4772</span>&#160;  std::vector&lt;int32&gt; whole_submatrices;</div><div class="line"><a name="l04773"></a><span class="lineno"> 4773</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ac6ad0d391be80aff8f4538b6fbf747b1">GetWholeSubmatrices</a>(&amp;whole_submatrices);</div><div class="line"><a name="l04774"></a><span class="lineno"> 4774</span>&#160;</div><div class="line"><a name="l04775"></a><span class="lineno"> 4775</span>&#160;  <span class="comment">// &#39;pairs_to_insert&#39; will be a list of pairs (command-index, command),</span></div><div class="line"><a name="l04776"></a><span class="lineno"> 4776</span>&#160;  <span class="comment">// meaning: (command-index just before which to insert this command; command</span></div><div class="line"><a name="l04777"></a><span class="lineno"> 4777</span>&#160;  <span class="comment">// to insert).</span></div><div class="line"><a name="l04778"></a><span class="lineno"> 4778</span>&#160;  std::vector&lt;std::pair&lt;int32, NnetComputation::Command&gt; &gt;</div><div class="line"><a name="l04779"></a><span class="lineno"> 4779</span>&#160;      pairs_to_insert;</div><div class="line"><a name="l04780"></a><span class="lineno"> 4780</span>&#160;  pairs_to_insert.reserve(compress_info_.size() * 2);</div><div class="line"><a name="l04781"></a><span class="lineno"> 4781</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; compress_info_.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l04782"></a><span class="lineno"> 4782</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html">MatrixCompressInfo</a> &amp;info = compress_info_[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div><div class="line"><a name="l04783"></a><span class="lineno"> 4783</span>&#160;    int32 s = whole_submatrices[info.<a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#ae9d62983f13507bd8805be92eb61a2a4">m</a>];</div><div class="line"><a name="l04784"></a><span class="lineno"> 4784</span>&#160;    <span class="comment">// below we use compression_command_index + 1 because we want the</span></div><div class="line"><a name="l04785"></a><span class="lineno"> 4785</span>&#160;    <span class="comment">// compression to go after the command in &#39;info.compression_command_index&#39;</span></div><div class="line"><a name="l04786"></a><span class="lineno"> 4786</span>&#160;    <span class="comment">// (which might be, for instance, a forward propagation command).</span></div><div class="line"><a name="l04787"></a><span class="lineno"> 4787</span>&#160;    std::pair&lt;int32, NnetComputation::Command&gt; p1(</div><div class="line"><a name="l04788"></a><span class="lineno"> 4788</span>&#160;        info.<a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#a3177807d10c7537255bcfdc9122b1212">compression_command_index</a> + 1,</div><div class="line"><a name="l04789"></a><span class="lineno"> 4789</span>&#160;        <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a>(info.<a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#a54fa0913d637257d7c7afa7a393b9fdf">range</a>, <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a19758aa995e3baa1aa2cef6528d10fb9">kCompressMatrix</a>,</div><div class="line"><a name="l04790"></a><span class="lineno"> 4790</span>&#160;                                 s, static_cast&lt;int32&gt;(info.<a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#ad965a774d4c06790fec9f890f9698128">compression_type</a>),</div><div class="line"><a name="l04791"></a><span class="lineno"> 4791</span>&#160;                                 info.<a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#a1c577ae5458f02e60819f016514cdeed">truncate</a> ? 1 : 0));</div><div class="line"><a name="l04792"></a><span class="lineno"> 4792</span>&#160;    pairs_to_insert.push_back(p1);</div><div class="line"><a name="l04793"></a><span class="lineno"> 4793</span>&#160;    std::pair&lt;int32, NnetComputation::Command&gt; p2(</div><div class="line"><a name="l04794"></a><span class="lineno"> 4794</span>&#160;        info.<a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#a0551990c4556cf74e0f29c68c3294e31">uncompression_command_index</a>,</div><div class="line"><a name="l04795"></a><span class="lineno"> 4795</span>&#160;        <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a>(1.0, <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a0260a200407f88708e5c2793506e4ada">kDecompressMatrix</a>, s));</div><div class="line"><a name="l04796"></a><span class="lineno"> 4796</span>&#160;    pairs_to_insert.push_back(p2);</div><div class="line"><a name="l04797"></a><span class="lineno"> 4797</span>&#160;  }</div><div class="line"><a name="l04798"></a><span class="lineno"> 4798</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a0cc731e05d6603b7d4d0191f9f1c9d32">InsertCommands</a>(&amp;pairs_to_insert,</div><div class="line"><a name="l04799"></a><span class="lineno"> 4799</span>&#160;                 <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>);</div><div class="line"><a name="l04800"></a><span class="lineno"> 4800</span>&#160;}</div><div class="line"><a name="l04801"></a><span class="lineno"> 4801</span>&#160;</div><div class="line"><a name="l04802"></a><span class="lineno"> 4802</span>&#160;</div><div class="line"><a name="l04803"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a2035ba0afa36778a6f4f664af777e7e6"> 4803</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a2035ba0afa36778a6f4f664af777e7e6">MemoryCompressionOptimizer::Optimize</a>() {</div><div class="line"><a name="l04804"></a><span class="lineno"> 4804</span>&#160;  analyzer_.Init(<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#adbabf05a7702103113a02a113015205f">nnet_</a>, *<a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>);</div><div class="line"><a name="l04805"></a><span class="lineno"> 4805</span>&#160;  <span class="comment">// note: matrix zero is not really a matrix.</span></div><div class="line"><a name="l04806"></a><span class="lineno"> 4806</span>&#160;  int32 num_matrices = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">matrices</a>.size();</div><div class="line"><a name="l04807"></a><span class="lineno"> 4807</span>&#160;  <span class="keywordflow">for</span> (int32 m = 1; m &lt; num_matrices; m++)</div><div class="line"><a name="l04808"></a><span class="lineno"> 4808</span>&#160;    ProcessMatrix(m);</div><div class="line"><a name="l04809"></a><span class="lineno"> 4809</span>&#160;  <span class="keywordflow">if</span> (!compress_info_.empty())</div><div class="line"><a name="l04810"></a><span class="lineno"> 4810</span>&#160;    ModifyComputation();</div><div class="line"><a name="l04811"></a><span class="lineno"> 4811</span>&#160;}</div><div class="line"><a name="l04812"></a><span class="lineno"> 4812</span>&#160;</div><div class="line"><a name="l04813"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#ae23a562cb4f08452e78e541239a06668"> 4813</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#ae23a562cb4f08452e78e541239a06668">MemoryCompressionOptimizer::ProcessMatrix</a>(int32 m) {</div><div class="line"><a name="l04814"></a><span class="lineno"> 4814</span>&#160;  <span class="keywordflow">if</span> (analyzer_.matrix_accesses[m].is_output) {</div><div class="line"><a name="l04815"></a><span class="lineno"> 4815</span>&#160;    <span class="keywordflow">return</span>;  <span class="comment">// We can&#39;t do this optimization for matrices that are going to be</span></div><div class="line"><a name="l04816"></a><span class="lineno"> 4816</span>&#160;             <span class="comment">// output to the user.</span></div><div class="line"><a name="l04817"></a><span class="lineno"> 4817</span>&#160;  }</div><div class="line"><a name="l04818"></a><span class="lineno"> 4818</span>&#160;</div><div class="line"><a name="l04819"></a><span class="lineno"> 4819</span>&#160;  <span class="comment">// &#39;accesses&#39; list the commands that access this matrix.</span></div><div class="line"><a name="l04820"></a><span class="lineno"> 4820</span>&#160;  <span class="keyword">const</span> std::vector&lt;Access&gt; &amp;accesses = analyzer_.matrix_accesses[m].accesses;</div><div class="line"><a name="l04821"></a><span class="lineno"> 4821</span>&#160;  <span class="comment">// the &#39;kReadAccess&#39; below is actually a don&#39;t-care  This is just</span></div><div class="line"><a name="l04822"></a><span class="lineno"> 4822</span>&#160;  <span class="comment">// to find the position in &#39;accesses&#39; that corresponds to command-index</span></div><div class="line"><a name="l04823"></a><span class="lineno"> 4823</span>&#160;  <span class="comment">// &#39;middle_command&#39;.</span></div><div class="line"><a name="l04824"></a><span class="lineno"> 4824</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1Access.html">Access</a> middle_access(middle_command_, <a class="code" href="namespacekaldi_1_1nnet3.html#ad8aff9e545a5f496a179a16667431478acaca1f8be65b8d29c8710e04ac7629f3">kReadAccess</a>);</div><div class="line"><a name="l04825"></a><span class="lineno"> 4825</span>&#160;  std::vector&lt;Access&gt;::const_iterator iter = std::lower_bound(accesses.begin(),</div><div class="line"><a name="l04826"></a><span class="lineno"> 4826</span>&#160;                                                              accesses.end(),</div><div class="line"><a name="l04827"></a><span class="lineno"> 4827</span>&#160;                                                              middle_access);</div><div class="line"><a name="l04828"></a><span class="lineno"> 4828</span>&#160;  <span class="comment">// At this point, &#39;iter&#39; points to the first access in &#39;accesses&#39;</span></div><div class="line"><a name="l04829"></a><span class="lineno"> 4829</span>&#160;  <span class="comment">// whose command index is &gt;= &#39;middle_command_&#39; (which separates the forward</span></div><div class="line"><a name="l04830"></a><span class="lineno"> 4830</span>&#160;  <span class="comment">// and backward passes), or accesses.end() if this matrix was not</span></div><div class="line"><a name="l04831"></a><span class="lineno"> 4831</span>&#160;  <span class="comment">// accessed during the backward pass.</span></div><div class="line"><a name="l04832"></a><span class="lineno"> 4832</span>&#160;  <span class="keywordflow">if</span> (iter == accesses.end()) {</div><div class="line"><a name="l04833"></a><span class="lineno"> 4833</span>&#160;    <span class="keywordflow">return</span>;  <span class="comment">// There is nothing to do: this matrix was not accessed during the</span></div><div class="line"><a name="l04834"></a><span class="lineno"> 4834</span>&#160;             <span class="comment">// backward pass.</span></div><div class="line"><a name="l04835"></a><span class="lineno"> 4835</span>&#160;  }</div><div class="line"><a name="l04836"></a><span class="lineno"> 4836</span>&#160;  <span class="keywordflow">if</span> (iter == accesses.begin()) {</div><div class="line"><a name="l04837"></a><span class="lineno"> 4837</span>&#160;    <span class="keywordflow">return</span>;  <span class="comment">// There is nothing to do: this matrix was not accessed during the</span></div><div class="line"><a name="l04838"></a><span class="lineno"> 4838</span>&#160;             <span class="comment">// forward pass.</span></div><div class="line"><a name="l04839"></a><span class="lineno"> 4839</span>&#160;  }</div><div class="line"><a name="l04840"></a><span class="lineno"> 4840</span>&#160;  <span class="comment">// &#39;backward_access&#39; is the first access of the matrix in the backward</span></div><div class="line"><a name="l04841"></a><span class="lineno"> 4841</span>&#160;  <span class="comment">// pass of the computation, and</span></div><div class="line"><a name="l04842"></a><span class="lineno"> 4842</span>&#160;  <span class="comment">// &#39;forward_access&#39; is the last access of the matrix in the forward pass</span></div><div class="line"><a name="l04843"></a><span class="lineno"> 4843</span>&#160;  <span class="comment">// of the computation.</span></div><div class="line"><a name="l04844"></a><span class="lineno"> 4844</span>&#160;  <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1Access.html">Access</a> &amp;backward_access = iter[0],</div><div class="line"><a name="l04845"></a><span class="lineno"> 4845</span>&#160;      &amp;forward_access = iter[-1];</div><div class="line"><a name="l04846"></a><span class="lineno"> 4846</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(forward_access.command_index &lt; middle_command_ &amp;&amp;</div><div class="line"><a name="l04847"></a><span class="lineno"> 4847</span>&#160;               backward_access.<a class="code" href="structkaldi_1_1nnet3_1_1Access.html#a5784248b7d100605c5bd6fe017987afd">command_index</a> &gt; middle_command_);</div><div class="line"><a name="l04848"></a><span class="lineno"> 4848</span>&#160;</div><div class="line"><a name="l04849"></a><span class="lineno"> 4849</span>&#160;  <span class="comment">// &#39;backward_access_is_last_access&#39; is going to be set to true if</span></div><div class="line"><a name="l04850"></a><span class="lineno"> 4850</span>&#160;  <span class="comment">// &#39;backward_access&#39; is the last command to access the matrix (apart from</span></div><div class="line"><a name="l04851"></a><span class="lineno"> 4851</span>&#160;  <span class="comment">// deallocation or matrix-swap commands, which don&#39;t show up in the list of</span></div><div class="line"><a name="l04852"></a><span class="lineno"> 4852</span>&#160;  <span class="comment">// accesses).</span></div><div class="line"><a name="l04853"></a><span class="lineno"> 4853</span>&#160;  <span class="keywordtype">bool</span> backward_access_is_last_access = (accesses.end() == iter + 1);</div><div class="line"><a name="l04854"></a><span class="lineno"> 4854</span>&#160;</div><div class="line"><a name="l04855"></a><span class="lineno"> 4855</span>&#160;  int32 backward_command_index = backward_access.<a class="code" href="structkaldi_1_1nnet3_1_1Access.html#a5784248b7d100605c5bd6fe017987afd">command_index</a>,</div><div class="line"><a name="l04856"></a><span class="lineno"> 4856</span>&#160;      forward_command_index = forward_access.command_index;</div><div class="line"><a name="l04857"></a><span class="lineno"> 4857</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">NnetComputation::Command</a></div><div class="line"><a name="l04858"></a><span class="lineno"> 4858</span>&#160;      &amp;backward_command = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">computation_</a>-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[backward_command_index];</div><div class="line"><a name="l04859"></a><span class="lineno"> 4859</span>&#160;</div><div class="line"><a name="l04860"></a><span class="lineno"> 4860</span>&#160;  <span class="keywordflow">if</span> (memory_compression_level_ &gt;= 1 &amp;&amp;</div><div class="line"><a name="l04861"></a><span class="lineno"> 4861</span>&#160;      backward_access_is_last_access &amp;&amp;</div><div class="line"><a name="l04862"></a><span class="lineno"> 4862</span>&#160;      backward_access.<a class="code" href="structkaldi_1_1nnet3_1_1Access.html#abe920302408265dccfe076ebd1fb02c1">access_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#ad8aff9e545a5f496a179a16667431478acaca1f8be65b8d29c8710e04ac7629f3">kReadAccess</a> &amp;&amp;</div><div class="line"><a name="l04863"></a><span class="lineno"> 4863</span>&#160;      backward_command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">command_type</a> == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83">kBackprop</a>) {</div><div class="line"><a name="l04864"></a><span class="lineno"> 4864</span>&#160;    int32 component_index = backward_command.<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">arg1</a>;</div><div class="line"><a name="l04865"></a><span class="lineno"> 4865</span>&#160;    <span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Component.html">Component</a> *component = <a class="code" href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#adbabf05a7702103113a02a113015205f">nnet_</a>.<a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html#aec8d6dfed3e4ab080d3ff4cf6a1126e3">GetComponent</a>(component_index);</div><div class="line"><a name="l04866"></a><span class="lineno"> 4866</span>&#160;    <span class="comment">// this is potentially a candidate for our optimization for ReLU units,</span></div><div class="line"><a name="l04867"></a><span class="lineno"> 4867</span>&#160;    <span class="comment">// where we only need to store the sign.</span></div><div class="line"><a name="l04868"></a><span class="lineno"> 4868</span>&#160;    <span class="keywordflow">if</span> (component-&gt;<a class="code" href="classkaldi_1_1nnet3_1_1Component.html#ab6b6147feb5e0688469b735a6546c222">Type</a>() == <span class="stringliteral">&quot;RectifiedLinearComponent&quot;</span>) {</div><div class="line"><a name="l04869"></a><span class="lineno"> 4869</span>&#160;      compress_info_.push_back(</div><div class="line"><a name="l04870"></a><span class="lineno"> 4870</span>&#160;          <a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html">MatrixCompressInfo</a>(m, forward_command_index,</div><div class="line"><a name="l04871"></a><span class="lineno"> 4871</span>&#160;                             backward_command_index,</div><div class="line"><a name="l04872"></a><span class="lineno"> 4872</span>&#160;                             <a class="code" href="namespacekaldi.html#a6a81f9c498a2d703ea343d906a827b6fa23164e2fb75b9b890518973aa841de3d">kCompressedMatrixUint8</a>, 0.0,</div><div class="line"><a name="l04873"></a><span class="lineno"> 4873</span>&#160;                             <span class="keyword">true</span>));</div><div class="line"><a name="l04874"></a><span class="lineno"> 4874</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l04875"></a><span class="lineno"> 4875</span>&#160;    }</div><div class="line"><a name="l04876"></a><span class="lineno"> 4876</span>&#160;  }</div><div class="line"><a name="l04877"></a><span class="lineno"> 4877</span>&#160;</div><div class="line"><a name="l04878"></a><span class="lineno"> 4878</span>&#160;  <span class="comment">// If memory_compression_level &gt;= 2 (an &quot;intermediate&quot; level of compression),</span></div><div class="line"><a name="l04879"></a><span class="lineno"> 4879</span>&#160;  <span class="comment">// then we&#39;ll consider compressing quantities using 16 bits in the range</span></div><div class="line"><a name="l04880"></a><span class="lineno"> 4880</span>&#160;  <span class="comment">// [-10, 10].  Because of the way this compression works, exact zero will</span></div><div class="line"><a name="l04881"></a><span class="lineno"> 4881</span>&#160;  <span class="comment">// still be uncompressed as exact zero, so even if this is the output</span></div><div class="line"><a name="l04882"></a><span class="lineno"> 4882</span>&#160;  <span class="comment">// of a ReLU, it&#39;s OK.  (Having a few derivatives zero for ReLU outputs</span></div><div class="line"><a name="l04883"></a><span class="lineno"> 4883</span>&#160;  <span class="comment">// that were very close to zero is OK.)</span></div><div class="line"><a name="l04884"></a><span class="lineno"> 4884</span>&#160;  <span class="keywordflow">if</span> (memory_compression_level_ &gt;= 2) {</div><div class="line"><a name="l04885"></a><span class="lineno"> 4885</span>&#160;    compress_info_.push_back(</div><div class="line"><a name="l04886"></a><span class="lineno"> 4886</span>&#160;        <a class="code" href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html">MatrixCompressInfo</a>(m, forward_command_index,</div><div class="line"><a name="l04887"></a><span class="lineno"> 4887</span>&#160;                           backward_command_index,</div><div class="line"><a name="l04888"></a><span class="lineno"> 4888</span>&#160;                           <a class="code" href="namespacekaldi.html#a6a81f9c498a2d703ea343d906a827b6fa8cf976d526a5eac828cf765737a64bfa">kCompressedMatrixInt16</a>, 10.0,</div><div class="line"><a name="l04889"></a><span class="lineno"> 4889</span>&#160;                           <span class="keyword">true</span>));</div><div class="line"><a name="l04890"></a><span class="lineno"> 4890</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l04891"></a><span class="lineno"> 4891</span>&#160;  }</div><div class="line"><a name="l04892"></a><span class="lineno"> 4892</span>&#160;</div><div class="line"><a name="l04893"></a><span class="lineno"> 4893</span>&#160;  <span class="comment">// TODO: later maybe implement something for memory compression level = 3.</span></div><div class="line"><a name="l04894"></a><span class="lineno"> 4894</span>&#160;}</div><div class="line"><a name="l04895"></a><span class="lineno"> 4895</span>&#160;</div><div class="line"><a name="l04896"></a><span class="lineno"> 4896</span>&#160;</div><div class="line"><a name="l04897"></a><span class="lineno"> 4897</span>&#160;</div><div class="line"><a name="l04898"></a><span class="lineno"> 4898</span>&#160;</div><div class="line"><a name="l04899"></a><span class="lineno"><a class="line" href="namespacekaldi_1_1nnet3.html#a10b449e04f7115cc85d295440638fade"> 4899</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacekaldi_1_1nnet3.html#a10b449e04f7115cc85d295440638fade">OptimizeMemoryCompression</a>(<span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;nnet,</div><div class="line"><a name="l04900"></a><span class="lineno"> 4900</span>&#160;                               int32 memory_compression_level,</div><div class="line"><a name="l04901"></a><span class="lineno"> 4901</span>&#160;                               <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation) {</div><div class="line"><a name="l04902"></a><span class="lineno"> 4902</span>&#160;  <span class="keywordflow">if</span> (memory_compression_level == 0 || computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.empty())</div><div class="line"><a name="l04903"></a><span class="lineno"> 4903</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l04904"></a><span class="lineno"> 4904</span>&#160;  <span class="comment">// don&#39;t apply this optimization to looped computations.</span></div><div class="line"><a name="l04905"></a><span class="lineno"> 4905</span>&#160;  <span class="keywordflow">if</span> (computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.back().command_type == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352add9060e8c7434f250048082c634d9a6d">kGotoLabel</a>)</div><div class="line"><a name="l04906"></a><span class="lineno"> 4906</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l04907"></a><span class="lineno"> 4907</span>&#160;</div><div class="line"><a name="l04908"></a><span class="lineno"> 4908</span>&#160;  <span class="comment">// &#39;middle_command&#39; will be the index of the command of type</span></div><div class="line"><a name="l04909"></a><span class="lineno"> 4909</span>&#160;  <span class="comment">// &#39;kNoOperationMarker&#39; that separates the forward and backward</span></div><div class="line"><a name="l04910"></a><span class="lineno"> 4910</span>&#160;  <span class="comment">// passes.  If it doesn&#39;t exist, it means this computation doesn&#39;t</span></div><div class="line"><a name="l04911"></a><span class="lineno"> 4911</span>&#160;  <span class="comment">// include</span></div><div class="line"><a name="l04912"></a><span class="lineno"> 4912</span>&#160;  int32 middle_command = -1;</div><div class="line"><a name="l04913"></a><span class="lineno"> 4913</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>.size(); <a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div><div class="line"><a name="l04914"></a><span class="lineno"> 4914</span>&#160;    <span class="keywordflow">if</span> (computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">commands</a>[<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>].command_type == <a class="code" href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352af67517e882c1aebe145a016945b9e6a4">kNoOperationMarker</a>) {</div><div class="line"><a name="l04915"></a><span class="lineno"> 4915</span>&#160;      <span class="keywordflow">if</span> (middle_command &lt; 0) {</div><div class="line"><a name="l04916"></a><span class="lineno"> 4916</span>&#160;        middle_command = <span class="keyword">static_cast&lt;</span>int32<span class="keyword">&gt;</span>(<a class="code" href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">i</a>);</div><div class="line"><a name="l04917"></a><span class="lineno"> 4917</span>&#160;      } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04918"></a><span class="lineno"> 4918</span>&#160;        <a class="code" href="group__error__group.html#ga994be213ddf127b5d6f20a43a02b513a">KALDI_WARN</a> &lt;&lt; <span class="stringliteral">&quot;Found more than one command of type kNoOperationMarker &quot;</span></div><div class="line"><a name="l04919"></a><span class="lineno"> 4919</span>&#160;            <span class="stringliteral">&quot;in non-looped computation.&quot;</span>;</div><div class="line"><a name="l04920"></a><span class="lineno"> 4920</span>&#160;        <span class="comment">// there are more than one command of this type... this wasn&#39;t expected.</span></div><div class="line"><a name="l04921"></a><span class="lineno"> 4921</span>&#160;        <span class="comment">// return (i.e. do nothing).</span></div><div class="line"><a name="l04922"></a><span class="lineno"> 4922</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l04923"></a><span class="lineno"> 4923</span>&#160;      }</div><div class="line"><a name="l04924"></a><span class="lineno"> 4924</span>&#160;    }</div><div class="line"><a name="l04925"></a><span class="lineno"> 4925</span>&#160;  }</div><div class="line"><a name="l04926"></a><span class="lineno"> 4926</span>&#160;  <span class="keywordflow">if</span> (middle_command == -1) {</div><div class="line"><a name="l04927"></a><span class="lineno"> 4927</span>&#160;    <span class="keywordflow">return</span>;  <span class="comment">// This computation doesn&#39;t have a backprop pass.</span></div><div class="line"><a name="l04928"></a><span class="lineno"> 4928</span>&#160;  }</div><div class="line"><a name="l04929"></a><span class="lineno"> 4929</span>&#160;  <span class="keywordflow">if</span> (memory_compression_level &gt;= 1) {</div><div class="line"><a name="l04930"></a><span class="lineno"> 4930</span>&#160;    int64 bytes_used_initial, bytes_used_final;</div><div class="line"><a name="l04931"></a><span class="lineno"> 4931</span>&#160;    <span class="keywordtype">bool</span> verbose_ge_2 = <a class="code" href="group__error__group.html#gae77f5cf98f18f8cbe207690e49da166e">GetVerboseLevel</a>() &gt;= 2;</div><div class="line"><a name="l04932"></a><span class="lineno"> 4932</span>&#160;    <span class="keywordflow">if</span> (verbose_ge_2)</div><div class="line"><a name="l04933"></a><span class="lineno"> 4933</span>&#160;      bytes_used_initial = <a class="code" href="namespacekaldi_1_1nnet3.html#ab753d835b665dd1b444b16f045c3e1a3">GetMaxMemoryUse</a>(*computation);</div><div class="line"><a name="l04934"></a><span class="lineno"> 4934</span>&#160;</div><div class="line"><a name="l04935"></a><span class="lineno"> 4935</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html">MemoryCompressionOptimizer</a> opt(nnet, memory_compression_level,</div><div class="line"><a name="l04936"></a><span class="lineno"> 4936</span>&#160;                                   middle_command, computation);</div><div class="line"><a name="l04937"></a><span class="lineno"> 4937</span>&#160;    opt.<a class="code" href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a2035ba0afa36778a6f4f664af777e7e6">Optimize</a>();</div><div class="line"><a name="l04938"></a><span class="lineno"> 4938</span>&#160;</div><div class="line"><a name="l04939"></a><span class="lineno"> 4939</span>&#160;    <span class="keywordflow">if</span> (verbose_ge_2) {</div><div class="line"><a name="l04940"></a><span class="lineno"> 4940</span>&#160;      bytes_used_final = <a class="code" href="namespacekaldi_1_1nnet3.html#ab753d835b665dd1b444b16f045c3e1a3">GetMaxMemoryUse</a>(*computation);</div><div class="line"><a name="l04941"></a><span class="lineno"> 4941</span>&#160;      <span class="keywordflow">if</span> (bytes_used_final != bytes_used_initial) {</div><div class="line"><a name="l04942"></a><span class="lineno"> 4942</span>&#160;        <a class="code" href="group__error__group.html#ga16c81ec6ff3ba04c6ff96fdaed9d854e">KALDI_VLOG</a>(2) &lt;&lt; <span class="stringliteral">&quot;Memory compression reduced  memory use from &quot;</span></div><div class="line"><a name="l04943"></a><span class="lineno"> 4943</span>&#160;                      &lt;&lt; bytes_used_initial &lt;&lt; <span class="stringliteral">&quot; to &quot;</span></div><div class="line"><a name="l04944"></a><span class="lineno"> 4944</span>&#160;                      &lt;&lt; bytes_used_final &lt;&lt; <span class="stringliteral">&quot; bytes.&quot;</span>;</div><div class="line"><a name="l04945"></a><span class="lineno"> 4945</span>&#160;      }</div><div class="line"><a name="l04946"></a><span class="lineno"> 4946</span>&#160;    }</div><div class="line"><a name="l04947"></a><span class="lineno"> 4947</span>&#160;  }</div><div class="line"><a name="l04948"></a><span class="lineno"> 4948</span>&#160;}</div><div class="line"><a name="l04949"></a><span class="lineno"> 4949</span>&#160;</div><div class="line"><a name="l04950"></a><span class="lineno"> 4950</span>&#160;</div><div class="line"><a name="l04951"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a32eb6279a97f57165c225724a533ae39"> 4951</a></span>&#160;std::shared_ptr&lt;const NnetComputation&gt; <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a32eb6279a97f57165c225724a533ae39">ComputationCache::Find</a>(</div><div class="line"><a name="l04952"></a><span class="lineno"> 4952</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html">ComputationRequest</a> &amp;in_request) {</div><div class="line"><a name="l04953"></a><span class="lineno"> 4953</span>&#160;  std::lock_guard&lt;std::mutex&gt; lock(mutex_);</div><div class="line"><a name="l04954"></a><span class="lineno"> 4954</span>&#160;</div><div class="line"><a name="l04955"></a><span class="lineno"> 4955</span>&#160;  CacheType::iterator iter = computation_cache_.find(&amp;in_request);</div><div class="line"><a name="l04956"></a><span class="lineno"> 4956</span>&#160;  <span class="keywordflow">if</span> (iter == computation_cache_.end()) {</div><div class="line"><a name="l04957"></a><span class="lineno"> 4957</span>&#160;    <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l04958"></a><span class="lineno"> 4958</span>&#160;  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04959"></a><span class="lineno"> 4959</span>&#160;    std::shared_ptr&lt;const NnetComputation&gt; ans = iter-&gt;second.first;</div><div class="line"><a name="l04960"></a><span class="lineno"> 4960</span>&#160;    <span class="comment">// Update access record by moving the accessed request to the end of the</span></div><div class="line"><a name="l04961"></a><span class="lineno"> 4961</span>&#160;    <span class="comment">// access queue, which declares that it&#39;s the most recently used.</span></div><div class="line"><a name="l04962"></a><span class="lineno"> 4962</span>&#160;    access_queue_.splice(access_queue_.end(), access_queue_,</div><div class="line"><a name="l04963"></a><span class="lineno"> 4963</span>&#160;                         iter-&gt;second.second);</div><div class="line"><a name="l04964"></a><span class="lineno"> 4964</span>&#160;    <span class="keywordflow">return</span> ans;</div><div class="line"><a name="l04965"></a><span class="lineno"> 4965</span>&#160;  }</div><div class="line"><a name="l04966"></a><span class="lineno"> 4966</span>&#160;}</div><div class="line"><a name="l04967"></a><span class="lineno"> 4967</span>&#160;</div><div class="line"><a name="l04968"></a><span class="lineno"> 4968</span>&#160;</div><div class="line"><a name="l04969"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a59e28b5d21625bf91ff84067ba90246d"> 4969</a></span>&#160;<a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a59e28b5d21625bf91ff84067ba90246d">ComputationCache::ComputationCache</a>(int32 cache_capacity):</div><div class="line"><a name="l04970"></a><span class="lineno"> 4970</span>&#160;    cache_capacity_(cache_capacity) {</div><div class="line"><a name="l04971"></a><span class="lineno"> 4971</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(cache_capacity &gt; 0);</div><div class="line"><a name="l04972"></a><span class="lineno"> 4972</span>&#160;}</div><div class="line"><a name="l04973"></a><span class="lineno"> 4973</span>&#160;</div><div class="line"><a name="l04974"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a551e1e19651c8e13d62f27e82248b33a"> 4974</a></span>&#160;std::shared_ptr&lt;const NnetComputation&gt; <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a551e1e19651c8e13d62f27e82248b33a">ComputationCache::Insert</a>(</div><div class="line"><a name="l04975"></a><span class="lineno"> 4975</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html">ComputationRequest</a> &amp;request_in,</div><div class="line"><a name="l04976"></a><span class="lineno"> 4976</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation_in) {</div><div class="line"><a name="l04977"></a><span class="lineno"> 4977</span>&#160;</div><div class="line"><a name="l04978"></a><span class="lineno"> 4978</span>&#160;  std::lock_guard&lt;std::mutex&gt; lock(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a281b5ec791338d4378e22ef44a51b4a1">mutex_</a>);</div><div class="line"><a name="l04979"></a><span class="lineno"> 4979</span>&#160;  <span class="keywordflow">if</span> (static_cast&lt;int32&gt;(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a6d889d796739f83d1af7a8a081e5a316">computation_cache_</a>.size()) &gt;= <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a38be6b2c66f846512889b9fed7669815">cache_capacity_</a>) {</div><div class="line"><a name="l04980"></a><span class="lineno"> 4980</span>&#160;    <span class="comment">//  Cache has reached capacity; purge the least-recently-accessed request</span></div><div class="line"><a name="l04981"></a><span class="lineno"> 4981</span>&#160;    <span class="keyword">const</span> CacheType::iterator iter =</div><div class="line"><a name="l04982"></a><span class="lineno"> 4982</span>&#160;        <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a6d889d796739f83d1af7a8a081e5a316">computation_cache_</a>.find(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#adc9736e62e5ba21e68fb538c9d573beb">access_queue_</a>.front());</div><div class="line"><a name="l04983"></a><span class="lineno"> 4983</span>&#160;    <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(iter != <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a6d889d796739f83d1af7a8a081e5a316">computation_cache_</a>.end());</div><div class="line"><a name="l04984"></a><span class="lineno"> 4984</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html">ComputationRequest</a> *request = iter-&gt;first;</div><div class="line"><a name="l04985"></a><span class="lineno"> 4985</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a6d889d796739f83d1af7a8a081e5a316">computation_cache_</a>.erase(iter);</div><div class="line"><a name="l04986"></a><span class="lineno"> 4986</span>&#160;    <span class="keyword">delete</span> request;</div><div class="line"><a name="l04987"></a><span class="lineno"> 4987</span>&#160;    <span class="comment">// we don&#39;t need to delete the computation in iter-&gt;second.first, as the</span></div><div class="line"><a name="l04988"></a><span class="lineno"> 4988</span>&#160;    <span class="comment">// shared_ptr takes care of that automatically.</span></div><div class="line"><a name="l04989"></a><span class="lineno"> 4989</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#adc9736e62e5ba21e68fb538c9d573beb">access_queue_</a>.pop_front();</div><div class="line"><a name="l04990"></a><span class="lineno"> 4990</span>&#160;  }</div><div class="line"><a name="l04991"></a><span class="lineno"> 4991</span>&#160;</div><div class="line"><a name="l04992"></a><span class="lineno"> 4992</span>&#160;  <span class="comment">// Now insert the thing we need to insert.  We&#39;ll own the pointer &#39;request&#39; in</span></div><div class="line"><a name="l04993"></a><span class="lineno"> 4993</span>&#160;  <span class="comment">// &#39;computation_cache_&#39;, so we need to allocate our own version.</span></div><div class="line"><a name="l04994"></a><span class="lineno"> 4994</span>&#160;  <a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html">ComputationRequest</a> *request = <span class="keyword">new</span> <a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html">ComputationRequest</a>(request_in);</div><div class="line"><a name="l04995"></a><span class="lineno"> 4995</span>&#160;  <span class="comment">// When we construct this shared_ptr, it takes ownership of the pointer</span></div><div class="line"><a name="l04996"></a><span class="lineno"> 4996</span>&#160;  <span class="comment">// &#39;computation_in&#39;.</span></div><div class="line"><a name="l04997"></a><span class="lineno"> 4997</span>&#160;  std::shared_ptr&lt;const NnetComputation&gt; computation(computation_in);</div><div class="line"><a name="l04998"></a><span class="lineno"> 4998</span>&#160;</div><div class="line"><a name="l04999"></a><span class="lineno"> 4999</span>&#160;  AqType::iterator ait = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#adc9736e62e5ba21e68fb538c9d573beb">access_queue_</a>.insert(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#adc9736e62e5ba21e68fb538c9d573beb">access_queue_</a>.end(), request);</div><div class="line"><a name="l05000"></a><span class="lineno"> 5000</span>&#160;</div><div class="line"><a name="l05001"></a><span class="lineno"> 5001</span>&#160;  std::pair&lt;CacheType::iterator, bool&gt; p = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a6d889d796739f83d1af7a8a081e5a316">computation_cache_</a>.insert(</div><div class="line"><a name="l05002"></a><span class="lineno"> 5002</span>&#160;      std::make_pair(request, std::make_pair(computation, ait)));</div><div class="line"><a name="l05003"></a><span class="lineno"> 5003</span>&#160;  <span class="keywordflow">if</span> (!p.second) {</div><div class="line"><a name="l05004"></a><span class="lineno"> 5004</span>&#160;    <span class="comment">// if p.second is false, this pair was not inserted because</span></div><div class="line"><a name="l05005"></a><span class="lineno"> 5005</span>&#160;    <span class="comment">// a computation for the same computation-request already existed in</span></div><div class="line"><a name="l05006"></a><span class="lineno"> 5006</span>&#160;    <span class="comment">// the map. This is possible in multi-threaded operations, if two</span></div><div class="line"><a name="l05007"></a><span class="lineno"> 5007</span>&#160;    <span class="comment">// threads try to compile the same computation at the same time (only</span></div><div class="line"><a name="l05008"></a><span class="lineno"> 5008</span>&#160;    <span class="comment">// one of them will successfully add it).</span></div><div class="line"><a name="l05009"></a><span class="lineno"> 5009</span>&#160;    <span class="comment">// We need to erase the access-queue element that we just added, it&#39;s</span></div><div class="line"><a name="l05010"></a><span class="lineno"> 5010</span>&#160;    <span class="comment">// no longer going to be needed.</span></div><div class="line"><a name="l05011"></a><span class="lineno"> 5011</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#adc9736e62e5ba21e68fb538c9d573beb">access_queue_</a>.erase(ait);</div><div class="line"><a name="l05012"></a><span class="lineno"> 5012</span>&#160;    <span class="keyword">delete</span> request;</div><div class="line"><a name="l05013"></a><span class="lineno"> 5013</span>&#160;  }</div><div class="line"><a name="l05014"></a><span class="lineno"> 5014</span>&#160;  <span class="keywordflow">return</span> computation;</div><div class="line"><a name="l05015"></a><span class="lineno"> 5015</span>&#160;}</div><div class="line"><a name="l05016"></a><span class="lineno"> 5016</span>&#160;</div><div class="line"><a name="l05017"></a><span class="lineno"> 5017</span>&#160;</div><div class="line"><a name="l05018"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a8e7d2790fc7e94fe9780ccc937de1270"> 5018</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a8e7d2790fc7e94fe9780ccc937de1270">ComputationCache::Read</a>(std::istream &amp;is, <span class="keywordtype">bool</span> binary) {</div><div class="line"><a name="l05019"></a><span class="lineno"> 5019</span>&#160;  <span class="comment">// Note: the object on disk doesn&#39;t have tokens like &quot;&lt;ComputationCache&gt;&quot;</span></div><div class="line"><a name="l05020"></a><span class="lineno"> 5020</span>&#160;  <span class="comment">// and &quot;&lt;/ComputationCache&gt;&quot; for back-compatibility reasons.</span></div><div class="line"><a name="l05021"></a><span class="lineno"> 5021</span>&#160;  int32 computation_cache_size;</div><div class="line"><a name="l05022"></a><span class="lineno"> 5022</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a41114607233f11aab89539abf08cf922">ExpectToken</a>(is, binary, <span class="stringliteral">&quot;&lt;ComputationCacheSize&gt;&quot;</span>);</div><div class="line"><a name="l05023"></a><span class="lineno"> 5023</span>&#160;  <a class="code" href="group__io__funcs__basic.html#ga1bd1af0ef712b76f2332febcec8d095a">ReadBasicType</a>(is, binary, &amp;computation_cache_size);</div><div class="line"><a name="l05024"></a><span class="lineno"> 5024</span>&#160;  <a class="code" href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a>(computation_cache_size &gt;= 0);</div><div class="line"><a name="l05025"></a><span class="lineno"> 5025</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a6d889d796739f83d1af7a8a081e5a316">computation_cache_</a>.clear();</div><div class="line"><a name="l05026"></a><span class="lineno"> 5026</span>&#160;  <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#adc9736e62e5ba21e68fb538c9d573beb">access_queue_</a>.clear();</div><div class="line"><a name="l05027"></a><span class="lineno"> 5027</span>&#160;  <a class="code" href="namespacekaldi_1_1nnet3.html#a41114607233f11aab89539abf08cf922">ExpectToken</a>(is, binary, <span class="stringliteral">&quot;&lt;ComputationCache&gt;&quot;</span>);</div><div class="line"><a name="l05028"></a><span class="lineno"> 5028</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> c = 0; c &lt; computation_cache_size; c++) {</div><div class="line"><a name="l05029"></a><span class="lineno"> 5029</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html">ComputationRequest</a> request;</div><div class="line"><a name="l05030"></a><span class="lineno"> 5030</span>&#160;    request.<a class="code" href="structkaldi_1_1nnet3_1_1ComputationRequest.html#ab1b9ede63de755642e79f7287a62b92c">Read</a>(is, binary);</div><div class="line"><a name="l05031"></a><span class="lineno"> 5031</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> *computation = <span class="keyword">new</span> <a class="code" href="namespacekaldi_1_1nnet2.html#aeff1c1ada8948d90166bccf6ff83cf3e">NnetComputation</a>();</div><div class="line"><a name="l05032"></a><span class="lineno"> 5032</span>&#160;    computation-&gt;<a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab1b9ede63de755642e79f7287a62b92c">Read</a>(is, binary);</div><div class="line"><a name="l05033"></a><span class="lineno"> 5033</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a551e1e19651c8e13d62f27e82248b33a">Insert</a>(request, computation);</div><div class="line"><a name="l05034"></a><span class="lineno"> 5034</span>&#160;  }</div><div class="line"><a name="l05035"></a><span class="lineno"> 5035</span>&#160;}</div><div class="line"><a name="l05036"></a><span class="lineno"> 5036</span>&#160;</div><div class="line"><a name="l05037"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a78eddb3e92fffc4e0e75e1f0e9a23488"> 5037</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a78eddb3e92fffc4e0e75e1f0e9a23488">ComputationCache::Check</a>(<span class="keyword">const</span> <a class="code" href="classkaldi_1_1nnet3_1_1Nnet.html">Nnet</a> &amp;nnet)<span class="keyword"> const </span>{</div><div class="line"><a name="l05038"></a><span class="lineno"> 5038</span>&#160;  CacheType::const_iterator iter = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a6d889d796739f83d1af7a8a081e5a316">computation_cache_</a>.begin(),</div><div class="line"><a name="l05039"></a><span class="lineno"> 5039</span>&#160;      end = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a6d889d796739f83d1af7a8a081e5a316">computation_cache_</a>.end();</div><div class="line"><a name="l05040"></a><span class="lineno"> 5040</span>&#160;  <span class="comment">// We only need to explicitly delete the pointer to the ComputationRequest.</span></div><div class="line"><a name="l05041"></a><span class="lineno"> 5041</span>&#160;  <span class="comment">// The pointers to Computation are deleted automatically by std::shared_ptr</span></div><div class="line"><a name="l05042"></a><span class="lineno"> 5042</span>&#160;  <span class="comment">// when the reference count goes to zero.</span></div><div class="line"><a name="l05043"></a><span class="lineno"> 5043</span>&#160;  <span class="keywordflow">for</span> (; iter != end; ++iter) {</div><div class="line"><a name="l05044"></a><span class="lineno"> 5044</span>&#160;    <span class="keyword">const</span> <a class="code" href="structkaldi_1_1nnet3_1_1NnetComputation.html">NnetComputation</a> &amp;computation = *(iter-&gt;second.first);</div><div class="line"><a name="l05045"></a><span class="lineno"> 5045</span>&#160;    <a class="code" href="structkaldi_1_1nnet3_1_1CheckComputationOptions.html">CheckComputationOptions</a> check_config;</div><div class="line"><a name="l05046"></a><span class="lineno"> 5046</span>&#160;    <a class="code" href="classkaldi_1_1nnet3_1_1ComputationChecker.html">ComputationChecker</a> checker(check_config, nnet, computation);</div><div class="line"><a name="l05047"></a><span class="lineno"> 5047</span>&#160;    checker.<a class="code" href="classkaldi_1_1nnet3_1_1ComputationChecker.html#a434b035308434bbeb9b857f22b9f0db1">Check</a>();</div><div class="line"><a name="l05048"></a><span class="lineno"> 5048</span>&#160;  }</div><div class="line"><a name="l05049"></a><span class="lineno"> 5049</span>&#160;}</div><div class="line"><a name="l05050"></a><span class="lineno"> 5050</span>&#160;</div><div class="line"><a name="l05051"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a68f354fd5f096134162f01719096e6fc"> 5051</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a68f354fd5f096134162f01719096e6fc">ComputationCache::Write</a>(std::ostream &amp;os, <span class="keywordtype">bool</span> binary)<span class="keyword"> const </span>{</div><div class="line"><a name="l05052"></a><span class="lineno"> 5052</span>&#160;  <a class="code" href="group__io__funcs__basic.html#ga87f1638ef3c0a3ee117178b202c2d02a">WriteToken</a>(os, binary, <span class="stringliteral">&quot;&lt;ComputationCacheSize&gt;&quot;</span>);</div><div class="line"><a name="l05053"></a><span class="lineno"> 5053</span>&#160;  <a class="code" href="group__io__funcs__basic.html#ga108506a9aabafd9006926aa1b47617da">WriteBasicType</a>(os, binary, static_cast&lt;int32&gt;(<a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a6d889d796739f83d1af7a8a081e5a316">computation_cache_</a>.size()));</div><div class="line"><a name="l05054"></a><span class="lineno"> 5054</span>&#160;  <a class="code" href="group__io__funcs__basic.html#ga87f1638ef3c0a3ee117178b202c2d02a">WriteToken</a>(os, binary, <span class="stringliteral">&quot;&lt;ComputationCache&gt;&quot;</span>);</div><div class="line"><a name="l05055"></a><span class="lineno"> 5055</span>&#160;  <span class="keywordflow">for</span> (CacheType::const_iterator iter = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a6d889d796739f83d1af7a8a081e5a316">computation_cache_</a>.begin();</div><div class="line"><a name="l05056"></a><span class="lineno"> 5056</span>&#160;           iter != <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a6d889d796739f83d1af7a8a081e5a316">computation_cache_</a>.end(); ++iter) {</div><div class="line"><a name="l05057"></a><span class="lineno"> 5057</span>&#160;    iter-&gt;first-&gt;Write(os, binary);</div><div class="line"><a name="l05058"></a><span class="lineno"> 5058</span>&#160;    iter-&gt;second.first-&gt;Write(os, binary);</div><div class="line"><a name="l05059"></a><span class="lineno"> 5059</span>&#160;  }</div><div class="line"><a name="l05060"></a><span class="lineno"> 5060</span>&#160;}</div><div class="line"><a name="l05061"></a><span class="lineno"> 5061</span>&#160;</div><div class="line"><a name="l05062"></a><span class="lineno"><a class="line" href="classkaldi_1_1nnet3_1_1ComputationCache.html#ac299795e58d574b7211af15d240110c7"> 5062</a></span>&#160;<a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#ac299795e58d574b7211af15d240110c7">ComputationCache::~ComputationCache</a>() {</div><div class="line"><a name="l05063"></a><span class="lineno"> 5063</span>&#160;  CacheType::const_iterator iter = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a6d889d796739f83d1af7a8a081e5a316">computation_cache_</a>.begin(),</div><div class="line"><a name="l05064"></a><span class="lineno"> 5064</span>&#160;      end = <a class="code" href="classkaldi_1_1nnet3_1_1ComputationCache.html#a6d889d796739f83d1af7a8a081e5a316">computation_cache_</a>.end();</div><div class="line"><a name="l05065"></a><span class="lineno"> 5065</span>&#160;  <span class="comment">// We only need to explicitly delete the pointer to the ComputationRequest.</span></div><div class="line"><a name="l05066"></a><span class="lineno"> 5066</span>&#160;  <span class="comment">// The pointers to Computation are deleted automatically by std::shared_ptr</span></div><div class="line"><a name="l05067"></a><span class="lineno"> 5067</span>&#160;  <span class="comment">// when the reference count goes to zero.</span></div><div class="line"><a name="l05068"></a><span class="lineno"> 5068</span>&#160;  <span class="keywordflow">for</span> (; iter != end; ++iter)</div><div class="line"><a name="l05069"></a><span class="lineno"> 5069</span>&#160;    <span class="keyword">delete</span> iter-&gt;first;</div><div class="line"><a name="l05070"></a><span class="lineno"> 5070</span>&#160;}</div><div class="line"><a name="l05071"></a><span class="lineno"> 5071</span>&#160;</div><div class="line"><a name="l05072"></a><span class="lineno"> 5072</span>&#160;} <span class="comment">// namespace nnet3</span></div><div class="line"><a name="l05073"></a><span class="lineno"> 5073</span>&#160;} <span class="comment">// namespace kaldi</span></div><div class="ttc" id="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo_html_a5b5e72d60df6479503b80e9ed4861fc6"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a5b5e72d60df6479503b80e9ed4861fc6">kaldi::nnet3::DerivativeTimeLimiter::MatrixPruneInfo::row_end</a></div><div class="ttdeci">int32 row_end</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00330">nnet-optimize-utils.h:330</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_ac879380727c26962a7aaa4a6de9dc4d4"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#ac879380727c26962a7aaa4a6de9dc4d4">kaldi::nnet3::MatrixIsUnused</a></div><div class="ttdeci">bool MatrixIsUnused(const Analyzer &amp;analyzer, const NnetComputation &amp;computation, int32 m)</div><div class="ttdoc">This function returns true if matrix 1 &lt;= m &lt; computation-&gt;matrices.size() is unused, defined as: it is not an input or an output, and is not accessed other than via commands of type kAllocMatrix, kDeallocMatrix, and kSetConst. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04582">nnet-optimize-utils.cc:4582</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352">kaldi::nnet3::CommandType</a></div><div class="ttdeci">CommandType</div><div class="ttdoc">CommandType is an enum that describes the category of the command used in the NnetComputation. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00288">nnet-computation.h:288</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command_html_ae3f3622984892212d4bc3f3b789d1fb0"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae3f3622984892212d4bc3f3b789d1fb0">kaldi::nnet3::NnetComputation::Command::arg2</a></div><div class="ttdeci">int32 arg2</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00342">nnet-computation.h:342</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_a04c50ce17b400e39661d1f8a38c05f1e"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a04c50ce17b400e39661d1f8a38c05f1e">kaldi::nnet3::ComputationRenumberer::CreateRenumbering</a></div><div class="ttdeci">static void CreateRenumbering(int32 old_num_elements, const std::vector&lt; int32 &gt; &amp;to_remove, std::vector&lt; int32 &gt; *renumbering)</div><div class="ttdoc">creates a renumbering that removes the elements in &quot;to_remove&quot;, e.g. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00271">nnet-optimize-utils.cc:271</a></div></div>
<div class="ttc" id="namespacekaldi_html"><div class="ttname"><a href="namespacekaldi.html">kaldi</a></div><div class="ttdoc">Relabels neural network egs with the read pdf-id alignments. </div><div class="ttdef"><b>Definition:</b> <a href="chain_8dox_source.html#l00020">chain.dox:20</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo_html_a37530671a271e2e54ce7c6f8762a7421"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#a37530671a271e2e54ce7c6f8762a7421">kaldi::nnet3::RowOpsSplitter::SingleSplitInfo::offset</a></div><div class="ttdeci">int32 offset</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02622">nnet-optimize-utils.cc:2622</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo_html_a1c577ae5458f02e60819f016514cdeed"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#a1c577ae5458f02e60819f016514cdeed">kaldi::nnet3::MemoryCompressionOptimizer::MatrixCompressInfo::truncate</a></div><div class="ttdeci">bool truncate</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04748">nnet-optimize-utils.cc:4748</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a35d3d1a70d075561aaf91b263ea28f74"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a35d3d1a70d075561aaf91b263ea28f74">kaldi::nnet3::kMatrixCopy</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00291">nnet-computation.h:291</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo_html_a8b8b798a5c4c75c2a6a104bfa156808a"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#a8b8b798a5c4c75c2a6a104bfa156808a">kaldi::nnet3::RowOpsSplitter::SingleSplitInfo::second_value_range</a></div><div class="ttdeci">int32 second_value_range</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02638">nnet-optimize-utils.cc:2638</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1Access_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1Access.html">kaldi::nnet3::Access</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00221">nnet-analyze.h:221</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetOptimizeOptions_html_a2af78454a6c4008c23ec34cb8cefc376"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetOptimizeOptions.html#a2af78454a6c4008c23ec34cb8cefc376">kaldi::nnet3::NnetOptimizeOptions::allow_right_merge</a></div><div class="ttdeci">bool allow_right_merge</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize_8h_source.html#l00048">nnet-optimize.h:48</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_html_a863b06831c83977ed474b5896a02a579"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a863b06831c83977ed474b5896a02a579">kaldi::nnet3::MemoryCompressionOptimizer::compress_info_</a></div><div class="ttdeci">std::vector&lt; MatrixCompressInfo &gt; compress_info_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04759">nnet-optimize-utils.cc:4759</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_a5ce3b0b9947d694dce936488d805cbc9"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a5ce3b0b9947d694dce936488d805cbc9">kaldi::nnet3::ComputationRenumberer::matrix_is_used_</a></div><div class="ttdeci">std::vector&lt; bool &gt; matrix_is_used_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00243">nnet-optimize-utils.cc:243</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationAnalysis_html_a68f6c05cf1aab9fd7e6a475078e38466"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html#a68f6c05cf1aab9fd7e6a475078e38466">kaldi::nnet3::ComputationAnalysis::FirstNontrivialAccess</a></div><div class="ttdeci">int32 FirstNontrivialAccess(int32 s) const</div><div class="ttdoc">Returns the first command (read or write) that accesses any part of &amp;#39;s&amp;#39; except for zeroing it (i...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8cc_source.html#l01182">nnet-analyze.cc:1182</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_ae8592f4c16a6a1b36c06dccda5511316"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#ae8592f4c16a6a1b36c06dccda5511316">kaldi::nnet3::IdentifyMatrixArgsInComputation</a></div><div class="ttdeci">void IdentifyMatrixArgsInComputation(NnetComputation *computation, std::vector&lt; int32 *&gt; *matrix_args)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00096">nnet-optimize-utils.cc:96</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_a72907a94f0ef8ddc489134dad4fba1aa"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a72907a94f0ef8ddc489134dad4fba1aa">kaldi::nnet3::ComputationLoopedOptimizer::ConvertListsToPairLists</a></div><div class="ttdeci">static void ConvertListsToPairLists(const std::vector&lt; std::vector&lt; int32 &gt; &gt; &amp;active_matrices, const std::vector&lt; std::pair&lt; int32, int32 &gt; &gt; &amp;matrix_to_pair, std::vector&lt; std::vector&lt; std::pair&lt; int32, int32 &gt; &gt; &gt; *active_pairs)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04189">nnet-optimize-utils.cc:4189</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1ComputationRequest_html_a5c5011f4cb4b2fc21775a3308c9cecda"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a5c5011f4cb4b2fc21775a3308c9cecda">kaldi::nnet3::ComputationRequest::store_component_stats</a></div><div class="ttdeci">bool store_component_stats</div><div class="ttdoc">you should set need_component_stats to true if you need the average-activation and average-derivative...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00126">nnet-computation.h:126</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_ad70a13d2a5ffc3f7e7370f7b4e774a73"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ad70a13d2a5ffc3f7e7370f7b4e774a73">kaldi::nnet3::DerivativeTimeLimiter::PruneMatrices</a></div><div class="ttdeci">void PruneMatrices()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02179">nnet-optimize-utils.cc:2179</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a0a04e946fa68432f4e723944ce8ab281"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a0a04e946fa68432f4e723944ce8ab281">kaldi::nnet3::GetCommandsOfType</a></div><div class="ttdeci">void GetCommandsOfType(const NnetComputation &amp;computation, CommandType t, std::vector&lt; int32 &gt; *command_indexes)</div><div class="ttdoc">This utility function works out from a computation, the command-indexes of the commands of the given ...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8cc_source.html#l01429">nnet-analyze.cc:1429</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MatrixExtender_html_a10fb93312fefce2859a649b0274aac56"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a10fb93312fefce2859a649b0274aac56">kaldi::nnet3::MatrixExtender::FixComputation</a></div><div class="ttdeci">void FixComputation()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01195">nnet-optimize-utils.cc:1195</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_ad608a50eef55fe012c53acb48f1de02b"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#ad608a50eef55fe012c53acb48f1de02b">kaldi::nnet3::NnetComputation::matrix_debug_info</a></div><div class="ttdeci">std::vector&lt; MatrixDebugInfo &gt; matrix_debug_info</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00394">nnet-computation.h:394</a></div></div>
<div class="ttc" id="namespacernnlm_html_a37d972ae0b47b9099e30983131d31916"><div class="ttname"><a href="namespacernnlm.html#a37d972ae0b47b9099e30983131d31916">rnnlm::j</a></div><div class="ttdeci">int j</div><div class="ttdef"><b>Definition:</b> <a href="mikolov-rnnlm-lib_8cc_source.html#l00066">mikolov-rnnlm-lib.cc:66</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_acd48d2ca65dc0a73952effbec24ccfb1"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#acd48d2ca65dc0a73952effbec24ccfb1">kaldi::nnet3::SplitRowOps</a></div><div class="ttdeci">bool SplitRowOps(NnetComputation *computation)</div><div class="ttdoc">This function detects cases where commands of type kAddRowsMulti, kAddToRowsMulti, kCopyRowsMulti, kCopyToRowsMulti use indexes that correspond to at most two submatrices, in two distinct ranges without gaps filled by -1&amp;#39;s, and could be converted to at most two commands of type kMatrixAdd, kMatrixCopy, kAddRows or kCopyRows. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02894">nnet-optimize-utils.cc:2894</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_af13a24e7f0ed6969f7659518478ffdc2"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#af13a24e7f0ed6969f7659518478ffdc2">kaldi::nnet3::ModelUpdateConsolidator::final_commands_</a></div><div class="ttdeci">std::vector&lt; NnetComputation::Command &gt; final_commands_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01340">nnet-optimize-utils.cc:1340</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_abb347167ff71d1cd8a2ab35b6eb2f636"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#abb347167ff71d1cd8a2ab35b6eb2f636">kaldi::nnet3::OptimizeLoopedComputation</a></div><div class="ttdeci">void OptimizeLoopedComputation(const Nnet &amp;nnet, NnetComputation *computation)</div><div class="ttdoc">This function tries to optimize computation &amp;#39;computation&amp;#39; for an &amp;#39;looped&amp;#39; computation. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04544">nnet-optimize-utils.cc:4544</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_a741e7e5a1297b3649eddf521ccede5a4"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a741e7e5a1297b3649eddf521ccede5a4">kaldi::nnet3::ComputationRenumberer::submatrix_is_kept_</a></div><div class="ttdeci">std::vector&lt; bool &gt; submatrix_is_kept_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00239">nnet-optimize-utils.cc:239</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationCache_html_adc9736e62e5ba21e68fb538c9d573beb"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationCache.html#adc9736e62e5ba21e68fb538c9d573beb">kaldi::nnet3::ComputationCache::access_queue_</a></div><div class="ttdeci">AqType access_queue_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00669">nnet-optimize-utils.h:669</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_ab3fd960e56dece4b5af4efa3fc35d98f"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#ab3fd960e56dece4b5af4efa3fc35d98f">kaldi::nnet3::ComputationLoopedOptimizer::ComputationLoopedOptimizer</a></div><div class="ttdeci">ComputationLoopedOptimizer(const Nnet &amp;nnet, NnetComputation *computation)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03892">nnet-optimize-utils.cc:3892</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo_html_ae99e4ce52adf069a641d61427aed351b"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#ae99e4ce52adf069a641d61427aed351b">kaldi::nnet3::RowOpsSplitter::SingleSplitInfo::second_value_offsets</a></div><div class="ttdeci">std::vector&lt; int32 &gt; second_value_offsets</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02649">nnet-optimize-utils.cc:2649</a></div></div>
<div class="ttc" id="namespacekaldi_html_a21841167f1ffde9582edc512acdbaa51a2b73d1b429e7067fc592b019190e4976"><div class="ttname"><a href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51a2b73d1b429e7067fc592b019190e4976">kaldi::kStrideEqualNumCols</a></div><div class="ttdef"><b>Definition:</b> <a href="matrix-common_8h_source.html#l00046">matrix-common.h:46</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1PrecomputedIndexesInfo_html_a910c43bfaec0fcc760c761ee67501ea8"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1PrecomputedIndexesInfo.html#a910c43bfaec0fcc760c761ee67501ea8">kaldi::nnet3::NnetComputation::PrecomputedIndexesInfo::input_indexes</a></div><div class="ttdeci">std::vector&lt; Index &gt; input_indexes</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00380">nnet-computation.h:380</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MatrixExtender_html_a23a3068bbd6de6b9f08b245daae44355"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a23a3068bbd6de6b9f08b245daae44355">kaldi::nnet3::MatrixExtender::orig_num_rows_</a></div><div class="ttdeci">std::vector&lt; int32 &gt; orig_num_rows_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01057">nnet-optimize-utils.cc:1057</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_aaa18736d4d5abceba0340d264da8ecd2"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#aaa18736d4d5abceba0340d264da8ecd2">kaldi::nnet3::ComputationRenumberer::RenumberSubmatrices</a></div><div class="ttdeci">void RenumberSubmatrices()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00428">nnet-optimize-utils.cc:428</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_aff6dbc6bf1ea33e5ea29bebebae8617a"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#aff6dbc6bf1ea33e5ea29bebebae8617a">kaldi::nnet3::ModelUpdateConsolidator::extra_commands_</a></div><div class="ttdeci">std::vector&lt; std::vector&lt; NnetComputation::Command &gt; &gt; extra_commands_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01335">nnet-optimize-utils.cc:1335</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1ComputationRequest_html_a58c542fffb7e7f754148c264c90b4a5e"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a58c542fffb7e7f754148c264c90b4a5e">kaldi::nnet3::ComputationRequest::need_model_derivative</a></div><div class="ttdeci">bool need_model_derivative</div><div class="ttdoc">if need_model_derivative is true, then we&amp;#39;ll be doing either model training or model-derivative compu...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00121">nnet-computation.h:121</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_a6b2ebb0f18100bdd03194aac19da1e09"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a6b2ebb0f18100bdd03194aac19da1e09">kaldi::nnet3::ComputationExpander::ExpandRowsMultiCommand</a></div><div class="ttdeci">void ExpandRowsMultiCommand(const NnetComputation::Command &amp;c_in, NnetComputation::Command *c_out)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03361">nnet-optimize-utils.cc:3361</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command_html_a299b2046550515733509b29583ea605c"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a299b2046550515733509b29583ea605c">kaldi::nnet3::NnetComputation::Command::arg7</a></div><div class="ttdeci">int32 arg7</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00347">nnet-computation.h:347</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352af9786d4042a4fcf23b29a14a6fb64126"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352af9786d4042a4fcf23b29a14a6fb64126">kaldi::nnet3::kNoOperationPermanent</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00295">nnet-computation.h:295</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationCache_html_ac299795e58d574b7211af15d240110c7"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationCache.html#ac299795e58d574b7211af15d240110c7">kaldi::nnet3::ComputationCache::~ComputationCache</a></div><div class="ttdeci">~ComputationCache()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l05062">nnet-optimize-utils.cc:5062</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_ad8aff9e545a5f496a179a16667431478acaca1f8be65b8d29c8710e04ac7629f3"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#ad8aff9e545a5f496a179a16667431478acaca1f8be65b8d29c8710e04ac7629f3">kaldi::nnet3::kReadAccess</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00076">nnet-analyze.h:76</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1VariableMergingOptimizer_html_a63de82c33f6a7330727c0f2fc670ae0d"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a63de82c33f6a7330727c0f2fc670ae0d">kaldi::nnet3::VariableMergingOptimizer::variable_dirty_</a></div><div class="ttdeci">std::vector&lt; bool &gt; variable_dirty_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00182">nnet-optimize-utils.h:182</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_a0ad00746c585650630f59ba3b3c3dad1"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a0ad00746c585650630f59ba3b3c3dad1">kaldi::nnet3::ComputationExpander::need_debug_info_</a></div><div class="ttdeci">bool need_debug_info_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03291">nnet-optimize-utils.cc:3291</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a2ec833031232462f45b425a8a5503489"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a2ec833031232462f45b425a8a5503489">kaldi::nnet3::IdentifySubmatrixArgs</a></div><div class="ttdeci">void IdentifySubmatrixArgs(NnetComputation::Command *c, std::vector&lt; int32 *&gt; *submatrix_args)</div><div class="ttdoc">This function outputs to &quot;submatrix_args&quot; the addresses of a subset of arguments arg1 through arg6 in...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00028">nnet-optimize-utils.cc:28</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a8ecee91c55553bcf2d755d00328b0253"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a8ecee91c55553bcf2d755d00328b0253">kaldi::nnet3::kSwapMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00289">nnet-computation.h:289</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MatrixExtender_html_adcf5cc095cea766e998cf4cde4e625de"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MatrixExtender.html#adcf5cc095cea766e998cf4cde4e625de">kaldi::nnet3::MatrixExtender::Extend</a></div><div class="ttdeci">void Extend(int32 *dest_submatrix_index, int32 *src_submatrix_index)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01132">nnet-optimize-utils.cc:1132</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1ComputationRequest_html_a4b8ac2055ef655ccb4cd6fdbdcabf000"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a4b8ac2055ef655ccb4cd6fdbdcabf000">kaldi::nnet3::ComputationRequest::misc_info</a></div><div class="ttdeci">MiscComputationInfo misc_info</div><div class="ttdoc">misc_info is for extensibility to things that don&amp;#39;t easily fit into the framework. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00130">nnet-computation.h:130</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a4a1bed82d2cb5fbdc695bf32053117ad"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a4a1bed82d2cb5fbdc695bf32053117ad">kaldi::nnet3::ConvertNumNValues</a></div><div class="ttdeci">static void ConvertNumNValues(int32 n_stride, int32 old_N, int32 new_N, const std::vector&lt; Index &gt; &amp;indexes_in, std::vector&lt; Index &gt; *indexes_out)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03106">nnet-optimize-utils.cc:3106</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_html_a2035ba0afa36778a6f4f664af777e7e6"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a2035ba0afa36778a6f4f664af777e7e6">kaldi::nnet3::MemoryCompressionOptimizer::Optimize</a></div><div class="ttdeci">void Optimize()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04803">nnet-optimize-utils.cc:4803</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1Component_html"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1Component.html">kaldi::nnet3::Component</a></div><div class="ttdoc">Abstract base-class for neural-net components. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-component-itf_8h_source.html#l00114">nnet-component-itf.h:114</a></div></div>
<div class="ttc" id="group__io__funcs__basic_html_ga1bd1af0ef712b76f2332febcec8d095a"><div class="ttname"><a href="group__io__funcs__basic.html#ga1bd1af0ef712b76f2332febcec8d095a">kaldi::ReadBasicType</a></div><div class="ttdeci">void ReadBasicType(std::istream &amp;is, bool binary, T *t)</div><div class="ttdoc">ReadBasicType is the name of the read function for bool, integer types, and floating-point types...</div><div class="ttdef"><b>Definition:</b> <a href="io-funcs-inl_8h_source.html#l00055">io-funcs-inl.h:55</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_adbabf05a7702103113a02a113015205f"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#adbabf05a7702103113a02a113015205f">kaldi::nnet3::ComputationExpander::nnet_</a></div><div class="ttdeci">const Nnet &amp; nnet_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03288">nnet-optimize-utils.cc:3288</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1CindexVectorHasher_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1CindexVectorHasher.html">kaldi::nnet3::CindexVectorHasher</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-common_8h_source.html#l00125">nnet-common.h:125</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_html_a3cdcac57cf79079fc211c29b6d4cb8dc"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a3cdcac57cf79079fc211c29b6d4cb8dc">kaldi::nnet3::MemoryCompressionOptimizer::ModifyComputation</a></div><div class="ttdeci">void ModifyComputation()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04769">nnet-optimize-utils.cc:4769</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo_html_ae9d62983f13507bd8805be92eb61a2a4"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#ae9d62983f13507bd8805be92eb61a2a4">kaldi::nnet3::MemoryCompressionOptimizer::MatrixCompressInfo::m</a></div><div class="ttdeci">int32 m</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04726">nnet-optimize-utils.cc:4726</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a6828e427bd8883455705e0c9b99b5f2f"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a6828e427bd8883455705e0c9b99b5f2f">kaldi::nnet3::RenumberComputation</a></div><div class="ttdeci">void RenumberComputation(NnetComputation *computation)</div><div class="ttdoc">This function detects submatrices and matrices that are never used (e.g. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00693">nnet-optimize-utils.cc:693</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_ac0618c08b05537029106fab90e16dfe0"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#ac0618c08b05537029106fab90e16dfe0">kaldi::nnet3::ComputationExpander::ComputeSubmatrixInfo</a></div><div class="ttdeci">void ComputeSubmatrixInfo()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03637">nnet-optimize-utils.cc:3637</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_a1920fdb81424ab47c050e27102ddcfd6"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a1920fdb81424ab47c050e27102ddcfd6">kaldi::nnet3::ComputationRenumberer::Renumber</a></div><div class="ttdeci">void Renumber()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00489">nnet-optimize-utils.cc:489</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a0cc731e05d6603b7d4d0191f9f1c9d32"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a0cc731e05d6603b7d4d0191f9f1c9d32">kaldi::nnet3::InsertCommands</a></div><div class="ttdeci">void InsertCommands(std::vector&lt; std::pair&lt; int32, NnetComputation::Command &gt; &gt; *new_commands, NnetComputation *computation)</div><div class="ttdoc">Inserts commands into the computation at the requested places. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04640">nnet-optimize-utils.cc:4640</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_ae93293e76f4dc9049065601362e9bc2e"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#ae93293e76f4dc9049065601362e9bc2e">kaldi::nnet3::ComputationLoopedOptimizer::AddMatrixSwapCommands</a></div><div class="ttdeci">static void AddMatrixSwapCommands(const std::vector&lt; int32 &gt; &amp;matrices1, const std::vector&lt; int32 &gt; &amp;matrices2, NnetComputation *computation)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04419">nnet-optimize-utils.cc:4419</a></div></div>
<div class="ttc" id="group__error__group_html_gae77f5cf98f18f8cbe207690e49da166e"><div class="ttname"><a href="group__error__group.html#gae77f5cf98f18f8cbe207690e49da166e">kaldi::GetVerboseLevel</a></div><div class="ttdeci">int32 GetVerboseLevel()</div><div class="ttdef"><b>Definition:</b> <a href="kaldi-error_8h_source.html#l00057">kaldi-error.h:57</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a36da016976f88292c0d31653a20cbfe3a1713e609229066c956d4c7d544c69658"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a1713e609229066c956d4c7d544c69658">kaldi::nnet3::kUsesMemo</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-component-itf_8h_source.html#l00079">nnet-component-itf.h:79</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352aaa3fd92744438323baec475cee5b9b3d"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352aaa3fd92744438323baec475cee5b9b3d">kaldi::nnet3::kProvideOutput</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00294">nnet-computation.h:294</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1MatrixAccesses_html_a7464ec491eeba4c23632a6ae583e9429"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#a7464ec491eeba4c23632a6ae583e9429">kaldi::nnet3::MatrixAccesses::is_output</a></div><div class="ttdeci">bool is_output</div><div class="ttdoc">true if this matrix is an output of the computation (i.e. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00270">nnet-analyze.h:270</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo_html_a9da2804c57d358d12d491f0c3d51d0ef"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a9da2804c57d358d12d491f0c3d51d0ef">kaldi::nnet3::NnetComputation::MatrixDebugInfo::is_deriv</a></div><div class="ttdeci">bool is_deriv</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00316">nnet-computation.h:316</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_a14a83a4f58ad0342612cbb5ff943c580"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a14a83a4f58ad0342612cbb5ff943c580">kaldi::nnet3::DerivativeTimeLimiter::submatrix_map_if_deriv_</a></div><div class="ttdeci">std::vector&lt; int32 &gt; submatrix_map_if_deriv_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00361">nnet-optimize-utils.h:361</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a79ca9eaa954dd29bb0671fb99e550439">kaldi::nnet3::kNoOperation</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00295">nnet-computation.h:295</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_html_a36d13565d1302a2bf74127b141ba3537"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a36d13565d1302a2bf74127b141ba3537">kaldi::nnet3::MemoryCompressionOptimizer::computation_</a></div><div class="ttdeci">NnetComputation * computation_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04764">nnet-optimize-utils.cc:4764</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_a8bca4ab6bca2d1728dc0b03cf863be52"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a8bca4ab6bca2d1728dc0b03cf863be52">kaldi::nnet3::DerivativeTimeLimiter::ComputeSubmatrixMaps</a></div><div class="ttdeci">void ComputeSubmatrixMaps()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02013">nnet-optimize-utils.cc:2013</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1RowOpsSplitter_html_a8f9f90f42e150720274c1aa1194b2cf3"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a8f9f90f42e150720274c1aa1194b2cf3">kaldi::nnet3::RowOpsSplitter::SplitCommand</a></div><div class="ttdeci">bool SplitCommand(int32 command_index)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02780">nnet-optimize-utils.cc:2780</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_a96c233d2a3038b6ce3f46adc9eeac6c8"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a96c233d2a3038b6ce3f46adc9eeac6c8">kaldi::nnet3::ComputationExpander::misc_info_</a></div><div class="ttdeci">const MiscComputationInfo &amp; misc_info_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03289">nnet-optimize-utils.cc:3289</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_ab7df4401facb8eb025241471ca37a9d9"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ab7df4401facb8eb025241471ca37a9d9">kaldi::nnet3::DerivativeTimeLimiter::whole_submatrices_</a></div><div class="ttdeci">std::vector&lt; int32 &gt; whole_submatrices_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00346">nnet-optimize-utils.h:346</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_a356665946a32706f0cc3c880154ff3ca"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a356665946a32706f0cc3c880154ff3ca">kaldi::nnet3::ComputationRenumberer::ComputeSubmatrixIsUsed</a></div><div class="ttdeci">void ComputeSubmatrixIsUsed()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00361">nnet-optimize-utils.cc:361</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a36da016976f88292c0d31653a20cbfe3a61132a04f6c327dffd7f053b93ae393b"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a61132a04f6c327dffd7f053b93ae393b">kaldi::nnet3::kUpdatableComponent</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-component-itf_8h_source.html#l00042">nnet-component-itf.h:42</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetOptimizeOptions_html_a5a9cf0a0e6fa879ef136d18e4b3a7493"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetOptimizeOptions.html#a5a9cf0a0e6fa879ef136d18e4b3a7493">kaldi::nnet3::NnetOptimizeOptions::remove_assignments</a></div><div class="ttdeci">bool remove_assignments</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize_8h_source.html#l00046">nnet-optimize.h:46</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_af87da4e8a0e1880438bf77e8a34b4143"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#af87da4e8a0e1880438bf77e8a34b4143">kaldi::nnet3::IdentifySubmatrixArgsInComputation</a></div><div class="ttdeci">void IdentifySubmatrixArgsInComputation(NnetComputation *computation, std::vector&lt; int32 *&gt; *submatrix_args)</div><div class="ttdoc">This function outputs to &quot;submatrix_args&quot; the addresses of integers in &amp;#39;computation&amp;#39; that correspond ...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00340">nnet-optimize-utils.cc:340</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_a16ed03ea200a71de08070d77fd52ceb9"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#a16ed03ea200a71de08070d77fd52ceb9">kaldi::nnet3::NnetComputation::NewMatrix</a></div><div class="ttdeci">int32 NewMatrix(int32 num_rows, int32 num_cols, MatrixStrideType stride_type)</div><div class="ttdoc">Convenience function used when adding new matrices. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8cc_source.html#l00128">nnet-computation.cc:128</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_a9bfd022e9b1b6b8bf5494afbcd8aff9d"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a9bfd022e9b1b6b8bf5494afbcd8aff9d">kaldi::nnet3::ComputationExpander::ExpandRowRangesCommand</a></div><div class="ttdeci">void ExpandRowRangesCommand(const NnetComputation::Command &amp;c_in, NnetComputation::Command *c_out)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03426">nnet-optimize-utils.cc:3426</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html">kaldi::nnet3::NnetComputation::SubMatrixInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00323">nnet-computation.h:323</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_a849faa82711b6faa8551205167721bfa"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#a849faa82711b6faa8551205167721bfa">kaldi::nnet3::NnetComputation::Print</a></div><div class="ttdeci">void Print(std::ostream &amp;os, const Nnet &amp;nnet) const</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8cc_source.html#l00717">nnet-computation.cc:717</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a79122735e3f124a6865ff339f40ec191"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a79122735e3f124a6865ff339f40ec191">kaldi::nnet3::FindNStride</a></div><div class="ttdeci">static int32 FindNStride(const std::vector&lt; Index &gt; &amp;indexes, bool full_check)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02942">nnet-optimize-utils.cc:2942</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo_html_af204d5e92149d32574e14fc5416092af"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#af204d5e92149d32574e14fc5416092af">kaldi::nnet3::MemoryCompressionOptimizer::MatrixCompressInfo::MatrixCompressInfo</a></div><div class="ttdeci">MatrixCompressInfo(int32 m, int32 forward_command_index, int32 backward_command_index, CuCompressedMatrixType compression_type, BaseFloat range, bool truncate)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04749">nnet-optimize-utils.cc:4749</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_ae3ebe9f7e8bfc061d7582b3964698e4e"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#ae3ebe9f7e8bfc061d7582b3964698e4e">kaldi::nnet3::IsNoop</a></div><div class="ttdeci">static bool IsNoop(const NnetComputation::Command &amp;command)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00699">nnet-optimize-utils.cc:699</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_a50e8cbb0a710d4d2862d8b19c72902bc"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a50e8cbb0a710d4d2862d8b19c72902bc">kaldi::nnet3::ComputationLoopedOptimizer::GetIdentifiedMatrices</a></div><div class="ttdeci">static void GetIdentifiedMatrices(const std::vector&lt; std::pair&lt; int32, int32 &gt; &gt; &amp;pair_list1, const std::vector&lt; std::pair&lt; int32, int32 &gt; &gt; &amp;pair_list2, const unordered_map&lt; std::pair&lt; int32, int32 &gt;, int32, PairHasher&lt; int32 &gt; &gt; &amp;pair_to_matrix, std::vector&lt; int32 &gt; *matrix_list1, std::vector&lt; int32 &gt; *matrix_list2)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04258">nnet-optimize-utils.cc:4258</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_a2d58446b9b01c450142c48ec4732b0b6"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a2d58446b9b01c450142c48ec4732b0b6">kaldi::nnet3::ComputationRenumberer::RenumberIndexesRanges</a></div><div class="ttdeci">void RenumberIndexesRanges()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00635">nnet-optimize-utils.cc:635</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html">kaldi::nnet3::ModelUpdateConsolidator</a></div><div class="ttdoc">This class is responsible for consolidating the model-update part of backprop commands, for components in (e.g.) recurrent networks that need to have many separate backprop commands, into more efficient single commands operating on consolidated data in larger matrices. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01282">nnet-optimize-utils.cc:1282</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo_html_a1854b20fac9e366b01781d5d7c3a87e9"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a1854b20fac9e366b01781d5d7c3a87e9">kaldi::nnet3::DerivativeTimeLimiter::MatrixPruneInfo::row_begin</a></div><div class="ttdeci">int32 row_begin</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00328">nnet-optimize-utils.h:328</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a54a0b9eb6a79c232605aa83476d44bb0"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a54a0b9eb6a79c232605aa83476d44bb0">kaldi::nnet3::RequestIsDecomposable</a></div><div class="ttdeci">bool RequestIsDecomposable(const ComputationRequest &amp;request, ComputationRequest *mini_request, int32 *num_n_values)</div><div class="ttdoc">This function, used in &amp;#39;shortcut&amp;#39; compilation where we first compile a smaller computation with the s...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03852">nnet-optimize-utils.cc:3852</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_a81b35995b5ef2650f6367cb1299ef0fd"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a81b35995b5ef2650f6367cb1299ef0fd">kaldi::nnet3::ComputationExpander::computation_</a></div><div class="ttdeci">const NnetComputation &amp; computation_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03290">nnet-optimize-utils.cc:3290</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1RowOpsSplitter_html_a20fdcf4e5960cc4202a0415153b5e19b"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a20fdcf4e5960cc4202a0415153b5e19b">kaldi::nnet3::RowOpsSplitter::new_commands_</a></div><div class="ttdeci">std::vector&lt; std::pair&lt; int32, NnetComputation::Command &gt; &gt; new_commands_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02681">nnet-optimize-utils.cc:2681</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_a8f1ed03be326c0cbf0728194d4ac30d0"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a8f1ed03be326c0cbf0728194d4ac30d0">kaldi::nnet3::ComputationRenumberer::ComputationRenumberer</a></div><div class="ttdeci">ComputationRenumberer(NnetComputation *computation)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00150">nnet-optimize-utils.cc:150</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a341a9c019757a7f1172d86bad51500a5"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a341a9c019757a7f1172d86bad51500a5">kaldi::nnet3::kCopyRowsMulti</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00292">nnet-computation.h:292</a></div></div>
<div class="ttc" id="namespacekaldi_html_aa3e99328db564bc2bf6397fa1eaee4d7"><div class="ttname"><a href="namespacekaldi.html#aa3e99328db564bc2bf6397fa1eaee4d7">kaldi::swap</a></div><div class="ttdeci">void swap(basic_filebuf&lt; CharT, Traits &gt; &amp;x, basic_filebuf&lt; CharT, Traits &gt; &amp;y)</div><div class="ttdef"><b>Definition:</b> <a href="basic-filebuf_8h_source.html#l00275">basic-filebuf.h:275</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo_html_a71978616b0acd678d1f284943acd6586"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a71978616b0acd678d1f284943acd6586">kaldi::nnet3::NnetComputation::SubMatrixInfo::num_rows</a></div><div class="ttdeci">int32 num_rows</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00326">nnet-computation.h:326</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command_html_a267b75d3c5f85743c08fb319bd679b1f"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a267b75d3c5f85743c08fb319bd679b1f">kaldi::nnet3::NnetComputation::Command::arg6</a></div><div class="ttdeci">int32 arg6</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00346">nnet-computation.h:346</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationChecker_html"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationChecker.html">kaldi::nnet3::ComputationChecker</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00411">nnet-analyze.h:411</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352ae77588ab7fc4ccf842de7ec941247062"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae77588ab7fc4ccf842de7ec941247062">kaldi::nnet3::kDeallocMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00289">nnet-computation.h:289</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1ComputationRequest_html_a56ccdfeff2303e6dee20771d1a4fad78"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a56ccdfeff2303e6dee20771d1a4fad78">kaldi::nnet3::ComputationRequest::inputs</a></div><div class="ttdeci">std::vector&lt; IoSpecification &gt; inputs</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00115">nnet-computation.h:115</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_a47a751a8db1c9c4856d04495f80620e9"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#a47a751a8db1c9c4856d04495f80620e9">kaldi::nnet3::NnetComputation::matrices</a></div><div class="ttdeci">std::vector&lt; MatrixInfo &gt; matrices</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00390">nnet-computation.h:390</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_a8217a8f0d8406fe0e5fdbdb371feebbd"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a8217a8f0d8406fe0e5fdbdb371feebbd">kaldi::nnet3::DerivativeTimeLimiter::DerivativeTimeLimiter</a></div><div class="ttdeci">DerivativeTimeLimiter(const Nnet &amp;nnet, int32 min_deriv_time, int32 max_deriv_time, NnetComputation *computation)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01930">nnet-optimize-utils.cc:1930</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationCache_html_a281b5ec791338d4378e22ef44a51b4a1"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationCache.html#a281b5ec791338d4378e22ef44a51b4a1">kaldi::nnet3::ComputationCache::mutex_</a></div><div class="ttdeci">std::mutex mutex_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00658">nnet-optimize-utils.h:658</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352add9060e8c7434f250048082c634d9a6d"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352add9060e8c7434f250048082c634d9a6d">kaldi::nnet3::kGotoLabel</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00296">nnet-computation.h:296</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a308b0ecf9083a7fde572d88f70af6258"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a308b0ecf9083a7fde572d88f70af6258">kaldi::nnet3::kCopyRows</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00291">nnet-computation.h:291</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352ae9638edeb0ada9a6373257fd508ae11f"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352ae9638edeb0ada9a6373257fd508ae11f">kaldi::nnet3::kAddRows</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00291">nnet-computation.h:291</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1Component_html_ad3829084b3e064ff320153ff4b6cfd44"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1Component.html#ad3829084b3e064ff320153ff4b6cfd44">kaldi::nnet3::Component::PrecomputeIndexes</a></div><div class="ttdeci">virtual ComponentPrecomputedIndexes * PrecomputeIndexes(const MiscComputationInfo &amp;misc_info, const std::vector&lt; Index &gt; &amp;input_indexes, const std::vector&lt; Index &gt; &amp;output_indexes, bool need_backprop) const</div><div class="ttdoc">This function must return NULL for simple Components. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-component-itf_8h_source.html#l00302">nnet-component-itf.h:302</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet2_html_aeff1c1ada8948d90166bccf6ff83cf3e"><div class="ttname"><a href="namespacekaldi_1_1nnet2.html#aeff1c1ada8948d90166bccf6ff83cf3e">kaldi::nnet2::NnetComputation</a></div><div class="ttdeci">void NnetComputation(const Nnet &amp;nnet, const CuMatrixBase&lt; BaseFloat &gt; &amp;input, bool pad_input, CuMatrixBase&lt; BaseFloat &gt; *output)</div><div class="ttdoc">Does the basic neural net computation, on a sequence of data (e.g. </div><div class="ttdef"><b>Definition:</b> <a href="nnet2_2nnet-compute_8cc_source.html#l00160">nnet-compute.cc:160</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_ac797c8d6a701fb10dc8de13d2db3dcbe"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#ac797c8d6a701fb10dc8de13d2db3dcbe">kaldi::nnet3::ComputationLoopedOptimizer::GetPairToMatrixMap</a></div><div class="ttdeci">static void GetPairToMatrixMap(std::vector&lt; std::pair&lt; int32, int32 &gt; &gt; &amp;matrix_to_pair, unordered_map&lt; std::pair&lt; int32, int32 &gt;, int32, PairHasher&lt; int32 &gt; &gt; *pair_to_matrix)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04177">nnet-optimize-utils.cc:4177</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_a36d13565d1302a2bf74127b141ba3537"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a36d13565d1302a2bf74127b141ba3537">kaldi::nnet3::DerivativeTimeLimiter::computation_</a></div><div class="ttdeci">NnetComputation * computation_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00342">nnet-optimize-utils.h:342</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1MiscComputationInfo_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1MiscComputationInfo.html">kaldi::nnet3::MiscComputationInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00055">nnet-computation.h:55</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1MatrixAccesses_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1MatrixAccesses.html">kaldi::nnet3::MatrixAccesses</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00249">nnet-analyze.h:249</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1CommandPairComparator_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1CommandPairComparator.html">kaldi::nnet3::CommandPairComparator</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04631">nnet-optimize-utils.cc:4631</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_ac8ca96df1ecdb635738c59a88cff8835"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#ac8ca96df1ecdb635738c59a88cff8835">kaldi::nnet3::ComputationLoopedOptimizer::analyzer_</a></div><div class="ttdeci">Analyzer analyzer_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04063">nnet-optimize-utils.cc:4063</a></div></div>
<div class="ttc" id="namespacekaldi_html_a3dd7a9cc33032bfb870b4b6c053822db"><div class="ttname"><a href="namespacekaldi.html#a3dd7a9cc33032bfb870b4b6c053822db">kaldi::SortAndUniq</a></div><div class="ttdeci">void SortAndUniq(std::vector&lt; T &gt; *vec)</div><div class="ttdoc">Sorts and uniq&amp;#39;s (removes duplicates) from a vector. </div><div class="ttdef"><b>Definition:</b> <a href="stl-utils_8h_source.html#l00039">stl-utils.h:39</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1IoSpecification_html_a9b45b3e13bd9167aab02e17e08916231"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1IoSpecification.html#a9b45b3e13bd9167aab02e17e08916231">kaldi::nnet3::IoSpecification::name</a></div><div class="ttdeci">std::string name</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00073">nnet-computation.h:73</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a1adea5ddcf5f2d26ee01d796ec13510c"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a1adea5ddcf5f2d26ee01d796ec13510c">kaldi::nnet3::ExtendMatrices</a></div><div class="ttdeci">void ExtendMatrices(NnetComputation *computation)</div><div class="ttdoc">This is not really an optimization in itself but it can make things easier for class VariableMergingO...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01270">nnet-optimize-utils.cc:1270</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_a071bff9d8909e7d80b7d85a3d3b69aff"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a071bff9d8909e7d80b7d85a3d3b69aff">kaldi::nnet3::DerivativeTimeLimiter::MapAddRowRangesCommand</a></div><div class="ttdeci">void MapAddRowRangesCommand(NnetComputation::Command *c)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01860">nnet-optimize-utils.cc:1860</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a6b396f5162883c2f4fb837a2af4b8895"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a6b396f5162883c2f4fb837a2af4b8895">kaldi::nnet3::kAcceptInput</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00294">nnet-computation.h:294</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a19758aa995e3baa1aa2cef6528d10fb9"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a19758aa995e3baa1aa2cef6528d10fb9">kaldi::nnet3::kCompressMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00293">nnet-computation.h:293</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_afeb2e3e7413a0649c8a60e3bcd66981b"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#afeb2e3e7413a0649c8a60e3bcd66981b">kaldi::nnet3::NnetComputation::commands</a></div><div class="ttdeci">std::vector&lt; Command &gt; commands</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00439">nnet-computation.h:439</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationCache_html_a32eb6279a97f57165c225724a533ae39"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationCache.html#a32eb6279a97f57165c225724a533ae39">kaldi::nnet3::ComputationCache::Find</a></div><div class="ttdeci">std::shared_ptr&lt; const NnetComputation &gt; Find(const ComputationRequest &amp;request)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04951">nnet-optimize-utils.cc:4951</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_aecd7fa564d816a5025ca66346f6b80fe"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#aecd7fa564d816a5025ca66346f6b80fe">kaldi::nnet3::ComputationExpander::ComputeMatrixInfo</a></div><div class="ttdeci">void ComputeMatrixInfo()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03588">nnet-optimize-utils.cc:3588</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a73b5995148c3e987c4a163ad6bc9850b"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a73b5995148c3e987c4a163ad6bc9850b">kaldi::nnet3::kAllocMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00289">nnet-computation.h:289</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo_html_aff7fe31cc8e3cc6b36b37d139e4f1470"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#aff7fe31cc8e3cc6b36b37d139e4f1470">kaldi::nnet3::NnetComputation::MatrixInfo::stride_type</a></div><div class="ttdeci">MatrixStrideType stride_type</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00307">nnet-computation.h:307</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_accb646181ec3c992ecd18442ec788d33"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#accb646181ec3c992ecd18442ec788d33">kaldi::nnet3::DerivativeTimeLimiter::RemoveUnusedMemos</a></div><div class="ttdeci">void RemoveUnusedMemos()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01955">nnet-optimize-utils.cc:1955</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_a421b918da6c7e4b2706ae55f7be3611c"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a421b918da6c7e4b2706ae55f7be3611c">kaldi::nnet3::DerivativeTimeLimiter::LimitMatrices</a></div><div class="ttdeci">void LimitMatrices(const std::vector&lt; bool &gt; &amp;will_limit)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02116">nnet-optimize-utils.cc:2116</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a6ed9b871bd28649b80165dc1af5d1a98"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a6ed9b871bd28649b80165dc1af5d1a98">kaldi::nnet3::LimitDerivativeTimes</a></div><div class="ttdeci">void LimitDerivativeTimes(const Nnet &amp;nnet, int32 min_deriv_time, int32 max_deriv_time, NnetComputation *computation)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02215">nnet-optimize-utils.cc:2215</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationCache_html_a68f354fd5f096134162f01719096e6fc"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationCache.html#a68f354fd5f096134162f01719096e6fc">kaldi::nnet3::ComputationCache::Write</a></div><div class="ttdeci">void Write(std::ostream &amp;os, bool binary) const</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l05051">nnet-optimize-utils.cc:5051</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MatrixExtender_html_ac0d77abc89752f5c47d7141456ed1821"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MatrixExtender.html#ac0d77abc89752f5c47d7141456ed1821">kaldi::nnet3::MatrixExtender::is_input_or_output_</a></div><div class="ttdeci">std::vector&lt; bool &gt; is_input_or_output_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01061">nnet-optimize-utils.cc:1061</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_ab1ce7f2f77d6a0b0dcd87e3b09bc7a43"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ab1ce7f2f77d6a0b0dcd87e3b09bc7a43">kaldi::nnet3::DerivativeTimeLimiter::CanLimitMatrix</a></div><div class="ttdeci">bool CanLimitMatrix(const Analyzer &amp;analyzer, int32 matrix_index) const</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02070">nnet-optimize-utils.cc:2070</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1Index_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1Index.html">kaldi::nnet3::Index</a></div><div class="ttdoc">struct Index is intended to represent the various indexes by which we number the rows of the matrices...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-common_8h_source.html#l00044">nnet-common.h:44</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html">kaldi::nnet3::ComputationLoopedOptimizer</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03890">nnet-optimize-utils.cc:3890</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1RowOpsSplitter_html_adc9b18c1d651afbbff474ffa6cf29d77"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#adc9b18c1d651afbbff474ffa6cf29d77">kaldi::nnet3::RowOpsSplitter::RowOpsSplitter</a></div><div class="ttdeci">RowOpsSplitter(NnetComputation *computation)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02580">nnet-optimize-utils.cc:2580</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a55f8cb2bfd2e2c3605dfa961eff35fa2"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a55f8cb2bfd2e2c3605dfa961eff35fa2">kaldi::nnet3::kSetConst</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00289">nnet-computation.h:289</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_af21b8b1c9ede3dc6087eb7f89f7f1b43"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#af21b8b1c9ede3dc6087eb7f89f7f1b43">kaldi::nnet3::ComputationRenumberer::num_matrices_new_</a></div><div class="ttdeci">int32 num_matrices_new_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00245">nnet-optimize-utils.cc:245</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_aaa7be32bf8cc53a5cfb20eb89280dd06"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#aaa7be32bf8cc53a5cfb20eb89280dd06">kaldi::nnet3::ComputationExpander::GetNewMatrixLocationInfo</a></div><div class="ttdeci">int32 GetNewMatrixLocationInfo(int32 old_matrix_index, int32 old_row_index) const</div><div class="ttdoc">This function is used in mapping row-indexes into matrices, from the old to the new computation...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03761">nnet-optimize-utils.cc:3761</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a10b449e04f7115cc85d295440638fade"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a10b449e04f7115cc85d295440638fade">kaldi::nnet3::OptimizeMemoryCompression</a></div><div class="ttdeci">void OptimizeMemoryCompression(const Nnet &amp;nnet, int32 memory_compression_level, NnetComputation *computation)</div><div class="ttdoc">Performs optimization to reduce memory usage where possible, making use of the kCompressMatrix and kD...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04899">nnet-optimize-utils.cc:4899</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_a0d39b8710ac9abb65b0812bc1a82f52e"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a0d39b8710ac9abb65b0812bc1a82f52e">kaldi::nnet3::ComputationExpander::ExpandIndexes</a></div><div class="ttdeci">void ExpandIndexes(const std::vector&lt; Index &gt; &amp;indexes, std::vector&lt; Index &gt; *indexes_expanded) const</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03794">nnet-optimize-utils.cc:3794</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1MatrixAccesses_html_a36b3030ce98db1e72110930473d8b93e"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#a36b3030ce98db1e72110930473d8b93e">kaldi::nnet3::MatrixAccesses::accesses</a></div><div class="ttdeci">std::vector&lt; Access &gt; accesses</div><div class="ttdoc">Records the indexes of commands that access the matrix, and the type (read, read/write, write). </div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00264">nnet-analyze.h:264</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo_html_a3177807d10c7537255bcfdc9122b1212"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#a3177807d10c7537255bcfdc9122b1212">kaldi::nnet3::MemoryCompressionOptimizer::MatrixCompressInfo::compression_command_index</a></div><div class="ttdeci">int32 compression_command_index</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04730">nnet-optimize-utils.cc:4730</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationCache_html_a551e1e19651c8e13d62f27e82248b33a"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationCache.html#a551e1e19651c8e13d62f27e82248b33a">kaldi::nnet3::ComputationCache::Insert</a></div><div class="ttdeci">std::shared_ptr&lt; const NnetComputation &gt; Insert(const ComputationRequest &amp;request, const NnetComputation *computation)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04974">nnet-optimize-utils.cc:4974</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a8ce789ab4782758335cc37349fb97257"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a8ce789ab4782758335cc37349fb97257">kaldi::nnet3::kMatrixAdd</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00291">nnet-computation.h:291</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1PrecomputedIndexesInfo_html_aac3f15181923193b59c8cf2f1433d88b"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1PrecomputedIndexesInfo.html#aac3f15181923193b59c8cf2f1433d88b">kaldi::nnet3::NnetComputation::PrecomputedIndexesInfo::data</a></div><div class="ttdeci">ComponentPrecomputedIndexes * data</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00379">nnet-computation.h:379</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command_html_ab082999af0bd106d899d3121506053a4"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ab082999af0bd106d899d3121506053a4">kaldi::nnet3::NnetComputation::Command::arg4</a></div><div class="ttdeci">int32 arg4</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00344">nnet-computation.h:344</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_a7b34d0f8ba1be1c25827f404fd1de33c"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a7b34d0f8ba1be1c25827f404fd1de33c">kaldi::nnet3::DerivativeTimeLimiter::max_deriv_time_</a></div><div class="ttdeci">int32 max_deriv_time_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00338">nnet-optimize-utils.h:338</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_a228a7ce7320c66bc72058b3805fec957"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a228a7ce7320c66bc72058b3805fec957">kaldi::nnet3::ComputationRenumberer::RenumberIndexes</a></div><div class="ttdeci">void RenumberIndexes()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00581">nnet-optimize-utils.cc:581</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command_html_a93be071b8aca6a02f5fe1f67c5e69273"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a93be071b8aca6a02f5fe1f67c5e69273">kaldi::nnet3::NnetComputation::Command::arg1</a></div><div class="ttdeci">int32 arg1</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00341">nnet-computation.h:341</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_a9ff791337c174a7dd4d789a414c452e3"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a9ff791337c174a7dd4d789a414c452e3">kaldi::nnet3::ModelUpdateConsolidator::AddCommandsToComputation</a></div><div class="ttdeci">void AddCommandsToComputation()</div><div class="ttdoc">This function, called at the end of ConsolidateModelUpdate(), takes the commands that we have put in ...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01434">nnet-optimize-utils.cc:1434</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_ac6ad0d391be80aff8f4538b6fbf747b1"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#ac6ad0d391be80aff8f4538b6fbf747b1">kaldi::nnet3::NnetComputation::GetWholeSubmatrices</a></div><div class="ttdeci">void GetWholeSubmatrices(std::vector&lt; int32 &gt; *whole_submatrices) const</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8cc_source.html#l01173">nnet-computation.cc:1173</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_ac8344e7587df9247d6cc492874901d4d"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#ac8344e7587df9247d6cc492874901d4d">kaldi::nnet3::Cindex</a></div><div class="ttdeci">std::pair&lt; int32, Index &gt; Cindex</div><div class="ttdef"><b>Definition:</b> <a href="nnet-common_8h_source.html#l00115">nnet-common.h:115</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetOptimizeOptions_html_ada3212723faff5ad5d718401c2b14abd"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetOptimizeOptions.html#ada3212723faff5ad5d718401c2b14abd">kaldi::nnet3::NnetOptimizeOptions::optimize</a></div><div class="ttdeci">bool optimize</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize_8h_source.html#l00038">nnet-optimize.h:38</a></div></div>
<div class="ttc" id="nnet-optimize_8h_html"><div class="ttname"><a href="nnet-optimize_8h.html">nnet-optimize.h</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_a138955c2d9469f28aa78853564c298ce"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a138955c2d9469f28aa78853564c298ce">kaldi::nnet3::ComputationRenumberer::RemoveIndexesMultiDuplicates</a></div><div class="ttdeci">void RemoveIndexesMultiDuplicates()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00538">nnet-optimize-utils.cc:538</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_a357897f866f5c4ab0b3536d31ddf4284"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a357897f866f5c4ab0b3536d31ddf4284">kaldi::nnet3::ComputationExpander::ComputationExpander</a></div><div class="ttdeci">ComputationExpander(const Nnet &amp;nnet, const MiscComputationInfo &amp;misc_info, const NnetComputation &amp;computation, bool need_debug_info, int32 num_n_values, NnetComputation *expanded_computation)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03140">nnet-optimize-utils.cc:3140</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352af67517e882c1aebe145a016945b9e6a4"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352af67517e882c1aebe145a016945b9e6a4">kaldi::nnet3::kNoOperationMarker</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00295">nnet-computation.h:295</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_a61634eedcfea10a32bdb33bca3f94f2b"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#a61634eedcfea10a32bdb33bca3f94f2b">kaldi::nnet3::NnetComputation::NewSubMatrix</a></div><div class="ttdeci">int32 NewSubMatrix(int32 base_submatrix, int32 row_offset, int32 num_rows, int32 col_offset, int32 num_cols)</div><div class="ttdoc">Convenience function used when adding new sub-matrices. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8cc_source.html#l00102">nnet-computation.cc:102</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a5161c1dfc34a4df1b19e9d3b8dc9499c"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a5161c1dfc34a4df1b19e9d3b8dc9499c">kaldi::nnet3::kCopyToRowsMulti</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00292">nnet-computation.h:292</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1Index_html_aad8b608072a1b6dcd9e91de38ee2925f"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1Index.html#aad8b608072a1b6dcd9e91de38ee2925f">kaldi::nnet3::Index::n</a></div><div class="ttdeci">int32 n</div><div class="ttdef"><b>Definition:</b> <a href="nnet-common_8h_source.html#l00045">nnet-common.h:45</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo_html_aea941d74a486998b6fa921bc19fed05c"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#aea941d74a486998b6fa921bc19fed05c">kaldi::nnet3::NnetComputation::SubMatrixInfo::num_cols</a></div><div class="ttdeci">int32 num_cols</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00328">nnet-computation.h:328</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1ComputationRequest_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1ComputationRequest.html">kaldi::nnet3::ComputationRequest</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00114">nnet-computation.h:114</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1VariableMergingOptimizer_html_a22dcf522c53105fb97eedd837ec8f6ec"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a22dcf522c53105fb97eedd837ec8f6ec">kaldi::nnet3::VariableMergingOptimizer::DoMerge</a></div><div class="ttdeci">void DoMerge(int32 command_index, int32 s_to_keep, int32 m_to_discard)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00819">nnet-optimize-utils.cc:819</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_ab9f2139eeea0f81f453a7d514d7fb3d2"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ab9f2139eeea0f81f453a7d514d7fb3d2">kaldi::nnet3::ComputationRenumberer::submatrix_is_used_</a></div><div class="ttdeci">std::vector&lt; bool &gt; submatrix_is_used_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00235">nnet-optimize-utils.cc:235</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_a49ab0eb74e9ab7b96b459d319f443d02"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a49ab0eb74e9ab7b96b459d319f443d02">kaldi::nnet3::ModelUpdateConsolidator::ModelUpdateConsolidator</a></div><div class="ttdeci">ModelUpdateConsolidator(const Nnet &amp;nnet, NnetComputation *computation)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01509">nnet-optimize-utils.cc:1509</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_a283d532b71865991e14f83433b440332"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a283d532b71865991e14f83433b440332">kaldi::nnet3::ComputationLoopedOptimizer::CheckIdentifiedMatrices</a></div><div class="ttdeci">static void CheckIdentifiedMatrices(const NnetComputation &amp;computation, const std::vector&lt; int32 &gt; &amp;list1, const std::vector&lt; int32 &gt; &amp;list2, int32 time_difference)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04331">nnet-optimize-utils.cc:4331</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_ac0eab3be8e97f0ed110d0998bc2bc0a1"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#ac0eab3be8e97f0ed110d0998bc2bc0a1">kaldi::nnet3::ComputationLoopedOptimizer::matrix_to_pair_</a></div><div class="ttdeci">std::vector&lt; std::pair&lt; int32, int32 &gt; &gt; matrix_to_pair_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04064">nnet-optimize-utils.cc:4064</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html">kaldi::nnet3::NnetComputation::MatrixInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00304">nnet-computation.h:304</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationCache_html_a59e28b5d21625bf91ff84067ba90246d"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationCache.html#a59e28b5d21625bf91ff84067ba90246d">kaldi::nnet3::ComputationCache::ComputationCache</a></div><div class="ttdeci">ComputationCache(int32 cache_capacity)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04969">nnet-optimize-utils.cc:4969</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_a0208954d6ae356dca488033ecea40274"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a0208954d6ae356dca488033ecea40274">kaldi::nnet3::ComputationLoopedOptimizer::ListsAreEqualExceptForPossibleShift</a></div><div class="ttdeci">static bool ListsAreEqualExceptForPossibleShift(const std::vector&lt; std::pair&lt; int32, int32 &gt; &gt; &amp;a, const std::vector&lt; std::pair&lt; int32, int32 &gt; &gt; &amp;b, int32 shift)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04213">nnet-optimize-utils.cc:4213</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_ab753d835b665dd1b444b16f045c3e1a3"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#ab753d835b665dd1b444b16f045c3e1a3">kaldi::nnet3::GetMaxMemoryUse</a></div><div class="ttdeci">int64 GetMaxMemoryUse(const NnetComputation &amp;computation)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8cc_source.html#l01439">nnet-analyze.cc:1439</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_a58c542fffb7e7f754148c264c90b4a5e"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#a58c542fffb7e7f754148c264c90b4a5e">kaldi::nnet3::NnetComputation::need_model_derivative</a></div><div class="ttdeci">bool need_model_derivative</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00442">nnet-computation.h:442</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo_html_aea941d74a486998b6fa921bc19fed05c"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#aea941d74a486998b6fa921bc19fed05c">kaldi::nnet3::NnetComputation::MatrixInfo::num_cols</a></div><div class="ttdeci">int32 num_cols</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00306">nnet-computation.h:306</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1ComputationRequest_html_ab1b9ede63de755642e79f7287a62b92c"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1ComputationRequest.html#ab1b9ede63de755642e79f7287a62b92c">kaldi::nnet3::ComputationRequest::Read</a></div><div class="ttdeci">void Read(std::istream &amp;istream, bool binary)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8cc_source.html#l01034">nnet-computation.cc:1034</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html">kaldi::nnet3::RowOpsSplitter::SingleSplitInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02616">nnet-optimize-utils.cc:2616</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1Analyzer_html_aab8a145e53802c80302dc498e388a2ad"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1Analyzer.html#aab8a145e53802c80302dc498e388a2ad">kaldi::nnet3::Analyzer::Init</a></div><div class="ttdeci">void Init(const Nnet &amp;nnet, const NnetComputation &amp;computation)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8cc_source.html#l01421">nnet-analyze.cc:1421</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_afa02f703a75537d153178d8ad1e104ad"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#afa02f703a75537d153178d8ad1e104ad">kaldi::nnet3::ComputationExpander::expanded_computation_</a></div><div class="ttdeci">NnetComputation * expanded_computation_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03293">nnet-optimize-utils.cc:3293</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a41114607233f11aab89539abf08cf922"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a41114607233f11aab89539abf08cf922">kaldi::nnet3::ExpectToken</a></div><div class="ttdeci">static void ExpectToken(const std::string &amp;token, const std::string &amp;what_we_are_parsing, const std::string **next_token)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-descriptor_8cc_source.html#l00045">nnet-descriptor.cc:45</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationCache_html_a8e7d2790fc7e94fe9780ccc937de1270"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationCache.html#a8e7d2790fc7e94fe9780ccc937de1270">kaldi::nnet3::ComputationCache::Read</a></div><div class="ttdeci">void Read(std::istream &amp;is, bool binary)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l05018">nnet-optimize-utils.cc:5018</a></div></div>
<div class="ttc" id="classfloat_html"><div class="ttname"><a href="classfloat.html">float</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationVariables_html_a869ebf8f8238163a6c89ab096a6fcacf"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationVariables.html#a869ebf8f8238163a6c89ab096a6fcacf">kaldi::nnet3::ComputationVariables::NumVariables</a></div><div class="ttdeci">int32 NumVariables() const</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00155">nnet-analyze.h:155</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_aa8c3cb92dfb1d06fbfc4fe902f367c94"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#aa8c3cb92dfb1d06fbfc4fe902f367c94">kaldi::nnet3::NnetComputation::indexes_multi</a></div><div class="ttdeci">std::vector&lt; std::vector&lt; std::pair&lt; int32, int32 &gt; &gt; &gt; indexes_multi</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00425">nnet-computation.h:425</a></div></div>
<div class="ttc" id="namespacekaldi_html_a6a81f9c498a2d703ea343d906a827b6fa8cf976d526a5eac828cf765737a64bfa"><div class="ttname"><a href="namespacekaldi.html#a6a81f9c498a2d703ea343d906a827b6fa8cf976d526a5eac828cf765737a64bfa">kaldi::kCompressedMatrixInt16</a></div><div class="ttdef"><b>Definition:</b> <a href="cu-compressed-matrix_8h_source.html#l00143">cu-compressed-matrix.h:143</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_adbabf05a7702103113a02a113015205f"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#adbabf05a7702103113a02a113015205f">kaldi::nnet3::ComputationLoopedOptimizer::nnet_</a></div><div class="ttdeci">const Nnet &amp; nnet_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04061">nnet-optimize-utils.cc:4061</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_a768ce6ef8c9f2cd1b13dee1164c38213"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a768ce6ef8c9f2cd1b13dee1164c38213">kaldi::nnet3::ComputationLoopedOptimizer::FindActiveMatrices</a></div><div class="ttdeci">static void FindActiveMatrices(const NnetComputation &amp;computation, const Analyzer &amp;analyzer, const std::vector&lt; int32 &gt; &amp;splice_point_commands, std::vector&lt; std::vector&lt; int32 &gt; &gt; *active_matrices)</div><div class="ttdoc">Given a list of command indexes (&amp;#39;splice_point_commands&amp;#39;) which are expected to be command indexes of...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04293">nnet-optimize-utils.cc:4293</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a36da016976f88292c0d31653a20cbfe3a2a37e781d9be4e2cb09699a840dde841"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a2a37e781d9be4e2cb09699a840dde841">kaldi::nnet3::kBackpropNeedsOutput</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-component-itf_8h_source.html#l00067">nnet-component-itf.h:67</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MatrixExtender_html_a4e7255b52c14390ceef526de72511cc5"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a4e7255b52c14390ceef526de72511cc5">kaldi::nnet3::MatrixExtender::ExtendMatrices</a></div><div class="ttdeci">void ExtendMatrices()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01174">nnet-optimize-utils.cc:1174</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MatrixExtender_html_a0b1e031e0f3c969b8006e81aff6b160d"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a0b1e031e0f3c969b8006e81aff6b160d">kaldi::nnet3::MatrixExtender::CanBeExtended</a></div><div class="ttdeci">bool CanBeExtended(int32 dest_submatrix_index, int32 src_submatrix_index)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01099">nnet-optimize-utils.cc:1099</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1Component_html_a3a4ff15fafe0c8c4885586fc2c36ca8a"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1Component.html#a3a4ff15fafe0c8c4885586fc2c36ca8a">kaldi::nnet3::Component::Properties</a></div><div class="ttdeci">virtual int32 Properties() const =0</div><div class="ttdoc">Return bitmask of the component&amp;#39;s properties. </div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command_html_a2de3c74f7141e97502ff48c2407b78be"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2de3c74f7141e97502ff48c2407b78be">kaldi::nnet3::NnetComputation::Command::alpha</a></div><div class="ttdeci">BaseFloat alpha</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00340">nnet-computation.h:340</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_html"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html">kaldi::nnet3::MemoryCompressionOptimizer</a></div><div class="ttdoc">This class is used in the function OptimizeMemoryCompression(), once we determine that there is some ...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04690">nnet-optimize-utils.cc:4690</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html">kaldi::nnet3::ComputationExpander</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03138">nnet-optimize-utils.cc:3138</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a3c29cb7ac7e40e18309451b6f8a193bd"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a3c29cb7ac7e40e18309451b6f8a193bd">kaldi::nnet3::SnipRangesRowOp</a></div><div class="ttdeci">static bool SnipRangesRowOp(NnetComputation *computation, int32 command_index)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02507">nnet-optimize-utils.cc:2507</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo_html_a297d5616d3920cb01d699e7a0e4d2a67"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html#a297d5616d3920cb01d699e7a0e4d2a67">kaldi::nnet3::NnetComputation::MatrixDebugInfo::cindexes</a></div><div class="ttdeci">std::vector&lt; Cindex &gt; cindexes</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00317">nnet-computation.h:317</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a36da016976f88292c0d31653a20cbfe3a2f52823d0c7fdc03b0be47662c66146d"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a2f52823d0c7fdc03b0be47662c66146d">kaldi::nnet3::kPropagateInPlace</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-component-itf_8h_source.html#l00049">nnet-component-itf.h:49</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_a1e3dad6a0a1c8cc5e5806070896de8c1"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a1e3dad6a0a1c8cc5e5806070896de8c1">kaldi::nnet3::DerivativeTimeLimiter::matrix_prune_info_</a></div><div class="ttdeci">std::vector&lt; MatrixPruneInfo &gt; matrix_prune_info_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00348">nnet-optimize-utils.h:348</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a86704308a1467b6000867cc9ed198482"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a86704308a1467b6000867cc9ed198482">kaldi::nnet3::GetSubMatrixOfSubMatrix</a></div><div class="ttdeci">static NnetComputation::SubMatrixInfo GetSubMatrixOfSubMatrix(const NnetComputation &amp;computation, int32 submat_a, int32 submat_b)</div><div class="ttdoc">This static function returns a SubMatrixInfo corresponding to replacing the matrix-index in a&amp;#39;s &quot;matr...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00789">nnet-optimize-utils.cc:789</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1VariableMergingOptimizer_html_a4dcce2ef4364ac3b222debac11646a39"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a4dcce2ef4364ac3b222debac11646a39">kaldi::nnet3::VariableMergingOptimizer::config_</a></div><div class="ttdeci">const NnetOptimizeOptions &amp; config_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00171">nnet-optimize-utils.h:171</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo_html_a7524bea2834a3dc08b90e5b3406ee0e8"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a7524bea2834a3dc08b90e5b3406ee0e8">kaldi::nnet3::NnetComputation::SubMatrixInfo::col_offset</a></div><div class="ttdeci">int32 col_offset</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00327">nnet-computation.h:327</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1VariableMergingOptimizer_html_a0655730456d3a04cafe943687894a84d"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a0655730456d3a04cafe943687894a84d">kaldi::nnet3::VariableMergingOptimizer::matrix_to_submatrix_</a></div><div class="ttdeci">std::vector&lt; std::vector&lt; int32 &gt; &gt; matrix_to_submatrix_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00178">nnet-optimize-utils.h:178</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_a777e19363ed62a4364eeb8743e848889"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a777e19363ed62a4364eeb8743e848889">kaldi::nnet3::ComputationRenumberer::SetUpMappings</a></div><div class="ttdeci">void SetUpMappings()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00401">nnet-optimize-utils.cc:401</a></div></div>
<div class="ttc" id="namespacekaldi_html_a21841167f1ffde9582edc512acdbaa51aae343c6085287b6272231336d4b75986"><div class="ttname"><a href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51aae343c6085287b6272231336d4b75986">kaldi::kDefaultStride</a></div><div class="ttdef"><b>Definition:</b> <a href="matrix-common_8h_source.html#l00045">matrix-common.h:45</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationAnalysis_html_a20b2fb94d3cfc130b1402912f072199e"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html#a20b2fb94d3cfc130b1402912f072199e">kaldi::nnet3::ComputationAnalysis::FirstNontrivialMatrixAccess</a></div><div class="ttdeci">int32 FirstNontrivialMatrixAccess(int32 m) const</div><div class="ttdoc">Returns the first command that is not a zeroing command (kSetConst with alpha=0.0), that accesses any part of &amp;#39;m&amp;#39; [note: allocation and deallocation do not count a matrix accesses. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8cc_source.html#l01226">nnet-analyze.cc:1226</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_af96b480d0b6d2b5890e1490f8c2e6ac0"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#af96b480d0b6d2b5890e1490f8c2e6ac0">kaldi::nnet3::IdentifyIndexesMultiArgs</a></div><div class="ttdeci">void IdentifyIndexesMultiArgs(std::vector&lt; NnetComputation::Command &gt; *commands, std::vector&lt; int32 *&gt; *indexes_multi_args)</div><div class="ttdoc">Identifies in the vector of commands, arguments that correspond to indexes into the computation&amp;#39;s ind...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00105">nnet-optimize-utils.cc:105</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_aba9b56c9f5c5545ab2ab957cec8c56cc"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#aba9b56c9f5c5545ab2ab957cec8c56cc">kaldi::nnet3::FindNumLeadingAndTrailingNegatives</a></div><div class="ttdeci">static void FindNumLeadingAndTrailingNegatives(const std::vector&lt; int32 &gt; &amp;vec, int32 *num_leading_negatives, int32 *num_trailing_negatives)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02339">nnet-optimize-utils.cc:2339</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_a5907a076729be892104754ad91aa38d5"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a5907a076729be892104754ad91aa38d5">kaldi::nnet3::DerivativeTimeLimiter::MapIndexesMultiCommand</a></div><div class="ttdeci">void MapIndexesMultiCommand(NnetComputation::Command *c)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01798">nnet-optimize-utils.cc:1798</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1PointerCompare_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1PointerCompare.html">kaldi::nnet3::ComputationRenumberer::PointerCompare</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00202">nnet-optimize-utils.cc:202</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_acb31bf5441a137f7cbed4aeb74cb8421"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#acb31bf5441a137f7cbed4aeb74cb8421">kaldi::nnet3::NnetComputation::submatrices</a></div><div class="ttdeci">std::vector&lt; SubMatrixInfo &gt; submatrices</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00404">nnet-computation.h:404</a></div></div>
<div class="ttc" id="namespacernnlm_html_ab4871778d570f724a07823e0a2fb9884"><div class="ttname"><a href="namespacernnlm.html#ab4871778d570f724a07823e0a2fb9884">rnnlm::n</a></div><div class="ttdeci">struct rnnlm::@11::@12 n</div></div>
<div class="ttc" id="namespacekaldi_html_a21841167f1ffde9582edc512acdbaa51"><div class="ttname"><a href="namespacekaldi.html#a21841167f1ffde9582edc512acdbaa51">kaldi::MatrixStrideType</a></div><div class="ttdeci">MatrixStrideType</div><div class="ttdef"><b>Definition:</b> <a href="matrix-common_8h_source.html#l00044">matrix-common.h:44</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html">kaldi::nnet3::NnetComputation::Command</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00338">nnet-computation.h:338</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_a6e33b4d185cc5638ac9a27c09d211490"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a6e33b4d185cc5638ac9a27c09d211490">kaldi::nnet3::DerivativeTimeLimiter::memos_to_delete_</a></div><div class="ttdeci">std::unordered_set&lt; int32 &gt; memos_to_delete_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00367">nnet-optimize-utils.h:367</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo_html_a5b453b78ae9c6939b8961da23c8c987c"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#a5b453b78ae9c6939b8961da23c8c987c">kaldi::nnet3::RowOpsSplitter::SingleSplitInfo::first_value</a></div><div class="ttdeci">int32 first_value</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02629">nnet-optimize-utils.cc:2629</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html">kaldi::nnet3::DerivativeTimeLimiter</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00226">nnet-optimize-utils.h:226</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetOptimizeOptions_html_a8de177378a5c3ef537b9d5927012427d"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetOptimizeOptions.html#a8de177378a5c3ef537b9d5927012427d">kaldi::nnet3::NnetOptimizeOptions::propagate_in_place</a></div><div class="ttdeci">bool propagate_in_place</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize_8h_source.html#l00040">nnet-optimize.h:40</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetOptimizeOptions_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetOptimizeOptions.html">kaldi::nnet3::NnetOptimizeOptions</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize_8h_source.html#l00035">nnet-optimize.h:35</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo_html_acfb04e9339880d3594894f5201b70eac"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#acfb04e9339880d3594894f5201b70eac">kaldi::nnet3::NnetComputation::SubMatrixInfo::row_offset</a></div><div class="ttdeci">int32 row_offset</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00325">nnet-computation.h:325</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_ad691fe3a6e61eb46c08d591d4af2ea4b"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#ad691fe3a6e61eb46c08d591d4af2ea4b">kaldi::nnet3::ModelUpdateConsolidator::ConsolidateUpdateForComponent</a></div><div class="ttdeci">void ConsolidateUpdateForComponent(int32 component, const std::vector&lt; int32 &gt; &amp;backprop_commands)</div><div class="ttdoc">This function, called from ConsolidateModelUpdate, is passed a list of commands that are all backprop...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01460">nnet-optimize-utils.cc:1460</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1Nnet_html"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1Nnet.html">kaldi::nnet3::Nnet</a></div><div class="ttdef"><b>Definition:</b> <a href="_2nnet-nnet_8h_source.html#l00115">nnet-nnet.h:115</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo_html_ac0b46c3dd51edd4418492743565ee2ab"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#ac0b46c3dd51edd4418492743565ee2ab">kaldi::nnet3::RowOpsSplitter::SingleSplitInfo::min_second_value</a></div><div class="ttdeci">int32 min_second_value</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02633">nnet-optimize-utils.cc:2633</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1SubMatrixHasher_html_a1653f8247dc6dcc4f76d44aafaade46d"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1SubMatrixHasher.html#a1653f8247dc6dcc4f76d44aafaade46d">kaldi::nnet3::ComputationRenumberer::SubMatrixHasher::operator()</a></div><div class="ttdeci">size_t operator()(const NnetComputation::SubMatrixInfo &amp;submat) const noexcept</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00189">nnet-optimize-utils.cc:189</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationCache_html_a78eddb3e92fffc4e0e75e1f0e9a23488"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationCache.html#a78eddb3e92fffc4e0e75e1f0e9a23488">kaldi::nnet3::ComputationCache::Check</a></div><div class="ttdeci">void Check(const Nnet &amp;nnet) const</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l05037">nnet-optimize-utils.cc:5037</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo_html_ad965a774d4c06790fec9f890f9698128"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#ad965a774d4c06790fec9f890f9698128">kaldi::nnet3::MemoryCompressionOptimizer::MatrixCompressInfo::compression_type</a></div><div class="ttdeci">CuCompressedMatrixType compression_type</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04737">nnet-optimize-utils.cc:4737</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_af983142dc68170e669067284f55e06b8"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#af983142dc68170e669067284f55e06b8">kaldi::nnet3::ComputationExpander::n_stride_</a></div><div class="ttdeci">std::vector&lt; int32 &gt; n_stride_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03286">nnet-optimize-utils.cc:3286</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_html_a9c5be1c635342710540a8f6c675625d8"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a9c5be1c635342710540a8f6c675625d8">kaldi::nnet3::MemoryCompressionOptimizer::MemoryCompressionOptimizer</a></div><div class="ttdeci">MemoryCompressionOptimizer(const Nnet &amp;nnet, int32 memory_compression_level, int32 middle_command, NnetComputation *computation)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04703">nnet-optimize-utils.cc:4703</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MatrixExtender_html_a1e4ca23704d364f81f2e4500c225290c"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a1e4ca23704d364f81f2e4500c225290c">kaldi::nnet3::MatrixExtender::SubMatrixInfo</a></div><div class="ttdeci">NnetComputation::SubMatrixInfo SubMatrixInfo</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01021">nnet-optimize-utils.cc:1021</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1VariableMergingOptimizer_html_a36d13565d1302a2bf74127b141ba3537"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a36d13565d1302a2bf74127b141ba3537">kaldi::nnet3::VariableMergingOptimizer::computation_</a></div><div class="ttdeci">NnetComputation * computation_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00173">nnet-optimize-utils.h:173</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1VariableMergingOptimizer_html_ac8ca96df1ecdb635738c59a88cff8835"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#ac8ca96df1ecdb635738c59a88cff8835">kaldi::nnet3::VariableMergingOptimizer::analyzer_</a></div><div class="ttdeci">Analyzer analyzer_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00175">nnet-optimize-utils.h:175</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_afffba6e2f4c37c755f2ab63893d2d8b9"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#afffba6e2f4c37c755f2ab63893d2d8b9">kaldi::nnet3::ComputationLoopedOptimizer::CreateMatrixPairs</a></div><div class="ttdeci">static void CreateMatrixPairs(const NnetComputation &amp;computation, std::vector&lt; std::pair&lt; int32, int32 &gt; &gt; *matrix_to_pair)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04144">nnet-optimize-utils.cc:4144</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_html_ae23a562cb4f08452e78e541239a06668"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#ae23a562cb4f08452e78e541239a06668">kaldi::nnet3::MemoryCompressionOptimizer::ProcessMatrix</a></div><div class="ttdeci">void ProcessMatrix(int32 m)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04813">nnet-optimize-utils.cc:4813</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a281a103d9beaef2e5d64370754800cd1"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a281a103d9beaef2e5d64370754800cd1">kaldi::nnet3::ReplaceRowWithMatrixOps</a></div><div class="ttdeci">bool ReplaceRowWithMatrixOps(NnetComputation *computation)</div><div class="ttdoc">This function detects cases where commands of type kCopyRows, kAddRows or kAddToRows can be converted...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02288">nnet-optimize-utils.cc:2288</a></div></div>
<div class="ttc" id="namespacekaldi_html_a6a81f9c498a2d703ea343d906a827b6f"><div class="ttname"><a href="namespacekaldi.html#a6a81f9c498a2d703ea343d906a827b6f">kaldi::CuCompressedMatrixType</a></div><div class="ttdeci">CuCompressedMatrixType</div><div class="ttdef"><b>Definition:</b> <a href="cu-compressed-matrix_8h_source.html#l00140">cu-compressed-matrix.h:140</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a36da016976f88292c0d31653a20cbfe3a5530b2f8f01fac9e6e73fd29a65d4127"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3a5530b2f8f01fac9e6e73fd29a65d4127">kaldi::nnet3::kSimpleComponent</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-component-itf_8h_source.html#l00038">nnet-component-itf.h:38</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_ab1b9ede63de755642e79f7287a62b92c"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab1b9ede63de755642e79f7287a62b92c">kaldi::nnet3::NnetComputation::Read</a></div><div class="ttdeci">void Read(std::istream &amp;istream, bool binary)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8cc_source.html#l00732">nnet-computation.cc:732</a></div></div>
<div class="ttc" id="group__error__group_html_ga0251fa005e2fdb1dcc6e24f06afe3b1f"><div class="ttname"><a href="group__error__group.html#ga0251fa005e2fdb1dcc6e24f06afe3b1f">KALDI_ERR</a></div><div class="ttdeci">#define KALDI_ERR</div><div class="ttdef"><b>Definition:</b> <a href="kaldi-error_8h_source.html#l00126">kaldi-error.h:126</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1VariableMergingOptimizer_html_adbabf05a7702103113a02a113015205f"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#adbabf05a7702103113a02a113015205f">kaldi::nnet3::VariableMergingOptimizer::nnet_</a></div><div class="ttdeci">const Nnet &amp; nnet_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00172">nnet-optimize-utils.h:172</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_ad6767e6a06ceef8ceedb067c8c86d463"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#ad6767e6a06ceef8ceedb067c8c86d463">kaldi::nnet3::ModelUpdateConsolidator::ConsolidateSubmatrices</a></div><div class="ttdeci">int32 ConsolidateSubmatrices(const std::vector&lt; int32 &gt; &amp;commands, const std::vector&lt; int32 &gt; &amp;submatrices)</div><div class="ttdoc">You call this function when you want to consolidate the values of a list of submatrices taken just pr...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01371">nnet-optimize-utils.cc:1371</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_a7d43f793d8585fd0de88e7a428d60a6b"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a7d43f793d8585fd0de88e7a428d60a6b">kaldi::nnet3::DerivativeTimeLimiter::min_deriv_time_</a></div><div class="ttdeci">int32 min_deriv_time_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00337">nnet-optimize-utils.h:337</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_a652f9fe87cd1b276eb349312151054f8"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a652f9fe87cd1b276eb349312151054f8">kaldi::nnet3::ComputationExpander::InitStrideInfo</a></div><div class="ttdeci">void InitStrideInfo()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03548">nnet-optimize-utils.cc:3548</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html">kaldi::nnet3::ComputationRenumberer</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00148">nnet-optimize-utils.cc:148</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_a36d13565d1302a2bf74127b141ba3537"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a36d13565d1302a2bf74127b141ba3537">kaldi::nnet3::ModelUpdateConsolidator::computation_</a></div><div class="ttdeci">NnetComputation * computation_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01329">nnet-optimize-utils.cc:1329</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_html_a715006dc6c8d8855816051d40a2c1944"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#a715006dc6c8d8855816051d40a2c1944">kaldi::nnet3::MemoryCompressionOptimizer::memory_compression_level_</a></div><div class="ttdeci">int32 memory_compression_level_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04762">nnet-optimize-utils.cc:4762</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_a45761855efc1786f2089e550ec71712a"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a45761855efc1786f2089e550ec71712a">kaldi::nnet3::ComputationLoopedOptimizer::FindFirstRepeat</a></div><div class="ttdeci">static bool FindFirstRepeat(const std::vector&lt; std::vector&lt; std::pair&lt; int32, int32 &gt; &gt; &gt; &amp;active_pairs, int32 time_shift_per_segment, int32 *seg1, int32 *seg2)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04232">nnet-optimize-utils.cc:4232</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a36da016976f88292c0d31653a20cbfe3adac6588b2ef2e8b52936718cf97263e7"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3adac6588b2ef2e8b52936718cf97263e7">kaldi::nnet3::kBackpropNeedsInput</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-component-itf_8h_source.html#l00065">nnet-component-itf.h:65</a></div></div>
<div class="ttc" id="group__error__group_html_ga994be213ddf127b5d6f20a43a02b513a"><div class="ttname"><a href="group__error__group.html#ga994be213ddf127b5d6f20a43a02b513a">KALDI_WARN</a></div><div class="ttdeci">#define KALDI_WARN</div><div class="ttdef"><b>Definition:</b> <a href="kaldi-error_8h_source.html#l00129">kaldi-error.h:129</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1Analyzer_html_a3b73c505d462ed9086dc5fc3735202a7"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1Analyzer.html#a3b73c505d462ed9086dc5fc3735202a7">kaldi::nnet3::Analyzer::variable_accesses</a></div><div class="ttdeci">std::vector&lt; std::vector&lt; Access &gt; &gt; variable_accesses</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00297">nnet-analyze.h:297</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_acdecf85ba9844b9db2d0649ff34139c8"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#acdecf85ba9844b9db2d0649ff34139c8">kaldi::nnet3::ComputationLoopedOptimizer::Optimize</a></div><div class="ttdeci">bool Optimize()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04473">nnet-optimize-utils.cc:4473</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a26009d8f2bc3f61d214925ae25af9962"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26009d8f2bc3f61d214925ae25af9962">kaldi::nnet3::kAddRowsMulti</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00292">nnet-computation.h:292</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo_html_aa1728750481b853c3246037c1ba1c68b"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1SingleSplitInfo.html#aa1728750481b853c3246037c1ba1c68b">kaldi::nnet3::RowOpsSplitter::SingleSplitInfo::size</a></div><div class="ttdeci">int32 size</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02625">nnet-optimize-utils.cc:2625</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1MatrixAccesses_html_a7ca773444a9de6d9f8c01f693ec4ab16"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#a7ca773444a9de6d9f8c01f693ec4ab16">kaldi::nnet3::MatrixAccesses::deallocate_command</a></div><div class="ttdeci">int32 deallocate_command</div><div class="ttdoc">Index of the command that deallocates the matrix (which will be of type kDeallocMatrix or kSwapMatrix...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00257">nnet-analyze.h:257</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationAnalysis_html_a05f855eac05e56f202ecb10127261127"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html#a05f855eac05e56f202ecb10127261127">kaldi::nnet3::ComputationAnalysis::LastWriteAccess</a></div><div class="ttdeci">int32 LastWriteAccess(int32 s) const</div><div class="ttdoc">Returns the last command-index that accesses any part of submatrix &amp;#39;s&amp;#39; as a write operation...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8cc_source.html#l01291">nnet-analyze.cc:1291</a></div></div>
<div class="ttc" id="group__io__funcs__basic_html_ga87f1638ef3c0a3ee117178b202c2d02a"><div class="ttname"><a href="group__io__funcs__basic.html#ga87f1638ef3c0a3ee117178b202c2d02a">kaldi::WriteToken</a></div><div class="ttdeci">void WriteToken(std::ostream &amp;os, bool binary, const char *token)</div><div class="ttdoc">The WriteToken functions are for writing nonempty sequences of non-space characters. </div><div class="ttdef"><b>Definition:</b> <a href="io-funcs_8cc_source.html#l00134">io-funcs.cc:134</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_ae00720e16e58e1065f81793469767a84"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ae00720e16e58e1065f81793469767a84">kaldi::nnet3::DerivativeTimeLimiter::ModifyCommands</a></div><div class="ttdeci">void ModifyCommands()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02057">nnet-optimize-utils.cc:2057</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationAnalysis_html_affc0d346da68b1a977ea4f91ac8ca780"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html#affc0d346da68b1a977ea4f91ac8ca780">kaldi::nnet3::ComputationAnalysis::DataInvalidatedCommand</a></div><div class="ttdeci">int32 DataInvalidatedCommand(int32 c, int32 s) const</div><div class="ttdoc">Returns (the first command-index after &amp;#39;c&amp;#39; that any part of submatrix &amp;#39;s&amp;#39; is written to); or if there...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8cc_source.html#l01323">nnet-analyze.cc:1323</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_a6f8e8995300ee82f98f923a053d66573"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a6f8e8995300ee82f98f923a053d66573">kaldi::nnet3::ComputationRenumberer::ComputeMatrixIsUsed</a></div><div class="ttdeci">void ComputeMatrixIsUsed()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00385">nnet-optimize-utils.cc:385</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_a2e550555b94eb7980bb3f5c0474ef816"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a2e550555b94eb7980bb3f5c0474ef816">kaldi::nnet3::ComputationRenumberer::old_to_new_matrix_</a></div><div class="ttdeci">std::vector&lt; int32 &gt; old_to_new_matrix_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00247">nnet-optimize-utils.cc:247</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command_html_a2d9ffb310ae91c656b84c1f68a897d02"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a2d9ffb310ae91c656b84c1f68a897d02">kaldi::nnet3::NnetComputation::Command::command_type</a></div><div class="ttdeci">CommandType command_type</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00339">nnet-computation.h:339</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1PrecomputedIndexesInfo_html_ac02949595ba936e91eb7ccbfdfd98c2a"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1PrecomputedIndexesInfo.html#ac02949595ba936e91eb7ccbfdfd98c2a">kaldi::nnet3::NnetComputation::PrecomputedIndexesInfo::output_indexes</a></div><div class="ttdeci">std::vector&lt; Index &gt; output_indexes</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00381">nnet-computation.h:381</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a8953a6af8e449d7cc12efeb115c5f8d2"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a8953a6af8e449d7cc12efeb115c5f8d2">kaldi::nnet3::FixGotoLabel</a></div><div class="ttdeci">void FixGotoLabel(NnetComputation *computation)</div><div class="ttdoc">This function ensures that the arg1 of a final command of type kGotoLabel is the same as the command ...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04552">nnet-optimize-utils.cc:4552</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352afab6637ac4a83d6775366b4e9c42e241"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352afab6637ac4a83d6775366b4e9c42e241">kaldi::nnet3::kBackpropNoModelUpdate</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00290">nnet-computation.h:290</a></div></div>
<div class="ttc" id="namespacekaldi_html_a6a81f9c498a2d703ea343d906a827b6fa23164e2fb75b9b890518973aa841de3d"><div class="ttname"><a href="namespacekaldi.html#a6a81f9c498a2d703ea343d906a827b6fa23164e2fb75b9b890518973aa841de3d">kaldi::kCompressedMatrixUint8</a></div><div class="ttdef"><b>Definition:</b> <a href="cu-compressed-matrix_8h_source.html#l00142">cu-compressed-matrix.h:142</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1Access_html_abe920302408265dccfe076ebd1fb02c1"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1Access.html#abe920302408265dccfe076ebd1fb02c1">kaldi::nnet3::Access::access_type</a></div><div class="ttdeci">AccessType access_type</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00223">nnet-analyze.h:223</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationAnalysis_html_a3a6f864b459da77d4014835edaa0653f"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html#a3a6f864b459da77d4014835edaa0653f">kaldi::nnet3::ComputationAnalysis::LastAccess</a></div><div class="ttdeci">int32 LastAccess(int32 s) const</div><div class="ttdoc">Returns the last non-deallocation command that accesses any part of submatrix &amp;#39;s&amp;#39;; if there is no suc...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8cc_source.html#l01264">nnet-analyze.cc:1264</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1RowOpsSplitter_html_a0708ed4c4b812eb5a8b6b5e5d68f0e48"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a0708ed4c4b812eb5a8b6b5e5d68f0e48">kaldi::nnet3::RowOpsSplitter::GetSplitInfo</a></div><div class="ttdeci">bool GetSplitInfo(std::vector&lt; std::pair&lt; int32, int32 &gt; &gt;::const_iterator begin, std::vector&lt; std::pair&lt; int32, int32 &gt; &gt;::const_iterator end, SingleSplitInfo *info)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02686">nnet-optimize-utils.cc:2686</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a602819d33d3a59c128aa4e865e610e14"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a602819d33d3a59c128aa4e865e610e14">kaldi::nnet3::Optimize</a></div><div class="ttdeci">void Optimize(const NnetOptimizeOptions &amp;config, const Nnet &amp;nnet, int32 max_output_time_in_request, NnetComputation *computation)</div><div class="ttdoc">This is the top-level function for optimizing a computation. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize_8cc_source.html#l00501">nnet-optimize.cc:501</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a36da016976f88292c0d31653a20cbfe3abaa0f1d8521d4753ffae9f2cc22a15df"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a36da016976f88292c0d31653a20cbfe3abaa0f1d8521d4753ffae9f2cc22a15df">kaldi::nnet3::kBackpropInPlace</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-component-itf_8h_source.html#l00069">nnet-component-itf.h:69</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1Nnet_html_aec8d6dfed3e4ab080d3ff4cf6a1126e3"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1Nnet.html#aec8d6dfed3e4ab080d3ff4cf6a1126e3">kaldi::nnet3::Nnet::GetComponent</a></div><div class="ttdeci">Component * GetComponent(int32 c)</div><div class="ttdoc">Return component indexed c. Not a copy; not owned by caller. </div><div class="ttdef"><b>Definition:</b> <a href="_2nnet-nnet_8cc_source.html#l00150">nnet-nnet.cc:150</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1IoSpecification_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1IoSpecification.html">kaldi::nnet3::IoSpecification</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00072">nnet-computation.h:72</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1RowOpsSplitter_html_ac47c74355b808fa46848090718a6f05f"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#ac47c74355b808fa46848090718a6f05f">kaldi::nnet3::RowOpsSplitter::SplitIndexes</a></div><div class="ttdeci">bool SplitIndexes()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02730">nnet-optimize-utils.cc:2730</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_afacff028a27406ccf7e72e1f40ac6288"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#afacff028a27406ccf7e72e1f40ac6288">kaldi::nnet3::DerivativeTimeLimiter::GetPruneValues</a></div><div class="ttdeci">void GetPruneValues(int32 initial_submatrix, int32 new_submatrix, int32 *left_prune, int32 *right_prune) const</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01564">nnet-optimize-utils.cc:1564</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1IoSpecification_html_a4e836d0aae6b13f7b0c0f4959060f9dd"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1IoSpecification.html#a4e836d0aae6b13f7b0c0f4959060f9dd">kaldi::nnet3::IoSpecification::has_deriv</a></div><div class="ttdeci">bool has_deriv</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00075">nnet-computation.h:75</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1Access_html_a5784248b7d100605c5bd6fe017987afd"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1Access.html#a5784248b7d100605c5bd6fe017987afd">kaldi::nnet3::Access::command_index</a></div><div class="ttdeci">int32 command_index</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00222">nnet-analyze.h:222</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_af8364fb4b69f001a20545ea5b1a2c65f"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#af8364fb4b69f001a20545ea5b1a2c65f">kaldi::nnet3::ComputationLoopedOptimizer::splice_point_commands_</a></div><div class="ttdeci">std::vector&lt; int32 &gt; splice_point_commands_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04066">nnet-optimize-utils.cc:4066</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_a740071247a178d84b8bf2b17901509b4"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a740071247a178d84b8bf2b17901509b4">kaldi::nnet3::ComputationExpander::Expand</a></div><div class="ttdeci">void Expand()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03573">nnet-optimize-utils.cc:3573</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_ab8ae09d46a89f34a89b970a24156481d"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab8ae09d46a89f34a89b970a24156481d">kaldi::nnet3::NnetComputation::component_precomputed_indexes</a></div><div class="ttdeci">std::vector&lt; PrecomputedIndexesInfo &gt; component_precomputed_indexes</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00412">nnet-computation.h:412</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_a47b759979e43092bbb39fc8897f6b143"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a47b759979e43092bbb39fc8897f6b143">kaldi::nnet3::ComputationExpander::ComputeCommands</a></div><div class="ttdeci">void ComputeCommands()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03501">nnet-optimize-utils.cc:3501</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MatrixExtender_html_a36d13565d1302a2bf74127b141ba3537"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a36d13565d1302a2bf74127b141ba3537">kaldi::nnet3::MatrixExtender::computation_</a></div><div class="ttdeci">NnetComputation * computation_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01052">nnet-optimize-utils.cc:1052</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_a221b58d21500493f6a49cdefcd9c5d4f"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a221b58d21500493f6a49cdefcd9c5d4f">kaldi::nnet3::ComputationRenumberer::RenumberMemos</a></div><div class="ttdeci">void RenumberMemos()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00296">nnet-optimize-utils.cc:296</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationChecker_html_a434b035308434bbeb9b857f22b9f0db1"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationChecker.html#a434b035308434bbeb9b857f22b9f0db1">kaldi::nnet3::ComputationChecker::Check</a></div><div class="ttdeci">void Check()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8cc_source.html#l00579">nnet-analyze.cc:579</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo_html_a0551990c4556cf74e0f29c68c3294e31"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#a0551990c4556cf74e0f29c68c3294e31">kaldi::nnet3::MemoryCompressionOptimizer::MatrixCompressInfo::uncompression_command_index</a></div><div class="ttdeci">int32 uncompression_command_index</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04734">nnet-optimize-utils.cc:4734</a></div></div>
<div class="ttc" id="namespacernnlm_html_acb559820d9ca11295b4500f179ef6392"><div class="ttname"><a href="namespacernnlm.html#acb559820d9ca11295b4500f179ef6392">rnnlm::i</a></div><div class="ttdeci">int i</div><div class="ttdef"><b>Definition:</b> <a href="mikolov-rnnlm-lib_8cc_source.html#l00066">mikolov-rnnlm-lib.cc:66</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_ab5c1a034b55e741c8e3019aaab55db03"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ab5c1a034b55e741c8e3019aaab55db03">kaldi::nnet3::DerivativeTimeLimiter::ComputeMatrixPruneInfo</a></div><div class="ttdeci">void ComputeMatrixPruneInfo()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01972">nnet-optimize-utils.cc:1972</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_adbabf05a7702103113a02a113015205f"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#adbabf05a7702103113a02a113015205f">kaldi::nnet3::DerivativeTimeLimiter::nnet_</a></div><div class="ttdeci">const Nnet &amp; nnet_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00335">nnet-optimize-utils.h:335</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1Component_html_ab6b6147feb5e0688469b735a6546c222"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1Component.html#ab6b6147feb5e0688469b735a6546c222">kaldi::nnet3::Component::Type</a></div><div class="ttdeci">virtual std::string Type() const =0</div><div class="ttdoc">Returns a string such as &quot;SigmoidComponent&quot;, describing the type of the object. </div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_a92539dc86963420ae51faa16150cf0be"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a92539dc86963420ae51faa16150cf0be">kaldi::nnet3::DerivativeTimeLimiter::MapIndexesCommand</a></div><div class="ttdeci">void MapIndexesCommand(NnetComputation::Command *c)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01735">nnet-optimize-utils.cc:1735</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_ac671ddd1b3a2e51149bc86d7a0965b64"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ac671ddd1b3a2e51149bc86d7a0965b64">kaldi::nnet3::ComputationRenumberer::RenumberMatrices</a></div><div class="ttdeci">void RenumberMatrices()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00454">nnet-optimize-utils.cc:454</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a7468a5d6108f9a2f81b9b79b82866354"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a7468a5d6108f9a2f81b9b79b82866354">kaldi::nnet3::ComputeMatrixToSubmatrix</a></div><div class="ttdeci">void ComputeMatrixToSubmatrix(const NnetComputation &amp;computation, std::vector&lt; std::vector&lt; int32 &gt; &gt; *mat_to_submat)</div><div class="ttdoc">This function computes a vector &amp;#39;mat_to_submat&amp;#39;, indexed by matrix index, such that (*mat_to_submat)[...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8cc_source.html#l01166">nnet-analyze.cc:1166</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_af8007bfceb176a3f8f7f3efb765c9062"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#af8007bfceb176a3f8f7f3efb765c9062">kaldi::nnet3::ExpandComputation</a></div><div class="ttdeci">void ExpandComputation(const Nnet &amp;nnet, const MiscComputationInfo &amp;misc_info, const NnetComputation &amp;computation, bool need_debug_info, int32 num_n_values, NnetComputation *expanded_computation)</div><div class="ttdoc">This function is used in &amp;#39;shortcut&amp;#39; compilation to expand a computation that has been compiled for ex...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03804">nnet-optimize-utils.cc:3804</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_a75060dc1f93ff9085cc6a6f0bf2d2f30"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a75060dc1f93ff9085cc6a6f0bf2d2f30">kaldi::nnet3::ComputationLoopedOptimizer::NormalizeCindexes</a></div><div class="ttdeci">static int32 NormalizeCindexes(std::vector&lt; Cindex &gt; *cindexes)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04121">nnet-optimize-utils.cc:4121</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a7832c022dde05525759677b75b362b83">kaldi::nnet3::kBackprop</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00290">nnet-computation.h:290</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_ab22ae6f823fa687017ff28e30c668156"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ab22ae6f823fa687017ff28e30c668156">kaldi::nnet3::ComputationRenumberer::num_submatrices_new_</a></div><div class="ttdeci">int32 num_submatrices_new_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00246">nnet-optimize-utils.cc:246</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo_html_af56ede1afd7484983967d35f6abc11db"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html#af56ede1afd7484983967d35f6abc11db">kaldi::nnet3::RowOpsSplitter::MultiIndexSplitInfo::splits</a></div><div class="ttdeci">std::vector&lt; SingleSplitInfo &gt; splits</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02657">nnet-optimize-utils.cc:2657</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_af512f7de6c401fbdf7013d62295df9c2"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#af512f7de6c401fbdf7013d62295df9c2">kaldi::nnet3::ConsolidateModelUpdate</a></div><div class="ttdeci">void ConsolidateModelUpdate(const Nnet &amp;nnet, NnetComputation *computation)</div><div class="ttdoc">This optimization consolidates the model-update part of backprop commands, for components in (e...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01551">nnet-optimize-utils.cc:1551</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1IoSpecification_html_aa3daaa77b972f8dace077e94b418aab1"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1IoSpecification.html#aa3daaa77b972f8dace077e94b418aab1">kaldi::nnet3::IoSpecification::indexes</a></div><div class="ttdeci">std::vector&lt; Index &gt; indexes</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00074">nnet-computation.h:74</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_a104e34b2a7fa8395d34e9e6e0d24ee42"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a104e34b2a7fa8395d34e9e6e0d24ee42">kaldi::nnet3::DerivativeTimeLimiter::ModifyCommand</a></div><div class="ttdeci">void ModifyCommand(NnetComputation::Command *command)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01604">nnet-optimize-utils.cc:1604</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationCache_html_a6d889d796739f83d1af7a8a081e5a316"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationCache.html#a6d889d796739f83d1af7a8a081e5a316">kaldi::nnet3::ComputationCache::computation_cache_</a></div><div class="ttdeci">CacheType computation_cache_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00678">nnet-optimize-utils.h:678</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1Analyzer_html_a1451c041c35be895025d122f136b9959"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1Analyzer.html#a1451c041c35be895025d122f136b9959">kaldi::nnet3::Analyzer::matrix_accesses</a></div><div class="ttdeci">std::vector&lt; MatrixAccesses &gt; matrix_accesses</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00298">nnet-analyze.h:298</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComponentPrecomputedIndexes_html"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComponentPrecomputedIndexes.html">kaldi::nnet3::ComponentPrecomputedIndexes</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-component-itf_8h_source.html#l00097">nnet-component-itf.h:97</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1Nnet_html_a15b5336b4413124b1fd4531f57781182"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1Nnet.html#a15b5336b4413124b1fd4531f57781182">kaldi::nnet3::Nnet::NumComponents</a></div><div class="ttdeci">int32 NumComponents() const</div><div class="ttdef"><b>Definition:</b> <a href="_2nnet-nnet_8h_source.html#l00124">nnet-nnet.h:124</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1VariableMergingOptimizer_html_a60ce57f518b5fa77d140cb414354cd95"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a60ce57f518b5fa77d140cb414354cd95">kaldi::nnet3::VariableMergingOptimizer::MarkAsDirty</a></div><div class="ttdeci">void MarkAsDirty(int32 s)</div><div class="ttdoc">Marks the variables underlying submatrix &amp;#39;s&amp;#39; as dirty. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00807">nnet-optimize-utils.cc:807</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_adbabf05a7702103113a02a113015205f"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#adbabf05a7702103113a02a113015205f">kaldi::nnet3::ModelUpdateConsolidator::nnet_</a></div><div class="ttdeci">const Nnet &amp; nnet_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01328">nnet-optimize-utils.cc:1328</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_a70c1595b263268a6a0ec5bd2468151bc"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a70c1595b263268a6a0ec5bd2468151bc">kaldi::nnet3::ComputationLoopedOptimizer::FormInfiniteLoop</a></div><div class="ttdeci">static void FormInfiniteLoop(int32 command1, int32 command2, NnetComputation *computation)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04453">nnet-optimize-utils.cc:4453</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a967844c2c7775d280d15738cbe852536"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a967844c2c7775d280d15738cbe852536">kaldi::nnet3::kNoOperationLabel</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00295">nnet-computation.h:295</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1VariableMergingOptimizer_html_a65d0ad3958501631af43a076c556a8d8"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a65d0ad3958501631af43a076c556a8d8">kaldi::nnet3::VariableMergingOptimizer::VariableMergingOptimizer</a></div><div class="ttdeci">VariableMergingOptimizer(const NnetOptimizeOptions &amp;config, const Nnet &amp;nnet, NnetComputation *computation)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00711">nnet-optimize-utils.cc:711</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html">kaldi::nnet3::MemoryCompressionOptimizer::MatrixCompressInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04724">nnet-optimize-utils.cc:4724</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1SubMatrixHasher_html_afdeb79758745dbc19fd1fab85623feba"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1SubMatrixHasher.html#afdeb79758745dbc19fd1fab85623feba">kaldi::nnet3::ComputationRenumberer::SubMatrixHasher::SubMatrixHasher</a></div><div class="ttdeci">SubMatrixHasher()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00188">nnet-optimize-utils.cc:188</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1PrecomputedIndexesInfo_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1PrecomputedIndexesInfo.html">kaldi::nnet3::NnetComputation::PrecomputedIndexesInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00366">nnet-computation.h:366</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html">kaldi::nnet3::NnetComputation</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00303">nnet-computation.h:303</a></div></div>
<div class="ttc" id="group__error__group_html_gad5710173d69cddcda4fa21ded3c77f16"><div class="ttname"><a href="group__error__group.html#gad5710173d69cddcda4fa21ded3c77f16">KALDI_ASSERT</a></div><div class="ttdeci">#define KALDI_ASSERT(cond)</div><div class="ttdef"><b>Definition:</b> <a href="kaldi-error_8h_source.html#l00168">kaldi-error.h:168</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetOptimizeOptions_html_a9338247ac24f099364f25f6221981cf8"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetOptimizeOptions.html#a9338247ac24f099364f25f6221981cf8">kaldi::nnet3::NnetOptimizeOptions::allow_left_merge</a></div><div class="ttdeci">bool allow_left_merge</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize_8h_source.html#l00047">nnet-optimize.h:47</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1ComputationRequest_html_a75f6d03596c9241ae8d5791e6d0d84aa"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1ComputationRequest.html#a75f6d03596c9241ae8d5791e6d0d84aa">kaldi::nnet3::ComputationRequest::outputs</a></div><div class="ttdeci">std::vector&lt; IoSpecification &gt; outputs</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00116">nnet-computation.h:116</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a1146f4efa141a56210f9dbf1090b20f0"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a1146f4efa141a56210f9dbf1090b20f0">kaldi::nnet3::RemoveNoOps</a></div><div class="ttdeci">void RemoveNoOps(NnetComputation *computation)</div><div class="ttdoc">Removes commands of type kNoOperation in the computation. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00703">nnet-optimize-utils.cc:703</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_a4ba6b7dba4c539ad7a149e05b59f80aa"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a4ba6b7dba4c539ad7a149e05b59f80aa">kaldi::nnet3::ComputationRenumberer::RemoveUnusedIndexesMulti</a></div><div class="ttdeci">void RemoveUnusedIndexesMulti()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00502">nnet-optimize-utils.cc:502</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MatrixExtender_html"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MatrixExtender.html">kaldi::nnet3::MatrixExtender</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01019">nnet-optimize-utils.cc:1019</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1RowOpsSplitter_html_a36d13565d1302a2bf74127b141ba3537"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a36d13565d1302a2bf74127b141ba3537">kaldi::nnet3::RowOpsSplitter::computation_</a></div><div class="ttdeci">NnetComputation * computation_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02673">nnet-optimize-utils.cc:2673</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetOptimizeOptions_html_a751610db82b663a3b2b415a839b0cad4"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetOptimizeOptions.html#a751610db82b663a3b2b415a839b0cad4">kaldi::nnet3::NnetOptimizeOptions::backprop_in_place</a></div><div class="ttdeci">bool backprop_in_place</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize_8h_source.html#l00041">nnet-optimize.h:41</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_a9a0388f6e3ce9318db544eef95415305"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a9a0388f6e3ce9318db544eef95415305">kaldi::nnet3::ComputationExpander::num_n_values_</a></div><div class="ttdeci">int32 num_n_values_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03292">nnet-optimize-utils.cc:3292</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1VariableMergingOptimizer_html_a08a57d03b1828eeb8548ee5e8a942264"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a08a57d03b1828eeb8548ee5e8a942264">kaldi::nnet3::VariableMergingOptimizer::MergeVariables</a></div><div class="ttdeci">bool MergeVariables()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00723">nnet-optimize-utils.cc:723</a></div></div>
<div class="ttc" id="group__error__group_html_ga16c81ec6ff3ba04c6ff96fdaed9d854e"><div class="ttname"><a href="group__error__group.html#ga16c81ec6ff3ba04c6ff96fdaed9d854e">KALDI_VLOG</a></div><div class="ttdeci">#define KALDI_VLOG(v)</div><div class="ttdef"><b>Definition:</b> <a href="kaldi-error_8h_source.html#l00135">kaldi-error.h:135</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationVariables_html_a15ab7e051d1b51d4e5391c92cb283c50"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationVariables.html#a15ab7e051d1b51d4e5391c92cb283c50">kaldi::nnet3::ComputationVariables::AppendVariablesForSubmatrix</a></div><div class="ttdeci">void AppendVariablesForSubmatrix(int32 submatrix_index, std::vector&lt; int32 &gt; *variable_indexes) const</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8cc_source.html#l00146">nnet-analyze.cc:146</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo_html_a54fa0913d637257d7c7afa7a393b9fdf"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_1_1MatrixCompressInfo.html#a54fa0913d637257d7c7afa7a393b9fdf">kaldi::nnet3::MemoryCompressionOptimizer::MatrixCompressInfo::range</a></div><div class="ttdeci">BaseFloat range</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04744">nnet-optimize-utils.cc:4744</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_a1d8913b401bfd339536bdd60f97d6101"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1d8913b401bfd339536bdd60f97d6101">kaldi::nnet3::ModelUpdateConsolidator::ConsolidateModelUpdate</a></div><div class="ttdeci">void ConsolidateModelUpdate()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01515">nnet-optimize-utils.cc:1515</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1RowOpsSplitter_1_1MultiIndexSplitInfo.html">kaldi::nnet3::RowOpsSplitter::MultiIndexSplitInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02654">nnet-optimize-utils.cc:2654</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1RowOpsSplitter_html"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html">kaldi::nnet3::RowOpsSplitter</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02578">nnet-optimize-utils.cc:2578</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo_html_a64221ce8a4754677e990d336b6154936"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a64221ce8a4754677e990d336b6154936">kaldi::nnet3::DerivativeTimeLimiter::MatrixPruneInfo::partly_inside_range</a></div><div class="ttdeci">bool partly_inside_range</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00326">nnet-optimize-utils.h:326</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_a36d13565d1302a2bf74127b141ba3537"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#a36d13565d1302a2bf74127b141ba3537">kaldi::nnet3::ComputationRenumberer::computation_</a></div><div class="ttdeci">NnetComputation * computation_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00244">nnet-optimize-utils.cc:244</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a4d88467d1a24ad6a2b21d4b8923615ca"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a4d88467d1a24ad6a2b21d4b8923615ca">kaldi::nnet3::IoSpecificationIsDecomposable</a></div><div class="ttdeci">static bool IoSpecificationIsDecomposable(const IoSpecification &amp;io_spec, IoSpecification *mini_io_spec, int32 *num_n_values_out)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03822">nnet-optimize-utils.cc:3822</a></div></div>
<div class="ttc" id="nnet-optimize-utils_8h_html"><div class="ttname"><a href="nnet-optimize-utils_8h.html">nnet-optimize-utils.h</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a17acd598bf1ced7e83e0c8a8569d224f"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a17acd598bf1ced7e83e0c8a8569d224f">kaldi::nnet3::IdentifyIndexesRangesArgs</a></div><div class="ttdeci">void IdentifyIndexesRangesArgs(std::vector&lt; NnetComputation::Command &gt; *commands, std::vector&lt; int32 *&gt; *indexes_ranges_args)</div><div class="ttdoc">Identifies in the vector of commands, arguments that correspond to indexes into the computation&amp;#39;s &amp;#39;in...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00121">nnet-optimize-utils.cc:121</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixDebugInfo.html">kaldi::nnet3::NnetComputation::MatrixDebugInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00315">nnet-computation.h:315</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1MatrixAccesses_html_a6a26bfae0a795d6987c7db2476fdda1a"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#a6a26bfae0a795d6987c7db2476fdda1a">kaldi::nnet3::MatrixAccesses::allocate_command</a></div><div class="ttdeci">int32 allocate_command</div><div class="ttdoc">Index of the command that allocates the matrix (which will be of type kAllocMatrix or kSwapMatrix)...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00253">nnet-analyze.h:253</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_af53fca33c55f05968eab8ec1009509e6"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#af53fca33c55f05968eab8ec1009509e6">kaldi::nnet3::RemoveCommandsForUnusedMatrix</a></div><div class="ttdeci">void RemoveCommandsForUnusedMatrix(const Analyzer &amp;analyzer, int32 m, NnetComputation *computation)</div><div class="ttdoc">This function removes from &amp;#39;computation&amp;#39; the commands accessing matrix &amp;#39;m&amp;#39;, which is assumed to be un...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04600">nnet-optimize-utils.cc:4600</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1MatrixAccesses_html_aa8a8ede92285acbe2795e8570b81c9ae"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1MatrixAccesses.html#aa8a8ede92285acbe2795e8570b81c9ae">kaldi::nnet3::MatrixAccesses::is_input</a></div><div class="ttdeci">bool is_input</div><div class="ttdoc">true if this matrix is an input to the computation (i.e. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00267">nnet-analyze.h:267</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_a594bab8b25225a0b1c64109336934916"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a594bab8b25225a0b1c64109336934916">kaldi::nnet3::DerivativeTimeLimiter::LimitDerivTimes</a></div><div class="ttdeci">void LimitDerivTimes()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01939">nnet-optimize-utils.cc:1939</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_abd9243d8740392f619af25f0653afa9e"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#abd9243d8740392f619af25f0653afa9e">kaldi::nnet3::FindNumLeadingAndTrailingIdenticals</a></div><div class="ttdeci">static void FindNumLeadingAndTrailingIdenticals(const std::vector&lt; std::pair&lt; int32, int32 &gt; &gt; &amp;vec, int32 *num_leading_identicals, int32 *num_trailing_identicals)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02477">nnet-optimize-utils.cc:2477</a></div></div>
<div class="ttc" id="group__io__funcs__basic_html_ga108506a9aabafd9006926aa1b47617da"><div class="ttname"><a href="group__io__funcs__basic.html#ga108506a9aabafd9006926aa1b47617da">kaldi::WriteBasicType</a></div><div class="ttdeci">void WriteBasicType(std::ostream &amp;os, bool binary, T t)</div><div class="ttdoc">WriteBasicType is the name of the write function for bool, integer types, and floating-point types...</div><div class="ttdef"><b>Definition:</b> <a href="io-funcs-inl_8h_source.html#l00034">io-funcs-inl.h:34</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command_html_a27787107ac04bc94a8708c2a5c63e092"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#a27787107ac04bc94a8708c2a5c63e092">kaldi::nnet3::NnetComputation::Command::arg5</a></div><div class="ttdeci">int32 arg5</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00345">nnet-computation.h:345</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_a20efdbe0990f3fa04abb85ac56089614"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a20efdbe0990f3fa04abb85ac56089614">kaldi::nnet3::ModelUpdateConsolidator::AppendDebugInfoForSubmatrix</a></div><div class="ttdeci">void AppendDebugInfoForSubmatrix(int32 submatrix_index, NnetComputation::MatrixDebugInfo *debug_info) const</div><div class="ttdoc">This function, called from ConsolidateSubmatrices, will update &amp;#39;debug_info&amp;#39; by appending the correspo...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01347">nnet-optimize-utils.cc:1347</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_html_adbabf05a7702103113a02a113015205f"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#adbabf05a7702103113a02a113015205f">kaldi::nnet3::MemoryCompressionOptimizer::nnet_</a></div><div class="ttdeci">const Nnet &amp; nnet_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04761">nnet-optimize-utils.cc:4761</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_ac790fa54a2c9e95706a7384c687651ad"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#ac790fa54a2c9e95706a7384c687651ad">kaldi::nnet3::DerivativeTimeLimiter::MapSimpleMatrixCommand</a></div><div class="ttdeci">void MapSimpleMatrixCommand(NnetComputation::Command *c)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01686">nnet-optimize-utils.cc:1686</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_a066039f8c4f9f320876c465226f17f59"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#a066039f8c4f9f320876c465226f17f59">kaldi::nnet3::DerivativeTimeLimiter::submatrix_map_</a></div><div class="ttdeci">std::vector&lt; int32 &gt; submatrix_map_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00354">nnet-optimize-utils.h:354</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a26ebe2a579bf27a5453cb7b489ad6f69"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a26ebe2a579bf27a5453cb7b489ad6f69">kaldi::nnet3::kPropagate</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00290">nnet-computation.h:290</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_html_ac8ca96df1ecdb635738c59a88cff8835"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#ac8ca96df1ecdb635738c59a88cff8835">kaldi::nnet3::MemoryCompressionOptimizer::analyzer_</a></div><div class="ttdeci">Analyzer analyzer_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04765">nnet-optimize-utils.cc:4765</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo_html_a515c4dd14ce4dc58f42c9a60b6bfbaba"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1SubMatrixInfo.html#a515c4dd14ce4dc58f42c9a60b6bfbaba">kaldi::nnet3::NnetComputation::SubMatrixInfo::matrix_index</a></div><div class="ttdeci">int32 matrix_index</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00324">nnet-computation.h:324</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MatrixExtender_html_aceebe1d56d0762409ab7360cd9171ef3"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MatrixExtender.html#aceebe1d56d0762409ab7360cd9171ef3">kaldi::nnet3::MatrixExtender::FixDebugInfo</a></div><div class="ttdeci">void FixDebugInfo()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01246">nnet-optimize-utils.cc:1246</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_aad666818585d567208e5833cd3ed6ea4"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#aad666818585d567208e5833cd3ed6ea4">kaldi::nnet3::ComputationExpander::ComputePrecomputedIndexes</a></div><div class="ttdeci">void ComputePrecomputedIndexes()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03676">nnet-optimize-utils.cc:3676</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_ab84babea5bedf77dcfd64a0df53219c5"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab84babea5bedf77dcfd64a0df53219c5">kaldi::nnet3::NnetComputation::indexes</a></div><div class="ttdeci">std::vector&lt; std::vector&lt; int32 &gt; &gt; indexes</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00419">nnet-computation.h:419</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1Analyzer_html_afe662460f3e8b135d96fcd057638bd28"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1Analyzer.html#afe662460f3e8b135d96fcd057638bd28">kaldi::nnet3::Analyzer::variables</a></div><div class="ttdeci">ComputationVariables variables</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00295">nnet-analyze.h:295</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1SubMatrixHasher_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1ComputationRenumberer_1_1SubMatrixHasher.html">kaldi::nnet3::ComputationRenumberer::SubMatrixHasher</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00187">nnet-optimize-utils.cc:187</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1VariableMergingOptimizer_html_a400e33db7a90834eec20a7eee34f162d"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a400e33db7a90834eec20a7eee34f162d">kaldi::nnet3::VariableMergingOptimizer::already_called_merge_variables_</a></div><div class="ttdeci">bool already_called_merge_variables_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00184">nnet-optimize-utils.h:184</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a590c38bb0c9acc4ad1f626237f1a4169"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a590c38bb0c9acc4ad1f626237f1a4169">kaldi::nnet3::SnipRowOps</a></div><div class="ttdeci">bool SnipRowOps(NnetComputation *computation)</div><div class="ttdoc">This function detects cases where commands of type kCopyRows, kAddRows, kAddRowsMulti, kAddToRowsMulti, kCopyRowsMulti, kCopyToRowsMulti or kAddRowRanges use indexes that start or end with -1&amp;#39;s or equivalents, and replace them with similar commands that act on a sub-matrix of the matrices they are currently acting on. </div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02537">nnet-optimize-utils.cc:2537</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer_html_ac098379dcf820792fc77cd03a42c759e"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MemoryCompressionOptimizer.html#ac098379dcf820792fc77cd03a42c759e">kaldi::nnet3::MemoryCompressionOptimizer::middle_command_</a></div><div class="ttdeci">int32 middle_command_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04763">nnet-optimize-utils.cc:4763</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a662aa95978d72cd24fde262e35941fad"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a662aa95978d72cd24fde262e35941fad">kaldi::nnet3::kAddToRowsMulti</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00292">nnet-computation.h:292</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a0260a200407f88708e5c2793506e4ada"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a0260a200407f88708e5c2793506e4ada">kaldi::nnet3::kDecompressMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00293">nnet-computation.h:293</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a68068a73dabd55faade8d658a56f277b"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a68068a73dabd55faade8d658a56f277b">kaldi::nnet3::IndexesHaveSpecialStructure</a></div><div class="ttdeci">static bool IndexesHaveSpecialStructure(const std::vector&lt; int32 &gt; &amp;indexes, int32 *first_nonnegative_pos, int32 *first_nonnegative_value, int32 *num_nonnegative_indexes)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02252">nnet-optimize-utils.cc:2252</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html">kaldi::nnet3::DerivativeTimeLimiter::MatrixPruneInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00321">nnet-optimize-utils.h:321</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_a87cbe94f28fe1fbbbcde4e650b5fbfe2"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a87cbe94f28fe1fbbbcde4e650b5fbfe2">kaldi::nnet3::ComputationExpander::ExpandRowsCommand</a></div><div class="ttdeci">void ExpandRowsCommand(const NnetComputation::Command &amp;c_in, NnetComputation::Command *c_out)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03298">nnet-optimize-utils.cc:3298</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo_html_a71978616b0acd678d1f284943acd6586"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1MatrixInfo.html#a71978616b0acd678d1f284943acd6586">kaldi::nnet3::NnetComputation::MatrixInfo::num_rows</a></div><div class="ttdeci">int32 num_rows</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00305">nnet-computation.h:305</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MatrixExtender_html_a8605a31b0233e3b83fdb834a7995521a"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a8605a31b0233e3b83fdb834a7995521a">kaldi::nnet3::MatrixExtender::MatrixExtender</a></div><div class="ttdeci">MatrixExtender(NnetComputation *computation)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01067">nnet-optimize-utils.cc:1067</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a59e6e35ab79257514b799d2ebe48ed20"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a59e6e35ab79257514b799d2ebe48ed20">kaldi::nnet3::SnipSingleRowOp</a></div><div class="ttdeci">static bool SnipSingleRowOp(NnetComputation *computation, int32 command_index)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02364">nnet-optimize-utils.cc:2364</a></div></div>
<div class="ttc" id="namespacekaldi_html_a81dfa76eeac63eba502e32ee58e37d57"><div class="ttname"><a href="namespacekaldi.html#a81dfa76eeac63eba502e32ee58e37d57">kaldi::IsSortedAndUniq</a></div><div class="ttdeci">bool IsSortedAndUniq(const std::vector&lt; T &gt; &amp;vec)</div><div class="ttdoc">Returns true if the vector is sorted and contains each element only once. </div><div class="ttdef"><b>Definition:</b> <a href="stl-utils_8h_source.html#l00063">stl-utils.h:63</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1CheckComputationOptions_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1CheckComputationOptions.html">kaldi::nnet3::CheckComputationOptions</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00391">nnet-analyze.h:391</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_ae75e6d0c1a5e33b7b6a02175357f0fcd"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#ae75e6d0c1a5e33b7b6a02175357f0fcd">kaldi::nnet3::ComputationExpander::GetNewSubmatLocationInfo</a></div><div class="ttdeci">bool GetNewSubmatLocationInfo(int32 submat_index, int32 old_row_index, int32 *new_row_index, int32 *n_stride) const</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03743">nnet-optimize-utils.cc:3743</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a21e038f5b8958e203d28bc4f18472352a86646468234ab036580a4f2e4d72af3c"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a21e038f5b8958e203d28bc4f18472352a86646468234ab036580a4f2e4d72af3c">kaldi::nnet3::kAddRowRanges</a></div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00293">nnet-computation.h:293</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MatrixExtender_html_ae21e72d8f14723918b89dbf6615b53b2"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MatrixExtender.html#ae21e72d8f14723918b89dbf6615b53b2">kaldi::nnet3::MatrixExtender::MatrixInfo</a></div><div class="ttdeci">NnetComputation::MatrixInfo MatrixInfo</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01022">nnet-optimize-utils.cc:1022</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter_html_aa7fea2a9fb72886fbc7d8bb55f025e21"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1DerivativeTimeLimiter.html#aa7fea2a9fb72886fbc7d8bb55f025e21">kaldi::nnet3::DerivativeTimeLimiter::RowIsKept</a></div><div class="ttdeci">bool RowIsKept(int32 submatrix, int32 row_index) const</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01580">nnet-optimize-utils.cc:1580</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1RowOpsSplitter_html_a464801e09b6b4e3d2b20730f6002016c"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a464801e09b6b4e3d2b20730f6002016c">kaldi::nnet3::RowOpsSplitter::SplitCommands</a></div><div class="ttdeci">bool SplitCommands()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02883">nnet-optimize-utils.cc:2883</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1RowOpsSplitter_html_a2867a317eb29f40c427ab677c0502ab5"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a2867a317eb29f40c427ab677c0502ab5">kaldi::nnet3::RowOpsSplitter::Split</a></div><div class="ttdeci">bool Split()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02584">nnet-optimize-utils.cc:2584</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_a6950699c83d835e55f003f89bb92bc80"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#a6950699c83d835e55f003f89bb92bc80">kaldi::nnet3::IdentifyIndexesArgs</a></div><div class="ttdeci">void IdentifyIndexesArgs(std::vector&lt; NnetComputation::Command &gt; *commands, std::vector&lt; int32 *&gt; *indexes_args)</div><div class="ttdoc">Identifies in the vector of commands, arguments that correspond to indexes into the computation&amp;#39;s &amp;#39;in...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00133">nnet-optimize-utils.cc:133</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_af8b9a053089365f8c8d0f3e5436d66a4"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#af8b9a053089365f8c8d0f3e5436d66a4">kaldi::nnet3::SnipMultiRowOp</a></div><div class="ttdeci">static bool SnipMultiRowOp(NnetComputation *computation, int32 command_index)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02434">nnet-optimize-utils.cc:2434</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationCache_html_a38be6b2c66f846512889b9fed7669815"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationCache.html#a38be6b2c66f846512889b9fed7669815">kaldi::nnet3::ComputationCache::cache_capacity_</a></div><div class="ttdeci">int32 cache_capacity_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00660">nnet-optimize-utils.h:660</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator_html_a1637cd5c5a1274835dfb87d75fde2037"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ModelUpdateConsolidator.html#a1637cd5c5a1274835dfb87d75fde2037">kaldi::nnet3::ModelUpdateConsolidator::final_deallocate_commands_</a></div><div class="ttdeci">std::vector&lt; NnetComputation::Command &gt; final_deallocate_commands_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01343">nnet-optimize-utils.cc:1343</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_ab4efec36ef0d5bab190891c36bd9b2e3"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#ab4efec36ef0d5bab190891c36bd9b2e3">kaldi::nnet3::NnetComputation::IsWholeMatrix</a></div><div class="ttdeci">bool IsWholeMatrix(int32 submatrix_index) const</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8cc_source.html#l00975">nnet-computation.cc:975</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1Analyzer_html"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1Analyzer.html">kaldi::nnet3::Analyzer</a></div><div class="ttdoc">This struct exists to set up various pieces of analysis; it helps avoid the repetition of code where ...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00294">nnet-analyze.h:294</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1VariableMergingOptimizer_html_a7156e8f117cea1292ffbbc0dc1d87067"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1VariableMergingOptimizer.html#a7156e8f117cea1292ffbbc0dc1d87067">kaldi::nnet3::VariableMergingOptimizer::MayBeMerged</a></div><div class="ttdeci">std::pair&lt; bool, bool &gt; MayBeMerged(int32 command, int32 s1, int32 s2) const</div><div class="ttdoc">This function returns a pair of bools saying whether we can do a (left and/or right) merge respective...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00945">nnet-optimize-utils.cc:945</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_a69d4034713b69fe896cf7fd0566c3216"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a69d4034713b69fe896cf7fd0566c3216">kaldi::nnet3::ComputationLoopedOptimizer::GetMatrixSwapOrder</a></div><div class="ttdeci">static void GetMatrixSwapOrder(const std::vector&lt; int32 &gt; &amp;matrices1, const std::vector&lt; int32 &gt; &amp;matrices2, std::vector&lt; std::pair&lt; int32, int32 &gt; &gt; *swaps)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04367">nnet-optimize-utils.cc:4367</a></div></div>
<div class="ttc" id="namespacekaldi_1_1nnet3_html_ac952f0840a7950dff80c1a89e69656d7"><div class="ttname"><a href="namespacekaldi_1_1nnet3.html#ac952f0840a7950dff80c1a89e69656d7">kaldi::nnet3::kNoTime</a></div><div class="ttdeci">const int kNoTime</div><div class="ttdef"><b>Definition:</b> <a href="nnet-common_8cc_source.html#l00573">nnet-common.cc:573</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationExpander_html_a349da8d95ac1defe31a714e52954bbde"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationExpander.html#a349da8d95ac1defe31a714e52954bbde">kaldi::nnet3::ComputationExpander::ComputeDebugInfo</a></div><div class="ttdeci">void ComputeDebugInfo()</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l03603">nnet-optimize-utils.cc:3603</a></div></div>
<div class="ttc" id="namespacernnlm_html_a873684cefeb665f3d5e6b495de57fc0d"><div class="ttname"><a href="namespacernnlm.html#a873684cefeb665f3d5e6b495de57fc0d">rnnlm::d</a></div><div class="ttdeci">double d</div><div class="ttdef"><b>Definition:</b> <a href="mikolov-rnnlm-lib_8cc_source.html#l00064">mikolov-rnnlm-lib.cc:64</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_a40b93bc9e9fe7dccea10334ecf8edf2a"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a40b93bc9e9fe7dccea10334ecf8edf2a">kaldi::nnet3::ComputationLoopedOptimizer::FindTimeShift</a></div><div class="ttdeci">static int32 FindTimeShift(const NnetComputation &amp;computation)</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04070">nnet-optimize-utils.cc:4070</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationRenumberer_html_ac9050b561913ee338e9a5b75d1671ac9"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationRenumberer.html#ac9050b561913ee338e9a5b75d1671ac9">kaldi::nnet3::ComputationRenumberer::old_to_new_submatrix_</a></div><div class="ttdeci">std::vector&lt; int32 &gt; old_to_new_submatrix_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l00250">nnet-optimize-utils.cc:250</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command_html_ae703ec85ed072c6abc26f0346c928f06"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation_1_1Command.html#ae703ec85ed072c6abc26f0346c928f06">kaldi::nnet3::NnetComputation::Command::arg3</a></div><div class="ttdeci">int32 arg3</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00343">nnet-computation.h:343</a></div></div>
<div class="ttc" id="namespacekaldi_html_a0361eab3c5ebb78e6be060e6fa78e1a1"><div class="ttname"><a href="namespacekaldi.html#a0361eab3c5ebb78e6be060e6fa78e1a1">kaldi::RandInt</a></div><div class="ttdeci">int32 RandInt(int32 min_val, int32 max_val, struct RandomState *state)</div><div class="ttdef"><b>Definition:</b> <a href="kaldi-math_8cc_source.html#l00094">kaldi-math.cc:94</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer_html_a36d13565d1302a2bf74127b141ba3537"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationLoopedOptimizer.html#a36d13565d1302a2bf74127b141ba3537">kaldi::nnet3::ComputationLoopedOptimizer::computation_</a></div><div class="ttdeci">NnetComputation * computation_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l04062">nnet-optimize-utils.cc:4062</a></div></div>
<div class="ttc" id="structkaldi_1_1PairHasher_html"><div class="ttname"><a href="structkaldi_1_1PairHasher.html">kaldi::PairHasher</a></div><div class="ttdoc">A hashing function-object for pairs of ints. </div><div class="ttdef"><b>Definition:</b> <a href="stl-utils_8h_source.html#l00237">stl-utils.h:237</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo_html_a3080a09e5ea2e63c0b61d0ab3d0958bc"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1DerivativeTimeLimiter_1_1MatrixPruneInfo.html#a3080a09e5ea2e63c0b61d0ab3d0958bc">kaldi::nnet3::DerivativeTimeLimiter::MatrixPruneInfo::fully_inside_range</a></div><div class="ttdeci">bool fully_inside_range</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8h_source.html#l00324">nnet-optimize-utils.h:324</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_abf2fedad8e73e55adba8dba14361967f"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#abf2fedad8e73e55adba8dba14361967f">kaldi::nnet3::NnetComputation::GetSubmatrixStrings</a></div><div class="ttdeci">void GetSubmatrixStrings(const Nnet &amp;nnet, std::vector&lt; std::string &gt; *submat_strings) const</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8cc_source.html#l00424">nnet-computation.cc:424</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1MatrixExtender_html_a76a052939eb8507417303c9cbaef5452"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1MatrixExtender.html#a76a052939eb8507417303c9cbaef5452">kaldi::nnet3::MatrixExtender::min_proportion_</a></div><div class="ttdeci">BaseFloat min_proportion_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l01050">nnet-optimize-utils.cc:1050</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1RowOpsSplitter_html_a2e4b2c10e3fa4daad72c553006aa7c53"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1RowOpsSplitter.html#a2e4b2c10e3fa4daad72c553006aa7c53">kaldi::nnet3::RowOpsSplitter::split_info_</a></div><div class="ttdeci">std::vector&lt; MultiIndexSplitInfo &gt; split_info_</div><div class="ttdef"><b>Definition:</b> <a href="nnet-optimize-utils_8cc_source.html#l02676">nnet-optimize-utils.cc:2676</a></div></div>
<div class="ttc" id="classkaldi_1_1nnet3_1_1ComputationAnalysis_html"><div class="ttname"><a href="classkaldi_1_1nnet3_1_1ComputationAnalysis.html">kaldi::nnet3::ComputationAnalysis</a></div><div class="ttdoc">This class performs various kinds of specific analysis on top of what class Analyzer gives you immedi...</div><div class="ttdef"><b>Definition:</b> <a href="nnet-analyze_8h_source.html#l00308">nnet-analyze.h:308</a></div></div>
<div class="ttc" id="structkaldi_1_1nnet3_1_1NnetComputation_html_a3095d45a751aaa81c1024cf9510e2ed7"><div class="ttname"><a href="structkaldi_1_1nnet3_1_1NnetComputation.html#a3095d45a751aaa81c1024cf9510e2ed7">kaldi::nnet3::NnetComputation::indexes_ranges</a></div><div class="ttdeci">std::vector&lt; std::vector&lt; std::pair&lt; int32, int32 &gt; &gt; &gt; indexes_ranges</div><div class="ttdef"><b>Definition:</b> <a href="nnet-computation_8h_source.html#l00430">nnet-computation.h:430</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_67a0a17020b8eedc08ffa5626b1d53a1.html">nnet3</a></li><li class="navelem"><a class="el" href="nnet-optimize-utils_8cc.html">nnet-optimize-utils.cc</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
